console.log("Helena Paint - draw67.js");const canvas=document.getElementById("glCanvas"),canvasWrapper=document.getElementById("canvasWrapper")||canvas.parentElement;canvas.style.transformOrigin="top left";let lastX=null,lastY=null,zoomScale=1,panX=0,panY=0,zoomMin=1,zoomMax=5,lastTouchDist=null,lastTouchMidpoint=null,isPanning=!1,isTwoFingerGesture=!1,isUIDragging=!1;const PIVOT_DEBUG=!0,log=(...e)=>{console.log("[pivot]",...e)};function isMobile(){return/Mobi|Android|iPhone|iPad|iPod/.test(navigator.userAgent)}function getMidpoint(e,t){return{x:(e.clientX+t.clientX)/2,y:(e.clientY+t.clientY)/2}}function getDistance(e,t){const a=e.clientX-t.clientX,r=e.clientY-t.clientY;return Math.sqrt(a*a+r*r)}function canPaint(){return"idle"===transformTool.mode&&!spacePanning&&!isTwoFingerGesture&&!isUIDragging}let pinchStart=null;function normAngle(e){return e>Math.PI&&(e-=2*Math.PI),e<-Math.PI&&(e+=2*Math.PI),e}function transformCanvasPoint(e,t,a,r){const n=e*a,o=t*a,i=Math.cos(r),l=Math.sin(r);return{x:n*i-o*l,y:n*l+o*i}}let viewRotation=0,transformOriginX=0,transformOriginY=0;function updateCanvasTransform(){canvas.style.transformOrigin="0 0",canvas.style.transform=`translate(${panX}px, ${panY}px) rotate(${viewRotation}rad) scale(${zoomScale})`}function rotatePoint(e,t,a,r=0,n=0){const o=e-r,i=t-n,l=Math.cos(a),s=Math.sin(a);return{x:r+o*l-i*s,y:n+o*s+i*l}}function docToCanvasPx(e,t){return{x:e*(canvas.width/fixedFBOWidth),y:t*(canvas.height/fixedFBOHeight)}}function tracePivot(e){const t=getActiveLayer();if(!t)return void console.warn("[pivot]",e,"no active layer");const a=transformTool.pivotCanvas,r={x:t.px,y:t.py},n=docToCanvasPx(r.x,r.y),o={...lastPointer};console.log("[pivot]",e,{mode:transformTool.mode,lastPointer:o,pivotCanvas_UI:a,pivotDoc_math:r,pivotDoc_asCanvas:n})}function screenToCanvasPx(e,t,a=!0){const r=canvasWrapper.getBoundingClientRect();let n=e-r.left,o=t-r.top;const i={clientX:e,clientY:t,panX:panX,panY:panY,zoomScale:zoomScale,viewRotation:viewRotation,clamp:a};n-=panX,o-=panY;const l=rotatePoint(n,o,-viewRotation,transformOriginX,transformOriginY);n=l.x,o=l.y;const s=n/zoomScale,c=o/zoomScale;if(!a)return log("screenToCanvasPx(unclamped)",i,"→",{x:s,y:c}),{x:s,y:c};const d={x:Math.max(0,Math.min(canvas.width,s)),y:Math.max(0,Math.min(canvas.height,c))};return log("screenToCanvasPx(clamped)",i,"→",d),d}function canvasPxToFBO(e,t){return{fx:e*(fixedFBOWidth/canvas.width),fy:t*(fixedFBOHeight/canvas.height)}}function pointerToBoth(e){const t=!(transformTool&&transformTool.mode&&"idle"!==transformTool.mode),a=screenToCanvasPx(e.clientX,e.clientY,t),r=canvasPxToFBO(a.x,a.y),n={cx:a.x,cy:a.y,fx:r.fx,fy:r.fy};return log("pointerToBoth",{mode:transformTool?.mode,clamp:t},"→",n),n}let brushHUD={visible:!1,hideAt:0},lastPointer={cx:.5*canvas.width,cy:.5*canvas.height};function showBrushHUD(e=1200){brushHUD.visible=!0,brushHUD.hideAt=performance.now()+e,needsRedraw=!0,requestDrawIfIdle()}function maybeAutoHideBrushHUD(){brushHUD.visible&&performance.now()>=brushHUD.hideAt&&(brushHUD.visible=!1,needsRedraw=!0,requestDrawIfIdle())}let touchViz={pts:[],visible:!1};function setTouchVizFromTouches(e){const t=[];for(let a=0;a<e.length;a++){const r=e[a],n=screenToCanvasPx(r.clientX,r.clientY);t.push({x:n.x,y:n.y})}touchViz.pts=t,touchViz.visible=t.length>0,void 0!==needsRedraw&&(needsRedraw=!0),"function"==typeof requestDrawIfIdle&&requestDrawIfIdle()}function clearTouchViz(){touchViz.pts=[],touchViz.visible=!1,void 0!==needsRedraw&&(needsRedraw=!0),"function"==typeof requestDrawIfIdle&&requestDrawIfIdle()}const TOUCH_TARGET_OK=e=>!(!e||e!==canvas&&e!==canvasWrapper&&!e.closest?.("#canvasWrapper"));function onTouchStartCapture(e){e.touches&&e.touches.length&&TOUCH_TARGET_OK(e.target)&&setTouchVizFromTouches(e.touches)}function onTouchMoveCapture(e){e.touches&&e.touches.length&&TOUCH_TARGET_OK(e.target)&&setTouchVizFromTouches(e.touches)}function onTouchEndCapture(e){e.touches&&e.touches.length?setTouchVizFromTouches(e.touches):clearTouchViz()}document.addEventListener("touchstart",onTouchStartCapture,{capture:!0,passive:!0}),document.addEventListener("touchmove",onTouchMoveCapture,{capture:!0,passive:!0}),document.addEventListener("touchend",onTouchEndCapture,{capture:!0,passive:!0}),document.addEventListener("touchcancel",onTouchEndCapture,{capture:!0,passive:!0});let frameTimes=[],memoryWarningShown=!1,frameRateMonitoringActive=!1;function sampleFrameTime(){const e=performance.now();if(frameTimes.push(e),frameTimes.length>30&&frameTimes.shift(),activeReasons.size>0){const e=[];for(let t=1;t<frameTimes.length;t++)e.push(frameTimes[t]-frameTimes[t-1]);(e.length?e.reduce((e,t)=>e+t,0)/e.length:0)>80&&!memoryWarningShown&&(console.warn("⚠️ Low frame rate detected! Possible memory overload."),showStatusMessage("⚠️ App running slow — consider undo or saving","warning"),memoryWarningShown=!0)}}let rafId=null;const activeReasons=new Set;function requestDrawIfIdle(){rafId||(rafId=requestAnimationFrame(()=>{rafId=null,needsRedraw&&(drawScene(),needsRedraw=!1,sampleFrameTime?.())}))}function startRender(e){e&&activeReasons.add(e),rafId||(rafId=requestAnimationFrame(tick))}function stopRender(e){e&&activeReasons.delete(e)}function tick(){rafId=null;activeReasons.size>0?(needsRedraw&&(drawScene(),needsRedraw=!1,sampleFrameTime?.()),rafId=requestAnimationFrame(tick)):needsRedraw&&(drawScene(),needsRedraw=!1,sampleFrameTime?.())}let RENDER_LOOP_DISABLED=!0;function disableRenderLoop(){RENDER_LOOP_DISABLED=!0;try{activeReasons?.clear?.()}catch{}rafId&&(cancelAnimationFrame(rafId),rafId=null)}function enableRenderLoop(){RENDER_LOOP_DISABLED=!1}const _startRender=startRender;startRender=function(e){RENDER_LOOP_DISABLED||_startRender.call(this,e)};const _requestDrawIfIdle=requestDrawIfIdle;requestDrawIfIdle=function(){RENDER_LOOP_DISABLED?needsRedraw&&(drawScene(),needsRedraw=!1,sampleFrameTime?.()):_requestDrawIfIdle.call(this)};const _tick=tick;tick=function(){RENDER_LOOP_DISABLED?rafId&&(cancelAnimationFrame(rafId),rafId=null):_tick.call(this)},disableRenderLoop(),canvasWrapper.addEventListener("wheel",e=>{e.preventDefault();const t=1===e.deltaMode?16:1,a=e.deltaX*t,r=e.deltaY*t,n=canvasWrapper.getBoundingClientRect(),o=e.clientX-n.left,i=e.clientY-n.top,l=(o-panX)/zoomScale,s=(i-panY)/zoomScale;if(e.ctrlKey){const e=.0025,t=Math.min(Math.max(zoomScale-r*e,zoomMin),zoomMax),a=t/zoomScale;panX-=l*(a-1)*zoomScale,panY-=s*(a-1)*zoomScale,zoomScale=t,updateCanvasTransform()}else{const e=1;panX-=a*e,panY-=r*e,updateCanvasTransform()}},{passive:!1}),canvasWrapper.addEventListener("mousemove",e=>{const t=screenToCanvasPx(e.clientX,e.clientY,!0);lastPointer.cx=t.x,lastPointer.cy=t.y,brushHUD.visible&&(overlayPosition=[t.x/canvas.width,t.y/canvas.height],needsRedraw=!0,requestDrawIfIdle())},{passive:!0}),canvasWrapper.addEventListener("mousedown",e=>{const t=screenToCanvasPx(e.clientX,e.clientY,!1);lastPointer.cx=t.x,lastPointer.cy=t.y,log("mousedown → seed pivot",{clientX:e.clientX,clientY:e.clientY,canvas:t})},{passive:!0}),canvasWrapper.addEventListener("touchstart",e=>{if(!e.touches||1!==e.touches.length)return;const t=e.touches[0],a=screenToCanvasPx(t.clientX,t.clientY,!1);lastPointer.cx=a.x,lastPointer.cy=a.y,log("touchstart → seed pivot",{clientX:t.clientX,clientY:t.clientY,canvas:a})},{passive:!0});let spacePanning=!1,panStart=null;document.addEventListener("keydown",e=>{"Space"===e.code&&(spacePanning=!0)}),document.addEventListener("keyup",e=>{"Space"===e.code&&(spacePanning=!1)}),canvasWrapper.addEventListener("mousedown",e=>{spacePanning&&(e.preventDefault(),panStart={x:e.clientX,y:e.clientY,panX0:panX,panY0:panY})}),window.addEventListener("mousemove",e=>{panStart&&(panX=panStart.panX0+(e.clientX-panStart.x),panY=panStart.panY0+(e.clientY-panStart.y),updateCanvasTransform())}),["mouseup","mouseleave"].forEach(e=>window.addEventListener(e,()=>panStart=null)),canvasWrapper.addEventListener("mousedown",e=>{if(1!==e.button)return;e.preventDefault();const t=e.clientX,a=e.clientY,r=panX,n=panY,o=e=>{panX=r+(e.clientX-t),panY=n+(e.clientY-a),updateCanvasTransform()},i=()=>{window.removeEventListener("mousemove",o),window.removeEventListener("mouseup",i)};window.addEventListener("mousemove",o),window.addEventListener("mouseup",i)}),window.addEventListener("mousemove",onTransformPointerMove),window.addEventListener("mousemove",onTransformPointerMove),canvas.addEventListener("touchmove",e=>{if("idle"===transformTool.mode)return;const t=e.touches[0];t&&onTransformPointerMove(t)},{passive:!1}),["mouseup","mouseleave","touchend","touchcancel"].forEach(e=>window.addEventListener(e,()=>{"idle"!==transformTool.mode&&endTransform(!0)},{passive:!0})),canvas.addEventListener("mousedown",()=>{isDrawing=!0,startRender("draw")}),["mouseup","mouseleave"].forEach(e=>canvas.addEventListener(e,()=>{isDrawing=!1,stopRender("draw")})),canvas.addEventListener("touchstart",e=>{isTwoFingerGesture||(isDrawing=!0,startRender("draw"))},{passive:!1}),["touchend","touchcancel"].forEach(e=>window.addEventListener(e,()=>{isTwoFingerGesture&&(!event.touches||event.touches.length<2)&&(isTwoFingerGesture=!1,pinchStart=null),"idle"!==transformTool.mode&&endTransform(!0)},{passive:!0}));let lastTouchAngle=null;function getAngle(e,t){return Math.atan2(t.clientY-e.clientY,t.clientX-e.clientX)}canvasWrapper.addEventListener("touchstart",e=>{if(2===e.touches.length){e.preventDefault(),isTwoFingerGesture=!0;const t=e.touches[0],a=e.touches[1];lastTouchDist=getDistance(t,a),lastTouchAngle=getAngle(t,a);const r=getMidpoint(t,a),n=canvasWrapper.getBoundingClientRect(),o=r.x-n.left,i=r.y-n.top,l=screenToCanvasPx(o+n.left,i+n.top);pinchStart={dist:Math.max(1e-6,lastTouchDist),angle:lastTouchAngle,scale0:zoomScale,rot0:viewRotation,anchorCanvas:{x:l.x,y:l.y}}}},{passive:!1}),canvasWrapper.addEventListener("touchmove",e=>{if(2!==e.touches.length||!pinchStart)return;e.preventDefault(),isDrawing=!1;const t=e.touches[0],a=e.touches[1],r=Math.max(1e-6,getDistance(t,a)),n=getAngle(t,a),o=getMidpoint(t,a),i=canvasWrapper.getBoundingClientRect(),l=o.x-i.left,s=o.y-i.top,c=pinchStart.scale0*(r/pinchStart.dist),d=Math.min(Math.max(c,zoomMin),zoomMax),g=normAngle(n-pinchStart.angle),u=pinchStart.rot0+g,m=pinchStart.anchorCanvas,f=transformCanvasPoint(m.x,m.y,d,u);panX=l-f.x,panY=s-f.y,zoomScale=d,viewRotation=u,updateCanvasTransform(),lastTouchDist=r,lastTouchAngle=n},{passive:!1}),canvas.addEventListener("touchstart",e=>{isTwoFingerGesture&&(e.preventDefault(),e.stopPropagation())},{passive:!1});const gl=canvas.getContext("webgl2",{alpha:!0,powerPreference:"high-performance"});let needsRedraw=!0;const imageLoader=document.getElementById("imageLoader"),colorPicker=document.getElementById("colorPicker"),brushes=[{name:"Dot",file:"/static/draw/images/brushes/dot.webp",defaultSize:.02,selected:!1},{name:"Fine Liner",file:"/static/draw/images/brushes/fine-liner-2.webp",defaultSize:.03,selected:!1},{name:"Brush 12",file:"/static/draw/images/brushes/12.webp",defaultSize:.04,selected:!1},{name:"Brush 11",file:"/static/draw/images/brushes/11.webp",defaultSize:.05,selected:!0},{name:"Brush 0",file:"/static/draw/images/brushes/0.png",defaultSize:.025,selected:!1},{name:"Brush 5",file:"/static/draw/images/brushes/5.png",defaultSize:.03,selected:!1},{name:"Brush 1",file:"/static/draw/images/brushes/1.png",defaultSize:.035,selected:!1},{name:"Brush 2",file:"/static/draw/images/brushes/2.png",defaultSize:.04,selected:!1},{name:"Brush 3",file:"/static/draw/images/brushes/3.png",defaultSize:.045,selected:!1},{name:"Brush 4",file:"/static/draw/images/brushes/4.png",defaultSize:.05,selected:!1},{name:"Brush 7",file:"/static/draw/images/brushes/7.webp",defaultSize:.06,selected:!1},{name:"Brush 8",file:"/static/draw/images/brushes/8.webp",defaultSize:.2,selected:!1}];let paintFBO,paintTexture,quadProgram,paintProgram,overlayProgram,floodFillProgram,brushTextures={},brushAspects={},currentBrush=null,currentArtworkId=null,texture=null,overlayTexture=null,brushAspect=1,imageAspect=1,currentImage=null,overlayPosition=[0,0],isDrawing=!1,currentTool="draw",fixedFBOWidth=0,fixedFBOHeight=0,tintColor=[0,0,0,1];function hexToHSL(e){3===(e=e.replace(/^#/,"")).length&&(e=e.split("").map(e=>e+e).join(""));let t,a,r=parseInt(e.substr(0,2),16)/255,n=parseInt(e.substr(2,2),16)/255,o=parseInt(e.substr(4,2),16)/255,i=Math.max(r,n,o),l=Math.min(r,n,o),s=(i+l)/2;if(i===l)t=a=0;else{let e=i-l;switch(a=s>.5?e/(2-i-l):e/(i+l),i){case r:t=(n-o)/e+(n<o?6:0);break;case n:t=(o-r)/e+2;break;case o:t=(r-n)/e+4}t/=6}return{h:t,s:a,l:s}}colorPicker.addEventListener("input",e=>{tintColor=hexToRGBA(e.target.value);const t=hexToHSL(e.target.value);baseColor=hexToRGBA(e.target.value).slice(0,3),lightnessFactor=t.l,updateLightnessGradient(),updateFinalColor();const a=colorPalette.querySelector(".indicator");a&&(a.style.top=t.h*(colorPalette.clientHeight-a.clientHeight)+"px");const r=lightnessPalette.querySelector(".indicator");r&&(r.style.top=t.l*(lightnessPalette.clientHeight-r.clientHeight)+"px")});const colorPalette=document.getElementById("colorPalette"),lightnessPalette=document.getElementById("lightnessPalette");let baseColor=[0,0,0],lightnessFactor=.5;function updateLightnessGradient(){const e=`linear-gradient(to bottom, rgb(${Math.round(255*baseColor[0])}, ${Math.round(255*baseColor[1])}, ${Math.round(255*baseColor[2])}), white)`;document.getElementById("lightnessPalette").style.background=e}function pickBaseColor(e){const t=colorPalette.getBoundingClientRect(),a=(e.touches?e.touches[0].clientY:e.clientY)-t.top,r=Math.max(0,Math.min(1,a/t.height)),n=[[255,0,0],[255,255,0],[0,255,0],[0,255,255],[0,0,255],[255,0,255],[255,0,0]],o=Math.floor(r*(n.length-1)),i=Math.min(o+1,n.length-1),l=r*(n.length-1)%1;baseColor=[(n[o][0]*(1-l)+n[i][0]*l)/255,(n[o][1]*(1-l)+n[i][1]*l)/255,(n[o][2]*(1-l)+n[i][2]*l)/255],updateLightnessGradient(),updateFinalColor();const s=colorPalette.querySelector(".indicator");s&&(s.style.top=r*(colorPalette.clientHeight-s.clientHeight)+"px")}function pickLightness(e){const t=lightnessPalette.getBoundingClientRect(),a=(e.touches?e.touches[0].clientY:e.clientY)-t.top,r=Math.max(0,Math.min(1,a/t.height));lightnessFactor=r,updateFinalColor();const n=lightnessPalette.querySelector(".indicator");n&&(n.style.top=r*(lightnessPalette.clientHeight-n.clientHeight)+"px")}function updateFinalColor(){const e=Math.round(baseColor[0]*(1-lightnessFactor)*255+255*lightnessFactor),t=Math.round(baseColor[1]*(1-lightnessFactor)*255+255*lightnessFactor),a=Math.round(baseColor[2]*(1-lightnessFactor)*255+255*lightnessFactor);tintColor=[e/255,t/255,a/255,1];const r=rgbToHex(e,t,a);console.log("hexColor",r),document.getElementById("colorPicker").value=r,needsRedraw=!0}function rgbToHex(e,t,a){return`#${(1<<24|e<<16|t<<8|a).toString(16).slice(1).toUpperCase()}`}function replaceColorPicker(e){const t=document.getElementById("colorPicker"),a=document.createElement("input");a.type="color",a.id="colorPicker",a.value=e,a.addEventListener("input",e=>{tintColor=hexToRGBA(e.target.value),needsRedraw=!0}),t.parentNode.replaceChild(a,t)}function hexToRGBA(e){"#"===e.charAt(0)&&(e=e.substr(1)),3===e.length&&(e=e.split("").map(e=>e+e).join(""));let t=parseInt(e,16);return[(t>>16&255)/255,(t>>8&255)/255,(255&t)/255,1]}function createShader(e,t,a){const r=e.createShader(t);return e.shaderSource(r,a),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS)?r:(console.error("Shader compile error:",e.getShaderInfoLog(r)),e.deleteShader(r),null)}function createProgram(e,t,a){const r=createShader(e,e.VERTEX_SHADER,t),n=createShader(e,e.FRAGMENT_SHADER,a);if(!r||!n)return null;const o=e.createProgram();return e.attachShader(o,r),e.attachShader(o,n),e.linkProgram(o),e.getProgramParameter(o,e.LINK_STATUS)?o:(console.error("Program link error:",e.getProgramInfoLog(o)),null)}["mousedown","touchstart"].forEach(e=>{colorPalette.addEventListener(e,e=>{pickBaseColor(e),document.addEventListener("mousemove",pickBaseColor),document.addEventListener("touchmove",pickBaseColor)}),lightnessPalette.addEventListener(e,e=>{pickLightness(e),document.addEventListener("mousemove",pickLightness),document.addEventListener("touchmove",pickLightness)})}),["mouseup","touchend"].forEach(e=>{document.addEventListener(e,()=>{document.removeEventListener("mousemove",pickBaseColor),document.removeEventListener("mousemove",pickLightness),document.removeEventListener("touchmove",pickBaseColor),document.removeEventListener("touchmove",pickLightness)})}),document.addEventListener("touchmove",function(e){e.target.closest("#colorPalette, #lightnessPalette")&&e.preventDefault()},{passive:!1});const quadVS="\n  attribute vec2 a_position;\n  attribute vec2 a_texCoord;\n  uniform vec2 u_resolution;\n  uniform float u_flipY; // set to 1.0 for no flip; -1.0 for normal flip\n  varying vec2 v_texCoord;\n  void main() {\n    vec2 zeroToOne = a_position / u_resolution;\n    vec2 clipSpace = zeroToOne * 2.0 - 1.0;\n    gl_Position = vec4(clipSpace.x, clipSpace.y * u_flipY, 0, 1);\n    v_texCoord = a_texCoord;\n  }\n",quadFS="\n    precision mediump float;\n    varying vec2 v_texCoord;\n    uniform sampler2D u_texture;\n    uniform float u_layerOpacity; // NEW\n\n    void main() {\n      vec4 c = texture2D(u_texture, v_texCoord);\n      c.a *= u_layerOpacity;      // apply per-layer opacity here\n      gl_FragColor = c;\n    }\n",paintFS="\n  precision mediump float;\n  varying vec2 v_texCoord;\n  uniform sampler2D u_brush;\n  uniform vec4 u_tint;\n  uniform bool u_erase;\n  uniform float u_eraseStrength; // controls erasing strength\n  uniform float u_paintStrength; // controls painting strength\n  void main() {\n    vec4 brushColor = texture2D(u_brush, v_texCoord);\n    if (u_erase) {\n      gl_FragColor = vec4(0.0, 0.0, 0.0, brushColor.a * u_eraseStrength * 0.05);\n    } else {\n      // Multiply the brush alpha by u_paintStrength so that lower values yield lighter strokes.\n      gl_FragColor = vec4(u_tint.rgb, brushColor.a * u_paintStrength);\n    }\n  }\n",overlayFS="\n  precision mediump float;\n  varying vec2 v_texCoord;\n  uniform sampler2D u_brush;\n  uniform vec4 u_tint;\n  void main() {\n    vec4 brushColor = texture2D(u_brush, v_texCoord);\n    gl_FragColor = vec4(u_tint.rgb, brushColor.a);\n  }\n";let ringProgram;const ringFS="\nprecision mediump float;\nuniform vec2  u_center;     // circle center in screen px (top-left origin)\nuniform float u_radius;     // ring radius in px\nuniform float u_thickness;  // ring thickness in px\nuniform vec4  u_color;      // RGBA\nuniform vec2  u_viewport;   // canvas size (w,h)\n\nvoid main() {\n  // Convert gl_FragCoord (bottom-left origin) to top-left\n  vec2 p = vec2(gl_FragCoord.x, u_viewport.y - gl_FragCoord.y);\n  float d = abs(length(p - u_center) - u_radius);\n  // 1px anti-aliasing band\n  float aa = 1.0;\n  float alpha = smoothstep(u_thickness + aa, u_thickness - aa, d);\n  gl_FragColor = vec4(u_color.rgb, u_color.a * alpha);\n}\n";let dashProgram;const dashFS="\nprecision mediump float;\n\nuniform vec2  u_a;          // start of line in screen px (top-left origin)\nuniform vec2  u_b;          // end of line in screen px\nuniform float u_thickness;  // half-thickness in px\nuniform float u_dash;       // dash length in px\nuniform float u_gap;        // gap length in px\nuniform vec4  u_color;      // RGBA\nuniform vec2  u_viewport;   // canvas size (w,h)\n\nvoid main() {\n  // convert gl_FragCoord (bottom-left origin) to top-left origin\n  vec2 p = vec2(gl_FragCoord.x, u_viewport.y - gl_FragCoord.y);\n  vec2 a = u_a, b = u_b;\n\n  vec2 ab = b - a;\n  float len = max(1.0, length(ab));\n  vec2 ap = p - a;\n\n  // project p onto segment a-b\n  float t = clamp(dot(ap, ab) / (len * len), 0.0, 1.0);\n  float dist = length(ap - ab * t);\n\n  // dashed pattern along the segment\n  float along = t * len;\n  float seg   = max(1.0, u_dash + u_gap);\n  float m     = mod(along, seg);\n  float inDash = step(m, u_dash); // 1 inside dash, 0 inside gap\n\n  // soft edges (1px AA band)\n  float aa = 1.0;\n  float alpha = inDash * smoothstep(u_thickness + aa, u_thickness - aa, dist);\n\n  gl_FragColor = vec4(u_color.rgb, u_color.a * alpha);\n}\n";function getActiveLayer(){return layers[activeLayerIndex]}function syncActiveAliases(){const e=getActiveLayer();if(!e)return paintFBO=null,void(paintTexture=null);paintFBO=e.fbo,paintTexture=e.texture}function initGL(){gl?(quadProgram=createProgram(gl,quadVS,quadFS),paintProgram=createProgram(gl,quadVS,paintFS),overlayProgram=createProgram(gl,quadVS,overlayFS),ringProgram=createProgram(gl,quadVS,ringFS),dashProgram=createProgram(gl,quadVS,dashFS)):console.error("WebGL not supported.")}let __quadVbo=null;function __bindAndDrawTexturedQuad(e,t,a){const r=new Float32Array([0,0,0,0,t,0,1,0,0,a,0,1,0,a,0,1,t,0,1,0,t,a,1,1]);__quadVbo||(__quadVbo=gl.createBuffer()),gl.bindBuffer(gl.ARRAY_BUFFER,__quadVbo),gl.bufferData(gl.ARRAY_BUFFER,r,gl.STREAM_DRAW);const n=gl.getAttribLocation(e,"a_position"),o=gl.getAttribLocation(e,"a_texCoord");gl.enableVertexAttribArray(n),gl.vertexAttribPointer(n,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(o),gl.vertexAttribPointer(o,2,gl.FLOAT,!1,16,8),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(n),gl.disableVertexAttribArray(o),gl.bindBuffer(gl.ARRAY_BUFFER,null)}function __getSelectedIndices(){if(void 0!==selectedLayerIndices&&selectedLayerIndices&&selectedLayerIndices.size)return Array.from(selectedLayerIndices).sort((e,t)=>e-t);try{const e=document.getElementById("layersList");if(e){const t=[];if(e.querySelectorAll(".layer-item").forEach(e=>{const a=e.getAttribute("data-index"),r=e.querySelector(".layer-select input[type='checkbox']");r&&r.checked&&null!=a&&t.push(Number(a))}),t.length)return t.sort((e,t)=>e-t)}}catch{}return["number"==typeof activeLayerIndex?activeLayerIndex:0]}function __layerQuadInFboSpace(e,t,a){const r=fixedFBOWidth,n=fixedFBOHeight,o=Number.isFinite(e.ox)?e.ox:0,i=Number.isFinite(e.oy)?e.oy:0,l=Number.isFinite(e.texW)?e.texW:r,s=Number.isFinite(e.texH)?e.texH:n,c=Number.isFinite(e.px)?e.px:.5*r,d=Number.isFinite(e.py)?e.py:.5*n,g=Math.cos(e.rotation||0),u=Math.sin(e.rotation||0);function m(t,a){let r=t-c,n=a-d;r*=Number.isFinite(e.scaleX)?e.scaleX:1,n*=Number.isFinite(e.scaleY)?e.scaleY:1;const o=r*u+n*g;return{x:c+(r*g-n*u)+(Number.isFinite(e.x)?e.x:0),y:d+o+(Number.isFinite(e.y)?e.y:0)}}const f=m(o,i),h=m(o+l,i),y=m(o,i+s),p=m(o+l,i+s);return new Float32Array([f.x,f.y,0,0,h.x,h.y,1,0,y.x,y.y,0,1,y.x,y.y,0,1,h.x,h.y,1,0,p.x,p.y,1,1])}function createLayerFBO(e,t){const a=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,a),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,e,t,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);const r=gl.createFramebuffer();return gl.bindFramebuffer(gl.FRAMEBUFFER,r),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,a,0),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.bindFramebuffer(gl.FRAMEBUFFER,null),{texture:a,fbo:r}}let layers=[],activeLayerIndex=0;function addLayer(e=`Layer ${layers.length+1}`,t=activeLayerIndex){const a=fixedFBOWidth,r=fixedFBOHeight,{texture:n,fbo:o}=createLayerFBO(a,r),i={id:Date.now()+Math.random(),name:e,fbo:o,texture:n,visible:!0,opacity:1,x:0,y:0,scaleX:1,scaleY:1,rotation:0,px:.5*a,py:.5*r,texW:a,texH:r,ox:0,oy:0,history:[],redo:[]},l=Math.max(0,Math.min(t,layers.length));layers.splice(l,0,i),activeLayerIndex=l,syncActiveAliases(),"function"==typeof rebuildLayersUI&&rebuildLayersUI(),needsRedraw=!0}function drawRingOverlay(e,t,a,r,n=[1,0,0,.95]){if(!ringProgram)return;gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.useProgram(ringProgram);const o=gl.getUniformLocation(ringProgram,"u_flipY");o&&gl.uniform1f(o,-1);const i=gl.getUniformLocation(ringProgram,"u_resolution");i&&gl.uniform2f(i,canvas.width,canvas.height),gl.uniform2f(gl.getUniformLocation(ringProgram,"u_center"),e,t),gl.uniform1f(gl.getUniformLocation(ringProgram,"u_radius"),Math.max(0,a)),gl.uniform1f(gl.getUniformLocation(ringProgram,"u_thickness"),Math.max(.5,r)),gl.uniform4fv(gl.getUniformLocation(ringProgram,"u_color"),n),gl.uniform2f(gl.getUniformLocation(ringProgram,"u_viewport"),canvas.width,canvas.height);const l=new Float32Array([0,0,0,0,canvas.width,0,1,0,0,canvas.height,0,1,0,canvas.height,0,1,canvas.width,0,1,0,canvas.width,canvas.height,1,1]),s=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,s),gl.bufferData(gl.ARRAY_BUFFER,l,gl.STREAM_DRAW);const c=gl.getAttribLocation(ringProgram,"a_position"),d=gl.getAttribLocation(ringProgram,"a_texCoord");gl.enableVertexAttribArray(c),gl.vertexAttribPointer(c,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(d),gl.vertexAttribPointer(d,2,gl.FLOAT,!1,16,8),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(c),gl.disableVertexAttribArray(d),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(s)}function drawDashedLine(e,t,a,r,n=1.5,o=10,i=6,l=[1,0,0,.95]){if(!dashProgram)return;gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.useProgram(dashProgram);const s=gl.getUniformLocation(dashProgram,"u_flipY");s&&gl.uniform1f(s,-1);const c=gl.getUniformLocation(dashProgram,"u_resolution");c&&gl.uniform2f(c,canvas.width,canvas.height),gl.uniform2f(gl.getUniformLocation(dashProgram,"u_a"),e,t),gl.uniform2f(gl.getUniformLocation(dashProgram,"u_b"),a,r),gl.uniform1f(gl.getUniformLocation(dashProgram,"u_thickness"),Math.max(.5,n)),gl.uniform1f(gl.getUniformLocation(dashProgram,"u_dash"),Math.max(1,o)),gl.uniform1f(gl.getUniformLocation(dashProgram,"u_gap"),Math.max(.5,i)),gl.uniform4fv(gl.getUniformLocation(dashProgram,"u_color"),l),gl.uniform2f(gl.getUniformLocation(dashProgram,"u_viewport"),canvas.width,canvas.height);const d=new Float32Array([0,0,0,0,canvas.width,0,1,0,0,canvas.height,0,1,0,canvas.height,0,1,canvas.width,0,1,0,canvas.width,canvas.height,1,1]),g=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,g),gl.bufferData(gl.ARRAY_BUFFER,d,gl.STREAM_DRAW);const u=gl.getAttribLocation(dashProgram,"a_position"),m=gl.getAttribLocation(dashProgram,"a_texCoord");gl.enableVertexAttribArray(u),gl.vertexAttribPointer(u,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(m),gl.vertexAttribPointer(m,2,gl.FLOAT,!1,16,8),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(u),gl.disableVertexAttribArray(m),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(g)}function drawLayerWithTransform(e,t){const a=fixedFBOWidth,r=fixedFBOHeight,n=canvas.width/a,o=canvas.height/r,i=Number.isFinite(t.ox)?t.ox:0,l=Number.isFinite(t.oy)?t.oy:0,s=Number.isFinite(t.texW)?t.texW:a,c=Number.isFinite(t.texH)?t.texH:r,d=Number.isFinite(t.px)?t.px:.5*a,g=Number.isFinite(t.py)?t.py:.5*r,u=[{x:i,y:l},{x:i+s,y:l},{x:i,y:l+c},{x:i+s,y:l+c}],m=Math.cos(t.rotation||0),f=Math.sin(t.rotation||0);function h(e){let a=e.x-d,r=e.y-g;a*=Number.isFinite(t.scaleX)?t.scaleX:1,r*=Number.isFinite(t.scaleY)?t.scaleY:1;const i=a*f+r*m,l=d+(a*m-r*f)+(Number.isFinite(t.x)?t.x:0),s=g+i+(Number.isFinite(t.y)?t.y:0);return{x:l*n,y:s*o}}const y=h(u[0]),p=h(u[1]),E=h(u[2]),x=h(u[3]),v=new Float32Array([y.x,y.y,0,0,p.x,p.y,1,0,E.x,E.y,0,1,E.x,E.y,0,1,p.x,p.y,1,0,x.x,x.y,1,1]);gl.useProgram(e);const b=gl.getUniformLocation(e,"u_flipY");b&&gl.uniform1f(b,-1);const T=gl.getUniformLocation(e,"u_resolution");T&&gl.uniform2f(T,canvas.width,canvas.height);const w=gl.getUniformLocation(e,"u_layerOpacity");w&&gl.uniform1f(w,Math.max(0,Math.min(1,t.opacity||1)));const L=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,L),gl.bufferData(gl.ARRAY_BUFFER,v,gl.STREAM_DRAW);const A=gl.getAttribLocation(e,"a_position"),F=gl.getAttribLocation(e,"a_texCoord");gl.enableVertexAttribArray(A),gl.vertexAttribPointer(A,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(F),gl.vertexAttribPointer(F,2,gl.FLOAT,!1,16,8),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,t.texture);const R=gl.getUniformLocation(e,"u_texture");R&&gl.uniform1i(R,0),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(A),gl.disableVertexAttribArray(F),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(L)}let transformTool={mode:"idle",start:null,ref:null,shiftInvert:!1};function setLayerTransformLock(e,t){const a=layers[e];if(!a)return;a.transformLocked=!!t;const r=document.getElementById("layersList");if(r){r.querySelectorAll(".layer-item").forEach(a=>{const r=a.getAttribute("data-index");if((null!==r?Number(r):null)===e){const e=a.querySelector(".transform-btn");e&&e.classList.toggle("is-active",t)}})}if(t&&e===activeLayerIndex)transformTool.mobileCombo=!0,"idle"===transformTool.mode&&startTransform("grab");else if(!t){layers.some(e=>!!e.transformLocked)||(transformTool.mobileCombo=!1,"idle"!==transformTool.mode&&endTransform(!0))}needsRedraw=!0}function clearTransformLockAll(){layers.forEach(e=>{e&&(e.transformLocked=!1)}),transformTool.mobileCombo=!1;const e=document.getElementById("layersList");e&&e.querySelectorAll(".transform-btn.is-active").forEach(e=>e.classList.remove("is-active")),"idle"!==transformTool.mode&&endTransform(!0),needsRedraw=!0}function worldToLayer(e,t,a){const r=t-e.x,n=a-e.y,o=Math.cos(e.rotation),i=Math.sin(e.rotation);return{lx:(o*r+i*n)/(e.scaleX||1),ly:(-i*r+o*n)/(e.scaleY||1)}}function layerLocalToWorld(e,t,a){const r=t*(e.scaleX||1),n=a*(e.scaleY||1),o=Math.cos(e.rotation),i=Math.sin(e.rotation),l=o*r-i*n,s=i*r+o*n;return{fx:e.x+l,fy:e.y+s}}function startTransform(e,t=!1){const a=getActiveLayer();if(!a)return;a.x=Number.isFinite(a.x)?a.x:0,a.y=Number.isFinite(a.y)?a.y:0,a.scaleX=Number.isFinite(a.scaleX)?a.scaleX:1,a.scaleY=Number.isFinite(a.scaleY)?a.scaleY:1,a.rotation=Number.isFinite(a.rotation)?a.rotation:0,a.px=Number.isFinite(a.px)?a.px:.5*fixedFBOWidth,a.py=Number.isFinite(a.py)?a.py:.5*fixedFBOHeight;const r=lastPointer&&Number.isFinite(lastPointer.cx)?lastPointer.cx:.5*canvas.width,n=lastPointer&&Number.isFinite(lastPointer.cy)?lastPointer.cy:.5*canvas.height,o=canvasPxToFBO(r,n);let i=a.px,l=a.py;if("scale"===e||"rotate"===e){const e=0|fixedFBOWidth,t=0|fixedFBOHeight;i=Math.max(0,Math.min(e,o.fx)),l=Math.max(0,Math.min(t,o.fy));const r=Math.cos(a.rotation),n=Math.sin(a.rotation),s=(a.px-i)*a.scaleX,c=(a.py-l)*a.scaleY,d=s*r-c*n,g=s*n+c*r;a.x+=d,a.y+=g,a.px=i,a.py=l}transformTool.pivotWorld={fx:i,fy:l},transformTool.pivotCanvas={cx:r,cy:n},transformTool.mode=e,transformTool.shiftInvert=!!t,transformTool.ref={x:a.x,y:a.y,scaleX:a.scaleX,scaleY:a.scaleY,rotation:a.rotation,px:a.px,py:a.py},transformTool.start=null,isDrawing&&(isDrawing=!1,stopRender("draw")),startRender("transform"),needsRedraw=!0,requestDrawIfIdle()}function onTransformPointerMove(e){const t=getActiveLayer();if(!t||!transformTool||"idle"===transformTool.mode)return;const a=transformTool.ref;if(!a)return;const r=(e,t)=>canvasPxToFBO(e,t),n=e.clientX,o=e.clientY;transformTool.start||(transformTool.start={cx:n,cy:o});const i=transformTool.pivotWorld||{fx:a.px,fy:a.py},l=transformTool.mode;function s(e,t){const r=e-a.x,n=t-a.y,o=Math.cos(a.rotation),i=Math.sin(a.rotation),l=-r*i+n*o;return{lx:(r*o+n*i)/(a.scaleX||1),ly:l/(a.scaleY||1)}}function c(e,a){const r=e*(t.scaleX||1),n=a*(t.scaleY||1),o=Math.cos(t.rotation),i=Math.sin(t.rotation);return{fx:t.x+(r*o-n*i),fy:t.y+(r*i+n*o)}}if("grab"===l){const e=transformTool.start,i=r(e.cx,e.cy),l=r(n,o);t.x=a.x+(l.fx-i.fx),t.y=a.y+(l.fy-i.fy)}else if("scale"===l){const e=transformTool.start,l=r(e.cx,e.cy),d=r(n,o),g=l.fx-i.fx,u=l.fy-i.fy,m=d.fx-i.fx,f=d.fy-i.fy,h=Math.hypot(g,u)||1;let y=(Math.hypot(m,f)||1)/h;transformTool.shiftInvert&&(y=1/y);const p=.05,E=64,x=Math.max(p,Math.min(E,a.scaleX*y)),v=Math.max(p,Math.min(E,a.scaleY*y)),b=s(i.fx,i.fy);t.scaleX=x,t.scaleY=v,t.rotation=a.rotation;const T=c(b.lx,b.ly);t.x+=i.fx-T.fx,t.y+=i.fy-T.fy}else if("rotate"===l){const e=transformTool.start,l=r(e.cx,e.cy),d=r(n,o),g=Math.atan2(l.fy-i.fy,l.fx-i.fx);let u=Math.atan2(d.fy-i.fy,d.fx-i.fx)-g;u>Math.PI&&(u-=2*Math.PI),u<-Math.PI&&(u+=2*Math.PI),transformTool.shiftInvert&&(u=-u);const m=s(i.fx,i.fy);t.rotation=a.rotation+u,t.scaleX=a.scaleX,t.scaleY=a.scaleY;const f=c(m.lx,m.ly);t.x+=i.fx-f.fx,t.y+=i.fy-f.fy}needsRedraw=!0,requestDrawIfIdle?.()}function startTransform(e,t=!1){const a=getActiveLayer();if(!a)return;a.x=Number.isFinite(a.x)?a.x:0,a.y=Number.isFinite(a.y)?a.y:0,a.scaleX=Number.isFinite(a.scaleX)?a.scaleX:1,a.scaleY=Number.isFinite(a.scaleY)?a.scaleY:1,a.rotation=Number.isFinite(a.rotation)?a.rotation:0,a.px=Number.isFinite(a.px)?a.px:.5*fixedFBOWidth,a.py=Number.isFinite(a.py)?a.py:.5*fixedFBOHeight;const r=lastPointer&&Number.isFinite(lastPointer.cx)?lastPointer.cx:.5*canvas.width,n=lastPointer&&Number.isFinite(lastPointer.cy)?lastPointer.cy:.5*canvas.height,o=canvasPxToFBO(r,n);let i=a.px,l=a.py;if("scale"===e||"rotate"===e){const e=0|fixedFBOWidth,t=0|fixedFBOHeight;i=Math.max(0,Math.min(e,o.fx)),l=Math.max(0,Math.min(t,o.fy));const r=Math.cos(a.rotation),n=Math.sin(a.rotation),s=(a.px-i)*a.scaleX,c=(a.py-l)*a.scaleY,d=s*r-c*n,g=s*n+c*r;a.x+=d,a.y+=g,a.px=i,a.py=l}transformTool.pivotWorld={fx:i,fy:l},transformTool.pivotCanvas={cx:r,cy:n},transformTool.mode=e,transformTool.shiftInvert=!!t,transformTool.ref={x:a.x,y:a.y,scaleX:a.scaleX,scaleY:a.scaleY,rotation:a.rotation,px:a.px,py:a.py},transformTool.start=null,isDrawing&&(isDrawing=!1,stopRender("draw")),startRender("transform"),showStatusMessage("grab"===e?"Grab (move) layer":"scale"===e?t?"Scale (down)":"Scale (up)":"rotate"===e?"Rotate layer":""),needsRedraw=!0,requestDrawIfIdle()}function initPaintLayerFixed(){layers.forEach(e=>{gl.deleteTexture(e.texture),gl.deleteFramebuffer(e.fbo)}),layers=[],activeLayerIndex=0,addLayer("Layer 1",-1),syncActiveAliases()}function mergeSelectedLayers(){try{if(!gl||!quadProgram||!Array.isArray(layers)||0===layers.length)return void console.warn("[mergeSelectedLayers] GL or layers not ready");let t=[];if("function"==typeof selectedLayerIndices?.forEach&&selectedLayerIndices.forEach(e=>{Number.isFinite(e)&&t.push(0|e)}),t=t.filter(e=>e>=0&&e<layers.length),t.length<2)return showStatusMessage?.("Select at least two layers to merge","warning"),void console.warn("[mergeSelectedLayers] not enough selected layers",t);t.sort((e,t)=>e-t);const a=0|fixedFBOWidth,r=0|fixedFBOHeight,n=gl.getParameter(gl.FRAMEBUFFER_BINDING),o=gl.getParameter(gl.CURRENT_PROGRAM),i=gl.getParameter(gl.VIEWPORT),l=gl.isEnabled(gl.BLEND),s=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,s),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,a,r,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);const c=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,c),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,s,0),gl.viewport(0,0,a,r),gl.disable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.blendFuncSeparate(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA,gl.ONE,gl.ONE_MINUS_SRC_ALPHA),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);const d=gl.getUniformLocation(quadProgram,"u_texture"),g=gl.getUniformLocation(quadProgram,"u_resolution"),u=gl.getUniformLocation(quadProgram,"u_flipY"),m=gl.getUniformLocation(quadProgram,"u_layerOpacity");g&&gl.uniform2f(g,a,r),u&&gl.uniform1f(u,1);const f=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,f);const h=gl.getAttribLocation(quadProgram,"a_position"),y=gl.getAttribLocation(quadProgram,"a_texCoord");gl.enableVertexAttribArray(h),gl.enableVertexAttribArray(y);let p=0;for(const w of t){const L=layers[w];if(!L||!1===L.visible||!L.texture)continue;const A=Number.isFinite(L.ox)?L.ox:0,F=Number.isFinite(L.oy)?L.oy:0,R=Math.max(1,Number.isFinite(L.texW)?L.texW:a),_=Math.max(1,Number.isFinite(L.texH)?L.texH:r),I=Number.isFinite(L.scaleX)?L.scaleX:1,B=Number.isFinite(L.scaleY)?L.scaleY:1,P=Number.isFinite(L.rotation)?L.rotation:0,S=Number.isFinite(L.x)?L.x:0,M=Number.isFinite(L.y)?L.y:0,U=Number.isFinite(L.px)?L.px:.5*a,D=Number.isFinite(L.py)?L.py:.5*r,C=Math.cos(P),N=Math.sin(P);function e(e,t){let a=(e-U)*I,r=(t-D)*B;return{x:U+(a*C-r*N)+S,y:D+(a*N+r*C)+M}}const O=e(A,F),k=e(A+R,F),X=e(A,F+_),W=e(A+R,F+_),H=new Float32Array([O.x,O.y,0,0,k.x,k.y,1,0,X.x,X.y,0,1,X.x,X.y,0,1,k.x,k.y,1,0,W.x,W.y,1,1]);gl.bufferData(gl.ARRAY_BUFFER,H,gl.STREAM_DRAW),gl.vertexAttribPointer(h,2,gl.FLOAT,!1,16,0),gl.vertexAttribPointer(y,2,gl.FLOAT,!1,16,8),m&&gl.uniform1f(m,Math.max(0,Math.min(1,L.opacity??1))),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,L.texture),d&&gl.uniform1i(d,0),gl.drawArrays(gl.TRIANGLES,0,6),p++}const E=new Uint8Array(a*r*4);gl.readPixels(0,0,a,r,gl.RGBA,gl.UNSIGNED_BYTE,E),gl.disableVertexAttribArray(h),gl.disableVertexAttribArray(y),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(f),l||gl.disable(gl.BLEND),gl.bindFramebuffer(gl.FRAMEBUFFER,n),gl.useProgram(o),i&&gl.viewport(i[0],i[1],i[2],i[3]);const x=t.map(e=>({index:e,data:{name:layers[e].name,visible:!1!==layers[e].visible,opacity:"number"==typeof layers[e].opacity?layers[e].opacity:1,snapshot:snapshotLayer(e)}}));for(let Y=t.length-1;Y>=0;Y--){const G=t[Y],q=layers[G];if(q){try{q.texture&&gl.deleteTexture(q.texture)}catch{}try{q.fbo&&gl.deleteFramebuffer(q.fbo)}catch{}layers.splice(G,1)}}const v=Math.min(t[t.length-1]-(t.length-1),layers.length),b={name:`Merged (${t.length})`,visible:!0,opacity:1,snapshot:{index:v,w:a,h:r,pixels:E}};History._insertLayer(v,b),activeLayerIndex=v,"function"==typeof selectedLayerIndices?.clear&&(selectedLayerIndices.clear(),selectedLayerIndices.add(v)),syncActiveAliases?.(),rebuildLayersUI?.(),needsRedraw=!0,requestDrawIfIdle?.();const T={index:v,data:{name:b.name,visible:!0,opacity:1,snapshot:snapshotLayer(v)}};History.push({type:"merge_layers",removed:x,added:T}),showStatusMessage?.(`Merged ${p}/${t.length} selected layer(s) → index ${v}`,"success"),console.log("[mergeSelectedLayers] done",{selected:t,drawnCount:p,insertIndex:v,doc:{Wdoc:a,Hdoc:r}})}catch(z){console.error("[mergeSelectedLayers] failed",z),showStatusMessage?.("Merge failed – see console for details","error"),needsRedraw=!0,requestDrawIfIdle?.()}}let TRANSFORM_DEBUG=!0;function docToCanvasScale(){return{sx:canvas.width/fixedFBOWidth,sy:canvas.height/fixedFBOHeight}}function docToCanvasPt(e){const{sx:t,sy:a}=docToCanvasScale();return{x:e.x*t,y:e.y*a}}function layerLocalToDoc(e,t,a){const r=Number.isFinite(e.scaleX)?e.scaleX:1,n=Number.isFinite(e.scaleY)?e.scaleY:1,o=Number.isFinite(e.rotation)?e.rotation:0,i=Math.cos(o),l=Math.sin(o),s=t*r,c=a*n;return{x:e.x+(s*i-c*l),y:e.y+(s*l+c*i)}}function docToLayerLocal(e,t,a){const r=t-e.x,n=a-e.y,o=Number.isFinite(e.rotation)?e.rotation:0,i=Math.cos(o),l=Math.sin(o),s=-r*l+n*i;return{px:(r*i+n*l)/(Number.isFinite(e.scaleX)?e.scaleX:1),py:s/(Number.isFinite(e.scaleY)?e.scaleY:1)}}function drawCrosshair(e,t,a,r,n){drawDashedLine(e-a,t,e+a,t,r,1e6,0,n),drawDashedLine(e,t-a,e,t+a,r,1e6,0,n)}function drawAxisFromPivot(e,t,a){const r=Number.isFinite(e.scaleX)?e.scaleX:1,n=Number.isFinite(e.scaleY)?e.scaleY:1,o=Number.isFinite(e.rotation)?e.rotation:0,i=Math.cos(o),l=Math.sin(o),s=i*r,c=l*r,d=-l*n,g=i*n,{sx:u,sy:m}=docToCanvasScale(),f=e=>docToCanvasPt({x:e.x,y:e.y}),h={x:t.x+s*(a/Math.max(u,1e-6)),y:t.y+c*(a/Math.max(m,1e-6))},y={x:t.x+d*(a/Math.max(u,1e-6)),y:t.y+g*(a/Math.max(m,1e-6))},p=f(t),E=f(h),x=f(y);drawDashedLine(p.x,p.y,E.x,E.y,2,10,0,[1,0,1,.9]),drawDashedLine(p.x,p.y,x.x,x.y,2,10,0,[0,.4,1,.9])}function drawTransformDebugForActiveLayer(){if(!window.TRANSFORM_DEBUG)return;const e=getActiveLayer&&getActiveLayer();if(!e||!e.visible)return;if(!overlayProgram||"function"!=typeof drawRingOverlay||"function"!=typeof drawDashedLine)return;gl.useProgram(overlayProgram);const t=gl.getUniformLocation(overlayProgram,"u_flipY");t&&gl.uniform1f(t,-1);const a=gl.getUniformLocation(overlayProgram,"u_resolution");a&&gl.uniform2f(a,canvas.width,canvas.height);const r=({x:e,y:t})=>({x:e*(canvas.width/fixedFBOWidth),y:t*(canvas.height/fixedFBOHeight)}),n=(t,a)=>{const r=Number.isFinite(e.scaleX)?e.scaleX:1,n=Number.isFinite(e.scaleY)?e.scaleY:1,o=Number.isFinite(e.rotation)?e.rotation:0,i=Math.cos(o),l=Math.sin(o),s=t*r,c=a*n;return{x:e.x+(s*i-c*l),y:e.y+(s*l+c*i)}},o=transformTool&&transformTool.pivotDoc?{x:transformTool.pivotDoc.fx,y:transformTool.pivotDoc.fy}:{x:e.x,y:e.y};let i=transformTool&&transformTool.localPivot?{px:transformTool.localPivot.px,py:transformTool.localPivot.py}:function(){const t=o.x-e.x,a=o.y-e.y,r=Math.cos(e.rotation),n=Math.sin(e.rotation),i=-t*n+a*r;return{px:(t*r+a*n)/(e.scaleX||1),py:i/(e.scaleY||1)}}();const l=n(i.px,i.py),s={x:e.x,y:e.y},c={x:(Number.isFinite(e.ox)?e.ox:0)+.5*(Number.isFinite(e.texW)?e.texW:fixedFBOWidth),y:(Number.isFinite(e.oy)?e.oy:0)+.5*(Number.isFinite(e.texH)?e.texH:fixedFBOHeight)},d=n(c.x,c.y),g=r(o),u=r(l),m=r(d),f=r(s);drawRingOverlay(g.x,g.y,12,2,[1,0,0,.95]),drawRingOverlay(u.x,u.y,8,2,[1,.5,0,.95]),drawDashedLine(g.x,g.y,u.x,u.y,2,8,6,[1,1,0,.9]),drawDashedLine(g.x,g.y,m.x,m.y,2,8,6,[1,0,0,.8]),drawDashedLine(f.x,f.y,m.x,m.y,1.5,6,4,[0,1,1,.75]),function(t=80){const a=Number.isFinite(e.scaleX)?e.scaleX:1,n=Number.isFinite(e.scaleY)?e.scaleY:1,i=Number.isFinite(e.rotation)?e.rotation:0,l=Math.cos(i),s=Math.sin(i),c=l*a,d=s*a,u=-s*n,m=l*n,f=canvas.width/fixedFBOWidth,h=canvas.height/fixedFBOHeight,y=r({x:o.x+c*(t/Math.max(f,1e-6)),y:o.y+d*(t/Math.max(h,1e-6))}),p=r({x:o.x+u*(t/Math.max(f,1e-6)),y:o.y+m*(t/Math.max(h,1e-6))});drawDashedLine(g.x,g.y,y.x,y.y,2,10,0,[1,0,1,.9]),drawDashedLine(g.x,g.y,p.x,p.y,2,10,0,[0,.4,1,.9])}(),console.log("[pivot-debug]",{pose:{x:e.x,y:e.y,sx:e.scaleX,sy:e.scaleY,rot:e.rotation},pivotDoc:o,localPivot:i,localPivotWorld:l,originWorld:s,centerWorld:d})}function mergeAllLayers(){!gl||!layers||layers.length<2||(selectedLayerIndices=new Set(layers.map((e,t)=>t)),mergeSelectedLayers())}const BackgroundPicker=(()=>{let e=["/static/draw/images/backgrounds/WEBP_1920/46.webp","/static/draw/images/backgrounds/WEBP_1920/45.webp","/static/draw/images/backgrounds/WEBP_1920/44.webp","/static/draw/images/backgrounds/WEBP_1920/43.webp","/static/draw/images/backgrounds/WEBP_1920/42.webp","/static/draw/images/backgrounds/WEBP_1920/41.webp","/static/draw/images/backgrounds/WEBP_1920/40.webp"],t={},a=null,r="curated";function n(e){return document.getElementById(e)}function o(e,t){const a=document.createElement(e);return t&&(a.className=t),a}function i(e,t){const a=document.createElement("canvas");return a.width=e,a.height=t,a}function l(e){return new Promise((t,a)=>{const r=new Image;r.crossOrigin="anonymous",r.onload=()=>t(r),r.onerror=a,r.src=e})}function s(e,t,a){const r=i(t,a),n=r.getContext("2d"),o=(e.naturalWidth||e.width)/(e.naturalHeight||e.height);let l,s,c,d;return o>t/a?(s=a,l=Math.ceil(a*o),c=Math.floor((t-l)/2),d=0):(l=t,s=Math.ceil(t/o),c=0,d=Math.floor((a-s)/2)),n.drawImage(e,c,d,l,s),r}function c(e){t.curatedGrid.querySelectorAll(".bgp-thumb.selected").forEach(e=>e.classList.remove("selected")),e&&e.classList.add("selected")}function d(e){r=e,document.querySelectorAll(".bgp-tab").forEach(t=>t.classList.toggle("active",t.dataset.tab===e)),n("bgPickerModal").querySelectorAll(".bgp-pane").forEach(t=>{const a=t.classList.contains("bgp-pane-curated")?"curated":t.classList.contains("bgp-pane-upload")?"upload":"solid";t.classList.toggle("active",a===e)})}function g(){t.colorHex.value=t.color.value.toUpperCase();const e=fixedFBOWidth||canvas.width,r=fixedFBOHeight||canvas.height,o=function(e,t,a){const r=i(t,a),n=r.getContext("2d");return n.fillStyle=e,n.fillRect(0,0,t,a),r}(t.color.value,e,r),l=n("bgpSolidPreview").getContext("2d");l.clearRect(0,0,n("bgpSolidPreview").width,n("bgpSolidPreview").height),l.drawImage(s(o,n("bgpSolidPreview").width,n("bgpSolidPreview").height),0,0),a=o}function u(){a=null,c(null),t.fileName.textContent="No file chosen",t.file.value="",d("curated"),g(),n("bgPickerModal").style.display="flex"}function m(){n("bgPickerModal").style.display="none"}function f(){if(!a)return void m();const e=new Image;e.onload=()=>{currentImage=e,fixedFBOWidth=e.width,fixedFBOHeight=e.height,initPaintLayerFixed(),updateCanvasSize(e),initFloodFBOs(),createTextureFromImage(e),canvas.offsetWidth,canvasWrapper.offsetWidth,zoomScale=1,panX=(canvasWrapper.clientWidth-canvas.width)/2,panY=(canvasWrapper.clientHeight-canvas.height)/2,updateCanvasTransform(),needsRedraw=!0,initFloodFillProgram(),addSoundEvents(),m()},e.src=a.toDataURL("image/png")}function h(e){const r=e.target.files&&e.target.files[0];if(!r)return;t.fileName.textContent=r.name;const o=new FileReader;o.onload=async()=>{const e=o.result,t=await l(e),r=fixedFBOWidth||canvas.width,i=fixedFBOHeight||canvas.height;a=s(t,r,i);const c=n("bgpUploadPreview"),d=c.getContext("2d");d.clearRect(0,0,c.width,c.height),d.drawImage(s(t,c.width,c.height),0,0)},o.readAsDataURL(r)}function y(){t.gridBtn=n("bgpCuratedGrid"),t.modal=n("bgPickerModal"),t.curatedGrid=n("bgpCuratedGrid"),t.file=n("bgpFile"),t.fileName=n("bgpFileName"),t.color=n("bgpColor"),t.colorHex=n("bgpColorHex"),t.apply=n("bgpApply"),t.cancel=n("bgpCancel"),t.closeX=n("bgpClose"),document.querySelectorAll(".bgp-tab").forEach(e=>{e.addEventListener("click",()=>d(e.dataset.tab))}),t.file.addEventListener("change",h),t.color.addEventListener("input",g),t.colorHex.addEventListener("input",()=>{let e=t.colorHex.value.trim();/^#([0-9a-f]{3}|[0-9a-f]{6}|[0-9a-f]{8})$/i.test(e)&&(t.color.value=e,g())}),t.apply.addEventListener("click",f),t.cancel.addEventListener("click",m),t.closeX.addEventListener("click",m),document.getElementById("bgPickerBtn")?.addEventListener("click",u),t.curatedGrid.innerHTML="",e.forEach(e=>{const r=o("button","bgp-thumb");r.type="button";const n=o("img");n.loading="lazy",n.src=e,n.alt="background",r.appendChild(n),r.addEventListener("click",async()=>{const t=fixedFBOWidth||canvas.width,n=fixedFBOHeight||canvas.height,o=await l(e);a=s(o,t,n),c(r)}),t.curatedGrid.appendChild(r)}),g()}return{install:function(t){t?.curated&&Array.isArray(t.curated)&&(e=t.curated),y()},open:u}})();function duplicateLayer(e=activeLayerIndex){if(!(Array.isArray(layers)&&layers.length&&gl&&quadProgram))return;e=Math.max(0,Math.min(0|e,layers.length-1));const t=layers[e];if(!t||!gl.isFramebuffer(t.fbo)||!gl.isTexture(t.texture))return void console.warn("[duplicateLayer] invalid source layer");const a=Number.isFinite(t.texW)?t.texW:0|fixedFBOWidth,r=Number.isFinite(t.texH)?t.texH:0|fixedFBOHeight,{texture:n,fbo:o}=createLayerFBO(a,r);gl.bindFramebuffer(gl.FRAMEBUFFER,o),gl.viewport(0,0,a,r),gl.disable(gl.BLEND),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);const i=gl.getUniformLocation(quadProgram,"u_flipY"),l=gl.getUniformLocation(quadProgram,"u_resolution"),s=gl.getUniformLocation(quadProgram,"u_layerOpacity"),c=gl.getUniformLocation(quadProgram,"u_texture");i&&gl.uniform1f(i,1),l&&gl.uniform2f(l,a,r),s&&gl.uniform1f(s,1);const d=new Float32Array([0,0,0,0,a,0,1,0,0,r,0,1,0,r,0,1,a,0,1,0,a,r,1,1]),g=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,g),gl.bufferData(gl.ARRAY_BUFFER,d,gl.STREAM_DRAW);const u=gl.getAttribLocation(quadProgram,"a_position"),m=gl.getAttribLocation(quadProgram,"a_texCoord");gl.enableVertexAttribArray(u),gl.vertexAttribPointer(u,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(m),gl.vertexAttribPointer(m,2,gl.FLOAT,!1,16,8),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,t.texture),c&&gl.uniform1i(c,0),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(u),gl.disableVertexAttribArray(m),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(g),gl.bindFramebuffer(gl.FRAMEBUFFER,null);const f={id:Date.now()+Math.random(),name:("string"==typeof t.name?t.name:"Layer")+" copy",fbo:o,texture:n,visible:"boolean"!=typeof t.visible||t.visible,opacity:"number"==typeof t.opacity?t.opacity:1,ox:Number.isFinite(t.ox)?t.ox:0,oy:Number.isFinite(t.oy)?t.oy:0,texW:Number.isFinite(t.texW)?t.texW:a,texH:Number.isFinite(t.texH)?t.texH:r,x:Number.isFinite(t.x)?t.x:0,y:Number.isFinite(t.y)?t.y:0,scaleX:Number.isFinite(t.scaleX)?t.scaleX:1,scaleY:Number.isFinite(t.scaleY)?t.scaleY:1,rotation:Number.isFinite(t.rotation)?t.rotation:0,px:Number.isFinite(t.px)?t.px:.5*fixedFBOWidth,py:Number.isFinite(t.py)?t.py:.5*fixedFBOHeight},h=Math.min(e+1,layers.length);layers.splice(h,0,f),activeLayerIndex=h,selectedLayerIndices?.clear?.(),selectedLayerIndices?.add?.(activeLayerIndex),syncActiveAliases?.(),rebuildLayersUI?.();try{const e=snapshotLayer(h);History.push({type:"add_layer",index:h,addedLayer:{name:f.name,visible:f.visible,opacity:f.opacity,snapshot:e}})}catch(e){console.warn("[duplicateLayer] history snapshot failed:",e)}needsRedraw=!0,requestDrawIfIdle?.(),showStatusMessage?.("Layer duplicated","success"),console.log("[duplicateLayer] cloned at index",h,"from",e,{px:f.px,py:f.py,x:f.x,y:f.y,scaleX:f.scaleX,scaleY:f.scaleY,rot:f.rotation,ox:f.ox,oy:f.oy,texW:f.texW,texH:f.texH})}function createTextureFromImage(e,t=!1){if(!e)return void console.error("Image is null or undefined.");const a=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,a),t?(gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0),gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0)):gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!1),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,e),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),t?(overlayTexture=a,brushAspect=e.width/e.height):texture=a,needsRedraw=!0}function centerAndFitToWrapper(){const e=canvasWrapper.getBoundingClientRect(),t=canvas.width,a=canvas.height,r=Math.min(e.width/t,e.height/a);zoomScale=Math.min(zoomMax,Math.max(zoomMin,r)),panX=Math.round((e.width-t*zoomScale)/2),panY=Math.round((e.height-a*zoomScale)/2),updateCanvasTransform(),resetStrokeState(),needsRedraw=!0}function centerNextFrame(){requestAnimationFrame(()=>{centerAndFitToWrapper()})}function loadDefaultImage(){const e=document.createElement("canvas");e.width=window.innerWidth,e.height=window.innerHeight;const t=e.getContext("2d");t.fillStyle="#f2efe4",t.fillRect(0,0,e.width,e.height);const a=document.createElement("canvas");a.width=e.width,a.height=e.height;const r=a.getContext("2d"),n=r.createImageData(a.width,a.height);for(let e=0;e<n.data.length;e+=4){const t=50*Math.random()-25;n.data[e]=240+t,n.data[e+1]=235+t,n.data[e+2]=225+t,n.data[e+3]=255}r.putImageData(n,0,0),t.globalAlpha=.2,t.drawImage(a,0,0),t.globalAlpha=1;const o=document.createElement("canvas");o.width=e.width,o.height=e.height;const i=o.getContext("2d"),l=i.createImageData(o.width,o.height);for(let e=0;e<l.data.length;e+=4){const t=255*Math.random();l.data[e]=t,l.data[e+1]=t,l.data[e+2]=t,l.data[e+3]=90*Math.random()}i.putImageData(l,0,0),t.globalAlpha=.08,t.drawImage(o,0,0),t.globalAlpha=1;const s=t.createRadialGradient(e.width/2,e.height/2,.3*Math.min(e.width,e.height),e.width/2,e.height/2,.6*Math.max(e.width,e.height));s.addColorStop(0,"rgba(0,0,0,0)"),s.addColorStop(1,"rgba(0,0,0,0.35)"),t.globalAlpha=.3,t.fillStyle=s,t.fillRect(0,0,e.width,e.height),t.globalAlpha=1;const c=new Image;c.crossOrigin="anonymous",c.onload=()=>{currentImage=c,fixedFBOWidth=c.width,fixedFBOHeight=c.height,initPaintLayerFixed(),updateCanvasSize(c),initFloodFBOs(),createTextureFromImage(c),canvas.offsetWidth,canvasWrapper.offsetWidth,zoomScale=1,panX=(canvasWrapper.clientWidth-canvas.width)/2,panY=(canvasWrapper.clientHeight-canvas.height)/2,updateCanvasTransform(),resetStrokeState(),needsRedraw=!0,initFloodFillProgram(),addSoundEvents()},c.onerror=()=>console.error("Failed to load default image."),c.src=e.toDataURL("image/png")}function createBrushThumbnails(){const e=document.getElementById("brushContainer");e.innerHTML="",brushes.forEach(t=>{const a=document.createElement("img");a.src=t.file,a.classList.add("brush-thumbnail"),t.selected&&(a.style.border="2px solid red"),a.addEventListener("click",()=>selectBrush(t.name)),e.appendChild(a)});const t=document.getElementById("brushContainerToggle");e.appendChild(t)}function updateBrushThumbnailStyles(e){const t=document.getElementById("brushContainer").querySelectorAll("img.brush-thumbnail");brushes.forEach((a,r)=>{t[r]&&(t[r].style.border=a.name===e?"2px solid red":"2px solid transparent")})}function selectBrush(e){const t=brushes.find(t=>t.name===e);if(!t)return void console.warn(`Brush "${e}" not found.`);currentBrush=t,overlayTexture=brushTextures[t.name],brushAspect=brushAspects[t.name];const a=document.getElementById("brushSizeSlider"),r=document.getElementById("brushSizeValue");a.value=brushSize,r.textContent=brushSize.toFixed(2),brushes.forEach(t=>t.selected=t.name===e),updateBrushThumbnailStyles(t.name),needsRedraw=!0}function loadBrushes(){brushes.forEach(e=>{const t=new Image;t.crossOrigin="anonymous",t.onload=()=>{const a=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,a),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0),gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,t),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),brushTextures[e.name]=a,brushAspects[e.name]=t.width/t.height,e.selected&&selectBrush(e.name)},t.onerror=()=>console.error("Failed to load brush image:",e.file),t.src=e.file})}function centerCanvasInWrapper(){const e=canvasWrapper.getBoundingClientRect(),t=canvas.width*zoomScale,a=canvas.height*zoomScale;panX=(e.width-t)/2,panY=(e.height-a)/2,viewRotation=0,transformOriginX=0,transformOriginY=0,updateCanvasTransform()}function ensureCanvasNotLost(){const e=canvasWrapper.getBoundingClientRect(),t=canvas.getBoundingClientRect(),a=Math.max(0,Math.min(t.right,e.right)-Math.min(t.left,e.left))*Math.max(0,Math.min(t.bottom,e.bottom)-Math.min(t.top,e.top)),r=t.width*t.height;(!isFinite(a)||r<=0||a/r<.05)&&centerCanvasInWrapper()}BackgroundPicker.install({curated:["/static/draw/images/backgrounds/WEBP_1920/sl_072622_51930_13.jpg","/static/draw/images/backgrounds/WEBP_1920/02.webp","/static/draw/images/backgrounds/WEBP_1920/44.webp","/static/draw/images/backgrounds/WEBP_1920/43.webp","/static/draw/images/backgrounds/WEBP_1920/42.webp","/static/draw/images/backgrounds/WEBP_1920/41.webp","/static/draw/images/backgrounds/WEBP_1920/40.webp"]}),["mouseup","mouseleave","touchend","touchcancel"].forEach(e=>canvasWrapper.addEventListener(e,ensureCanvasNotLost,{passive:!0})),window.addEventListener("resize",ensureCanvasNotLost),window.visualViewport&&(visualViewport.addEventListener("resize",ensureCanvasNotLost),visualViewport.addEventListener("scroll",ensureCanvasNotLost));let lastMultiTap=0;function snapBackIfLost(e,t){t="number"==typeof t?t:8;var a=e.getBoundingClientRect(),r=window.visualViewport?window.visualViewport:null,n=r&&r.width?r.width:window.innerWidth,o=r&&r.height?r.height:window.innerHeight;if(!(a.right>t&&a.bottom>t&&a.left<n-t&&a.top<o-t)){var i=Math.min(Math.max(e.offsetLeft||0,t),n-a.width-t),l=Math.min(Math.max(e.offsetTop||0,t),o-a.height-t);e.style.left=Math.round(i)+"px",e.style.top=Math.round(l)+"px"}}canvasWrapper.addEventListener("touchend",e=>{if(e.changedTouches.length>=2){const e=performance.now();e-lastMultiTap<350&&centerCanvasInWrapper(),lastMultiTap=e}},{passive:!0}),[["brushSizeSliderContainer","brushSizeDragBar"],["brushContainerWrapper","brushContainerDragBar"],["layersPanel",".layers-header"]].forEach(([e,t])=>{const a=document.getElementById(e),r=a&&(t.startsWith("#")?document.querySelector(t):a.querySelector(t));if(!a||!r)return;const n=e=>{try{r.releasePointerCapture(e.pointerId)}catch{}snapBackIfLost(a)};r.addEventListener("pointerup",n),r.addEventListener("pointercancel",n)}),window.addEventListener("resize",()=>{["brushSizeSliderContainer","brushContainerWrapper","layersPanel"].forEach(e=>{const t=document.getElementById(e);t&&snapBackIfLost(t)})});let resizeTimer=null;function updateBrushSize(){const e=canvas.width;brushSize=Math.min(brushSize,e/10)}function updateCanvasSize(e){if(!e)return;const t=window.innerWidth/window.innerHeight;let a,r;imageAspect=e.width/e.height,imageAspect>t?(a=window.innerWidth,r=window.innerWidth/imageAspect):(r=window.innerHeight,a=window.innerHeight*imageAspect),canvas.width=Math.round(a),canvas.height=Math.round(r),gl.viewport(0,0,canvas.width,canvas.height),updateBrushSize(),needsRedraw=!0}function resetStrokeState(){lastX=null,lastY=null,lastFx=null,lastFy=null,void 0!==lastDrawTime&&(lastDrawTime=0),void 0!==soundLastX&&(soundLastX=null),void 0!==soundLastY&&(soundLastY=null)}function setDocumentSize(e,t){fixedFBOWidth=e,fixedFBOHeight=t,canvas.width=e,canvas.height=t,gl.viewport(0,0,e,t),zoomScale=1;const a=canvasWrapper.getBoundingClientRect();panX=Math.round((a.width-e)/2),panY=Math.round((a.height-t)/2),updateCanvasTransform(),resetStrokeState(),needsRedraw=!0}window.addEventListener("resize",()=>{clearTimeout(resizeTimer),resizeTimer=setTimeout(()=>{currentImage&&updateCanvasSize(currentImage),centerCanvasInWrapper?.()},120)}),window.addEventListener("resize",()=>{currentImage&&updateCanvasSize(currentImage)});const audioCtx=new(window.AudioContext||window.webkitAudioContext);let gainNode,noiseNode,filterNode,isDrawingSoundActive=!1,soundLastX=null,soundLastY=null,soundIsMoving=!1,lastMoveTimestamp=0;function unlockAudio(){"suspended"===audioCtx.state&&audioCtx.resume()}function createNoiseBuffer(){const e=audioCtx.sampleRate,t=Math.max(1,Math.floor(.5*e)),a=audioCtx.createBuffer(1,t,e),r=a.getChannelData(0);for(let e=0;e<t;e++)r[e]=Math.random()>.9?.5*(2*Math.random()-1):0;return a}function startDrawingSound(e=1){if(isDrawingSoundActive)return;isDrawingSoundActive=!0,unlockAudio(),gainNode=audioCtx.createGain(),gainNode.gain.setValueAtTime(0,audioCtx.currentTime),filterNode=audioCtx.createBiquadFilter(),filterNode.type="bandpass";const t=.5*audioCtx.sampleRate,a=400+300*(Number(e)||0),r=Math.min(t-20,Math.max(10,a));filterNode.frequency.setValueAtTime(r,audioCtx.currentTime),filterNode.Q.setValueAtTime(2.5,audioCtx.currentTime),noiseNode=audioCtx.createBufferSource(),noiseNode.buffer=createNoiseBuffer(),noiseNode.loop=!0,noiseNode.connect(filterNode),filterNode.connect(gainNode),gainNode.connect(audioCtx.destination),noiseNode.start()}function updateDrawingSound(e){if(!isDrawingSoundActive)return;const t=.5*audioCtx.sampleRate,a=400+300*(Number(e)||0),r=Math.min(t-20,Math.max(10,a));filterNode.frequency.linearRampToValueAtTime(r,audioCtx.currentTime+.05);const n=Math.min(.15,.05*(Number(e)||0)),o=Math.max(0,Math.min(1,n));gainNode.gain.linearRampToValueAtTime(o,audioCtx.currentTime+.05)}function stopDrawingSound(){isDrawingSoundActive&&(isDrawingSoundActive=!1,gainNode.gain.linearRampToValueAtTime(0,audioCtx.currentTime+.2),setTimeout(()=>{noiseNode&&(noiseNode.stop(),noiseNode.disconnect()),filterNode&&filterNode.disconnect(),gainNode&&gainNode.disconnect()},200))}function getTouchPos(e){const t=e.touches&&e.touches[0]?e.touches[0]:e.changedTouches&&e.changedTouches[0];if(!t)return{x:0,y:0};const a=canvasWrapper.getBoundingClientRect(),r=t.clientX-a.left,n=t.clientY-a.top,o=screenToCanvasPx(t.clientX,t.clientY);return{x:r,y:n,cx:o.x,cy:o.y}}function addSoundEvents(){document.addEventListener("touchstart",unlockAudio,{once:!0}),document.addEventListener("click",unlockAudio,{once:!0}),canvas.addEventListener("mousedown",()=>{soundIsMoving=!1}),canvas.addEventListener("mousemove",e=>{if(!isDrawing)return;let t=Math.sqrt(e.movementX**2+e.movementY**2);soundIsMoving||(startDrawingSound(t),soundIsMoving=!0),updateDrawingSound(t)}),canvas.addEventListener("mouseup",()=>{soundIsMoving=!1,stopDrawingSound()}),canvas.addEventListener("mouseleave",()=>{soundIsMoving=!1,stopDrawingSound()}),canvas.addEventListener("touchstart",e=>{e.preventDefault(),isDrawing=!0,soundLastX=null,soundLastY=null,soundIsMoving=!1,lastMoveTimestamp=Date.now()}),canvas.addEventListener("touchmove",e=>{if(e.preventDefault(),!isDrawing)return;const t=getTouchPos(e),a=Date.now();if(null!==soundLastX&&null!==soundLastY){const e=t.x-soundLastX,r=t.y-soundLastY,n=Math.sqrt(e*e+r*r);if(n>1){let e=n/(a-lastMoveTimestamp+1);lastMoveTimestamp=a,soundIsMoving||(startDrawingSound(e),soundIsMoving=!0),updateDrawingSound(e)}}soundLastX=t.x,soundLastY=t.y}),canvas.addEventListener("touchend",()=>{soundIsMoving=!1,stopDrawingSound()}),canvas.addEventListener("touchcancel",()=>{soundIsMoving=!1,stopDrawingSound()}),setInterval(()=>{isDrawing&&soundIsMoving&&Date.now()-lastMoveTimestamp>100&&(soundIsMoving=!1,stopDrawingSound())},50)}let lastDrawTime=0;function isUserTyping(){const e=document.activeElement;return e&&("INPUT"===e.tagName||"TEXTAREA"===e.tagName||e.isContentEditable)}canvas.addEventListener("mousedown",e=>{if(!canPaint())return;const t=pointerToBoth(e);if(overlayPosition=[t.cx/canvas.width,t.cy/canvas.height],"fill"===currentTool)return performFloodFill(t.fx,t.fy),needsRedraw=!0,void drawScene();isDrawing=!0,startRender("draw"),drawBrushStrokeToPaintLayer(t.cx,t.cy)}),canvas.addEventListener("mousemove",e=>{if(!canPaint()&&!isDrawing)return;const t=Date.now();if(t-lastDrawTime<16)return;lastDrawTime=t;const a=pointerToBoth(e);if(null!==lastX&&null!==lastY){const e=a.cx-lastX,t=a.cy-lastY;(Math.abs(e)>.1||Math.abs(t)>.1)&&(currentAngle=Math.atan2(t,e))}lastX=a.cx,lastY=a.cy,overlayPosition=[a.cx/canvas.width,a.cy/canvas.height],isDrawing&&canPaint()&&drawBrushStrokeToPaintLayer(a.cx,a.cy)}),canvas.addEventListener("mouseup",()=>{isDrawing=!1,stopRender("draw"),lastFx=null,lastFy=null}),canvas.addEventListener("mouseleave",()=>{isDrawing=!1,stopRender("draw"),lastFx=null,lastFy=null}),canvas.addEventListener("touchstart",e=>{if(e.preventDefault(),!canPaint())return;const t=e.touches[0];if(!t)return;const a=pointerToBoth(t);if(overlayPosition=[a.cx/canvas.width,a.cy/canvas.height],"fill"===currentTool)return performFloodFill(a.fx,a.fy),needsRedraw=!0,void drawScene();isDrawing=!0,startRender("draw"),drawBrushStrokeToPaintLayer(a.cx,a.cy)},{passive:!1}),canvas.addEventListener("touchmove",e=>{if(e.preventDefault(),!isDrawing||!canPaint())return;const t=e.touches[0];if(!t)return;const a=Date.now();if(a-lastDrawTime<16)return;lastDrawTime=a;const r=pointerToBoth(t);if(null!==lastX&&null!==lastY){const e=r.cx-lastX,t=r.cy-lastY;(Math.abs(e)>.1||Math.abs(t)>.1)&&(currentAngle=Math.atan2(t,e))}lastX=r.cx,lastY=r.cy,overlayPosition=[r.cx/canvas.width,r.cy/canvas.height],drawBrushStrokeToPaintLayer(r.cx,r.cy)},{passive:!1}),canvas.addEventListener("touchend",()=>{isDrawing=!1,stopRender("draw"),lastFx=null,lastFy=null},{passive:!0}),canvas.addEventListener("touchcancel",()=>{isDrawing=!1,stopRender("draw"),lastFx=null,lastFy=null},{passive:!0}),document.addEventListener("keydown",e=>{if(isUserTyping())return;let t=!1;if("["===e.key){brushSize=Math.max(.01,brushSize-.02);const e=document.getElementById("brushSizeSlider");e&&(e.value=brushSize),t=!0,overlayPosition=[lastPointer.cx/canvas.width,lastPointer.cy/canvas.height],showBrushHUD()}else if("]"===e.key){brushSize=Math.min(1,brushSize+.02);const e=document.getElementById("brushSizeSlider");e&&(e.value=brushSize),t=!0,overlayPosition=[lastPointer.cx/canvas.width,lastPointer.cy/canvas.height],showBrushHUD()}else if(e.key>="0"&&e.key<="9"){let a="0"===e.key?9:parseInt(e.key,10)-1;a>=0&&a<brushes.length&&(selectBrush(brushes[a].name),t=!0,overlayPosition=[lastPointer.cx/canvas.width,lastPointer.cy/canvas.height],showBrushHUD())}t&&(needsRedraw=!0)});let brushSize=.02,opacity=1,eraseStrength=.5,paintStrength=1;document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("brushSizeSlider"),t=document.getElementById("brushSizeValue");e.value=brushSize,t.textContent=brushSize.toFixed(2),e.addEventListener("input",e=>{brushSize=parseFloat(e.target.value),t.textContent=brushSize.toFixed(2),needsRedraw=!0,showBrushHUD()});const a=document.getElementById("eraseStrengthSlider"),r=document.getElementById("eraseStrengthValue");a.value=eraseStrength,r.textContent=eraseStrength.toFixed(2),a.addEventListener("input",e=>{eraseStrength=parseFloat(e.target.value),r.textContent=eraseStrength.toFixed(2),needsRedraw=!0,showBrushHUD()});const n=document.getElementById("paintStrengthSlider"),o=document.getElementById("paintStrengthValue");n.value=paintStrength,o.textContent=paintStrength.toFixed(2),n.addEventListener("input",e=>{paintStrength=parseFloat(e.target.value),o.textContent=paintStrength.toFixed(2),needsRedraw=!0})});let selectedLayerIndices=new Set;function rebuildLayersUI(){const e=document.getElementById("layersList");if(!e)return;if(layers?.length?0===selectedLayerIndices.size&&Number.isInteger(activeLayerIndex)&&selectedLayerIndices.add(activeLayerIndex):selectedLayerIndices.clear(),!window.__mobileLayerTransformSetup){const l=canvasWrapper||document.getElementById("canvasWrapper")||canvas?.parentElement;let s=null;function t(e){if(isMobile()&&(s&&(!e.touches||e.touches.length<2)&&(s=null),transformTool&&"idle"===transformTool.mode)){const e=getActiveLayer();e&&e.transformLocked||(transformTool.mobileCombo=!1)}}l&&(l.addEventListener("touchstart",function(e){if(isMobile()&&transformTool&&transformTool.mobileCombo&&2===e.touches.length){e.preventDefault(),e.stopImmediatePropagation();const t=e.touches[0],a=e.touches[1],r=a.clientX-t.clientX,n=a.clientY-t.clientY,o=Math.hypot(r,n),i=Math.atan2(n,r),l=getActiveLayer();if(!l)return;s={dist0:Math.max(1e-6,o),ang0:i,ref:{scaleX:Number.isFinite(l.scaleX)?l.scaleX:1,scaleY:Number.isFinite(l.scaleY)?l.scaleY:1,rotation:Number.isFinite(l.rotation)?l.rotation:0}}}},{passive:!1,capture:!0}),l.addEventListener("touchmove",function(e){if(isMobile()&&transformTool&&transformTool.mobileCombo&&2===e.touches.length&&s){e.preventDefault(),e.stopImmediatePropagation();const t=e.touches[0],a=e.touches[1],r=a.clientX-t.clientX,n=a.clientY-t.clientY,o=Math.max(1e-6,Math.hypot(r,n)),i=Math.atan2(n,r),l=getActiveLayer();if(!l)return;const c=o/s.dist0;l.scaleX=s.ref.scaleX*c,l.scaleY=s.ref.scaleY*c;let d=i-s.ang0;return d>Math.PI&&(d-=2*Math.PI),d<-Math.PI&&(d+=2*Math.PI),l.rotation=s.ref.rotation+d,void(needsRedraw=!0)}},{passive:!1,capture:!0}),l.addEventListener("touchend",t,{passive:!0,capture:!0}),l.addEventListener("touchcancel",t,{passive:!0,capture:!0})),window.__mobileLayerTransformSetup=!0}e.innerHTML="";const a=document.createElement("div");a.className="layers-header";const r=document.createElement("button");r.type="button",r.className="bs-n",r.textContent="Merge Selected",r.disabled=selectedLayerIndices.size<2,r.addEventListener("click",e=>{e.stopPropagation(),selectedLayerIndices.size>=2&&mergeSelectedLayers()});const n=document.createElement("button");function o(){r.disabled=selectedLayerIndices.size<2,r.textContent=selectedLayerIndices.size>1?`Merge Selected (${selectedLayerIndices.size})`:"Merge Selected",n.disabled=!(layers&&layers.length>=2)}function i(e,t){if(!t)return selectedLayerIndices.clear(),selectedLayerIndices.add(e),void(activeLayerIndex=e);selectedLayerIndices.has(e)?(selectedLayerIndices.delete(e),0===selectedLayerIndices.size&&selectedLayerIndices.add(e)):(selectedLayerIndices.add(e),activeLayerIndex=e)}n.type="button",n.className="bs-n",n.textContent="Merge All",n.disabled=!(layers&&layers.length>=2),n.addEventListener("click",e=>{if(e.stopPropagation(),layers&&layers.length>=2){selectedLayerIndices.clear();for(let e=0;e<layers.length;e++)selectedLayerIndices.add(e);mergeSelectedLayers(),selectedLayerIndices.clear(),Number.isInteger(activeLayerIndex)&&selectedLayerIndices.add(activeLayerIndex),rebuildLayersUI()}}),a.appendChild(r),a.appendChild(n),e.appendChild(a),(layers||[]).forEach((t,a)=>{const r=document.createElement("div"),n=a===activeLayerIndex,l=selectedLayerIndices.has(a);r.className="layer-item"+(n?" active":"")+(l?" is-selected":""),r.dataset.index=String(a);const s=document.createElement("div");s.className="layer-select";const c=document.createElement("input");c.type="checkbox",c.checked=l,c.title="Select for merge",c.addEventListener("click",e=>{e.stopPropagation(),i(a,!0),o(),r.classList.toggle("is-selected",selectedLayerIndices.has(a))}),s.appendChild(c);const d=document.createElement("div");d.className="layer-vis";const g=document.createElement("button");g.type="button",g.className="bs icon-btn",g.title=t.visible?"Hide layer":"Show layer",g.setAttribute("aria-label",`${t.visible?"Hide":"Show"} ${t.name}`);const u="/static/draw/images/icons/show.svg",m="/static/draw/images/icons/hide.svg",f=document.createElement("img");function h(){f.src=t.visible?u:m,f.alt=t.visible?"Visible":"Hidden",g.title=t.visible?"Hide layer":"Show layer",g.setAttribute("aria-label",`${t.visible?"Hide":"Show"} ${t.name}`)}f.alt=t.visible?"Visible":"Hidden",f.src=t.visible?u:m,f.style.pointerEvents="none",g.appendChild(f),g.addEventListener("click",e=>{e.stopPropagation(),clearTransformLockAll(),t.visible=!t.visible,h(),needsRedraw=!0}),d.appendChild(g);const y=document.createElement("button");y.type="button",y.className="bs icon-btn transform-btn",y.title="Transform layer",y.setAttribute("aria-label",`Transform ${t.name}`),y.innerHTML='<img src="/static/draw/images/icons/transform.svg" alt="Transform">',isMobile()||(y.style.display="none"),isMobile()&&t.transformLocked&&n?y.classList.add("is-active"):y.classList.remove("is-active"),y.addEventListener("click",e=>{e.stopPropagation(),activeLayerIndex!==a&&(clearTransformLockAll(),activeLayerIndex=a,syncActiveAliases?.(),rebuildLayersUI());const r=!!t.transformLocked;setLayerTransformLock(a,!r),y.classList.toggle("is-active",!r),showStatusMessage?.(r?"Transform unlocked":"Transform locked: drag to move, pinch to scale/rotate","info"),needsRedraw=!0}),d.appendChild(y);const p=document.createElement("div");p.className="layer-name";const E=document.createElement("input");E.value=t.name,E.title="Rename layer",E.setAttribute("aria-label",`Rename ${t.name}`),E.addEventListener("click",e=>e.stopPropagation()),E.addEventListener("mousedown",()=>{activeLayerIndex=a}),E.addEventListener("focus",()=>{activeLayerIndex=a});const x=()=>{const e=E.value;e!==t.name&&(t.name=e,h())};E.addEventListener("change",x),E.addEventListener("blur",x),p.appendChild(E);const v=document.createElement("div");v.className="layer-ops";const b=document.createElement("button");b.type="button",b.className="bs icon-btn",b.title="Duplicate layer",b.setAttribute("aria-label","Duplicate layer"),b.innerHTML='<img src="/static/draw/images/icons/clone.svg" alt="" style="pointer-events:none" width="18" height="18">',b.addEventListener("click",e=>{e.stopPropagation(),clearTransformLockAll(),duplicateLayer(a)});const T=document.createElement("button");T.type="button",T.className="bs icon-btn",T.title="Move up",T.setAttribute("aria-label","Move layer up"),T.innerHTML='<img src="/static/draw/images/icons/up-shevron.svg" alt="" style="pointer-events:none" width="18" height="18">',T.addEventListener("click",e=>{e.stopPropagation(),clearTransformLockAll(),moveLayerUp(a)});const w=document.createElement("button");w.type="button",w.className="bs icon-btn",w.title="Move down",w.setAttribute("aria-label","Move layer down"),w.innerHTML='<img src="/static/draw/images/icons/down-shevron.svg" alt="" style="pointer-events:none" width="18" height="18">',w.addEventListener("click",e=>{e.stopPropagation(),clearTransformLockAll(),moveLayerDown(a)}),v.appendChild(b),v.appendChild(T),v.appendChild(w);const L=document.createElement("div");L.className="layer-opacity";const A=document.createElement("span");A.textContent="Opacity";const F=document.createElement("input");F.type="range",F.min="0",F.max="1",F.step="0.01",F.value=String(t.opacity),["click","mousedown","touchstart","keydown"].forEach(e=>F.addEventListener(e,e=>e.stopPropagation())),F.addEventListener("input",()=>{clearTransformLockAll();const e=parseFloat(F.value);Number.isNaN(e)||e===t.opacity||(t.opacity=Math.max(0,Math.min(1,e)),needsRedraw=!0)}),L.appendChild(A),L.appendChild(F),r.appendChild(s),r.appendChild(d),r.appendChild(p),r.appendChild(v),r.appendChild(L),r.addEventListener("click",e=>{const r=!(!e.ctrlKey&&!e.metaKey),n=!!e.shiftKey;if(clearTransformLockAll(),n)!function(e){if(0===selectedLayerIndices.size)return selectedLayerIndices.add(e),void(activeLayerIndex=e);const t=activeLayerIndex??e,a=Math.min(t,e),r=Math.max(t,e);selectedLayerIndices.clear();for(let e=a;e<=r;e++)selectedLayerIndices.add(e);activeLayerIndex=e}(a);else{if(!r)return void function(e,t){clearTransformLockAll(),activeLayerIndex=e,selectedLayerIndices.clear(),selectedLayerIndices.add(e),syncActiveAliases?.(),rebuildLayersUI(),showStatusMessage?.(`Selected: ${t.name}`,"info"),needsRedraw=!0}(a,t);i(a,!0),activeLayerIndex=a}document.querySelectorAll("#layersList .layer-item").forEach(e=>{const t=Number(e.dataset.index);e.classList.toggle("is-selected",selectedLayerIndices.has(t)),e.classList.toggle("active",t===activeLayerIndex)}),o()}),e.insertBefore(r,e.children[1]||null)}),o()}function clearActiveLayer(){const e="function"==typeof getActiveLayer?getActiveLayer():layers?.[activeLayerIndex];if(!(gl&&e&&e.fbo&&e.texture))return;const t=snapshotLayer(activeLayerIndex),a=0|fixedFBOWidth,r=0|fixedFBOHeight,n=gl.getParameter(gl.FRAMEBUFFER_BINDING),o=gl.getParameter(gl.VIEWPORT);gl.bindFramebuffer(gl.FRAMEBUFFER,e.fbo),gl.viewport(0,0,a,r),gl.disable(gl.BLEND),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.bindTexture(gl.TEXTURE_2D,e.texture),(0|e.texW)===a&&(0|e.texH)===r||(gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,a,r,0,gl.RGBA,gl.UNSIGNED_BYTE,null),e.texW=a,e.texH=r,gl.bindFramebuffer(gl.FRAMEBUFFER,e.fbo),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,e.texture,0)),gl.bindFramebuffer(gl.FRAMEBUFFER,n),o&&gl.viewport(o[0],o[1],o[2],o[3]);const i=snapshotLayer(activeLayerIndex);t&&i&&History.push({type:"clear_layer",index:activeLayerIndex,before:t,after:i}),needsRedraw=!0,requestDrawIfIdle?.(),showStatusMessage?.("Layer cleared","info")}function removeActiveLayer(){if(layers.length<=1)return void showStatusMessage("Need at least one layer","warning");const[e]=layers.splice(activeLayerIndex,1);gl.deleteTexture(e.texture),gl.deleteFramebuffer(e.fbo),activeLayerIndex=Math.max(0,activeLayerIndex-1),syncActiveAliases(),rebuildLayersUI(),needsRedraw=!0}function moveLayerUp(e){e>=layers.length-1||([layers[e],layers[e+1]]=[layers[e+1],layers[e]],activeLayerIndex===e?activeLayerIndex=e+1:activeLayerIndex===e+1&&(activeLayerIndex=e),syncActiveAliases(),rebuildLayersUI(),needsRedraw=!0)}function moveLayerDown(e){e<=0||([layers[e],layers[e-1]]=[layers[e-1],layers[e]],activeLayerIndex===e?activeLayerIndex=e-1:activeLayerIndex===e-1&&(activeLayerIndex=e),syncActiveAliases(),rebuildLayersUI(),needsRedraw=!0)}function initFloodFillProgram(){floodFillProgram=createProgram(gl,"\n        attribute vec2 aPosition;\n        varying vec2 vTexCoord;\n        void main() {\n            vTexCoord = (aPosition + 1.0) * 0.5;\n            gl_Position = vec4(aPosition, 0.0, 1.0);\n        }\n    ","\n        precision mediump float;\n        varying vec2 vTexCoord;\n        uniform sampler2D uSource;\n        uniform vec4 uTargetColor;\n        uniform vec4 uFillColor;\n        uniform vec2 uTexelSize;\n\n        void main() {\n            vec4 current = texture2D(uSource, vTexCoord);\n\n            float threshold = 0.01;\n\n            bool isTarget = distance(current, uTargetColor) < threshold;\n            bool isFilled = distance(current, uFillColor) < threshold;\n\n            if (isFilled) {\n                gl_FragColor = uFillColor;\n                return;\n            }\n\n            // Check neighbors:\n            vec2 offsets[8];\n            offsets[0] = vec2(-uTexelSize.x, 0.0);\n            offsets[1] = vec2(uTexelSize.x, 0.0);\n            offsets[2] = vec2(0.0, -uTexelSize.y);\n            offsets[3] = vec2(0.0, uTexelSize.y);\n            offsets[4] = vec2(-uTexelSize.x, -uTexelSize.y);\n            offsets[5] = vec2(-uTexelSize.x, uTexelSize.y);\n            offsets[6] = vec2(uTexelSize.x, -uTexelSize.y);\n            offsets[7] = vec2(uTexelSize.x, uTexelSize.y);\n\n            // vec2 offsets[4];\n            // offsets[0] = vec2(-uTexelSize.x, 0.0);\n            // offsets[1] = vec2(uTexelSize.x, 0.0);\n            // offsets[2] = vec2(0.0, -uTexelSize.y);\n            // offsets[3] = vec2(0.0, uTexelSize.y);\n\n            for (int i = 0; i < 8; i++) {\n                vec4 neighbor = texture2D(uSource, vTexCoord + offsets[i]);\n                bool neighborFilled = distance(neighbor, uFillColor) < threshold;\n                if (neighborFilled && isTarget) {\n                    gl_FragColor = uFillColor;\n                    return;\n                }\n            }\n\n            // for (int i = 0; i < 4; i++) {\n            //     vec4 neighbor = texture2D(uSource, vTexCoord + offsets[i]);\n            //     bool neighborFilled = distance(neighbor, uFillColor) < threshold;\n            //     if (neighborFilled && isTarget) {\n            //         gl_FragColor = uFillColor;\n            //         return;\n            //     }\n            // }\n\n            gl_FragColor = current;\n        }\n    ")}function performFloodFill(e,t){const a=getActiveLayer();if(!a)return;const r=snapshotLayer(activeLayerIndex),n=Math.max(0,Math.min(fixedFBOWidth-1,Math.round(e))),o=Math.max(0,Math.min(fixedFBOHeight-1,Math.round(t))),i=fixedFBOHeight-1-o,l=new Uint8Array(4);gl.bindFramebuffer(gl.FRAMEBUFFER,a.fbo),gl.readPixels(n,i,1,1,gl.RGBA,gl.UNSIGNED_BYTE,l),gl.bindFramebuffer(gl.FRAMEBUFFER,null);runFloodFillShader(a,[l[0]/255,l[1]/255,l[2]/255,l[3]/255],tintColor);const s=snapshotLayer(activeLayerIndex);History.push({type:"fill",before:r,after:s}),needsRedraw=!0}function runFloodFillShader(e,t,a){let r=fillFBO1,n=fillFBO2;gl.bindFramebuffer(gl.READ_FRAMEBUFFER,e.fbo),gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,r.fbo),gl.viewport(0,0,fixedFBOWidth,fixedFBOHeight),gl.blitFramebuffer(0,0,fixedFBOWidth,fixedFBOHeight,0,0,fixedFBOWidth,fixedFBOHeight,gl.COLOR_BUFFER_BIT,gl.NEAREST);const o=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),i=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,i),gl.bufferData(gl.ARRAY_BUFFER,o,gl.STATIC_DRAW);const l=gl.getAttribLocation(floodFillProgram,"aPosition");gl.enableVertexAttribArray(l),gl.vertexAttribPointer(l,2,gl.FLOAT,!1,0,0);for(let e=0;e<50;e++){gl.bindFramebuffer(gl.FRAMEBUFFER,n.fbo),gl.viewport(0,0,fixedFBOWidth,fixedFBOHeight),gl.useProgram(floodFillProgram),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,r.texture),gl.uniform1i(gl.getUniformLocation(floodFillProgram,"uSource"),0),gl.uniform4fv(gl.getUniformLocation(floodFillProgram,"uTargetColor"),t),gl.uniform4fv(gl.getUniformLocation(floodFillProgram,"uFillColor"),a),gl.uniform2f(gl.getUniformLocation(floodFillProgram,"uTexelSize"),1/fixedFBOWidth,1/fixedFBOHeight),gl.drawArrays(gl.TRIANGLES,0,6);let e=r;r=n,n=e}gl.bindFramebuffer(gl.READ_FRAMEBUFFER,r.fbo),gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,e.fbo),gl.viewport(0,0,fixedFBOWidth,fixedFBOHeight),gl.blitFramebuffer(0,0,fixedFBOWidth,fixedFBOHeight,0,0,fixedFBOWidth,fixedFBOHeight,gl.COLOR_BUFFER_BIT,gl.NEAREST),gl.disableVertexAttribArray(l),gl.deleteBuffer(i),gl.bindFramebuffer(gl.FRAMEBUFFER,null)}function createFBO(e,t){const a=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,a),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,e,t,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);const r=gl.createFramebuffer();return gl.bindFramebuffer(gl.FRAMEBUFFER,r),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,a,0),gl.bindFramebuffer(gl.FRAMEBUFFER,null),{fbo:r,texture:a}}!function(){function e(e){if("function"==typeof isUserTyping&&isUserTyping())return;const t=e.key;!("Delete"===t)&&!("Backspace"===t)||e.metaKey||e.ctrlKey||e.altKey||(e.preventDefault(),clearActiveLayer())}try{document.removeEventListener("keydown",e,!0)}catch{}document.addEventListener("keydown",e,!0)}(),document.getElementById("addLayerBtn").addEventListener("click",()=>{addLayer(`Layer ${layers.length+1}`,activeLayerIndex)}),document.getElementById("removeLayerBtn").addEventListener("click",()=>{removeActiveLayer()}),function(){const e=document.getElementById("addLayerBtn");if(e){try{document.removeEventListener("keydown",t,!0)}catch{}document.addEventListener("keydown",t,!0)}function t(t){if("function"==typeof isUserTyping&&isUserTyping())return;if(t.metaKey||t.ctrlKey||t.altKey)return;const a=t.key||"";"n"!==a&&"N"!==a||(t.preventDefault(),function(){try{e.click(),console.log("[Shortcut] New Layer via 'n' → addBtn.click()")}catch(e){try{const e=`Layer ${layers.length+1}`,t="number"==typeof activeLayerIndex?activeLayerIndex:layers.length-1;addLayer(e,t),console.log("[Shortcut] New Layer fallback → addLayer()",{name:e,insertBelowIndex:t})}catch(e){console.warn("[Shortcut] New Layer failed",e)}}}())}}(),document.addEventListener("keydown",e=>{if(isUserTyping())return;if(spacePanning||isDrawing)return;if(e.ctrlKey||e.metaKey||e.altKey)return;if("x"===e.key.toLowerCase()||"Delete"===e.key){if(e.preventDefault(),e.stopImmediatePropagation(),transformTool?.mode&&"idle"!==transformTool.mode&&endTransform(!1),layers.length<=1)return void showStatusMessage("Need at least one layer","warning");const t=layers[activeLayerIndex]?.name||"Layer";removeActiveLayer(),showStatusMessage(`Deleted: ${t}`,"success")}},{capture:!0});let fillFBO1=null,fillFBO2=null;function initFloodFBOs(){fillFBO1&&(gl.deleteTexture(fillFBO1.texture),gl.deleteFramebuffer(fillFBO1.fbo)),fillFBO2&&(gl.deleteTexture(fillFBO2.texture),gl.deleteFramebuffer(fillFBO2.fbo)),fillFBO1=createFBO(fixedFBOWidth,fixedFBOHeight),fillFBO2=createFBO(fixedFBOWidth,fixedFBOHeight)}let strokeCount=0;const FLATTEN_THRESHOLD=isMobile()?50:150;function flattenStrokes(){const e=getActiveLayer?.();if(!(gl&&e&&e.texture&&quadProgram))return;const t=Math.max(1,0|e.texW),a=Math.max(1,0|e.texH),r=gl.getParameter(gl.FRAMEBUFFER_BINDING),n=gl.getParameter(gl.CURRENT_PROGRAM),o=gl.getParameter(gl.VIEWPORT),i=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,i),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,t,a,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);const l=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,l),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,i,0),gl.viewport(0,0,t,a),gl.disable(gl.BLEND),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);const s=gl.getUniformLocation(quadProgram,"u_flipY");s&&gl.uniform1f(s,1);const c=gl.getUniformLocation(quadProgram,"u_resolution");c&&gl.uniform2f(c,t,a);const d=gl.getUniformLocation(quadProgram,"u_layerOpacity");d&&gl.uniform1f(d,1);const g=gl.getUniformLocation(quadProgram,"u_texture"),u=new Float32Array([0,0,0,0,t,0,1,0,0,a,0,1,0,a,0,1,t,0,1,0,t,a,1,1]),m=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,m),gl.bufferData(gl.ARRAY_BUFFER,u,gl.STREAM_DRAW);const f=gl.getAttribLocation(quadProgram,"a_position"),h=gl.getAttribLocation(quadProgram,"a_texCoord");gl.enableVertexAttribArray(f),gl.vertexAttribPointer(f,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(h),gl.vertexAttribPointer(h,2,gl.FLOAT,!1,16,8),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,e.texture),g&&gl.uniform1i(g,0),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(f),gl.disableVertexAttribArray(h),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(m);const y=e.texture,p=e.fbo;e.texture=i,e.fbo=l;try{y&&gl.deleteTexture(y)}catch{}try{p&&gl.deleteFramebuffer(p)}catch{}try{strokeCount=0}catch{}gl.bindFramebuffer(gl.FRAMEBUFFER,r),gl.useProgram(n),o&&gl.viewport(o[0],o[1],o[2],o[3]),needsRedraw=!0,requestDrawIfIdle?.()}let currentAngle=0,sharedBuffer=null;function createPaperImage(e,t){return new Promise((a,r)=>{try{const n=document.createElement("canvas");n.width=Math.max(1,Math.floor(e)),n.height=Math.max(1,Math.floor(t));const o=n.getContext("2d");o.fillStyle="#f2efe4",o.fillRect(0,0,n.width,n.height);const i=document.createElement("canvas");i.width=n.width,i.height=n.height;const l=i.getContext("2d"),s=l.createImageData(i.width,i.height);for(let e=0;e<s.data.length;e+=4){const t=50*Math.random()-25;s.data[e]=240+t,s.data[e+1]=235+t,s.data[e+2]=225+t,s.data[e+3]=255}l.putImageData(s,0,0),o.globalAlpha=.2,o.drawImage(i,0,0),o.globalAlpha=1;const c=document.createElement("canvas");c.width=n.width,c.height=n.height;const d=c.getContext("2d"),g=d.createImageData(c.width,c.height);for(let e=0;e<g.data.length;e+=4){const t=255*Math.random();g.data[e]=t,g.data[e+1]=t,g.data[e+2]=t,g.data[e+3]=90*Math.random()}d.putImageData(g,0,0),o.globalAlpha=.08,o.drawImage(c,0,0),o.globalAlpha=1;const u=o.createRadialGradient(n.width/2,n.height/2,.3*Math.min(n.width,n.height),n.width/2,n.height/2,.6*Math.max(n.width,n.height));u.addColorStop(0,"rgba(0,0,0,0)"),u.addColorStop(1,"rgba(0,0,0,0.35)"),o.globalAlpha=.3,o.fillStyle=u,o.fillRect(0,0,n.width,n.height),o.globalAlpha=1;const m=new Image;m.onload=()=>a(m),m.onerror=r,m.src=n.toDataURL("image/png")}catch(e){r(e)}})}async function resetToBasePaper(){const e=Number(fixedFBOWidth)>0?fixedFBOWidth:window.innerWidth,t=Number(fixedFBOHeight)>0?fixedFBOHeight:window.innerHeight,a=await createPaperImage(e,t);currentImage=a,fixedFBOWidth=a.width,fixedFBOHeight=a.height,initPaintLayerFixed(),initFloodFBOs?.(),updateCanvasSize(a),createTextureFromImage(a),canvas.offsetWidth,canvasWrapper.offsetWidth,zoomScale=1,panX=(canvasWrapper.clientWidth-canvas.width)/2,panY=(canvasWrapper.clientHeight-canvas.height)/2,viewRotation=0,updateCanvasTransform(),resetStrokeState?.(),rebuildLayersUI?.(),needsRedraw=!0,requestDrawIfIdle?.()}async function clearProject(){try{console.log("[ClearProject] begin");const e=History._captureProject?.();try{Array.isArray(layers)&&layers.forEach(e=>{try{gl.deleteTexture(e.texture)}catch{}try{gl.deleteFramebuffer(e.fbo)}catch{}})}catch(e){console.warn("[ClearProject] disposing old layers warning:",e)}await resetToBasePaper();const t=History._captureProject?.();History.push({type:"clear_project",beforeAll:e,afterAll:t}),showStatusMessage?.("Project cleared to base paper","success"),console.log("[ClearProject] done")}catch(e){console.error("[ClearProject] fatal error:",e),showStatusMessage?.("Clear failed","error")}}(()=>{const e=document.getElementById("cleanButton");e?e.addEventListener("click",()=>{console.log("[ClearProject] click"),clearProject();try{saveAutosaveDebounced?.(400)}catch{}}):console.warn('[ClearProject] "#cleanButton" not found; binding skipped.')})();const UNDO_LIMIT=isMobile()?50:200;function createTextureAndFBO(e,t,a=gl.NEAREST){const r=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,r),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,e,t,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,a),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,a),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);const n=gl.createFramebuffer();return gl.bindFramebuffer(gl.FRAMEBUFFER,n),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,r,0),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null),{texture:r,fbo:n}}function blitFBOtoFBO(e,t,a=fixedFBOWidth,r=fixedFBOHeight){gl.bindFramebuffer(gl.READ_FRAMEBUFFER,e),gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,t),gl.blitFramebuffer(0,0,a,r,0,0,a,r,gl.COLOR_BUFFER_BIT,gl.NEAREST),gl.bindFramebuffer(gl.READ_FRAMEBUFFER,null),gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,null)}function applySnapshotToLayer(e,t){const a=layers?.[e];if(!gl||!a||!t)return;const r=0|t.w,n=0|t.h;a.texture?gl.bindTexture(gl.TEXTURE_2D,a.texture):(a.texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,a.texture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE)),a.fbo||(a.fbo=gl.createFramebuffer()),gl.bindFramebuffer(gl.FRAMEBUFFER,a.fbo),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,a.texture,0),void 0!==gl.UNPACK_FLIP_Y_WEBGL&&gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,0),gl.pixelStorei(gl.UNPACK_ALIGNMENT,1),(0|a.texW)!==r||(0|a.texH)!==n?(gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,r,n,0,gl.RGBA,gl.UNSIGNED_BYTE,t.pixels),a.texW=r,a.texH=n):gl.texSubImage2D(gl.TEXTURE_2D,0,0,0,r,n,gl.RGBA,gl.UNSIGNED_BYTE,t.pixels),needsRedraw=!0,requestDrawIfIdle?.()}function snapshotLayer(e){const t=layers?.[e];if(!gl||!t||!t.fbo)return null;const a=0|fixedFBOWidth,r=0|fixedFBOHeight,n=gl.getParameter(gl.FRAMEBUFFER_BINDING),o=gl.getParameter(gl.VIEWPORT);gl.bindFramebuffer(gl.FRAMEBUFFER,t.fbo),gl.viewport(0,0,a,r);const i=new Uint8Array(a*r*4);return gl.readPixels(0,0,a,r,gl.RGBA,gl.UNSIGNED_BYTE,i),gl.bindFramebuffer(gl.FRAMEBUFFER,n),o&&gl.viewport(o[0],o[1],o[2],o[3]),{index:e,w:a,h:r,pixels:i}}function applyLayerTransformState(e,t){const a=layers?.[e];a&&t&&(a.x=t.x,a.y=t.y,a.scaleX=t.scaleX,a.scaleY=t.scaleY,a.rotation=t.rotation,a.px=t.px,a.py=t.py,a.ox=t.ox,a.oy=t.oy,a.texW=t.texW,a.texH=t.texH,"number"==typeof t.opacity&&(a.opacity=t.opacity),"boolean"==typeof t.visible&&(a.visible=t.visible),needsRedraw=!0,requestDrawIfIdle?.())}function endTransformHistory(e=activeLayerIndex){if(!__transformBefore)return;const t=getLayerTransformState(e),a=__transformBefore;(a.x!==t.x||a.y!==t.y||a.scaleX!==t.scaleX||a.scaleY!==t.scaleY||a.rotation!==t.rotation||a.px!==t.px||a.py!==t.py||a.ox!==t.ox||a.oy!==t.oy||a.texW!==t.texW||a.texH!==t.texH||a.opacity!==t.opacity||a.visible!==t.visible)&&History.push({type:"layer_transform",index:e,before:a,after:t}),__transformBefore=null}let __transformBefore=null;function beginTransformHistory(e=activeLayerIndex){__transformBefore=getLayerTransformState(e)}function getLayerTransformState(e){const t=layers?.[e];return t?{x:t.x||0,y:t.y||0,scaleX:"number"==typeof t.scaleX?t.scaleX:1,scaleY:"number"==typeof t.scaleY?t.scaleY:1,rotation:t.rotation||0,px:"number"==typeof t.px?t.px:.5*fixedFBOWidth,py:"number"==typeof t.py?t.py:.5*fixedFBOHeight,ox:t.ox||0,oy:t.oy||0,texW:t.texW||fixedFBOWidth,texH:t.texH||fixedFBOHeight,opacity:"number"==typeof t.opacity?t.opacity:1,visible:"boolean"!=typeof t.visible||t.visible}:null}function restoreLayerSnapshot(e){if(!e)return;const t="number"==typeof e.index?e.index:activeLayerIndex;layers[t]&&applySnapshotToLayer(t,e)}function disposeSnapshot(e){try{e?.texture&&gl.deleteTexture(e.texture),e?.fbo&&gl.deleteFramebuffer(e.fbo)}catch(e){console.warn("disposeSnapshot",e)}}const History={stack:[],redo:[],limit:UNDO_LIMIT,push(e){this.stack.push(e),this.stack.length>this.limit&&this._dispose(this.stack.shift()),this.redo.length=0,console.log("[History] push",e.type)},undo(){const e=this.stack.pop();if(e){this._applyInverse(e),this.redo.push(e);try{gl.flush?.()}catch{}needsRedraw=!0,requestDrawIfIdle?.(),showStatusMessage?.("Undo","info"),console.log("[History] undo",e.type)}},redoDo(){const e=this.redo.pop();if(e){this._apply(e),this.stack.push(e);try{gl.flush?.()}catch{}needsRedraw=!0,requestDrawIfIdle?.(),showStatusMessage?.("Redo","info"),console.log("[History] redo",e.type)}},_dispose(e){if(!e)return;const t=e=>{e&&e.pixels&&(e.pixels=null)};if(t(e.before),t(e.after),e.removedLayer&&t(e.removedLayer.snapshot),e.addedLayer&&t(e.addedLayer.snapshot),"merge_layers"===e.type&&(e.added?.data&&t(e.added.data.snapshot),Array.isArray(e.removed)))for(const a of e.removed)t(a?.data?.snapshot)},_apply(e){switch(e.type){case"stroke":case"fill":case"transform_bake":e.after&&restoreLayerSnapshot(e.after);break;case"layer_visibility":layers[e.index].visible=e.next;break;case"layer_opacity":layers[e.index].opacity=e.next;break;case"layer_rename":layers[e.index].name=e.next,rebuildLayersUI?.();break;case"layer_move":this._moveLayer(e.from,e.to);break;case"add_layer":this._insertLayer(e.index,e.addedLayer);break;case"remove_layer":this._removeLayerAt(e.index);break;case"clear_project":this._restoreProject(e.afterAll);break;case"merge_layers":{if(!Array.isArray(e.removed)||!e.added)break;const t=e.removed.map(e=>e.index).sort((e,t)=>t-e);for(const e of t)this._removeLayerAt(e);this._insertLayer(e.added.index,e.added.data),activeLayerIndex=e.added.index,syncActiveAliases?.(),rebuildLayersUI?.();break}case"layer_transform":applyLayerTransformState(e.index,e.after)}},_applyInverse(e){switch(e.type){case"stroke":case"fill":case"transform_bake":e.before&&restoreLayerSnapshot(e.before);break;case"layer_visibility":layers[e.index].visible=e.prev;break;case"layer_opacity":layers[e.index].opacity=e.prev;break;case"layer_rename":layers[e.index].name=e.prev,rebuildLayersUI?.();break;case"layer_move":this._moveLayer(e.to,e.from);break;case"add_layer":this._removeLayerAt(e.index);break;case"remove_layer":this._insertLayer(e.index,e.removedLayer);break;case"clear_project":this._restoreProject(e.beforeAll);break;case"merge_layers":if(e.added&&this._removeLayerAt(e.added.index),Array.isArray(e.removed)){const t=e.removed.slice().sort((e,t)=>e.index-t.index);for(const e of t)this._insertLayer(e.index,e.data);activeLayerIndex=t[t.length-1]?.index??0,syncActiveAliases?.(),rebuildLayersUI?.()}break;case"layer_transform":applyLayerTransformState(e.index,e.before)}},_moveLayer(e,t){if(e===t)return;const a=layers.splice(e,1)[0];layers.splice(t,0,a),activeLayerIndex=t,syncActiveAliases?.(),rebuildLayersUI?.()},_removeLayerAt(e){const t=layers[e];if(t){try{gl.deleteTexture(t.texture)}catch{}try{gl.deleteFramebuffer(t.fbo)}catch{}layers.splice(e,1),activeLayerIndex=Math.max(0,Math.min(activeLayerIndex,layers.length-1)),syncActiveAliases?.(),rebuildLayersUI?.()}},_insertLayer(e,t){const a={id:Date.now()+Math.random(),name:t?.name??"Layer",visible:t?.visible??!0,opacity:t?.opacity??1,ox:0,oy:0,texW:fixedFBOWidth,texH:fixedFBOHeight,x:0,y:0,scaleX:1,scaleY:1,rotation:0,px:.5*fixedFBOWidth,py:.5*fixedFBOHeight,texture:null,fbo:null},r=createLayerFBO(fixedFBOWidth,fixedFBOHeight);a.texture=r.texture,a.fbo=r.fbo,layers.splice(e,0,a),t?.snapshot&&t.snapshot.pixels?applySnapshotToLayer(e,t.snapshot):(gl.bindTexture(gl.TEXTURE_2D,a.texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,fixedFBOWidth,fixedFBOHeight,0,gl.RGBA,gl.UNSIGNED_BYTE,null),a.texW=fixedFBOWidth,a.texH=fixedFBOHeight),activeLayerIndex=e,syncActiveAliases?.(),rebuildLayersUI?.()},_captureProject:()=>({w:fixedFBOWidth,h:fixedFBOHeight,layers:layers.map((e,t)=>({index:t,name:e.name,visible:e.visible,opacity:e.opacity,snapshot:snapshotLayer(t)})),background:(()=>{try{if(!currentImage)return null;const e=document.createElement("canvas");e.width=fixedFBOWidth,e.height=fixedFBOHeight;return e.getContext("2d").drawImage(currentImage,0,0,fixedFBOWidth,fixedFBOHeight),e.toDataURL("image/png")}catch{return null}})()}),_restoreProject(e){if(e)try{for(const e of layers){try{gl.deleteTexture(e.texture)}catch{}try{gl.deleteFramebuffer(e.fbo)}catch{}}if(layers=[],e.background){const t=new Image;t.onload=()=>{currentImage=t,updateCanvasSize(t),createTextureFromImage(t),needsRedraw=!0,requestDrawIfIdle?.()},t.src=e.background}else currentImage=null,texture=null;for(const t of e.layers)this._insertLayer(layers.length,{name:t.name,visible:t.visible,opacity:t.opacity,snapshot:t.snapshot});activeLayerIndex=Math.max(0,layers.length-1),syncActiveAliases?.(),rebuildLayersUI?.(),needsRedraw=!0,requestDrawIfIdle?.()}catch(e){console.error("[History] _restoreProject failed:",e)}}};let __strokeBeforeSnap=null,__strokeInProgress=!1;function beginStrokeHistory(){try{if(__strokeInProgress)return;const e=getActiveLayer?.();if(!e)return;__strokeInProgress=!0,__strokeBeforeSnap=snapshotLayer(activeLayerIndex),console.log("[History] begin stroke on layer",activeLayerIndex)}catch(e){console.warn("beginStrokeHistory",e),__strokeInProgress=!1,__strokeBeforeSnap=null}}function endStrokeHistory(e="stroke"){try{const t=getActiveLayer?.();if(!t||!__strokeInProgress||!__strokeBeforeSnap)return __strokeInProgress=!1,void(__strokeBeforeSnap=null);requestAnimationFrame(()=>{try{gl.flush?.(),gl.finish?.();const t=snapshotLayer(activeLayerIndex);!function(e,t){if(!e||!t)return!1;if(e.w!==t.w||e.h!==t.h)return!1;const a=e.pixels,r=t.pixels;if(!a||!r||a.length!==r.length)return!1;const n=a.length;for(let e=0;e<n;e+=128)if(a[e]!==r[e]||a[e+1]!==r[e+1]||a[e+2]!==r[e+2]||a[e+3]!==r[e+3])return!1;const o=n-4;return a[o]===r[o]&&a[o+1]===r[o+1]&&a[o+2]===r[o+2]&&a[o+3]===r[o+3]}(__strokeBeforeSnap,t)?(History.push({type:e,before:__strokeBeforeSnap,after:t}),console.log("[History] commit stroke",{type:e,layer:activeLayerIndex})):console.log("[History] skip no-op stroke",{layer:activeLayerIndex})}catch(e){console.warn("endStrokeHistory/commit",e)}finally{__strokeInProgress=!1,__strokeBeforeSnap=null,needsRedraw=!0,requestDrawIfIdle?.()}})}catch(e){console.warn("endStrokeHistory",e),__strokeInProgress=!1,__strokeBeforeSnap=null}}function undoStroke(){History.undo()}function redoStroke(){History.redoDo()}try{document.getElementById("undoButton").removeEventListener?.("click",undoStroke),document.getElementById("redoButton").removeEventListener?.("click",redoStroke)}catch{}function performFloodFill(e,t){const a=getActiveLayer();if(!a)return;const r=snapshotLayer(activeLayerIndex),n=Math.max(0,Math.min(fixedFBOWidth-1,Math.round(e))),o=Math.max(0,Math.min(fixedFBOHeight-1,Math.round(t))),i=fixedFBOHeight-1-o,l=new Uint8Array(4);gl.bindFramebuffer(gl.FRAMEBUFFER,a.fbo),gl.readPixels(n,i,1,1,gl.RGBA,gl.UNSIGNED_BYTE,l),gl.bindFramebuffer(gl.FRAMEBUFFER,null);runFloodFillShader(a,[l[0]/255,l[1]/255,l[2]/255,l[3]/255],tintColor);const s=snapshotLayer(activeLayerIndex);History.push({type:"fill",before:r,after:s}),needsRedraw=!0}function endTransform(e=!0){if(!(transformTool&&transformTool.mode&&"idle"!==transformTool.mode)){try{isTwoFingerGesture=!1,pinchStart=null}catch{}return transformTool&&(transformTool.mode="idle"),needsRedraw=!0,void requestDrawIfIdle?.()}try{stopRender?.("transform")}catch{}let t=!1,a=null,r=null;try{promoteLayerForScale?.(1.25)}catch{}try{e&&activeLayerWouldClip()&&(e=!1,showStatusMessage?.("Skipped bake to prevent off-canvas cropping","info"))}catch{}if(e)try{a=snapshotLayer?.(activeLayerIndex),applyActiveLayerTransform?.(),r=snapshotLayer?.(activeLayerIndex),a&&r&&History?.push&&History.push({type:"transform_bake",before:a,after:r}),t=!0}catch(e){console.warn("[endTransform] Bake failed:",e),t=!1}try{transformTool.start=null,transformTool.ref=null,transformTool.shiftInvert=!1,transformTool.pivotCanvas=null}catch{}transformTool&&(transformTool.mode="idle");try{isTwoFingerGesture=!1,pinchStart=null}catch{}const n=getActiveLayer?.(),o=!(!n||!n.transformLocked);transformTool&&(transformTool.mobileCombo=o),o&&queueMicrotask?.(()=>startTransform?.("grab")),showStatusMessage?.(t?"Transform applied":e?"Transform failed":"Transform cancelled",t?"success":e?"warning":"info"),needsRedraw=!0,requestDrawIfIdle?.()}function recordLayerVisibilityChange(e,t,a){History.push({type:"layer_visibility",index:e,prev:t,next:a})}function recordLayerOpacityChange(e,t,a){History.push({type:"layer_opacity",index:e,prev:t,next:a})}function recordLayerRename(e,t,a){History.push({type:"layer_rename",index:e,prev:t,next:a})}function recordLayerMove(e,t){History.push({type:"layer_move",from:e,to:t})}function recordAddLayer(e){const t=snapshotLayer(e);History.push({type:"add_layer",index:e,addedLayer:{name:layers[e].name,visible:layers[e].visible,opacity:layers[e].opacity,snapshot:t}})}function recordRemoveLayer(e,t){History.push({type:"remove_layer",index:e,removedLayer:t})}function captureLayerDataForRemoval(e){const t=layers[e];return{name:t.name,visible:t.visible,opacity:t.opacity,snapshot:snapshotLayer(e)}}document.getElementById("undoButton").addEventListener("click",undoStroke),document.getElementById("redoButton").addEventListener("click",redoStroke),document.addEventListener("keydown",e=>{isUserTyping()||("z"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),undoStroke()),"y"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),redoStroke()))},{capture:!0}),canvas.addEventListener("pointerdown",()=>{beginStrokeHistory()},{capture:!0}),canvas.addEventListener("pointerup",()=>{endStrokeHistory("stroke")},{capture:!0});const __moveLayerUp=moveLayerUp;moveLayerUp=function(e){const t=Math.min(layers.length-1,e+1);e!==t&&(__moveLayerUp(e),recordLayerMove(e,t))};const __moveLayerDown=moveLayerDown;moveLayerDown=function(e){const t=Math.max(0,e-1);e!==t&&(__moveLayerDown(e),recordLayerMove(e,t))};const __removeActiveLayer=removeActiveLayer;removeActiveLayer=function(){if(layers.length<=1)return void __removeActiveLayer();const e=activeLayerIndex,t=captureLayerDataForRemoval(e);__removeActiveLayer(),recordRemoveLayer(e,t)};const __addLayer=addLayer;addLayer=function(e=`Layer ${layers.length+1}`,t=activeLayerIndex){__addLayer(e,t),recordAddLayer(activeLayerIndex)};const __rebuildLayersUI=rebuildLayersUI;function recordClearProject(e,t){History.push({type:"clear_project",beforeAll:e,afterAll:t})}rebuildLayersUI=function(){__rebuildLayersUI();try{const e=document.getElementById("layersList");if(!e)return;e.querySelectorAll(".layer-item").forEach(e=>{const t=Number(e.getAttribute("data-index")),a=e.querySelector(".layer-vis button.bs.icon-btn");if(a&&!a.__hp_vis_hist_patched){a.__hp_vis_hist_patched=!0;const e=a.onclick;a.onclick=a=>{const r=layers[t].visible;e?.(a);const n=layers[t].visible;r!==n&&recordLayerVisibilityChange(t,r,n)}}const r=e.querySelector(".layer-opacity input[type='range']");if(r&&!r.__hp_op_hist_patched){r.__hp_op_hist_patched=!0;let e=layers[t].opacity;r.addEventListener("change",()=>{const a=layers[t].opacity;e!==a&&(recordLayerOpacityChange(t,e,a),e=a)})}const n=e.querySelector(".layer-name input");if(n&&!n.__hp_name_hist_patched){n.__hp_name_hist_patched=!0;let e=layers[t].name;n.addEventListener("blur",()=>{const a=layers[t].name;e!==a&&(recordLayerRename(t,e,a),e=a)}),n.addEventListener("change",()=>{const a=layers[t].name;e!==a&&(recordLayerRename(t,e,a),e=a)})}})}catch(e){console.warn("rebuildLayersUI history patch",e)}};let isErasing=!1;function updateEraserSliderVisibility(){const e=document.getElementById("eraseStrengthSlider");e&&(e.style.display=isErasing?"block":"none")}function toggleEraser(){isErasing=!isErasing,updateEraserSliderVisibility(),updateEraserButton(),showStatusMessage(isErasing?"Mode: Erase":"Mode: Paint","info")}function updateEraserButton(){document.querySelector("#eraserToggle").innerHTML=isErasing?'<img src="/static/draw/images/icons/eraser.svg" alt="Erase">':'<img src="/static/draw/images/icons/brush.svg" alt="Brush">',needsRedraw=!0}document.addEventListener("keydown",e=>{isUserTyping()||"e"===e.key.toLowerCase()&&toggleEraser()}),document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector("#eraserToggle");e&&(e.addEventListener("click",toggleEraser),updateEraserButton())}),document.addEventListener("keydown",e=>{isUserTyping()||(","===e.key?(eraseStrength=Math.max(0,eraseStrength-.01),updateEraserSliderUI()):"."===e.key&&(eraseStrength=Math.min(1,eraseStrength+.01),updateEraserSliderUI()))});let lineMode=!0,lineStepFactor=.02,lastFx=null,lastFy=null;function drawSingleBrushStamp(e,t,a=null,r=null){const n=getActiveLayer();if(!n||!gl)return;const o=0|fixedFBOWidth,i=0|fixedFBOHeight;let l=Math.max(1,0|(Number(n.texW)||o)),s=Math.max(1,0|(Number(n.texH)||i)),c=Number.isFinite(n.ox)?n.ox:0,d=Number.isFinite(n.oy)?n.oy:0,g=Number.isFinite(n.px)?n.px:c+.5*l,u=Number.isFinite(n.py)?n.py:d+.5*s;const m=Number.isFinite(n.x)?n.x:0,f=Number.isFinite(n.y)?n.y:0,h=Number.isFinite(n.scaleX)?n.scaleX:1,y=Number.isFinite(n.scaleY)?n.scaleY:1,p=Number.isFinite(n.rotation)?n.rotation:0,E=!Number.isFinite(n.px)||!Number.isFinite(n.py),x=g,v=u;let b=e-m,T=t-f;b-=g,T-=u;const w=Math.cos(-p),L=Math.sin(-p),A=b*w-T*L,F=b*L+T*w;let R=(0!==h?A/h:A)+g-c,_=(0!==y?F/y:F)+u-d;const I=(a??brushSize)*o,B=.5*I,P=.5*(I/brushAspect),S=r??currentAngle,M=Math.cos(S),U=Math.sin(S),D=(e,t)=>({x:e*M-t*U,y:e*U+t*M});let C=D(-B,-P),N=D(B,-P),O=D(-B,P),k=D(B,P),X=R+C.x,W=_+C.y,H=R+N.x,Y=_+N.y,G=R+O.x,q=_+O.y,z=R+k.x,V=_+k.y,$=Math.min(X,H,G,z),j=Math.min(W,Y,q,V),K=Math.max(X,H,G,z),J=Math.max(W,Y,q,V);const Q=1.5,Z=$<0,ee=j<0,te=K>l,ae=J>s;if(Z||ee||te||ae){const e=Z?Math.ceil(-$):0,t=ee?Math.ceil(-j):0,a=te?Math.ceil(K-l):0,r=ae?Math.ceil(J-s):0,o=e?Math.ceil((e+4)*Q):0,i=t?Math.ceil((t+4)*Q):0,m=l+o+(a?Math.ceil((a+4)*Q):0),f=s+i+(r?Math.ceil((r+4)*Q):0),h=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,h),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,m,f,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);const y=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,y),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,h,0),gl.viewport(0,0,m,f),gl.disable(gl.BLEND),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);const p=gl.getUniformLocation(quadProgram,"u_texture")||gl.getUniformLocation(quadProgram,"u_image"),b=gl.getUniformLocation(quadProgram,"u_flipY"),T=gl.getUniformLocation(quadProgram,"u_resolution"),w=gl.getUniformLocation(quadProgram,"u_layerOpacity");b&&gl.uniform1f(b,1),T&&gl.uniform2f(T,m,f),w&&gl.uniform1f(w,1);const L=new Float32Array([o,i,0,0,o+l,i,1,0,o,i+s,0,1,o,i+s,0,1,o+l,i,1,0,o+l,i+s,1,1]),A=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,A),gl.bufferData(gl.ARRAY_BUFFER,L,gl.STREAM_DRAW);const F=gl.getAttribLocation(quadProgram,"a_position"),I=gl.getAttribLocation(quadProgram,"a_texCoord");gl.enableVertexAttribArray(F),gl.vertexAttribPointer(F,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(I),gl.vertexAttribPointer(I,2,gl.FLOAT,!1,16,8),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,n.texture),p&&gl.uniform1i(p,0),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(F),gl.disableVertexAttribArray(I),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(A);const B=n.texture,P=n.fbo;n.texture=h,n.fbo=y,n.texW=l=m,n.texH=s=f,n.ox=c-=o,n.oy=d-=i,E&&(n.px=x,n.py=v,g=n.px,u=n.py),R+=o,_+=i,X+=o,H+=o,G+=o,z+=o,W+=i,Y+=i,q+=i,V+=i,gl.deleteFramebuffer(P),gl.deleteTexture(B)}gl.bindFramebuffer(gl.FRAMEBUFFER,n.fbo),gl.viewport(0,0,l,s),gl.disable(gl.SCISSOR_TEST),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.useProgram(paintProgram),gl.enable(gl.BLEND),isErasing?gl.blendFuncSeparate(gl.ZERO,gl.ONE,gl.ZERO,gl.ONE_MINUS_SRC_ALPHA):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);const re=gl.getUniformLocation(paintProgram,"u_flipY");re&&gl.uniform1f(re,1);const ne=gl.getUniformLocation(paintProgram,"u_resolution");ne&&gl.uniform2f(ne,l,s);const oe=gl.getUniformLocation(paintProgram,"u_erase");oe&&gl.uniform1i(oe,isErasing?1:0);const ie=gl.getUniformLocation(paintProgram,"u_eraseStrength");ie&&gl.uniform1f(ie,eraseStrength);const le=gl.getUniformLocation(paintProgram,"u_paintStrength");le&&gl.uniform1f(le,paintStrength);const se=gl.getUniformLocation(paintProgram,"u_tint");se&&gl.uniform4fv(se,tintColor),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,overlayTexture);const ce=gl.getUniformLocation(paintProgram,"u_brushTex"),de=gl.getUniformLocation(paintProgram,"u_brush");ce&&gl.uniform1i(ce,0),de&&gl.uniform1i(de,0);const ge=new Float32Array([X,W,0,0,H,Y,1,0,G,q,0,1,G,q,0,1,H,Y,1,0,z,V,1,1]),ue=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,ue),gl.bufferData(gl.ARRAY_BUFFER,ge,gl.STREAM_DRAW);const me=gl.getAttribLocation(paintProgram,"a_position"),fe=gl.getAttribLocation(paintProgram,"a_texCoord");gl.enableVertexAttribArray(me),gl.vertexAttribPointer(me,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(fe),gl.vertexAttribPointer(fe,2,gl.FLOAT,!1,16,8),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(me),gl.disableVertexAttribArray(fe),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(ue),gl.bindFramebuffer(gl.FRAMEBUFFER,null),needsRedraw=!0,requestDrawIfIdle?.()}function drawBrushStrokeToPaintLayer(e,t){if(!canPaint())return;if(!(gl&&layers.length&&overlayTexture&&getActiveLayer()))return;if(!Number.isFinite(e)||!Number.isFinite(t))return;if(e<0||t<0||e>canvas.width||t>canvas.height)return;const a=e*(fixedFBOWidth/canvas.width),r=t*(fixedFBOHeight/canvas.height),n=getActiveLayer();let o=1;if(void 0!==dynamicModeEnabled&&dynamicModeEnabled&&(o=void 0!==intuitiveMode&&intuitiveMode?.8+.8*Math.random():1.5-Math.random()),void 0===window.__stampCarry&&(window.__stampCarry=0),void 0===window.__angleEMA&&(window.__angleEMA=null),n.__lastDoc||(n.__lastDoc=null),!n.__lastDoc){let i=currentAngle;return void 0!==reverseModeEnabled&&reverseModeEnabled&&(i+=Math.PI),drawSingleBrushStamp(a,r,brushSize*o,i),n.__lastDoc={x:a,y:r},lastFx=a,lastFy=r,lastX=e,lastY=t,needsRedraw=!0,strokeCount++,void(void 0!==FLATTEN_THRESHOLD&&strokeCount>=FLATTEN_THRESHOLD&&flattenStrokes?.())}const i=a-n.__lastDoc.x,l=r-n.__lastDoc.y,s=Math.hypot(i,l);let c=Math.atan2(l,i);if(null==window.__angleEMA)window.__angleEMA=c;else{const e=.35;let t=window.__angleEMA,a=c;for(;a-t>Math.PI;)a-=2*Math.PI;for(;a-t<-Math.PI;)a+=2*Math.PI;window.__angleEMA=t+(a-t)*e,c=window.__angleEMA}void 0!==reverseModeEnabled&&reverseModeEnabled&&(c+=Math.PI);const d=Math.max(1,brushSize*fixedFBOWidth),g=Math.max(1e-6,.3*d),u=Math.min(2.5,s/g),m=brushSize*u*o;let f=d*(void 0!==lineStepFactor?lineStepFactor:.3)*u*o;f=Math.max(.5,f);let h=Math.max(0,f-window.__stampCarry);if(lineMode){for(;h<=s;){const e=h/s;drawSingleBrushStamp(n.__lastDoc.x+i*e,n.__lastDoc.y+l*e,m,c),h+=f}window.__stampCarry=h-s}else drawSingleBrushStamp(a,r,m,c),window.__stampCarry=(f-s%f)%f;n.__lastDoc={x:a,y:r},lastFx=a,lastFy=r,lastX=e,lastY=t,strokeCount++,void 0!==FLATTEN_THRESHOLD&&strokeCount>=FLATTEN_THRESHOLD&&flattenStrokes?.(),needsRedraw=!0}function drawBrushStrokeToPaintLayer(e,t){if(!canPaint())return;if(!(gl&&layers.length&&overlayTexture&&getActiveLayer()))return;if(!Number.isFinite(e)||!Number.isFinite(t))return;if(e<0||t<0||e>canvas.width||t>canvas.height)return;const a=e*(fixedFBOWidth/canvas.width),r=t*(fixedFBOHeight/canvas.height);if(void 0===window.__stampCarry&&(window.__stampCarry=0),void 0===window.__angleEMA&&(window.__angleEMA=null),null===lastFx||null===lastFy){let n=1;dynamicModeEnabled&&(n=intuitiveMode?.8+.8*Math.random():1.5-Math.random());let o=currentAngle;return reverseModeEnabled&&(o+=Math.PI),drawSingleBrushStamp(a,r,brushSize*n,o),lastFx=a,lastFy=r,lastX=e,lastY=t,needsRedraw=!0,strokeCount++,void(strokeCount>=FLATTEN_THRESHOLD&&flattenStrokes())}const n=a-lastFx,o=r-lastFy,i=Math.hypot(n,o);if(i<=1e-6)return;const l=Math.atan2(o,n);if(null===window.__angleEMA)window.__angleEMA=l;else{const e=window.__angleEMA,t=Math.cos(e),a=Math.sin(e),r=.25,n=(1-r)*t+r*Math.cos(l),o=(1-r)*a+r*Math.sin(l);window.__angleEMA=Math.atan2(o,n)}let s=window.__angleEMA;reverseModeEnabled&&(s+=Math.PI);let c=1;dynamicModeEnabled&&(c=intuitiveMode?.8+.8*Math.random():1.5-Math.random());const d=Math.max(1,brushSize*fixedFBOWidth),g=Math.max(1e-6,.3*d),u=Math.min(2.5,i/g),m=brushSize*u*c;let f=d*lineStepFactor*u*c;f=Math.max(.5,f);let h=Math.max(0,f-window.__stampCarry);if(lineMode){for(;h<=i;){const e=h/i;drawSingleBrushStamp(lastFx+n*e,lastFy+o*e,m,s),h+=f}window.__stampCarry=h-i}else drawSingleBrushStamp(a,r,m,s),window.__stampCarry=(f-i%f)%f;lastFx=a,lastFy=r,lastX=e,lastY=t,strokeCount++,strokeCount>=FLATTEN_THRESHOLD&&flattenStrokes(),needsRedraw=!0}function drawBrushOverlay(){gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.useProgram(overlayProgram);let e=gl.getUniformLocation(overlayProgram,"u_flipY");gl.uniform1f(e,-1);let t=gl.getUniformLocation(overlayProgram,"u_resolution");gl.uniform2f(t,canvas.width,canvas.height);let a=gl.getUniformLocation(overlayProgram,"u_tint");gl.uniform4fv(a,tintColor);const r=overlayPosition[0]*canvas.width,n=overlayPosition[1]*canvas.height,o=brushSize*canvas.width,i=o/2,l=o/brushAspect/2,s=[{x:-i,y:-l},{x:i,y:-l},{x:-i,y:l},{x:i,y:l}],c=Math.cos(currentAngle),d=Math.sin(currentAngle);const g=s.map(function(e){return{x:e.x*c-e.y*d,y:e.x*d+e.y*c}}),u={x:r+g[0].x,y:n+g[0].y},m={x:r+g[1].x,y:n+g[1].y},f={x:r+g[2].x,y:n+g[2].y},h={x:r+g[3].x,y:n+g[3].y},y=new Float32Array([u.x,u.y,0,0,m.x,m.y,1,0,f.x,f.y,0,1,f.x,f.y,0,1,m.x,m.y,1,0,h.x,h.y,1,1]),p=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,p),gl.bufferData(gl.ARRAY_BUFFER,y,gl.STREAM_DRAW);let E=gl.getAttribLocation(overlayProgram,"a_position");gl.enableVertexAttribArray(E),gl.vertexAttribPointer(E,2,gl.FLOAT,!1,16,0);let x=gl.getAttribLocation(overlayProgram,"a_texCoord");gl.enableVertexAttribArray(x),gl.vertexAttribPointer(x,2,gl.FLOAT,!1,16,8),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,overlayTexture);const v=gl.getUniformLocation(overlayProgram,"u_brush");gl.uniform1i(v,0),gl.drawArrays(gl.TRIANGLES,0,6),gl.deleteBuffer(p),gl.disableVertexAttribArray(E),gl.disableVertexAttribArray(x)}function activeLayerWouldClip(){const e=getActiveLayer?.();if(!e)return!1;const t=0|fixedFBOWidth,a=0|fixedFBOHeight,r=Number.isFinite(e.ox)?e.ox:0,n=Number.isFinite(e.oy)?e.oy:0,o=Math.max(1,Number.isFinite(e.texW)?e.texW:t),i=Math.max(1,Number.isFinite(e.texH)?e.texH:a),l=Number.isFinite(e.scaleX)?e.scaleX:1,s=Number.isFinite(e.scaleY)?e.scaleY:1,c=Number.isFinite(e.rotation)?e.rotation:0,d=Number.isFinite(e.x)?e.x:0,g=Number.isFinite(e.y)?e.y:0,u=Number.isFinite(e.px)?e.px:.5*t,m=Number.isFinite(e.py)?e.py:.5*a,f=Math.cos(c),h=Math.sin(c);function y(e,t){const a=(e-u)*l,r=(t-m)*s;return{x:u+a*f-r*h+d,y:m+a*h+r*f+g}}const p=y(r,n),E=y(r+o,n),x=y(r,n+i),v=y(r+o,n+i);return p.x<0||p.y<0||p.x>t||p.y>a||E.x<0||E.y<0||E.x>t||E.y>a||x.x<0||x.y<0||x.x>t||x.y>a||v.x<0||v.y<0||v.x>t||v.y>a}function applyActiveLayerTransform(){const e=getActiveLayer?.();if(!(gl&&e&&e.texture&&quadProgram))return;const t=0|fixedFBOWidth,a=0|fixedFBOHeight,r=gl.getParameter(gl.FRAMEBUFFER_BINDING),n=gl.getParameter(gl.CURRENT_PROGRAM),o=gl.getParameter(gl.VIEWPORT),i=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,i),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,t,a,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);const l=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,l),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,i,0),gl.viewport(0,0,t,a),gl.disable(gl.BLEND),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT);const s=Number.isFinite(e.ox)?e.ox:0,c=Number.isFinite(e.oy)?e.oy:0,d=Math.max(1,Number.isFinite(e.texW)?e.texW:t),g=Math.max(1,Number.isFinite(e.texH)?e.texH:a),u=Number.isFinite(e.scaleX)?e.scaleX:1,m=Number.isFinite(e.scaleY)?e.scaleY:1,f=Number.isFinite(e.rotation)?e.rotation:0,h=Number.isFinite(e.x)?e.x:0,y=Number.isFinite(e.y)?e.y:0,p=Number.isFinite(e.px)?e.px:.5*t,E=Number.isFinite(e.py)?e.py:.5*a,x=Math.cos(f),v=Math.sin(f);function b(e,t){let a=(e-p)*u,r=(t-E)*m;return{x:p+(a*x-r*v)+h,y:E+(a*v+r*x)+y}}const T=b(s,c),w=b(s+d,c),L=b(s,c+g),A=b(s+d,c+g);gl.useProgram(quadProgram);const F=gl.getUniformLocation(quadProgram,"u_texture"),R=gl.getUniformLocation(quadProgram,"u_resolution"),_=gl.getUniformLocation(quadProgram,"u_flipY"),I=gl.getUniformLocation(quadProgram,"u_layerOpacity");R&&gl.uniform2f(R,t,a),_&&gl.uniform1f(_,1),I&&gl.uniform1f(I,Math.max(0,Math.min(1,e.opacity??1)));const B=new Float32Array([T.x,T.y,0,0,w.x,w.y,1,0,L.x,L.y,0,1,L.x,L.y,0,1,w.x,w.y,1,0,A.x,A.y,1,1]),P=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,P),gl.bufferData(gl.ARRAY_BUFFER,B,gl.STREAM_DRAW);const S=gl.getAttribLocation(quadProgram,"a_position"),M=gl.getAttribLocation(quadProgram,"a_texCoord");gl.enableVertexAttribArray(S),gl.vertexAttribPointer(S,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(M),gl.vertexAttribPointer(M,2,gl.FLOAT,!1,16,8),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,e.texture),F&&gl.uniform1i(F,0),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(S),gl.disableVertexAttribArray(M),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(P),gl.bindTexture(gl.TEXTURE_2D,e.texture);((0|e.texW)!==t||(0|e.texH)!==a)&&(gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,t,a,0,gl.RGBA,gl.UNSIGNED_BYTE,null),e.fbo||(e.fbo=gl.createFramebuffer()),gl.bindFramebuffer(gl.FRAMEBUFFER,e.fbo),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,e.texture,0));const U=new Uint8Array(t*a*4);gl.readPixels(0,0,t,a,gl.RGBA,gl.UNSIGNED_BYTE,U),gl.bindTexture(gl.TEXTURE_2D,e.texture),gl.texSubImage2D(gl.TEXTURE_2D,0,0,0,t,a,gl.RGBA,gl.UNSIGNED_BYTE,U),e.ox=0,e.oy=0,e.texW=t,e.texH=a,e.x=0,e.y=0,e.scaleX=1,e.scaleY=1,e.rotation=0,e.px=.5*t,e.py=.5*a,gl.bindFramebuffer(gl.FRAMEBUFFER,r),gl.useProgram(n),o&&gl.viewport(o[0],o[1],o[2],o[3]);try{gl.deleteFramebuffer(l)}catch{}try{gl.deleteTexture(i)}catch{}needsRedraw=!0,"function"==typeof requestDrawIfIdle&&requestDrawIfIdle()}function drawScene(){if(!gl||!quadProgram||!canvas)return;const e="undefined"!=typeof navigator&&navigator.maxTouchPoints>0||"undefined"!=typeof window&&"ontouchstart"in window;if(gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.viewport(0,0,canvas.width,canvas.height),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.SCISSOR_TEST),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),texture&&gl.isTexture(texture)){const e=new Float32Array([0,0,0,0,canvas.width,0,1,0,0,canvas.height,0,1,0,canvas.height,0,1,canvas.width,0,1,0,canvas.width,canvas.height,1,1]);gl.disable(gl.BLEND),function(e,t,a,r){if(!e||!t||!gl.isTexture(t))return;gl.useProgram(e);const n=gl.getUniformLocation(e,"u_flipY");n&&gl.uniform1f(n,-1);const o=gl.getUniformLocation(e,"u_resolution");o&&gl.uniform2f(o,canvas.width,canvas.height);const i=gl.getUniformLocation(e,"u_layerOpacity");i&&gl.uniform1f(i,null!=r?r:1);const l=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,l),gl.bufferData(gl.ARRAY_BUFFER,a,gl.STREAM_DRAW);const s=gl.getAttribLocation(e,"a_position"),c=gl.getAttribLocation(e,"a_texCoord");s>=0&&(gl.enableVertexAttribArray(s),gl.vertexAttribPointer(s,2,gl.FLOAT,!1,16,0)),c>=0&&(gl.enableVertexAttribArray(c),gl.vertexAttribPointer(c,2,gl.FLOAT,!1,16,8)),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,t);const d=gl.getUniformLocation(e,"u_texture")??gl.getUniformLocation(e,"u_brush");d&&gl.uniform1i(d,0),gl.drawArrays(gl.TRIANGLES,0,6),s>=0&&gl.disableVertexAttribArray(s),c>=0&&gl.disableVertexAttribArray(c),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(l)}(quadProgram,texture,e,1)}if(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),Array.isArray(layers))for(let e=0;e<layers.length;e++){const t=layers[e];!t||!t.visible||t.opacity<=0||t.texture&&gl.isTexture(t.texture)&&drawLayerWithTransform(quadProgram,t)}gl.disable(gl.BLEND);const t=!(!transformTool||"idle"===transformTool.mode),a=t&&!e;if((isDrawing||t||brushHUD.visible)&&overlayProgram&&overlayTexture&&gl.isTexture(overlayTexture)&&"function"==typeof drawBrushOverlay){gl.useProgram(overlayProgram);const e=gl.getUniformLocation(overlayProgram,"u_flipY");e&&gl.uniform1f(e,-1);const t=gl.getUniformLocation(overlayProgram,"u_resolution");if(t&&gl.uniform2f(t,canvas.width,canvas.height),drawBrushOverlay(),a){const e=overlayPosition[0]*canvas.width,t=overlayPosition[1]*canvas.height,a=brushSize*canvas.width,r=1.5*a,n=Math.max(1,.06*a);"function"==typeof drawRingOverlay&&drawRingOverlay(e,t,r,n,[1,0,0,.95]);"function"==typeof drawDashedLine&&drawDashedLine(lastPointer?.cx??e,lastPointer?.cy??t,e,t,1.5,10,6,[1,0,0,.95])}}if(t&&"object"==typeof touchViz&&touchViz?.visible&&Array.isArray(touchViz.pts)&&touchViz.pts.length&&"function"==typeof drawRingOverlay){if(overlayProgram){gl.useProgram(overlayProgram);const e=gl.getUniformLocation(overlayProgram,"u_flipY");e&&gl.uniform1f(e,-1);const t=gl.getUniformLocation(overlayProgram,"u_resolution");t&&gl.uniform2f(t,canvas.width,canvas.height)}const e=[0,1,0,.95],t=20*(window.devicePixelRatio||1),a=2*(window.devicePixelRatio||1),r=2,n=10,o=6;for(const r of touchViz.pts)drawRingOverlay(r.x,r.y,t,a,e);if(2===touchViz.pts.length&&"function"==typeof drawDashedLine){const t=touchViz.pts[0],a=touchViz.pts[1];drawDashedLine(t.x,t.y,a.x,a.y,r,n,o,e)}}gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null),gl.useProgram(null),maybeAutoHideBrushHUD()}document.addEventListener("keydown",e=>{if("function"==typeof isUserTyping&&isUserTyping())return;if(void 0!==spacePanning&&spacePanning)return;if(void 0!==isDrawing&&isDrawing)return;if(e.ctrlKey||e.metaKey||e.altKey)return;const t=e.key,a=t.toLowerCase(),r="ArrowUp"===t||"ArrowDown"===t||"ArrowLeft"===t||"ArrowRight"===t,n=Math.PI/180;if(e.shiftKey&&"d"===a){e.preventDefault(),e.stopImmediatePropagation();const t=Array.isArray(layers)?layers.length:0;try{"function"==typeof duplicateLayer&&duplicateLayer("number"==typeof activeLayerIndex?activeLayerIndex:void 0)}catch{}if((Array.isArray(layers)?layers.length:0)>t){try{const e="function"==typeof getActiveLayer?getActiveLayer():layers&&layers[activeLayerIndex]?layers[activeLayerIndex]:null;e&&(e.x=(Number.isFinite(e.x)?e.x:0)+10,e.y=(Number.isFinite(e.y)?e.y:0)+10,"function"==typeof startTransform&&startTransform("grab"))}catch{}try{rebuildLayersUI?.()}catch{}try{showStatusMessage?.("Layer duplicated (Shift+D)","success")}catch{}needsRedraw=!0,"function"==typeof requestDrawIfIdle&&requestDrawIfIdle()}return}if("function"==typeof isMobile&&!isMobile()&&"idle"!==transformTool?.mode&&r){e.preventDefault(),e.stopImmediatePropagation();const a="function"==typeof getActiveLayer?getActiveLayer():null;if(!a)return;Number.isFinite(a.x)||(a.x=0),Number.isFinite(a.y)||(a.y=0),Number.isFinite(a.scaleX)||(a.scaleX=1),Number.isFinite(a.scaleY)||(a.scaleY=1),Number.isFinite(a.rotation)||(a.rotation=0);const r=transformTool.mode;if("grab"===r){const r=e.shiftKey?10:1;"ArrowLeft"===t&&(a.x-=r),"ArrowRight"===t&&(a.x+=r),"ArrowUp"===t&&(a.y-=r),"ArrowDown"===t&&(a.y+=r)}else if("scale"===r){const r=e.shiftKey?.1:.01,n=e=>Math.max(.001,e);if(e.shiftKey){const e="ArrowRight"===t||"ArrowUp"===t?1:"ArrowLeft"===t||"ArrowDown"===t?-1:0;if(0!==e){const t=1+e*r;a.scaleX=n(a.scaleX*t),a.scaleY=n(a.scaleY*t)}}else"ArrowLeft"===t?a.scaleX=n(a.scaleX*(1-r)):"ArrowRight"===t?a.scaleX=n(a.scaleX*(1+r)):"ArrowUp"===t?a.scaleY=n(a.scaleY*(1+r)):"ArrowDown"===t&&(a.scaleY=n(a.scaleY*(1-r)))}else if("rotate"===r){const r=e.shiftKey?5:1,o="ArrowRight"===t||"ArrowDown"===t?1:"ArrowLeft"===t||"ArrowUp"===t?-1:0;a.rotation+=o*r*n}else{const r=e.shiftKey?10:1;"ArrowLeft"===t&&(a.x-=r),"ArrowRight"===t&&(a.x+=r),"ArrowUp"===t&&(a.y-=r),"ArrowDown"===t&&(a.y+=r)}try{startRender?.("transform")}catch{}return needsRedraw=!0,void("function"==typeof requestDrawIfIdle&&requestDrawIfIdle())}if("function"==typeof isMobile&&!isMobile()&&"idle"===transformTool?.mode&&e.shiftKey&&("ArrowUp"===t||"ArrowDown"===t)){if(e.preventDefault(),e.stopImmediatePropagation(),!layers||!layers.length)return;const a=Number.isInteger(activeLayerIndex)?activeLayerIndex:0,r="ArrowUp"===t?1:-1,n=Math.max(0,Math.min(layers.length-1,a+r));if(n===a)return;const o=layers[a]?.name??"";!function(e,t){if(!Array.isArray(layers)||0===layers.length)return;if((e=Math.max(0,Math.min(layers.length-1,0|e)))===(t=Math.max(0,Math.min(layers.length-1,0|t))))return;const a=layers.splice(e,1)[0];layers.splice(t,0,a);const r=Number.isInteger(activeLayerIndex)?activeLayerIndex:0;r===e?activeLayerIndex=t:e<r&&r<=t?activeLayerIndex=r-1:t<=r&&r<e&&(activeLayerIndex=r+1);try{recordLayerReorder?.(e,t)}catch{}try{rebuildLayersUI?.()}catch{}try{syncActiveAliases?.()}catch{}needsRedraw=!0,"function"==typeof requestDrawIfIdle&&requestDrawIfIdle()}(a,n);try{showStatusMessage?.(`Moved ${o||"layer"} ${r>0?"up":"down"}`,"info")}catch{}return}if(!("function"!=typeof isMobile||isMobile()||"idle"!==transformTool?.mode||e.shiftKey||"ArrowUp"!==t&&"ArrowDown"!==t)){if(e.preventDefault(),e.stopImmediatePropagation(),!layers||!layers.length)return;try{"idle"!==transformTool?.mode&&endTransform(!1)}catch{}try{clearTransformLockAll?.()}catch{}const a="ArrowUp"===t?1:-1,r=Math.max(0,Math.min(layers.length-1,activeLayerIndex+a));if(r!==activeLayerIndex){activeLayerIndex=r;try{syncActiveAliases?.()}catch{}try{rebuildLayersUI?.()}catch{}try{showStatusMessage?.(`Selected: ${layers[activeLayerIndex].name}`,"info")}catch{}needsRedraw=!0,"function"==typeof requestDrawIfIdle&&requestDrawIfIdle()}return}if("h"===a){e.preventDefault(),e.stopImmediatePropagation();const t=activeLayerIndex,a=layers?.[t];if(!a)return;const r=!!a.visible,n=!r;a.visible=n;try{recordLayerVisibilityChange?.(t,r,n)}catch{}try{rebuildLayersUI?.()}catch{}try{showStatusMessage?.(n?"Layer visible":"Layer hidden","info")}catch{}return needsRedraw=!0,void("function"==typeof requestDrawIfIdle&&requestDrawIfIdle())}if("g"===a)return e.preventDefault(),e.stopImmediatePropagation(),void("function"==typeof startTransform&&startTransform("grab"));if("s"===a)return e.preventDefault(),e.stopImmediatePropagation(),void("function"==typeof startTransform&&startTransform("scale",e.shiftKey));if("r"===a)return e.preventDefault(),e.stopImmediatePropagation(),void("function"==typeof startTransform&&startTransform("rotate",e.shiftKey));if("Escape"===t&&"idle"!==transformTool?.mode){const t="function"==typeof getActiveLayer?getActiveLayer():null;return t&&transformTool.ref&&(t.x=transformTool.ref.x,t.y=transformTool.ref.y,t.scaleX=transformTool.ref.scaleX,t.scaleY=transformTool.ref.scaleY,t.rotation=transformTool.ref.rotation),"function"==typeof endTransform&&endTransform(!1),needsRedraw=!0,e.preventDefault(),void e.stopImmediatePropagation()}if(("Enter"===t||"Return"===t)&&"idle"!==transformTool?.mode)return"function"==typeof endTransform&&endTransform(),needsRedraw=!0,e.preventDefault(),void e.stopImmediatePropagation();if("t"===a){e.preventDefault(),e.stopImmediatePropagation();const t="function"==typeof getActiveLayer?getActiveLayer():null;if(!t)return;t.x=0,t.y=0,t.scaleX=1,t.scaleY=1,t.rotation=0;try{showStatusMessage?.("Layer transform reset","info")}catch{}return needsRedraw=!0,void("function"==typeof requestDrawIfIdle&&requestDrawIfIdle())}},{capture:!0});let dynamicModeEnabled=!1,reverseModeEnabled=!1,intuitiveMode=!0;function showStatusMessage(e,t="info"){console.log("showStatusMessage",e);const a=document.createElement("div");a.classList.add("status-message",t),a.innerText=e,document.body.appendChild(a),setTimeout(()=>{a.classList.add("fade-out"),setTimeout(()=>a.remove(),700)},700)}function downscaleImage(e,t,a){const r=Math.min(t/e.width,a/e.height,1);if(r<1){const t=document.createElement("canvas");t.width=Math.floor(e.width*r),t.height=Math.floor(e.height*r);return t.getContext("2d").drawImage(e,0,0,t.width,t.height),t.toDataURL("image/jpeg",.7)}return null}function downscaleImageToWindow(e){const t=window.innerWidth,a=window.innerHeight,r=Math.min(t/e.width,a/e.height,1);if(r<1){const t=document.createElement("canvas");t.width=Math.floor(e.width*r),t.height=Math.floor(e.height*r);return t.getContext("2d").drawImage(e,0,0,t.width,t.height),t.toDataURL("image/jpeg",.7)}return null}document.addEventListener("keydown",e=>{isUserTyping()||(e.shiftKey&&"e"===e.key.toLowerCase()&&(isErasing=!isErasing,showStatusMessage(isErasing?"Mode: Erase":"Mode: Paint","info"),needsRedraw=!0),e.shiftKey&&"g"===e.key.toLowerCase()&&(lineMode=!lineMode,showStatusMessage("Line Mode: "+(lineMode?"ON":"OFF"),"info"),needsRedraw=!0))}),imageLoader.addEventListener("change",e=>{console.log("[DEBUG] imageLoader change event fired:",e);const t=e.target.files[0];if(t){console.log("[DEBUG] Selected file:",t.name,t.type,t.size);const e=new FileReader;e.onerror=e=>{console.error("[DEBUG] FileReader error:",e)},e.onload=e=>{console.log("[DEBUG] FileReader onload triggered. Data length:",e.target.result.length);const t=new Image;t.onerror=e=>{console.error("[DEBUG] Image load error:",e)},t.onload=()=>{console.log("[DEBUG] Image loaded successfully. Dimensions:",t.width,t.height);const e=downscaleImageToWindow(t);e?(console.log("[DEBUG] Downscaled image to window dimensions."),t.src=e,t.onload=()=>{console.log("[DEBUG] Downscaled image loaded. Dimensions:",t.width,t.height),currentImage=t,fixedFBOWidth=t.width,fixedFBOHeight=t.height,console.log("[DEBUG] Calling initPaintLayerFixed()"),initPaintLayerFixed(),initFloodFillProgram(),console.log("[DEBUG] Calling updateCanvasSize(currentImage)"),updateCanvasSize(currentImage),console.log("[DEBUG] Calling createTextureFromImage(currentImage)"),createTextureFromImage(currentImage),canvas.offsetWidth,canvasWrapper.offsetWidth,zoomScale=1,panX=(canvasWrapper.clientWidth-canvas.width)/2,panY=(canvasWrapper.clientHeight-canvas.height)/2,updateCanvasTransform(),resetStrokeState(),needsRedraw=!0}):(console.log("[DEBUG] No downscaling needed."),currentImage=t,fixedFBOWidth=t.width,fixedFBOHeight=t.height,console.log("[DEBUG] Calling initPaintLayerFixed()"),initPaintLayerFixed(),initFloodFillProgram(),console.log("[DEBUG] Calling updateCanvasSize(currentImage)"),updateCanvasSize(currentImage),console.log("[DEBUG] Calling createTextureFromImage(currentImage)"),createTextureFromImage(currentImage),canvas.offsetWidth,canvasWrapper.offsetWidth,zoomScale=1,panX=(canvasWrapper.clientWidth-canvas.width)/2,panY=(canvasWrapper.clientHeight-canvas.height)/2,updateCanvasTransform(),resetStrokeState(),needsRedraw=!0)},console.log("[DEBUG] Setting image src to FileReader result"),t.src=e.target.result};try{e.readAsDataURL(t),console.log("[DEBUG] FileReader readAsDataURL called successfully")}catch(e){console.error("[DEBUG] Exception while reading file:",e)}}else console.warn("[DEBUG] No file selected.")});const imageLoaderButton=document.getElementById("imageLoaderButton");async function clearCanvas(e=!0){const t=History._captureProject?History._captureProject():null;try{console.log("[Clear] start");try{Array.isArray(layers)&&layers.forEach(e=>{try{gl.deleteTexture(e.texture)}catch{}try{gl.deleteFramebuffer(e.fbo)}catch{}})}catch(e){console.warn("[Clear] warning disposing old layers:",e)}const e=Math.max(1,0|window.visualViewport?.width||0|window.innerWidth),t=Math.max(1,0|window.visualViewport?.height||0|window.innerHeight);let a=null;if("function"==typeof createPaperImage)try{a=await createPaperImage(e,t)}catch(e){console.warn("[Clear] createPaperImage failed, falling back to flat paper:",e)}if(!a){const r=document.createElement("canvas");r.width=e,r.height=t;const n=r.getContext("2d");n.fillStyle="#f2efe4",n.fillRect(0,0,e,t),a=await new Promise((e,t)=>{const a=new Image;a.onload=()=>e(a),a.onerror=t,a.src=r.toDataURL("image/png")})}currentImage=a,fixedFBOWidth=a.width,fixedFBOHeight=a.height,"function"==typeof setDocumentSize?setDocumentSize(a.width,a.height):(canvas.width=a.width,canvas.height=a.height,gl.viewport(0,0,a.width,a.height));try{initFloodFBOs?.()}catch{}initPaintLayerFixed();try{if(texture)try{gl.deleteTexture(texture)}catch{}createTextureFromImage(a)}catch(e){console.error("[Clear] createTextureFromImage failed:",e)}try{updateCanvasSize(a)}catch{}zoomScale=1,panX=panY=0;try{centerCanvasInWrapper?.()}catch{}viewRotation=0;try{updateCanvasTransform?.()}catch{}try{resetStrokeState?.()}catch{}try{syncActiveAliases?.()}catch{}try{rebuildLayersUI?.()}catch{}try{showStatusMessage?.("New project created to match current window.","success")}catch{}needsRedraw=!0;try{requestDrawIfIdle?.()}catch{}console.log("[Clear] done",{w:a.width,h:a.height})}catch(e){console.error("[Clear] fatal error:",e);try{showStatusMessage?.("Clear failed.","error")}catch{}}if(e&&History._captureProject){const e=History._captureProject();try{recordClearProject?.(t,e)}catch(a){console.warn("[Clear] recordClearProject failed; pushing generic history entry:",a);try{History.push?.({type:"clear_project",beforeAll:t,afterAll:e})}catch{}}}}function resetPageZoomFromInputs(){const e=document.querySelector('meta[name="viewport"]');if(!e)return;const t=e.getAttribute("content")||"width=device-width, initial-scale=1",a=t.replace(/,\s*maximum-scale=[^,]+/i,"");e.setAttribute("content",`${a}, maximum-scale=1`),setTimeout(()=>e.setAttribute("content",t),80)}function blurActiveElement(){document.activeElement&&"function"==typeof document.activeElement.blur&&document.activeElement.blur()}function resetToCurrentWindow(){const e=0|(window.visualViewport?.width||window.innerWidth),t=0|(window.visualViewport?.height||window.innerHeight),a=document.createElement("canvas");a.width=e,a.height=t;const r=a.getContext("2d");r.fillStyle="#f2efe4",r.fillRect(0,0,e,t);const n=r.createImageData(e,t);for(let e=0;e<n.data.length;e+=4){const t=40*Math.random()|0;n.data[e+0]=230+t,n.data[e+1]=226+t,n.data[e+2]=218+t,n.data[e+3]=255}r.globalAlpha=.15,r.putImageData(n,0,0),r.globalAlpha=1;const o=new Image;o.onload=()=>{currentImage=o,fixedFBOWidth=o.width,fixedFBOHeight=o.height,initFloodFBOs(),initPaintLayerFixed(),updateCanvasSize(o),createTextureFromImage(o),zoomScale=1,panX=panY=0,centerCanvasInWrapper?.(),resetStrokeState(),needsRedraw=!0,showStatusMessage("New document sized to window","success")},o.src=a.toDataURL("image/png")}imageLoaderButton.addEventListener("click",()=>{console.log("[DEBUG] imageLoaderButton clicked."),document.getElementById("imageLoader").click()}),imageLoaderButton.addEventListener("touchend",()=>{console.log("[DEBUG] imageLoaderButton touchend triggered."),document.getElementById("imageLoader").click()}),/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream&&(console.log("[DEBUG] Detected iOS device – removing capture attribute"),imageLoader.removeAttribute("capture")),document.addEventListener("DOMContentLoaded",async()=>{const e="artworks";let t;async function a(){return t||new Promise((a,r)=>{const n=indexedDB.open("DrawingAppDB",1);n.onupgradeneeded=t=>{let a=t.target.result;a.objectStoreNames.contains(e)||a.createObjectStore(e,{keyPath:"id"})},n.onsuccess=()=>a(t=n.result),n.onerror=()=>r("IndexedDB failed to open")})}async function r(t,r=!1,n=null,o=!1){try{const l=await a(),s=b(!0),c=await T(s,"image/png",.92),d=320,g=Math.min(d/s.width,d/s.height,1),u=document.createElement("canvas");u.width=Math.round(s.width*g),u.height=Math.round(s.height*g),u.getContext("2d").drawImage(s,0,0,u.width,u.height);const m=await T(u,"image/webp",.7),f=await new Promise(e=>{const t=new FileReader;t.onloadend=()=>e(t.result),t.readAsDataURL(m)}),h=fixedFBOWidth,y=fixedFBOHeight;let p=null;if(currentImage){const F=document.createElement("canvas");F.width=h,F.height=y;F.getContext("2d").drawImage(currentImage,0,0,h,y),p=await T(F,"image/png",.92)}async function i(e,t,a){const r=new Uint8Array(t*a*4);gl.bindFramebuffer(gl.FRAMEBUFFER,e),gl.readPixels(0,0,t,a,gl.RGBA,gl.UNSIGNED_BYTE,r),gl.bindFramebuffer(gl.FRAMEBUFFER,null);const n=document.createElement("canvas");n.width=t,n.height=a;const o=n.getContext("2d"),i=new ImageData(new Uint8ClampedArray(r),t,a);o.putImageData(i,0,0);const l=document.createElement("canvas");l.width=t,l.height=a;const s=l.getContext("2d");return s.save(),s.translate(t/2,a/2),s.scale(-1,-1),s.rotate(Math.PI),s.drawImage(n,-t/2,-a/2),s.restore(),T(l,"image/png",.92)}const E=[];for(let R=0;R<layers.length;R++){const _=layers[R],I=Math.max(1,0|(Number(_.texW)||h)),B=Math.max(1,0|(Number(_.texH)||y)),P=await i(_.fbo,I,B);E.push({name:_.name,visible:!!_.visible,opacity:Number(_.opacity)||1,x:Number(_.x)||0,y:Number(_.y)||0,scaleX:Number.isFinite(_.scaleX)?_.scaleX:1,scaleY:Number.isFinite(_.scaleY)?_.scaleY:1,rotation:Number(_.rotation)||0,px:Number.isFinite(_.px)?_.px:.5*h,py:Number.isFinite(_.py)?_.py:.5*y,texW:I,texH:B,ox:Number(_.ox)||0,oy:Number(_.oy)||0,blob:P})}const x=document.getElementById("existingArtworkId"),v=x?x.value:null,w=r?n??currentArtworkId??v??Date.now():Date.now(),L={id:w,name:t||`Untitled ${w}`,date:(new Date).toISOString(),username:"User",appName:"Web Paint",image:c,thumbnail:f,project:{v:2,width:h,height:y,backgroundBlob:p,layers:E}},A=l.transaction(e,"readwrite");A.objectStore(e).put(L),A.oncomplete=()=>{if(o||be(r?"Artwork overwritten!":"Artwork saved!","success"),x&&(x.value=w),currentArtworkId=w,!o&&k&&k.readyState===WebSocket.OPEN){const e=JSON.parse(localStorage.getItem("userProfile"))||{},t={type:"image",clientId:X,nickname:e.nickname?.trim()||"",profileImage:e.image||"",imageData:L.thumbnail,imageName:L.name,timestamp:Date.now()};k.send(JSON.stringify(t))}},A.onerror=e=>{console.error("[saveArtwork] IndexedDB ERROR:",e),o||be("Error saving artwork.","error")}}catch(S){console.error("[saveArtwork] ERROR:",S),o||be("Error saving artwork.","error")}}const n="__autosave__";let o=null;async function i(){await a();const e=document.getElementById("artworkName"),t=e?e.value:"";await r(t||"Autosave",!0,n,{quiet:!0})}async function l(e){if(e){if(currentArtworkId=e.id,e.project&&e.project.layers&&e.project.layers.length){const a=0|e.project.width,r=0|e.project.height;if(fixedFBOWidth=a,fixedFBOHeight=r,initFloodFBOs(),initPaintLayerFixed(),e.project.backgroundBlob){const n=URL.createObjectURL(e.project.backgroundBlob),o=new Image;await new Promise(e=>{o.onload=()=>{currentImage=o,updateCanvasSize(o),createTextureFromImage(o),canvas.offsetWidth,canvasWrapper.offsetWidth,zoomScale=1,panX=(canvasWrapper.clientWidth-canvas.width)/2,panY=(canvasWrapper.clientHeight-canvas.height)/2,updateCanvasTransform(),resetStrokeState(),needsRedraw=!0,URL.revokeObjectURL(n),e()},o.src=n})}else currentImage=null,texture=null,updateCanvasSize({width:a,height:r});function t(e,t,a,r){const n=document.createElement("canvas");n.width=a,n.height=r;const o=n.getContext("2d");o.clearRect(0,0,a,r),o.drawImage(e,0,0,a,r);const i=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,i),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!1),gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,n),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindFramebuffer(gl.FRAMEBUFFER,t),gl.viewport(0,0,a,r),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.SCISSOR_TEST),gl.disable(gl.BLEND),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);const l=gl.getUniformLocation(quadProgram,"u_flipY"),s=gl.getUniformLocation(quadProgram,"u_resolution"),c=gl.getUniformLocation(quadProgram,"u_layerOpacity"),d=gl.getUniformLocation(quadProgram,"u_texture")||gl.getUniformLocation(quadProgram,"u_image");l&&gl.uniform1f(l,1),s&&gl.uniform2f(s,a,r),c&&gl.uniform1f(c,1),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,i),d&&gl.uniform1i(d,0),__bindAndDrawTexturedQuad(quadProgram,a,r),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.deleteTexture(i)}layers.forEach(e=>{gl.deleteTexture(e.texture),gl.deleteFramebuffer(e.fbo)}),layers=[];for(const i of e.project.layers){const l=Math.max(1,0|(Number(i.texW)||a)),s=Math.max(1,0|(Number(i.texH)||r)),c=Number(i.ox)||0,d=Number(i.oy)||0,{texture:g,fbo:u}=createLayerFBO(l,s);if(i.blob){const f=URL.createObjectURL(i.blob),h=new Image;await new Promise(e=>{h.onload=()=>{t(h,u,l,s),URL.revokeObjectURL(f),e()},h.src=f})}else gl.bindFramebuffer(gl.FRAMEBUFFER,u),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.bindFramebuffer(gl.FRAMEBUFFER,null);const m={id:Date.now()+Math.random(),name:i.name||`Layer ${layers.length+1}`,fbo:u,texture:g,visible:!1!==i.visible,opacity:Number(i.opacity)||1,x:Number(i.x)||0,y:Number(i.y)||0,scaleX:Number.isFinite(i.scaleX)?i.scaleX:1,scaleY:Number.isFinite(i.scaleY)?i.scaleY:1,rotation:Number(i.rotation)||0,px:Number.isFinite(i.px)?i.px:.5*a,py:Number.isFinite(i.py)?i.py:.5*r,texW:l,texH:s,ox:c,oy:d,history:[],redo:[]};layers.push(m)}return activeLayerIndex=Math.max(0,layers.length-1),syncActiveAliases?.(),rebuildLayersUI?.(),needsRedraw=!0,void requestDrawIfIdle?.()}if(e.image){const y=URL.createObjectURL(e.image),p=new Image;p.onload=()=>{currentImage=p,updateCanvasSize(p),createTextureFromImage(p),zoomScale=1,panX=(canvasWrapper.clientWidth-canvas.width)/2,panY=(canvasWrapper.clientHeight-canvas.height)/2,updateCanvasTransform(),resetStrokeState(),needsRedraw=!0,URL.revokeObjectURL(y)},p.src=y}}}!function(){const t=()=>function(e=800){o&&clearTimeout(o),o=setTimeout(()=>{i().catch(console.error)},e)}(500),r=()=>{try{i()}catch(e){}},s=document.getElementById("glCanvas");s&&["pointerup","mouseup","touchend"].forEach(e=>s.addEventListener(e,t,{passive:!0})),document.addEventListener("keyup",t,{passive:!0}),document.addEventListener("visibilitychange",()=>{document.hidden&&r()}),window.addEventListener("beforeunload",r),setInterval(()=>{try{isDrawing||t()}catch(e){}},15e3),window.addEventListener("load",()=>{requestAnimationFrame(()=>{!async function(){const t=(await a()).transaction(e,"readonly").objectStore(e).get(n);t.onsuccess=async()=>{const e=t.result;e&&(await l(e),be("Autosave restored","success"))},t.onerror=()=>{console.warn("Autosave lookup failed.")}}()})})}(),document.addEventListener("keydown",e=>{if(!isUserTyping())if(e.metaKey&&"s"===e.key.toLowerCase()){console.log("kd: s"),e.preventDefault(),e.stopPropagation();const t=document.getElementById("artworkName").value,a=document.getElementById("existingArtworkId");a&&a.value?(r(t,!0,a.value),be("Artwork overwritten!","success")):console.warn("No artwork selected for overwrite.")}else if(e.shiftKey&&"s"===e.key.toLowerCase()){e.preventDefault(),e.stopPropagation();const t=document.getElementById("saveModal");P(t)}}),document.getElementById("saveNewButton").addEventListener("click",()=>{r(document.getElementById("artworkName").value,!1),S(Te)}),document.getElementById("overwriteButton").addEventListener("click",()=>{const e=document.getElementById("artworkName").value,t=document.getElementById("existingArtworkId"),a=t?t.value:null;a&&e?r(e,!0,a,{quiet:!0}):console.error("No existing artwork ID or name found. Cannot overwrite."),S(Te)}),document.getElementById("exportProjectBtn").addEventListener("click",()=>{!async function({includeBackground:e=!0}={}){if(!window.JSZip)return console.error("JSZip not loaded"),void be("Export failed: JSZip not loaded.","error");const t=fixedFBOWidth,a=fixedFBOHeight,r=new JSZip,n={version:2,width:t,height:a,app:"Helena Paint",date:(new Date).toISOString(),hasBackground:!!currentImage&&e,layers:layers.map((e,r)=>({index:r,name:e.name,visible:!!e.visible,opacity:Number(e.opacity)||1,x:Number(e.x)||0,y:Number(e.y)||0,scaleX:Number(e.scaleX)||1,scaleY:Number(e.scaleY)||1,rotation:Number(e.rotation)||0,px:Number.isFinite(e.px)?e.px:.5*t,py:Number.isFinite(e.py)?e.py:.5*a,ox:Number.isFinite(e.ox)?e.ox:0,oy:Number.isFinite(e.oy)?e.oy:0,texW:Number.isFinite(e.texW)?e.texW:t,texH:Number.isFinite(e.texH)?e.texH:a}))};if(r.file("manifest.json",JSON.stringify(n,null,2),{compression:"DEFLATE"}),n.hasBackground){const e=document.createElement("canvas");e.width=t,e.height=a,e.getContext("2d").drawImage(currentImage,0,0,t,a);const n=await new Promise(t=>e.toBlob(t,"image/png",.92));r.file("background.png",n,{compression:"DEFLATE"})}for(let e=0;e<layers.length;e++){const n=layers[e],o=Number.isFinite(n.texW)?n.texW:t,i=Number.isFinite(n.texH)?n.texH:a,l=c(n.fbo,o,i),s=await d(l),g=(n.name||"Layer").replace(/[^\w\-]+/g,"_"),u=`layers/${String(e).padStart(3,"0")}_${g}_${o}x${i}.png`;r.file(u,s,{compression:"DEFLATE"})}const o=await r.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:6}}),i=`helena_project_${Date.now()}.hpaint`,l=document.createElement("a");l.href=URL.createObjectURL(o),l.download=i,document.body.appendChild(l),l.click(),l.remove(),be("Project exported!","success")}({includeBackground:!0})});const s=document.getElementById("importProjectInput");document.getElementById("importProjectBtn").addEventListener("click",()=>s.click()),s.addEventListener("change",e=>{const t=e.target.files?.[0];t&&async function(e){if(!window.JSZip)return console.error("JSZip not loaded"),void be("Import failed: JSZip not loaded.","error");try{const a=await JSZip.loadAsync(e),r=await a.file("manifest.json").async("string"),n=JSON.parse(r),o=Number(n.version)||1,i=Number(n.width)||fixedFBOWidth,l=Number(n.height)||fixedFBOHeight;if("function"==typeof setFixedFBODimensions?setFixedFBODimensions(i,l):(window.fixedFBOWidth=i,window.fixedFBOHeight=l),initPaintLayerFixed?.(),n.hasBackground&&a.file("background.png")){const c=await a.file("background.png").async("blob"),d=await createImageBitmap(c);"function"==typeof setDocumentBackgroundImageBitmap?await setDocumentBackgroundImageBitmap(d):window.currentImage=d}function t(e,t,a,r){const n=Math.max(1,0|a.texW),o=Math.max(1,0|a.texH),s=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,s),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,n,o,0,gl.RGBA,gl.UNSIGNED_BYTE,null),t&&gl.texSubImage2D(gl.TEXTURE_2D,0,0,0,gl.RGBA,gl.UNSIGNED_BYTE,t);const c=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,c),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,s,0),gl.bindFramebuffer(gl.FRAMEBUFFER,null);const d={id:Date.now()+Math.random(),name:e,texture:s,fbo:c,visible:!!r.visible,opacity:Number.isFinite(r.opacity)?r.opacity:1,ox:0|a.ox,oy:0|a.oy,texW:n,texH:o,x:Number.isFinite(r.x)?r.x:0,y:Number.isFinite(r.y)?r.y:0,scaleX:Number.isFinite(r.scaleX)?r.scaleX:1,scaleY:Number.isFinite(r.scaleY)?r.scaleY:1,rotation:Number.isFinite(r.rotation)?r.rotation:0,px:Number.isFinite(r.px)?r.px:.5*i,py:Number.isFinite(r.py)?r.py:.5*l,history:[],redo:[]};layers.push(d)}const s=(n.layers||[]).slice().sort((e,t)=>e.index-t.index);for(let g=0;g<s.length;g++){const u=s[g],m=String(u.index).padStart(3,"0")+"_",f=Object.keys(a.files).filter(e=>e.startsWith("layers/")),h=f.find(e=>e.split("/").pop().startsWith(m))||f[u.index];let y=null;if(h){const E=await a.file(h).async("blob");y=await createImageBitmap(E)}else console.warn("Missing layer image in zip for index",u.index);const p=o>=2?{ox:Number.isFinite(u.ox)?u.ox:0,oy:Number.isFinite(u.oy)?u.oy:0,texW:Number.isFinite(u.texW)?u.texW:i,texH:Number.isFinite(u.texH)?u.texH:l}:{ox:0,oy:0,texW:i,texH:l};t(u.name||`Layer ${g+1}`,y,p,{visible:!!u.visible,opacity:Number(u.opacity)||1,x:u.x,y:u.y,scaleX:u.scaleX,scaleY:u.scaleY,rotation:u.rotation,px:u.px,py:u.py})}activeLayerIndex=Math.max(0,layers.length-1),syncActiveAliases?.(),rebuildLayersUI?.(),needsRedraw=!0,requestDrawIfIdle?.(),be?.("Project imported","success")}catch(x){console.error(x),be("Import failed.","error")}}(t)});function c(e,t,a){const r=new Uint8Array(t*a*4);return gl.bindFramebuffer(gl.FRAMEBUFFER,e),gl.readPixels(0,0,t,a,gl.RGBA,gl.UNSIGNED_BYTE,r),gl.bindFramebuffer(gl.FRAMEBUFFER,null),new ImageData(new Uint8ClampedArray(r),t,a)}function d(e){const t=document.createElement("canvas");return t.width=e.width,t.height=e.height,t.getContext("2d").putImageData(e,0,0),new Promise(e=>t.toBlob(e,"image/png",.92))}var g=document.getElementById("layerToBrushBtn");g&&g.addEventListener("click",function(){(function(){var e="function"==typeof getActiveLayer?getActiveLayer():null;if(!(gl&&quadProgram&&e&&e.texture))return null;var t=Math.max(1,0|e.texW||fixedFBOWidth||canvas.width),a=Math.max(1,0|e.texH||fixedFBOHeight||canvas.height),r=gl.getParameter(gl.FRAMEBUFFER_BINDING),n=gl.getParameter(gl.CURRENT_PROGRAM),o=gl.getParameter(gl.VIEWPORT),i=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,i),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,t,a,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);var l=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,l),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,i,0),gl.viewport(0,0,t,a),gl.disable(gl.BLEND),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);var s=gl.getUniformLocation(quadProgram,"u_flipY"),c=gl.getUniformLocation(quadProgram,"u_resolution"),d=gl.getUniformLocation(quadProgram,"u_layerOpacity"),g=gl.getUniformLocation(quadProgram,"u_texture");s&&gl.uniform1f(s,1),c&&gl.uniform2f(c,t,a),d&&gl.uniform1f(d,1),g&&gl.uniform1i(g,0);var u=new Float32Array([0,0,0,0,t,0,1,0,0,a,0,1,0,a,0,1,t,0,1,0,t,a,1,1]),m=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,m),gl.bufferData(gl.ARRAY_BUFFER,u,gl.STREAM_DRAW);var f=gl.getAttribLocation(quadProgram,"a_position"),h=gl.getAttribLocation(quadProgram,"a_texCoord");f>=0&&(gl.enableVertexAttribArray(f),gl.vertexAttribPointer(f,2,gl.FLOAT,!1,16,0)),h>=0&&(gl.enableVertexAttribArray(h),gl.vertexAttribPointer(h,2,gl.FLOAT,!1,16,8)),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,e.texture),gl.drawArrays(gl.TRIANGLES,0,6),f>=0&&gl.disableVertexAttribArray(f),h>=0&&gl.disableVertexAttribArray(h),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(m),gl.bindFramebuffer(gl.FRAMEBUFFER,r);try{gl.deleteFramebuffer(l)}catch(e){}return gl.useProgram(n),o&&gl.viewport(o[0],o[1],o[2],o[3]),overlayTexture=i,brushAspect=t/a,currentBrush={name:e.name?e.name+" → Brush":"Layer Brush",type:"bitmap",texture:i,defaultSize:currentBrush&&currentBrush.defaultSize?currentBrush.defaultSize:.05,aspect:brushAspect,spacing:.14,angleFromDirection:!0,opacity:1},currentTool="draw",lastPointer&&"function"==typeof showBrushHUD&&showBrushHUD(1500),needsRedraw=!0,"function"==typeof requestDrawIfIdle&&requestDrawIfIdle(),currentBrush})()?(be("Brush created from layer","success"),"function"==typeof requestDrawIfIdle&&requestDrawIfIdle()):be("No active layer to convert","warning")});const u=document.getElementById("importLayerButton"),m=document.getElementById("importLayerInput"),f=document.getElementById("exportLayerButton");function h(){document.getElementById("exportOptionsModal").style.display="none"}function y(e){const t=0|fixedFBOWidth,a=0|fixedFBOHeight,r=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,r),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,t,a,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);const n=gl.createFramebuffer();if(gl.bindFramebuffer(gl.FRAMEBUFFER,n),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,r,0),gl.checkFramebufferStatus(gl.FRAMEBUFFER)!==gl.FRAMEBUFFER_COMPLETE)return gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.deleteFramebuffer(n),gl.deleteTexture(r),void be?.("Export failed (FBO incomplete).","error");gl.viewport(0,0,t,a),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.SCISSOR_TEST),gl.enable(gl.BLEND),gl.blendFuncSeparate(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA,gl.ONE,gl.ONE_MINUS_SRC_ALPHA),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);const o=gl.getUniformLocation(quadProgram,"u_flipY"),i=gl.getUniformLocation(quadProgram,"u_resolution"),l=gl.getUniformLocation(quadProgram,"u_layerOpacity"),s=gl.getUniformLocation(quadProgram,"u_texture")||gl.getUniformLocation(quadProgram,"u_image");o&&gl.uniform1f(o,-1),i&&gl.uniform2f(i,t,a);const c=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,c);const d=gl.getAttribLocation(quadProgram,"a_position"),g=gl.getAttribLocation(quadProgram,"a_texCoord");function u(e,t,a,r,n,o){const i=new Float32Array([t.x,t.y,0,0,a.x,a.y,1,0,r.x,r.y,0,1,r.x,r.y,0,1,a.x,a.y,1,0,n.x,n.y,1,1]);gl.bufferData(gl.ARRAY_BUFFER,i,gl.STREAM_DRAW),l&&gl.uniform1f(l,Math.max(0,Math.min(1,o))),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,e),s&&gl.uniform1i(s,0),gl.drawArrays(gl.TRIANGLES,0,6)}gl.enableVertexAttribArray(d),gl.vertexAttribPointer(d,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(g),gl.vertexAttribPointer(g,2,gl.FLOAT,!1,16,8);let m=null;e&&currentImage&&(m=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,m),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!1),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,currentImage),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),u(m,{x:0,y:0},{x:t,y:0},{x:0,y:a},{x:t,y:a},1));for(let b=0;b<layers.length;b++){const T=layers[b];if(!T||!1===T.visible)continue;if(null!=T.opacity&&T.opacity<=0)continue;if(!T.texture)continue;const w=Number.isFinite(T.ox)?T.ox:0,L=Number.isFinite(T.oy)?T.oy:0,A=Math.max(1,0|(Number(T.texW)||t)),F=Math.max(1,0|(Number(T.texH)||a)),R=Number.isFinite(T.px)?T.px:.5*t,_=Number.isFinite(T.py)?T.py:.5*a,I=Number.isFinite(T.x)?T.x:0,B=Number.isFinite(T.y)?T.y:0,P=Number.isFinite(T.scaleX)?T.scaleX:1,S=Number.isFinite(T.scaleY)?T.scaleY:1,M=Number.isFinite(T.rotation)?T.rotation:0,U=Math.cos(M),D=Math.sin(M);function f(e,t){let a=e-R,r=t-_;return a*=P,r*=S,{x:R+(a*U-r*D)+I,y:_+(a*D+r*U)+B}}const C=f(w,L),N=f(w+A,L),O=f(w,L+F),k=f(w+A,L+F);u(T.texture,C,N,O,k,Number(T.opacity)||1)}const h=new Uint8Array(t*a*4);gl.readPixels(0,0,t,a,gl.RGBA,gl.UNSIGNED_BYTE,h);const y=new Uint8ClampedArray(t*a*4),p=4*t;for(let X=0;X<a;X++){const W=X*p,H=(a-1-X)*p;y.set(h.subarray(W,W+p),H)}const E=document.createElement("canvas");E.width=t,E.height=a;E.getContext("2d").putImageData(new ImageData(y,t,a),0,0);const x=e?"_with_background":"_transparent",v=`canvas_${Date.now()}${x}.png`;E.toBlob(e=>{if(!e)return void be?.("Export failed.","error");const t=document.createElement("a");t.download=v,t.href=URL.createObjectURL(e),document.body.appendChild(t),t.click(),URL.revokeObjectURL(t.href),t.remove()},"image/png",.92),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.disableVertexAttribArray(d),gl.disableVertexAttribArray(g),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(c),m&&gl.deleteTexture(m),gl.deleteFramebuffer(n),gl.deleteTexture(r)}function p(){document.getElementById("shareOptionsModal").style.display="none"}function E(e){b(e).toBlob(async t=>{if(!t)return void be("Error generating artwork.","error");const a=new File([t],`artwork${e?"_with_background":"_transparent"}.png`,{type:"image/png"});if(navigator.canShare&&navigator.canShare({files:[a]}))try{await navigator.share({title:"Artwork",text:"Check out my artwork!",files:[a]})}catch{be("Error sharing artwork.","error")}else be("Sharing not supported on this device.","error")},"image/png")}/iPad|iPhone|iPod/.test(navigator.userAgent)&&m?.removeAttribute("capture"),u?.addEventListener("click",()=>m?.click()),m?.addEventListener("change",async e=>{const t=e.target.files?.[0];if(!t)return;const a=new Image;a.onload=async()=>{fixedFBOWidth&&fixedFBOHeight||(fixedFBOWidth=a.width,fixedFBOHeight=a.height,initPaintLayerFixed?.(),updateCanvasSize({width:a.width,height:a.height}),needsRedraw=!0);const{texture:e,fbo:r}=createLayerFBO(fixedFBOWidth,fixedFBOHeight),n={id:Date.now()+Math.random(),name:(t.name||"Imported").replace(/\.[^.]+$/,""),fbo:r,texture:e,visible:!0,opacity:1,x:0,y:0,scaleX:1,scaleY:1,rotation:0,px:.5*fixedFBOWidth,py:.5*fixedFBOHeight,history:[],redo:[]},o=Math.max(0,Math.min(activeLayerIndex,layers.length));layers.splice(o,0,n),activeLayerIndex=o,await async function(e,t){const a=fixedFBOWidth,r=fixedFBOHeight,n=a/e.width,o=r/e.height,i=Math.min(n,o,1),l=Math.round(e.width*i),s=Math.round(e.height*i),c=Math.floor((a-l)/2),d=Math.floor((r-s)/2),g=document.createElement("canvas");g.width=a,g.height=r;const u=g.getContext("2d");u.clearRect(0,0,a,r),u.imageSmoothingEnabled=!0,u.imageSmoothingQuality="high",u.drawImage(e,0,0,e.width,e.height,c,d,l,s);const m=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,m),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!1),gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,g),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindFramebuffer(gl.FRAMEBUFFER,t),gl.viewport(0,0,a,r),gl.disable(gl.BLEND),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);const f=gl.getUniformLocation(quadProgram,"u_flipY");f&&gl.uniform1f(f,1);const h=gl.getUniformLocation(quadProgram,"u_resolution");h&&gl.uniform2f(h,a,r);const y=gl.getUniformLocation(quadProgram,"u_layerOpacity");y&&gl.uniform1f(y,1);const p=new Float32Array([0,0,0,0,a,0,1,0,0,r,0,1,0,r,0,1,a,0,1,0,a,r,1,1]),E=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,E),gl.bufferData(gl.ARRAY_BUFFER,p,gl.STATIC_DRAW);const x=gl.getAttribLocation(quadProgram,"a_position"),v=gl.getAttribLocation(quadProgram,"a_texCoord");gl.enableVertexAttribArray(x),gl.vertexAttribPointer(x,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(v),gl.vertexAttribPointer(v,2,gl.FLOAT,!1,16,8),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,m);const b=gl.getUniformLocation(quadProgram,"u_texture");b&&gl.uniform1i(b,0),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(x),gl.disableVertexAttribArray(v),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(E),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null),gl.deleteTexture(m),needsRedraw=!0}(a,r),syncActiveAliases?.(),rebuildLayersUI?.(),needsRedraw=!0,be?.("Imported image as new layer.","success")},a.src=URL.createObjectURL(t),e.target.value=""}),f?.addEventListener("click",()=>{const e=layers?.[activeLayerIndex];if(!e)return void be?.("No active layer to export.","error");const t=fixedFBOWidth,a=fixedFBOHeight,r=document.createElement("canvas");r.width=t,r.height=a;r.getContext("2d").putImageData(c(e.fbo,t,a),0,0);const n=document.createElement("canvas");n.width=t,n.height=a;const o=n.getContext("2d");o.save(),o.translate(t/2,a/2),o.scale(-1,-1),o.rotate(Math.PI),o.drawImage(r,-t/2,-a/2),o.restore();const i=document.createElement("a");i.download=`${(e.name||"Layer").replace(/\s+/g,"_")}.png`,i.href=n.toDataURL("image/png"),document.body.appendChild(i),i.click(),i.remove(),be?.("Active layer exported.","success")}),document.getElementById("saveCanvasAsIcoButton").addEventListener("click",function(){const e=b(!0),t=document.createElement("canvas");t.width=64,t.height=64,t.getContext("2d").drawImage(e,0,0,64,64),t.toBlob(e=>{if(!e)return void be("ICO export failed.","error");const t=new FileReader;t.onloadend=()=>{const e=function(e,t){const a=new Uint8Array([0,0,1,0,1,0]),r=new Uint8Array(16);r.set([t,t,0,0,1,0,32,0]);const n=e.byteLength,o=a.length+r.length,i=new DataView(r.buffer);i.setUint32(8,n,!0),i.setUint32(12,o,!0);const l=a.length+r.length+n,s=new Uint8Array(l);return s.set(a,0),s.set(r,a.length),s.set(new Uint8Array(e),o),s.buffer}(t.result,64),a=new Blob([e],{type:"image/x-icon"}),r=document.createElement("a");r.href=URL.createObjectURL(a),r.download="favicon.ico",document.body.appendChild(r),r.click(),document.body.removeChild(r)},t.readAsArrayBuffer(e)},"image/png")}),document.getElementById("exportModalClose").addEventListener("click",h),document.getElementById("exportWithBackgroundBtn").addEventListener("click",function(){h(),y(!0)}),document.getElementById("exportTransparentBtn").addEventListener("click",function(){h(),y(!1)}),document.getElementById("saveCanvasButton").addEventListener("click",function(){document.getElementById("exportOptionsModal").style.display="flex"}),document.getElementById("shareButton").addEventListener("click",function(){document.getElementById("shareOptionsModal").style.display="flex"}),document.getElementById("shareModalClose").addEventListener("click",p),document.getElementById("shareWithBackgroundBtn").addEventListener("click",function(){p(),E(!0)}),document.getElementById("shareTransparentBtn").addEventListener("click",function(){p(),E(!1)});let x=!1,v=null;function b(e=!0){if(!gl||!quadProgram)return null;const t=0|fixedFBOWidth,a=0|fixedFBOHeight,r=gl.getParameter(gl.FRAMEBUFFER_BINDING),n=gl.getParameter(gl.CURRENT_PROGRAM),o=gl.getParameter(gl.VIEWPORT),i=gl.isEnabled(gl.BLEND),l=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,l),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,t,a,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);const s=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,s),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,l,0),gl.viewport(0,0,t,a),gl.disable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.blendFuncSeparate(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA,gl.ONE,gl.ONE_MINUS_SRC_ALPHA),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);const c=gl.getUniformLocation(quadProgram,"u_flipY"),d=gl.getUniformLocation(quadProgram,"u_resolution"),g=gl.getUniformLocation(quadProgram,"u_layerOpacity"),u=gl.getUniformLocation(quadProgram,"u_texture"),m=gl.getAttribLocation(quadProgram,"a_position"),f=gl.getAttribLocation(quadProgram,"a_texCoord");c&&gl.uniform1f(c,-1),d&&gl.uniform2f(d,t,a);const h=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,h),gl.enableVertexAttribArray(m),gl.enableVertexAttribArray(f),gl.vertexAttribPointer(m,2,gl.FLOAT,!1,16,0),gl.vertexAttribPointer(f,2,gl.FLOAT,!1,16,8);let y=null;if(e&&currentImage){y=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,y),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,currentImage),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),g&&gl.uniform1f(g,1),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,y),u&&gl.uniform1i(u,0);const e=new Float32Array([0,0,0,0,t,0,1,0,0,a,0,1,0,a,0,1,t,0,1,0,t,a,1,1]);gl.bufferData(gl.ARRAY_BUFFER,e,gl.STREAM_DRAW),gl.drawArrays(gl.TRIANGLES,0,6)}for(let e=0;e<layers.length;e++){const r=layers[e];if(!r||!r.visible||!r.texture)continue;const n=Number.isFinite(r.ox)?r.ox:0,o=Number.isFinite(r.oy)?r.oy:0,i=Math.max(1,Number.isFinite(r.texW)?r.texW:t),l=Math.max(1,Number.isFinite(r.texH)?r.texH:a),s=Number.isFinite(r.scaleX)?r.scaleX:1,c=Number.isFinite(r.scaleY)?r.scaleY:1,d=Number.isFinite(r.rotation)?r.rotation:0,m=Number.isFinite(r.x)?r.x:0,f=Number.isFinite(r.y)?r.y:0,h=Number.isFinite(r.px)?r.px:.5*t,y=Number.isFinite(r.py)?r.py:.5*a,p=Math.max(0,Math.min(1,r.opacity??1)),E=Math.cos(d),x=Math.sin(d),v=(e,t)=>{let a=(e-h)*s,r=(t-y)*c;return{x:h+(a*E-r*x)+m,y:y+(a*x+r*E)+f}},b=v(n,o),T=v(n+i,o),w=v(n,o+l),L=v(n+i,o+l),A=new Float32Array([b.x,b.y,0,0,T.x,T.y,1,0,w.x,w.y,0,1,w.x,w.y,0,1,T.x,T.y,1,0,L.x,L.y,1,1]);g&&gl.uniform1f(g,p),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,r.texture),u&&gl.uniform1i(u,0),gl.bufferData(gl.ARRAY_BUFFER,A,gl.STREAM_DRAW),gl.drawArrays(gl.TRIANGLES,0,6)}const p=new Uint8Array(t*a*4);gl.readPixels(0,0,t,a,gl.RGBA,gl.UNSIGNED_BYTE,p);const E=new Uint8ClampedArray(t*a*4);for(let e=0;e<a;e++){const r=e*t*4,n=(a-1-e)*t*4;E.set(p.subarray(r,r+4*t),n)}const x=document.createElement("canvas");x.width=t,x.height=a;return x.getContext("2d").putImageData(new ImageData(E,t,a),0,0),i?gl.enable(gl.BLEND):gl.disable(gl.BLEND),o&&gl.viewport(o[0],o[1],o[2],o[3]),gl.bindFramebuffer(gl.FRAMEBUFFER,r),gl.useProgram(n),gl.disableVertexAttribArray(m),gl.disableVertexAttribArray(f),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(h),y&&gl.deleteTexture(y),gl.deleteFramebuffer(s),gl.deleteTexture(l),x}function T(e,t="image/webp",a=.75){return new Promise(r=>{e.toBlob(e=>r(e),t,a)})}async function w(){const t=(await a()).transaction(e,"readonly").objectStore(e).getAll();t.onsuccess=()=>{const r=t.result;r.sort((e,t)=>new Date(t.date)-new Date(e.date));const n=document.getElementById("gallery");n.innerHTML=r.length?"":"<p>No saved artworks</p>",r.forEach(t=>{const r=document.createElement("div");r.classList.add("gallery-item");const o=document.createElement("img");o.src=t.thumbnail||"",o.alt=t.name,r.appendChild(o);const i=document.createElement("p");i.textContent=t.name,r.appendChild(i);const s=document.createElement("button");s.classList.add("delete-button"),s.style.display=x?"block":"none",s.innerHTML='\n                <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" stroke-width="1.5" fill="none">\n                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"\n                          d="M19 11v9.4a.6.6 0 0 1-.6.6H5.6a.6.6 0 0 1-.6-.6V11M10 17v-6M14 17v-6M21 7h-5M3 7h5m0 0V3.6a.6.6 0 0 1 .6-.6h6.8a.6.6 0 0 1 .6.6V7M8 7h8" />\n                </svg>\n            ',s.addEventListener("click",e=>{e.stopPropagation(),v=t.id,document.getElementById("deleteConfirmModal").style.display="flex"}),r.appendChild(s),r.addEventListener("click",()=>{x||async function(t){const r=(await a()).transaction(e,"readonly").objectStore(e).get(t);r.onsuccess=async()=>{const e=r.result;e?await l(e):be("Artwork not found.","error")},r.onerror=()=>{console.error("Failed to load artwork from IndexedDB."),be("Failed to load artwork.","error")}}(t.id)}),n.appendChild(r)})},t.onerror=()=>console.error("Failed to load gallery.")}document.getElementById("galleryEditButton").addEventListener("click",()=>{x=!x,document.querySelectorAll(".gallery-item .delete-button").forEach(e=>{e.style.display=x?"block":"none"}),document.getElementById("galleryEditButton").textContent=x?"Done":"Edit"}),document.getElementById("confirmDeleteButton").addEventListener("click",async()=>{if(null!==v){const t=(await a()).transaction(e,"readwrite");t.objectStore(e).delete(v),t.oncomplete=()=>{be("Artwork deleted!","success"),v=null,document.getElementById("deleteConfirmModal").style.display="none",w()},t.onerror=()=>{console.error("Failed to delete artwork."),be("Error deleting artwork.","error")}}}),document.getElementById("cancelDeleteButton").addEventListener("click",()=>{v=null,document.getElementById("deleteConfirmModal").style.display="none"});const L=document.getElementById("profileModal"),A=document.getElementById("profileIconButton"),F=document.getElementById("saveProfileButton"),R=document.getElementById("profileImageInput"),_=document.getElementById("profileImagePreview"),I=document.getElementById("drawProfileButton");function B(){const e=JSON.parse(localStorage.getItem("userProfile"))||{};if(e.image){_.style.backgroundImage=`url('${e.image}')`;const t=document.querySelector("#profileIconButton img");t&&(t.src=e.image)}else{_.style.backgroundImage="url('/static/draw/images/icons/cat.svg')";const e=document.querySelector("#profileIconButton img");e&&(e.src="/static/draw/images/icons/cat.svg")}document.getElementById("profileNickname").value=e.nickname||"",document.getElementById("profileEmail").value=e.email||"",document.getElementById("profileBio").value=e.bio||""}function P(e){e.style.display="flex";const t=e.querySelector(".close");t&&!t.dataset.listenerAdded&&(t.addEventListener("click",()=>S(e)),t.dataset.listenerAdded="true")}function S(e){e.style.display="none"}B(),A.addEventListener("click",()=>{B(),P(L)}),F.addEventListener("click",function(){const e=_.style.backgroundImage.match(/url\(["']?(.*?)["']?\)/),t={image:e?e[1]:null,nickname:document.getElementById("profileNickname").value,email:document.getElementById("profileEmail").value,bio:document.getElementById("profileBio").value};localStorage.setItem("userProfile",JSON.stringify(t)),Y=t.nickname?.trim()||"",j(),be("Profile saved!","success"),S(L)}),_.addEventListener("click",()=>{R.click()}),R.addEventListener("change",t=>{const r=t.target.files[0];if(r){const t=new FileReader;t.onload=()=>{const r=t.result;_.style.backgroundImage=`url('${r}')`;const n={image:r,nickname:document.getElementById("profileNickname").value,email:document.getElementById("profileEmail").value,bio:document.getElementById("profileBio").value};localStorage.setItem("userProfile",JSON.stringify(n));const o=document.querySelector("#profileIconButton img");o&&(o.src=r),fetch(r).then(e=>e.blob()).then(t=>{const n={id:Date.now(),name:"Profile",date:(new Date).toISOString(),username:"User",appName:"Web Paint",image:t,thumbnail:r};a().then(t=>{t.transaction(e,"readwrite").objectStore(e).put(n),be("Profile image saved to gallery!","success")})})},t.readAsDataURL(r)}}),I.addEventListener("click",()=>{try{const t=b(!0);if(!t)return void be?.("Profile export unavailable.","error");const r=t.width,n=t.height,o=Math.min(r,n),i=(r-o)/2|0,l=(n-o)/2|0,s=document.createElement("canvas");s.width=o,s.height=o;s.getContext("2d").drawImage(t,i,l,o,o,0,0,o,o);const c=s.toDataURL("image/png");_.style.backgroundImage=`url('${c}')`;const d=document.querySelector("#profileIconButton img");d&&(d.src=c);const g={image:c,nickname:document.getElementById("profileNickname").value,email:document.getElementById("profileEmail").value,bio:document.getElementById("profileBio").value};try{localStorage.setItem("userProfile",JSON.stringify(g))}catch{}s.toBlob(t=>{if(!t)return void be?.("Profile save failed.","error");const r={id:Date.now(),name:"Profile",date:(new Date).toISOString(),username:"User",appName:"Web Paint",image:t,thumbnail:c};a().then(t=>{t.transaction(e,"readwrite").objectStore(e).put(r),be?.("Profile image saved.","success")}).catch(e=>{console.error("[Profile] gallery save error",e),be?.("Saved preview; gallery write failed.","warning")})},"image/png")}catch(e){console.error("[Profile] compose/save failed",e),be?.("Profile export failed.","error")}});const M=document.getElementById("chatToggleBtn"),U=document.getElementById("chatOverlay"),D=document.getElementById("chatCloseBtn"),C=document.getElementById("chatSendBtn"),N=document.getElementById("chatInput"),O=document.getElementById("chatMessages");M.addEventListener("click",()=>{U.classList.remove("hidden")}),D.addEventListener("click",()=>{U.classList.add("hidden")});let k=null,X=null,W=null,H=JSON.parse(localStorage.getItem("userProfile"))||{},Y=H.nickname?.trim()||"",G=H.image||"";const q=new Map;function z(e){M.style.borderColor=e?"limegreen":"red"}let V=null,$=0;function j(){k&&k.readyState===WebSocket.OPEN&&(H=JSON.parse(localStorage.getItem("userProfile"))||{},Y=H.nickname?.trim()||"",G=H.image||"",k.send(JSON.stringify({type:"set-nickname",nickname:Y,profileImage:G})))}function K(){const e=document.getElementById("chatUsers"),t=document.getElementById("chatUserBadge");e.innerHTML="",q.forEach((t,a)=>{const r=document.createElement("div");r.className="chat-user-item";const n=document.createElement("img");n.className="chat-user-avatar";t.profileImage&&t.profileImage.startsWith("data:")||t.profileImage&&""!==t.profileImage?n.src=t.profileImage:n.src="/static/draw/images/icons/cat.svg";const o=document.createElement("span");o.className="chat-user-name",o.textContent=t.nickname||"Unknown",r.appendChild(n),r.appendChild(o),e.appendChild(r)});const a=q.size;t&&(t.textContent=a,t.style.display=a>0?"flex":"none")}function J(){const e=N.value.trim();if(e&&k&&k.readyState===WebSocket.OPEN){const t={type:"text",clientId:X,message:e,timestamp:Date.now()};k.send(JSON.stringify(t)),N.value="",Q(t,"sent")}}function Q(e,t){const a=q.get(e.clientId)||{},r=a.nickname||"Unknown",n=a.profileImage?`<img src="${a.profileImage}" class="chat-avatar">`:"",o=Z(e.clientId),i=new Date(e.timestamp||Date.now()),l=`${String(i.getHours()).padStart(2,"0")}:${String(i.getMinutes()).padStart(2,"0")}:${String(i.getSeconds()).padStart(2,"0")}`,s=document.createElement("div");if("system"===t)s.textContent=`*** ${e.message} ***`,s.className="chat-message system";else{s.className=`chat-message ${t}`,s.style.backgroundColor="received"===t?o:"";const a=marked.parse(e.message),i=DOMPurify.sanitize(a,{ADD_TAGS:["pre","code"],ADD_ATTR:["class"]});s.innerHTML=`\n            <div class="chat-timestamp">${l}</div>\n            <div class="chat-message-header">\n                ${n}\n                <span class="chat-sender-name">${r}</span>\n            </div>\n            <div class="chat-message-body">${i}</div>\n        `,s.querySelectorAll("pre code").forEach(e=>{hljs.highlightElement(e)})}O.prepend(s)}function Z(e){let t=0;for(let a=0;a<e.length;a++)t=e.charCodeAt(a)+((t<<5)-t);return`hsl(${t%360}, 70%, 80%)`}!function e(){k&&(k.onopen=k.onmessage=k.onerror=k.onclose=null,k=null);let t="";if("localhost"===location.hostname||"127.0.0.1"===location.hostname||location.hostname.startsWith("172.")||location.hostname.startsWith("192.168.")){const e=3001;t=`${"https:"===location.protocol?"wss":"ws"}://${location.hostname}:${e}`}else{t=`${"https:"===location.protocol?"wss":"ws"}://${location.host}/chat-ws/`}k=new WebSocket(t),k.onopen=()=>{z(!0),W&&(clearTimeout(W),W=null),$=Date.now(),V&&clearInterval(V),V=setInterval(()=>{if(k.readyState===WebSocket.OPEN){k.send(JSON.stringify({type:"ping",timestamp:Date.now()}));Date.now()-$>1e4&&(console.warn("[WebSocket] Pong timeout — force reconnect"),k.close())}},3e3),j()},k.onmessage=e=>{try{let t=e.data;t.startsWith("[User] ")&&(t=t.substring(7));const a=JSON.parse(t);if("welcome"===a.type)return X=a.clientId,void K();if("profile-update"===a.type)return q.set(a.clientId,{nickname:a.nickname,profileImage:a.profileImage}),void K();if("user-list"===a.type)return q.clear(),a.users.forEach(e=>{q.set(e.clientId,{nickname:e.nickname,profileImage:e.profileImage})}),void K();if("pong"===a.type)return void($=Date.now());if("text"===a.type){const e=a.clientId===X;return void Q(a,e?"sent":"received")}if("image"===a.type){const e=q.get(a.clientId)||{},t=e.nickname||"Unknown",r=e.profileImage?`<img src="${e.profileImage}" class="chat-avatar">`:"",n=Z(a.clientId),o=document.createElement("div");return o.className="chat-message received",o.style.backgroundColor=n,o.innerHTML=`\n                ${r} \n                <div class="chat-text">\n                    <div>[${t}]: posted artwork</div>\n                    <img src="${a.imageData}" alt="${a.imageName}" style="max-width: 220px; max-height: 320px; margin-top: 5px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">\n                </div>\n            `,void O.prepend(o)}if("system"===a.type){return void Q({clientId:"",message:a.message,timestamp:a.timestamp},"system")}}catch(t){console.error("[WebSocket] Invalid message format",e.data)}},k.onclose=()=>{z(!1),V&&(clearInterval(V),V=null),W&&clearTimeout(W),W=setTimeout(e,3e3)},k.onerror=e=>{console.error("[WebSocket] Error:",e)}}(),C.addEventListener("click",J),N.addEventListener("keypress",e=>{"Enter"===e.key&&(e.preventDefault(),J())}),marked.setOptions({breaks:!0,gfm:!0,headerIds:!1,mangle:!1,sanitize:!1}),document.getElementById("sendToChatButton").addEventListener("click",()=>{!async function(e="Untitled",t={}){const a=/Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent)||navigator.maxTouchPoints>1,{includeBackground:r=!0,startLongest:n=(a?720:1024),jsonBudgetBytes:o=(a?3e5:1e5),startQuality:i=.8,minQuality:l=.4,downscaleStep:s=.85,maxAttempts:c=16}=t;if(!k||k.readyState!==WebSocket.OPEN)return void be?.("Chat not connected.","warning");const d=b(r);if(!d)return void be?.("Compose failed.","error");const g=new TextEncoder,u=e=>g.encode(JSON.stringify(e)).length,m=(e,t,a)=>new Promise(r=>e.toBlob(e=>r(e),t,a)),f=e=>new Promise(t=>{const a=new FileReader;a.onloadend=()=>t(a.result),a.readAsDataURL(e)}),h=Math.max(d.width,d.height),y=Math.min(1,(1===n?h:n)/h);let p=Math.max(1,Math.round(d.width*y)),E=Math.max(1,Math.round(d.height*y)),x=document.createElement("canvas");x.width=p,x.height=E;let v=x.getContext("2d");v.imageSmoothingEnabled=!0,v.imageSmoothingQuality="high",v.drawImage(d,0,0,p,E);let T="image/webp",w=i;const L=(JSON.parse(localStorage.getItem("userProfile")||"{}").nickname||"").trim();console.log("[ChatSend] start",{device:a?"mobile":"desktop",doc:`${d.width}x${d.height}`,start:`${p}x${E}`,budget:o});const A=e=>{p=Math.max(1,Math.round(p*e)),E=Math.max(1,Math.round(E*e));const t=document.createElement("canvas");t.width=p,t.height=E;const a=t.getContext("2d");a.imageSmoothingEnabled=!0,a.imageSmoothingQuality="high",a.drawImage(x,0,0,p,E),x=t,v=a};let F=0,R=!1,_=null;for(;F<c;){F++;let t=await m(x,T,w);if(t||"image/webp"!==T||(T="image/jpeg",w=i,t=await m(x,T,w)),t||"image/jpeg"!==T||(T="image/png",t=await m(x,T)),!t)break;const a=await f(t),r={type:"image",clientId:X,nickname:L,imageName:e,width:p,height:E,mime:T,imageData:a,timestamp:Date.now()},n=u(r);if(_={attempt:F,dims:`${p}x${E}`,fmt:T,q:w??"n/a",blob:t.size,json:n},console.log("[ChatSend] try",_),n<=o){k.send(JSON.stringify(r)),be?.("Sent image to chat","info"),console.log("[ChatSend] sent",_),R=!0;break}("image/webp"===T||"image/jpeg"===T)&&w>l+.001?w=Math.max(l,w-.15):"image/png"!==T?(A(s),w=i):(T="image/jpeg",w=i)}if(!R){T="image/jpeg",w=.55;let t=10;for(;t-- >0;){const t=await m(x,T,w);if(!t)break;const a=await f(t),r={type:"image",clientId:X,nickname:L,imageName:e,width:p,height:E,mime:T,imageData:a,timestamp:Date.now()},n=u(r);if(console.log("[ChatSend] emergency",{dims:`${p}x${E}`,q:w,blob:t.size,json:n}),n<=o)return k.send(JSON.stringify(r)),void be?.("Sent image to chat","info");if(p<=240||E<=240)break;A(.8)}console.warn("[ChatSend] failed to meet budget",{budget:o,last:_}),be?.("Image too large for chat after compression.","warning")}}("Quick Share")});const ee=document.getElementById("brushSizeToggle"),te=document.getElementById("brushSizeSliderContainer");let ae="true"===localStorage.getItem("brushSizeToggleMinimized");function re(){if(te.dataset.minimized=ae?"true":"false",te.classList.remove("brush-panel-visible","brush-panel-hidden"),ae){te.classList.add("brush-panel-hidden"),ee.innerHTML='<img class="show-icon" src="/static/draw/images/icons/hide.svg" alt="Show">';const e=te.getBoundingClientRect(),t=window.innerWidth,a=window.innerHeight;(e.left<0||e.top<0||e.left>t-40||e.top>a-40)&&(te.style.left="10px",te.style.top="10px")}else te.classList.add("brush-panel-visible"),ee.innerHTML='<img class="show-icon" src="/static/draw/images/icons/show.svg" alt="Hide">'}re(),ee.addEventListener("click",()=>{ae=!ae,localStorage.setItem("brushSizeToggleMinimized",ae),re()}),re();const ne=document.getElementById("brushContainerToggle"),oe=document.getElementById("brushContainer");let ie="true"===localStorage.getItem("brushContainerMinimized");function le(){oe.querySelectorAll(".brush-thumbnail").forEach(e=>{e.style.display=ie?"none":"inline-block"}),ne.innerHTML=ie?'<img class="show-icon" src="/static/draw/images/icons/hide.svg" alt="Show">':'<img class="show-icon" src="/static/draw/images/icons/show.svg" alt="Hide">'}ne.addEventListener("click",()=>{ie=!ie,localStorage.setItem("brushContainerMinimized",ie),le()}),le();const se=document.getElementById("brushSizeSliderContainer"),ce=document.getElementById("brushSizeDragBar");let de=0,ge=0,ue=!1;ce.addEventListener("pointerdown",e=>{ue=!0,de=e.clientX-se.offsetLeft,ge=e.clientY-se.offsetTop;try{ce.setPointerCapture(e.pointerId)}catch{}ce.style.cursor="grabbing"}),ce.addEventListener("pointermove",e=>{if(!ue)return;const t=e.clientX-de,a=e.clientY-ge,r=window.visualViewport&&window.visualViewport.width||window.innerWidth,n=window.visualViewport&&window.visualViewport.height||window.innerHeight,o=se.getBoundingClientRect(),i=Math.min(Math.max(t,0),r-o.width),l=Math.min(Math.max(a,0),n-o.height);se.style.left=`${i}px`,se.style.top=`${l}px`,se.style.bottom="auto"}),ce.addEventListener("pointerup",e=>{ue=!1;try{ce.releasePointerCapture(e.pointerId)}catch{}ce.style.cursor="grab";const t=window.visualViewport&&window.visualViewport.width||window.innerWidth,a=window.visualViewport&&window.visualViewport.height||window.innerHeight,r=se.getBoundingClientRect(),n=Math.min(Math.max(se.offsetLeft,0),t-r.width),o=Math.min(Math.max(se.offsetTop,0),a-r.height);se.style.left=`${n}px`,se.style.top=`${o}px`}),ce.addEventListener("pointercancel",()=>{ue=!1,ce.style.cursor="grab"});const me=document.getElementById("brushContainerWrapper"),fe=document.getElementById("brushContainerDragBar");let he=0,ye=0,pe=!1;function Ee(){if(!document.getElementById("__uiHideStyle")){const e=document.createElement("style");e.id="__uiHideStyle",e.textContent="\n      /* hide any element that is neither a canvas nor an ancestor of a canvas,\n         and keep the toggle button and its children visible */\n      body.__ui_off :not(canvas):not(#hideAllButton):not(#hideAllButton *):not(:has(canvas)) {\n        visibility: hidden !important;\n      }\n      /* canvases must remain interactive while UI is hidden */\n      body.__ui_off canvas { pointer-events: auto !important; }\n      /* ensure the toggle stays clickable above everything */\n      #hideAllButton { z-index: 999999; }\n    ",document.head.appendChild(e)}const e=document.body.classList.toggle("__ui_off"),t=document.getElementById("hideAllButton");t&&(t.title=e?"Show UI":"Hide UI")}fe.addEventListener("pointerdown",e=>{pe=!0,he=e.clientX-me.offsetLeft,ye=e.clientY-me.offsetTop;try{fe.setPointerCapture(e.pointerId)}catch{}fe.style.cursor="grabbing"}),fe.addEventListener("pointermove",e=>{if(!pe)return;const t=e.clientX-he,a=e.clientY-ye,r=window.visualViewport&&window.visualViewport.width||window.innerWidth,n=window.visualViewport&&window.visualViewport.height||window.innerHeight,o=me.getBoundingClientRect(),i=Math.min(Math.max(t,0),r-o.width),l=Math.min(Math.max(a,0),n-o.height);me.style.left=`${i}px`,me.style.top=`${l}px`}),fe.addEventListener("pointerup",e=>{pe=!1;try{fe.releasePointerCapture(e.pointerId)}catch{}fe.style.cursor="grab";const t=window.visualViewport&&window.visualViewport.width||window.innerWidth,a=window.visualViewport&&window.visualViewport.height||window.innerHeight,r=me.getBoundingClientRect(),n=Math.min(Math.max(me.offsetLeft,0),t-r.width),o=Math.min(Math.max(me.offsetTop,0),a-r.height);me.style.left=`${n}px`,me.style.top=`${o}px`}),fe.addEventListener("pointercancel",()=>{pe=!1,fe.style.cursor="grab"}),document.getElementById("hideAllButton")?.addEventListener("click",Ee),document.addEventListener("keydown",e=>{if(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;("Escape"===e.key||"Esc"===e.key||27===e.keyCode)&&(e.preventDefault(),Ee())},{capture:!0});const xe=document.getElementById("menuButton"),ve=document.querySelector("#saveGalleryButtons .menuButtons");function be(e,t="info"){console.log("showStatusMessage",e);const a=document.createElement("div");a.classList.add("status-message",t),a.innerText=e,document.body.appendChild(a),setTimeout(()=>{a.classList.add("fade-out"),setTimeout(()=>a.remove(),700)},700)}function P(e){e.style.display="flex",setTimeout(()=>{const t=e.querySelector(".close");t&&!t.dataset.listenerAdded&&(t.addEventListener("click",()=>S(e)),t.dataset.listenerAdded="true")},0)}function S(e){e.style.display="none"}ve.style.display="none",xe.addEventListener("click",()=>{"none"===ve.style.display?ve.style.display="flex":ve.style.display="none"});const Te=document.getElementById("saveModal"),we=document.getElementById("galleryModal"),Le=document.getElementById("saveButton"),Ae=document.getElementById("galleryButton"),Fe=document.getElementById("confirmSave");function Re({fit:e=!0}={}){const t=canvasWrapper.getBoundingClientRect(),a=canvas.width,r=canvas.height,n=Math.min(t.width/a,t.height/r,zoomMax),o=e?Math.max(zoomMin,n):1,i=canvas.style.transition;canvas.style.transition="transform 140ms ease-out",zoomScale=o,centerCanvasInWrapper(),setTimeout(()=>{canvas.style.transition=i},160),resetStrokeState(),needsRedraw=!0}Le&&Le.addEventListener("click",()=>P(Te)),Ae&&Ae.addEventListener("click",()=>{P(we),w()}),Fe&&Fe.addEventListener("click",()=>{const e=document.getElementById("artworkName");r(e?e.value:""),S(Te)});document.getElementById("resetViewBtn").addEventListener("click",()=>{Re({fit:!0}),document.activeElement&&"function"==typeof document.activeElement.blur&&document.activeElement.blur();const e=document.querySelector('meta[name="viewport"]');if(e){const t=e.getAttribute("content")||"width=device-width, initial-scale=1",a=t.replace(/,\s*maximum-scale=[^,]+/i,"");e.setAttribute("content",`${a}, maximum-scale=1`),setTimeout(()=>e.setAttribute("content",t),80)}}),document.addEventListener("keydown",e=>{isUserTyping()||"0"===e.key&&Re({fit:!0})})}),document.getElementById("cleanButton").addEventListener("click",()=>clearCanvas(!0)),document.getElementById("artworkName").addEventListener("keydown",function(e){"Enter"===e.key&&(e.preventDefault(),document.getElementById("saveNewButton").click())});const uiElements=[{id:"brushContainerWrapper",display:"flex"},{id:"brushSizeSliderContainer",display:"flex"},{id:"redoUndoButtons",display:"flex"},{id:"colorsContainer",display:"block"},{id:"saveGalleryButtons",display:"block"},{id:"profileSection",display:"block"},{id:"chatToggleBtn",display:"flex"},{id:"layersPanel",display:"block"}],fadeOutUI=()=>{uiElements.forEach(e=>{const t=document.getElementById(e.id);t&&(t.style.opacity="0",setTimeout(()=>{t.style.display="none"},250))})},fadeInUI=()=>{uiElements.forEach(e=>{const t=document.getElementById(e.id);t&&(t.style.display=e.display,setTimeout(()=>{t.style.opacity="1"},10))})};let uiTimeout=null;const uiTimeoutInterval=500,resetUITimeout=()=>{uiTimeout&&clearTimeout(uiTimeout),uiTimeout=setTimeout(fadeInUI,500)};let uiHidden=!1,hideStart=null;const HIDE_MOVE_THRESHOLD=6;function getCanvasPosFromEvent(e){const t=canvas.getBoundingClientRect(),a="touches"in e?e.touches[0]:e;return{x:(a.clientX-t.left)*(canvas.width/t.width),y:(a.clientY-t.top)*(canvas.height/t.height)}}function maybeHideUIOnMove(e){if(!isDrawing||uiHidden||!hideStart)return;const t=getCanvasPosFromEvent("touches"in e?e.touches[0]:e),a=t.x-hideStart.x,r=t.y-hideStart.y;Math.hypot(a,r)>=6&&(fadeOutUI(),uiTimeout&&clearTimeout(uiTimeout),uiHidden=!0)}function endStrokeUIReset(){uiHidden&&resetUITimeout(),hideStart=null,uiHidden=!1}canvas.addEventListener("mousedown",e=>{"fill"!==currentTool&&(hideStart=getCanvasPosFromEvent(e),uiHidden=!1)}),canvas.addEventListener("touchstart",e=>{isTwoFingerGesture||"fill"!==currentTool&&(hideStart=getCanvasPosFromEvent(e),uiHidden=!1)},{passive:!1}),canvas.addEventListener("mousemove",maybeHideUIOnMove,{passive:!0}),canvas.addEventListener("touchmove",e=>{isTwoFingerGesture||maybeHideUIOnMove(e)},{passive:!1}),canvas.addEventListener("mouseup",endStrokeUIReset),canvas.addEventListener("touchend",endStrokeUIReset),canvas.addEventListener("mouseleave",endStrokeUIReset),window.addEventListener("blur",resetUITimeout),window.addEventListener("focus",fadeInUI),document.getElementById("footer").innerHTML=document.title;const panels=[{id:"brushSizeSliderContainer",dragBarId:"brushSizeDragBar"},{id:"brushContainerWrapper",dragBarId:"brushContainerDragBar"}];function exportCanvasToImage(){const e=document.getElementById("glCanvas");return e?e.toDataURL("image/png"):(alert("Canvas not found!"),null)}function sendCanvasToFlaskForAI(){const e=exportCanvasToImage();e&&fetch("/run_ai_inference",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image_data:e})}).then(e=>e.blob()).then(e=>{const t=URL.createObjectURL(e),a=document.createElement("img");a.src=t,a.style.position="fixed",a.style.bottom="10px",a.style.right="10px",a.style.border="2px solid #ccc",a.style.maxWidth="200px",a.style.zIndex=9999,document.body.appendChild(a)}).catch(e=>{console.error("Error during AI request:",e),alert("AI request failed.")})}async function pasteImageFromClipboard(e){console.log("[Clipboard] pasteImageFromClipboard start");try{let t=null;if(e&&e.clipboardData&&e.clipboardData.items&&e.clipboardData.items.length)for(let a=0;a<e.clipboardData.items.length;a++){const r=e.clipboardData.items[a];if(r&&r.type&&r.type.startsWith("image/")){t=r.getAsFile?r.getAsFile():null;break}}if(!t&&navigator.clipboard&&navigator.clipboard.read)try{const e=await navigator.clipboard.read();for(const a of e){for(const e of a.types)if(e.startsWith("image/")){t=await a.getType(e);break}if(t)break}}catch(e){console.warn("[Clipboard] navigator.clipboard.read not permitted",e)}if(!t)return void showStatusMessage?.("Clipboard has no image data.","error");const a=await new Promise((e,a)=>{const r=URL.createObjectURL(t),n=new Image;n.onload=()=>{URL.revokeObjectURL(r),e(n)},n.onerror=e=>{URL.revokeObjectURL(r),a(e)},n.src=r});fixedFBOWidth&&fixedFBOHeight||(fixedFBOWidth=a.width,fixedFBOHeight=a.height,"function"==typeof initPaintLayerFixed&&initPaintLayerFixed(),"function"==typeof updateCanvasSize&&updateCanvasSize({width:a.width,height:a.height}),needsRedraw=!0);const r=layers&&Number.isInteger(activeLayerIndex)?layers[activeLayerIndex]:null;if(!r||!r.fbo)return void showStatusMessage?.("No active layer to paste into.","error");const n=fixedFBOWidth,o=fixedFBOHeight;!function(e,t,a,r){const n=a/e.width,o=r/e.height,i=Math.min(n,o,1),l=Math.max(1,Math.round(e.width*i)),s=Math.max(1,Math.round(e.height*i)),c=Math.floor((a-l)/2),d=Math.floor((r-s)/2),g=document.createElement("canvas");g.width=a,g.height=r;const u=g.getContext("2d");u.clearRect(0,0,a,r),u.imageSmoothingEnabled=!0,u.imageSmoothingQuality="high",u.drawImage(e,0,0,e.width,e.height,c,d,l,s);const m=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,m),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!1),gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,g),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindFramebuffer(gl.FRAMEBUFFER,t);const f=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(f!==gl.FRAMEBUFFER_COMPLETE)return console.warn("[Clipboard] FBO incomplete:",f),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null),void gl.deleteTexture(m);gl.viewport(0,0,a,r),gl.disable(gl.BLEND),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);const h=gl.getUniformLocation(quadProgram,"u_flipY");null!==h&&gl.uniform1f(h,1);const y=gl.getUniformLocation(quadProgram,"u_resolution");null!==y&&gl.uniform2f(y,a,r);const p=gl.getUniformLocation(quadProgram,"u_layerOpacity");null!==p&&gl.uniform1f(p,1);const E=new Float32Array([0,0,0,0,a,0,1,0,0,r,0,1,0,r,0,1,a,0,1,0,a,r,1,1]),x=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,x),gl.bufferData(gl.ARRAY_BUFFER,E,gl.STATIC_DRAW);const v=gl.getAttribLocation(quadProgram,"a_position"),b=gl.getAttribLocation(quadProgram,"a_texCoord");gl.enableVertexAttribArray(v),gl.vertexAttribPointer(v,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(b),gl.vertexAttribPointer(b,2,gl.FLOAT,!1,16,8),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,m);const T=gl.getUniformLocation(quadProgram,"u_texture");null!==T&&gl.uniform1i(T,0),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(v),gl.disableVertexAttribArray(b),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(x),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null),gl.deleteTexture(m)}(a,r.fbo,n,o),syncActiveAliases?.(),rebuildLayersUI?.(),needsRedraw=!0,showStatusMessage?.("Pasted image into active layer.","success"),console.log("[Clipboard] Paste complete")}catch(e){console.error("pasteImageFromClipboard error",e),showStatusMessage?.("Paste failed.","error")}}async function copyActiveLayerToClipboard(){console.log("[Clipboard] copyActiveLayerToClipboard start");try{if(!(navigator.clipboard&&navigator.clipboard.write&&window.ClipboardItem))return void showStatusMessage?.("Clipboard copy not supported.","error");const e=layers&&Number.isInteger(activeLayerIndex)?layers[activeLayerIndex]:null;if(!e||!e.fbo)return void showStatusMessage?.("No active layer to copy.","error");const t=fixedFBOWidth,a=fixedFBOHeight,r=document.createElement("canvas");r.width=t,r.height=a;r.getContext("2d").putImageData(readFBOToImageData(e.fbo,t,a),0,0);const n=document.createElement("canvas");n.width=t,n.height=a;const o=n.getContext("2d");o.save(),o.translate(t/2,a/2),o.scale(-1,-1),o.rotate(Math.PI),o.drawImage(r,-t/2,-a/2),o.restore();const i=await new Promise(e=>n.toBlob(e,"image/png"));if(!i)return void showStatusMessage?.("Copy failed (no data).","error");await navigator.clipboard.write([new ClipboardItem({[i.type]:i})]),showStatusMessage?.("Active layer copied to clipboard.","success"),console.log("[Clipboard] Copy complete")}catch(e){console.error("copyActiveLayerToClipboard error",e),showStatusMessage?.("Copy to clipboard failed.","error")}}async function _readClipboardImage(e){if(e&&e.clipboardData&&e.clipboardData.items&&e.clipboardData.items.length)for(let t=0;t<e.clipboardData.items.length;t++){const a=e.clipboardData.items[t];if(a&&a.type&&a.type.startsWith("image/")){const e=a.getAsFile?a.getAsFile():null;if(e)return e}}if(navigator.clipboard&&navigator.clipboard.read)try{const e=await navigator.clipboard.read();for(const t of e)for(const e of t.types)if(e.startsWith("image/")){const a=await t.getType(e);if(a)return a}}catch(e){console.warn("[Clipboard] navigator.clipboard.read not permitted",e)}return null}function _blobToImage(e){return new Promise((t,a)=>{const r=URL.createObjectURL(e),n=new Image;n.onload=()=>{URL.revokeObjectURL(r),t(n)},n.onerror=e=>{URL.revokeObjectURL(r),a(e)},n.src=r})}function renderLoop(){needsRedraw&&(drawScene(),console.log("renderLoop"),needsRedraw=!1),requestAnimationFrame(renderLoop)}panels.forEach(({id:e,dragBarId:t})=>{const a=document.getElementById(e),r=document.getElementById(t);if(!a||!r)return;let n=0,o=0,i=!1;const l=localStorage.getItem(`${e}-x`),s=localStorage.getItem(`${e}-y`);null!==l&&null!==s&&(a.style.left=`${l}px`,a.style.top=`${s}px`,a.style.bottom="auto"),r.addEventListener("pointerdown",e=>{i=!0,n=e.clientX-a.offsetLeft,o=e.clientY-a.offsetTop,r.setPointerCapture(e.pointerId),r.style.cursor="grabbing"}),r.addEventListener("pointermove",e=>{if(!i)return;const t=e.clientX-n,r=e.clientY-o;a.style.left=`${t}px`,a.style.top=`${r}px`,a.style.bottom="auto"}),r.addEventListener("pointerup",t=>{i=!1,r.releasePointerCapture(t.pointerId),r.style.cursor="grab",localStorage.setItem(`${e}-x`,a.offsetLeft),localStorage.setItem(`${e}-y`,a.offsetTop)}),r.addEventListener("pointercancel",()=>{i=!1,r.style.cursor="grab"})}),document.addEventListener("paste",e=>{!!(e&&e.clipboardData&&[...e.clipboardData.items].some(e=>e.type.startsWith("image/")))&&(e.preventDefault(),pasteImageFromClipboard(e))}),document.addEventListener("copy",e=>{(navigator.platform.toUpperCase().includes("MAC")?e.metaKey:e.ctrlKey)&&!0===e.shiftKey&&(e.preventDefault(),copyActiveLayerToClipboard())}),document.addEventListener("keydown",e=>{(navigator.platform.toUpperCase().includes("MAC")?e.metaKey:e.ctrlKey)&&"v"===e.key.toLowerCase()&&setTimeout(async()=>{if(navigator.clipboard&&navigator.clipboard.read)try{const e=await navigator.clipboard.read();e.some(e=>e.types.some(e=>e.startsWith("image/")))&&pasteImageFromClipboard(null)}catch(e){}},0)}),function(){const e=document.getElementById("layersPanel"),t=document.getElementById("layersPanelDragBar"),a=document.getElementById("layersList"),r=document.getElementById("layersActions"),n=document.getElementById("layersPanelToggle");if(!e||!t)return;const o="layersPanel:minimized",i="layersPanel:x",l="layersPanel:y",s=localStorage.getItem(i),c=localStorage.getItem(l);null!==s&&null!==c&&(e.style.left=+s+"px",e.style.top=+c+"px",e.style.bottom="auto");let d="true"===localStorage.getItem(o);function g(){a&&(a.style.display=d?"none":"flex"),r&&(r.style.display=d?"none":"flex"),n&&(n.innerHTML=d?'<img class="show-icon-invert" src="/static/draw/images/icons/hide.svg" alt="Show">':'<img class="show-icon-invert" src="/static/draw/images/icons/show.svg" alt="Hide">')}g(),n&&n.addEventListener("click",e=>{e.stopPropagation(),d=!d,localStorage.setItem(o,d),g()});let u=!1,m=0,f=0;function h(e,t,a){return Math.max(t,Math.min(a,e))}function y(a){if(u){u=!1;try{t.releasePointerCapture(a.pointerId)}catch{}t.style.cursor="grab",localStorage.setItem(i,e.offsetLeft),localStorage.setItem(l,e.offsetTop)}}t.style.cursor="grab",t.addEventListener("pointerdown",function(a){const r=a.target;if(!r.closest||!r.closest(".icon-btn")){u=!0,m=a.clientX-e.offsetLeft,f=a.clientY-e.offsetTop;try{t.setPointerCapture(a.pointerId)}catch{}t.style.cursor="grabbing",a.preventDefault()}}),t.addEventListener("pointermove",function(t){if(!u)return;const a=window.innerWidth,r=window.innerHeight,n=h(t.clientX-m,0,a-e.offsetWidth),o=h(t.clientY-f,0,r-e.offsetHeight);e.style.left=`${n}px`,e.style.top=`${o}px`,e.style.bottom="auto"}),t.addEventListener("pointerup",y),t.addEventListener("pointercancel",y);try{a&&"block"===getComputedStyle(a).display&&(a.style.display="flex")}catch{}try{rebuildLayersUI?.()}catch{}}(),initGL(),loadDefaultImage(),loadBrushes(),createBrushThumbnails(),renderLoop(),window.addEventListener("keydown",e=>{const t=/Mac|iPhone|iPad/.test(navigator.platform);"F1"===e.key&&(e.preventDefault(),openHelpModal()),("?"===e.key||"/"===e.key&&e.shiftKey)&&(e.preventDefault(),openQuickHelpOverlay()),(t?e.metaKey:e.ctrlKey)&&"/"===e.key&&(e.preventDefault(),openQuickHelpOverlay())});