console.log("Helena Paint - draw56.js");const canvas=document.getElementById("glCanvas"),canvasWrapper=document.getElementById("canvasWrapper")||canvas.parentElement;canvas.style.transformOrigin="top left";let lastX=null,lastY=null,zoomScale=1,panX=0,panY=0,zoomMin=1,zoomMax=5,lastTouchDist=null,lastTouchMidpoint=null,isPanning=!1,isTwoFingerGesture=!1,isUIDragging=!1;function isMobile(){return/Mobi|Android|iPhone|iPad|iPod/.test(navigator.userAgent)}function getMidpoint(e,t){return{x:(e.clientX+t.clientX)/2,y:(e.clientY+t.clientY)/2}}function getDistance(e,t){const a=e.clientX-t.clientX,r=e.clientY-t.clientY;return Math.sqrt(a*a+r*r)}function canPaint(){return"idle"===transformTool.mode&&!spacePanning&&!isTwoFingerGesture&&!isUIDragging}let pinchStart=null;function normAngle(e){return e>Math.PI&&(e-=2*Math.PI),e<-Math.PI&&(e+=2*Math.PI),e}function transformCanvasPoint(e,t,a,r){const n=e*a,o=t*a,i=Math.cos(r),l=Math.sin(r);return{x:n*i-o*l,y:n*l+o*i}}let viewRotation=0,transformOriginX=0,transformOriginY=0;function updateCanvasTransform(){canvas.style.transformOrigin="0 0",canvas.style.transform=`translate(${panX}px, ${panY}px) rotate(${viewRotation}rad) scale(${zoomScale})`}function rotatePoint(e,t,a,r=0,n=0){const o=e-r,i=t-n,l=Math.cos(a),s=Math.sin(a);return{x:r+o*l-i*s,y:n+o*s+i*l}}function screenToCanvasPx(e,t){const a=canvasWrapper.getBoundingClientRect();let r=e-a.left,n=t-a.top;r-=panX,n-=panY;const o=rotatePoint(r,n,-viewRotation,transformOriginX,transformOriginY);r=o.x,n=o.y;const i=r/zoomScale,l=n/zoomScale;return{x:Math.max(0,Math.min(canvas.width,i)),y:Math.max(0,Math.min(canvas.height,l))}}function canvasPxToFBO(e,t){return{fx:e*(fixedFBOWidth/canvas.width),fy:t*(fixedFBOHeight/canvas.height)}}function pointerToBoth(e){const t=screenToCanvasPx(e.clientX,e.clientY),a=canvasPxToFBO(t.x,t.y);return{cx:t.x,cy:t.y,fx:a.fx,fy:a.fy}}let brushHUD={visible:!1,hideAt:0},lastPointer={cx:.5*canvas.width,cy:.5*canvas.height};function showBrushHUD(e=1200){brushHUD.visible=!0,brushHUD.hideAt=performance.now()+e,needsRedraw=!0,requestDrawIfIdle()}function maybeAutoHideBrushHUD(){brushHUD.visible&&performance.now()>=brushHUD.hideAt&&(brushHUD.visible=!1,needsRedraw=!0,requestDrawIfIdle())}let touchViz={pts:[],visible:!1};function setTouchVizFromTouches(e){const t=[];for(let a=0;a<e.length;a++){const r=e[a],n=screenToCanvasPx(r.clientX,r.clientY);t.push({x:n.x,y:n.y})}touchViz.pts=t,touchViz.visible=t.length>0,void 0!==needsRedraw&&(needsRedraw=!0),"function"==typeof requestDrawIfIdle&&requestDrawIfIdle()}function clearTouchViz(){touchViz.pts=[],touchViz.visible=!1,void 0!==needsRedraw&&(needsRedraw=!0),"function"==typeof requestDrawIfIdle&&requestDrawIfIdle()}const TOUCH_TARGET_OK=e=>!(!e||e!==canvas&&e!==canvasWrapper&&!e.closest?.("#canvasWrapper"));function onTouchStartCapture(e){e.touches&&e.touches.length&&TOUCH_TARGET_OK(e.target)&&setTouchVizFromTouches(e.touches)}function onTouchMoveCapture(e){e.touches&&e.touches.length&&TOUCH_TARGET_OK(e.target)&&setTouchVizFromTouches(e.touches)}function onTouchEndCapture(e){e.touches&&e.touches.length?setTouchVizFromTouches(e.touches):clearTouchViz()}document.addEventListener("touchstart",onTouchStartCapture,{capture:!0,passive:!0}),document.addEventListener("touchmove",onTouchMoveCapture,{capture:!0,passive:!0}),document.addEventListener("touchend",onTouchEndCapture,{capture:!0,passive:!0}),document.addEventListener("touchcancel",onTouchEndCapture,{capture:!0,passive:!0});let frameTimes=[],memoryWarningShown=!1,frameRateMonitoringActive=!1;function sampleFrameTime(){const e=performance.now();if(frameTimes.push(e),frameTimes.length>30&&frameTimes.shift(),activeReasons.size>0){const e=[];for(let t=1;t<frameTimes.length;t++)e.push(frameTimes[t]-frameTimes[t-1]);(e.length?e.reduce((e,t)=>e+t,0)/e.length:0)>80&&!memoryWarningShown&&(console.warn("⚠️ Low frame rate detected! Possible memory overload."),showStatusMessage("⚠️ App running slow — consider undo or saving","warning"),memoryWarningShown=!0)}}let rafId=null;const activeReasons=new Set;function requestDrawIfIdle(){rafId||(rafId=requestAnimationFrame(()=>{rafId=null,needsRedraw&&(drawScene(),needsRedraw=!1,sampleFrameTime?.())}))}function startRender(e){e&&activeReasons.add(e),rafId||(rafId=requestAnimationFrame(tick))}function stopRender(e){e&&activeReasons.delete(e)}function tick(){rafId=null;activeReasons.size>0?(needsRedraw&&(drawScene(),needsRedraw=!1,sampleFrameTime?.()),rafId=requestAnimationFrame(tick)):needsRedraw&&(drawScene(),needsRedraw=!1,sampleFrameTime?.())}let RENDER_LOOP_DISABLED=!0;function disableRenderLoop(){RENDER_LOOP_DISABLED=!0;try{activeReasons?.clear?.()}catch{}rafId&&(cancelAnimationFrame(rafId),rafId=null)}function enableRenderLoop(){RENDER_LOOP_DISABLED=!1}const _startRender=startRender;startRender=function(e){RENDER_LOOP_DISABLED||_startRender.call(this,e)};const _requestDrawIfIdle=requestDrawIfIdle;requestDrawIfIdle=function(){RENDER_LOOP_DISABLED?needsRedraw&&(drawScene(),needsRedraw=!1,sampleFrameTime?.()):_requestDrawIfIdle.call(this)};const _tick=tick;tick=function(){RENDER_LOOP_DISABLED?rafId&&(cancelAnimationFrame(rafId),rafId=null):_tick.call(this)},disableRenderLoop(),canvasWrapper.addEventListener("wheel",e=>{e.preventDefault();const t=1===e.deltaMode?16:1,a=e.deltaX*t,r=e.deltaY*t,n=canvasWrapper.getBoundingClientRect(),o=e.clientX-n.left,i=e.clientY-n.top,l=(o-panX)/zoomScale,s=(i-panY)/zoomScale;if(e.ctrlKey){const e=.0025,t=Math.min(Math.max(zoomScale-r*e,zoomMin),zoomMax),a=t/zoomScale;panX-=l*(a-1)*zoomScale,panY-=s*(a-1)*zoomScale,zoomScale=t,updateCanvasTransform()}else{const e=1;panX-=a*e,panY-=r*e,updateCanvasTransform()}},{passive:!1}),canvasWrapper.addEventListener("mousemove",e=>{const t=screenToCanvasPx(e.clientX,e.clientY);lastPointer.cx=t.x,lastPointer.cy=t.y,brushHUD.visible&&(overlayPosition=[t.x/canvas.width,t.y/canvas.height],needsRedraw=!0,requestDrawIfIdle())},{passive:!0});let spacePanning=!1,panStart=null;document.addEventListener("keydown",e=>{"Space"===e.code&&(spacePanning=!0)}),document.addEventListener("keyup",e=>{"Space"===e.code&&(spacePanning=!1)}),canvasWrapper.addEventListener("mousedown",e=>{spacePanning&&(e.preventDefault(),panStart={x:e.clientX,y:e.clientY,panX0:panX,panY0:panY})}),window.addEventListener("mousemove",e=>{panStart&&(panX=panStart.panX0+(e.clientX-panStart.x),panY=panStart.panY0+(e.clientY-panStart.y),updateCanvasTransform())}),["mouseup","mouseleave"].forEach(e=>window.addEventListener(e,()=>panStart=null)),canvasWrapper.addEventListener("mousedown",e=>{if(1!==e.button)return;e.preventDefault();const t=e.clientX,a=e.clientY,r=panX,n=panY,o=e=>{panX=r+(e.clientX-t),panY=n+(e.clientY-a),updateCanvasTransform()},i=()=>{window.removeEventListener("mousemove",o),window.removeEventListener("mouseup",i)};window.addEventListener("mousemove",o),window.addEventListener("mouseup",i)}),window.addEventListener("mousemove",onTransformPointerMove),canvas.addEventListener("touchmove",e=>{if("idle"===transformTool.mode)return;const t=e.touches[0];t&&onTransformPointerMove(t)},{passive:!1}),["mouseup","mouseleave","touchend","touchcancel"].forEach(e=>window.addEventListener(e,()=>{"idle"!==transformTool.mode&&endTransform(!0)},{passive:!0})),canvas.addEventListener("mousedown",()=>{isDrawing=!0,startRender("draw")}),["mouseup","mouseleave"].forEach(e=>canvas.addEventListener(e,()=>{isDrawing=!1,stopRender("draw")})),canvas.addEventListener("touchstart",e=>{isTwoFingerGesture||(isDrawing=!0,startRender("draw"))},{passive:!1}),["touchend","touchcancel"].forEach(e=>window.addEventListener(e,()=>{isTwoFingerGesture&&(!event.touches||event.touches.length<2)&&(isTwoFingerGesture=!1,pinchStart=null),"idle"!==transformTool.mode&&endTransform(!0)},{passive:!0}));let lastTouchAngle=null;function getAngle(e,t){return Math.atan2(t.clientY-e.clientY,t.clientX-e.clientX)}canvasWrapper.addEventListener("touchstart",e=>{if(2===e.touches.length){e.preventDefault(),isTwoFingerGesture=!0;const t=e.touches[0],a=e.touches[1];lastTouchDist=getDistance(t,a),lastTouchAngle=getAngle(t,a);const r=getMidpoint(t,a),n=canvasWrapper.getBoundingClientRect(),o=r.x-n.left,i=r.y-n.top,l=screenToCanvasPx(o+n.left,i+n.top);pinchStart={dist:Math.max(1e-6,lastTouchDist),angle:lastTouchAngle,scale0:zoomScale,rot0:viewRotation,anchorCanvas:{x:l.x,y:l.y}}}},{passive:!1}),canvasWrapper.addEventListener("touchmove",e=>{if(2!==e.touches.length||!pinchStart)return;e.preventDefault(),isDrawing=!1;const t=e.touches[0],a=e.touches[1],r=Math.max(1e-6,getDistance(t,a)),n=getAngle(t,a),o=getMidpoint(t,a),i=canvasWrapper.getBoundingClientRect(),l=o.x-i.left,s=o.y-i.top,c=pinchStart.scale0*(r/pinchStart.dist),d=Math.min(Math.max(c,zoomMin),zoomMax),g=normAngle(n-pinchStart.angle),u=pinchStart.rot0+g,m=pinchStart.anchorCanvas,f=transformCanvasPoint(m.x,m.y,d,u);panX=l-f.x,panY=s-f.y,zoomScale=d,viewRotation=u,updateCanvasTransform(),lastTouchDist=r,lastTouchAngle=n},{passive:!1}),canvas.addEventListener("touchstart",e=>{isTwoFingerGesture&&(e.preventDefault(),e.stopPropagation())},{passive:!1});const gl=canvas.getContext("webgl2",{alpha:!0,powerPreference:"high-performance"});let needsRedraw=!0;const imageLoader=document.getElementById("imageLoader"),colorPicker=document.getElementById("colorPicker"),brushes=[{name:"Dot",file:"/static/draw/images/brushes/dot.webp",defaultSize:.02,selected:!1},{name:"Fine Liner",file:"/static/draw/images/brushes/fine-liner-2.webp",defaultSize:.03,selected:!1},{name:"Brush 12",file:"/static/draw/images/brushes/12.webp",defaultSize:.04,selected:!1},{name:"Brush 11",file:"/static/draw/images/brushes/11.webp",defaultSize:.05,selected:!0},{name:"Brush 0",file:"/static/draw/images/brushes/0.png",defaultSize:.025,selected:!1},{name:"Brush 5",file:"/static/draw/images/brushes/5.png",defaultSize:.03,selected:!1},{name:"Brush 1",file:"/static/draw/images/brushes/1.png",defaultSize:.035,selected:!1},{name:"Brush 2",file:"/static/draw/images/brushes/2.png",defaultSize:.04,selected:!1},{name:"Brush 3",file:"/static/draw/images/brushes/3.png",defaultSize:.045,selected:!1},{name:"Brush 4",file:"/static/draw/images/brushes/4.png",defaultSize:.05,selected:!1},{name:"Brush 7",file:"/static/draw/images/brushes/7.webp",defaultSize:.06,selected:!1},{name:"Brush 8",file:"/static/draw/images/brushes/8.webp",defaultSize:.2,selected:!1}];let paintFBO,paintTexture,quadProgram,paintProgram,overlayProgram,floodFillProgram,brushTextures={},brushAspects={},currentBrush=null,currentArtworkId=null,texture=null,overlayTexture=null,brushAspect=1,imageAspect=1,currentImage=null,overlayPosition=[0,0],isDrawing=!1,currentTool="draw",fixedFBOWidth=0,fixedFBOHeight=0,tintColor=[0,0,0,1];function hexToHSL(e){3===(e=e.replace(/^#/,"")).length&&(e=e.split("").map(e=>e+e).join(""));let t,a,r=parseInt(e.substr(0,2),16)/255,n=parseInt(e.substr(2,2),16)/255,o=parseInt(e.substr(4,2),16)/255,i=Math.max(r,n,o),l=Math.min(r,n,o),s=(i+l)/2;if(i===l)t=a=0;else{let e=i-l;switch(a=s>.5?e/(2-i-l):e/(i+l),i){case r:t=(n-o)/e+(n<o?6:0);break;case n:t=(o-r)/e+2;break;case o:t=(r-n)/e+4}t/=6}return{h:t,s:a,l:s}}colorPicker.addEventListener("input",e=>{tintColor=hexToRGBA(e.target.value);const t=hexToHSL(e.target.value);baseColor=hexToRGBA(e.target.value).slice(0,3),lightnessFactor=t.l,updateLightnessGradient(),updateFinalColor();const a=colorPalette.querySelector(".indicator");a&&(a.style.top=t.h*(colorPalette.clientHeight-a.clientHeight)+"px");const r=lightnessPalette.querySelector(".indicator");r&&(r.style.top=t.l*(lightnessPalette.clientHeight-r.clientHeight)+"px")});const colorPalette=document.getElementById("colorPalette"),lightnessPalette=document.getElementById("lightnessPalette");let baseColor=[0,0,0],lightnessFactor=.5;function updateLightnessGradient(){const e=`linear-gradient(to bottom, rgb(${Math.round(255*baseColor[0])}, ${Math.round(255*baseColor[1])}, ${Math.round(255*baseColor[2])}), white)`;document.getElementById("lightnessPalette").style.background=e}function pickBaseColor(e){const t=colorPalette.getBoundingClientRect(),a=(e.touches?e.touches[0].clientY:e.clientY)-t.top,r=Math.max(0,Math.min(1,a/t.height)),n=[[255,0,0],[255,255,0],[0,255,0],[0,255,255],[0,0,255],[255,0,255],[255,0,0]],o=Math.floor(r*(n.length-1)),i=Math.min(o+1,n.length-1),l=r*(n.length-1)%1;baseColor=[(n[o][0]*(1-l)+n[i][0]*l)/255,(n[o][1]*(1-l)+n[i][1]*l)/255,(n[o][2]*(1-l)+n[i][2]*l)/255],updateLightnessGradient(),updateFinalColor();const s=colorPalette.querySelector(".indicator");s&&(s.style.top=r*(colorPalette.clientHeight-s.clientHeight)+"px")}function pickLightness(e){const t=lightnessPalette.getBoundingClientRect(),a=(e.touches?e.touches[0].clientY:e.clientY)-t.top,r=Math.max(0,Math.min(1,a/t.height));lightnessFactor=r,updateFinalColor();const n=lightnessPalette.querySelector(".indicator");n&&(n.style.top=r*(lightnessPalette.clientHeight-n.clientHeight)+"px")}function updateFinalColor(){const e=Math.round(baseColor[0]*(1-lightnessFactor)*255+255*lightnessFactor),t=Math.round(baseColor[1]*(1-lightnessFactor)*255+255*lightnessFactor),a=Math.round(baseColor[2]*(1-lightnessFactor)*255+255*lightnessFactor);tintColor=[e/255,t/255,a/255,1];const r=rgbToHex(e,t,a);console.log("hexColor",r),document.getElementById("colorPicker").value=r,needsRedraw=!0}function rgbToHex(e,t,a){return`#${(1<<24|e<<16|t<<8|a).toString(16).slice(1).toUpperCase()}`}function replaceColorPicker(e){const t=document.getElementById("colorPicker"),a=document.createElement("input");a.type="color",a.id="colorPicker",a.value=e,a.addEventListener("input",e=>{tintColor=hexToRGBA(e.target.value),needsRedraw=!0}),t.parentNode.replaceChild(a,t)}function hexToRGBA(e){"#"===e.charAt(0)&&(e=e.substr(1)),3===e.length&&(e=e.split("").map(e=>e+e).join(""));let t=parseInt(e,16);return[(t>>16&255)/255,(t>>8&255)/255,(255&t)/255,1]}function makeBrushFromActiveLayer(){var e="function"==typeof getActiveLayer?getActiveLayer():null;if(!(gl&&quadProgram&&e&&e.texture))return null;var t=Math.max(1,0|e.texW||fixedFBOWidth||canvas.width),a=Math.max(1,0|e.texH||fixedFBOHeight||canvas.height),r=gl.getParameter(gl.FRAMEBUFFER_BINDING),n=gl.getParameter(gl.CURRENT_PROGRAM),o=gl.getParameter(gl.VIEWPORT),i=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,i),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,t,a,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);var l=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,l),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,i,0),gl.viewport(0,0,t,a),gl.disable(gl.BLEND),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);var s=gl.getUniformLocation(quadProgram,"u_flipY"),c=gl.getUniformLocation(quadProgram,"u_resolution"),d=gl.getUniformLocation(quadProgram,"u_layerOpacity"),g=gl.getUniformLocation(quadProgram,"u_texture");s&&gl.uniform1f(s,1),c&&gl.uniform2f(c,t,a),d&&gl.uniform1f(d,1),g&&gl.uniform1i(g,0);var u=new Float32Array([0,0,0,0,t,0,1,0,0,a,0,1,0,a,0,1,t,0,1,0,t,a,1,1]),m=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,m),gl.bufferData(gl.ARRAY_BUFFER,u,gl.STREAM_DRAW);var f=gl.getAttribLocation(quadProgram,"a_position"),h=gl.getAttribLocation(quadProgram,"a_texCoord");f>=0&&(gl.enableVertexAttribArray(f),gl.vertexAttribPointer(f,2,gl.FLOAT,!1,16,0)),h>=0&&(gl.enableVertexAttribArray(h),gl.vertexAttribPointer(h,2,gl.FLOAT,!1,16,8)),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,e.texture),gl.drawArrays(gl.TRIANGLES,0,6),f>=0&&gl.disableVertexAttribArray(f),h>=0&&gl.disableVertexAttribArray(h),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(m),gl.bindFramebuffer(gl.FRAMEBUFFER,r);try{gl.deleteFramebuffer(l)}catch(e){}return gl.useProgram(n),o&&gl.viewport(o[0],o[1],o[2],o[3]),overlayTexture=i,brushAspect=t/a,currentBrush={name:e.name?e.name+" → Brush":"Layer Brush",type:"bitmap",texture:i,defaultSize:currentBrush&&currentBrush.defaultSize?currentBrush.defaultSize:.05,aspect:brushAspect,spacing:.14,angleFromDirection:!0,opacity:1},currentTool="draw",lastPointer&&"function"==typeof showBrushHUD&&showBrushHUD(1500),needsRedraw=!0,"function"==typeof requestDrawIfIdle&&requestDrawIfIdle(),currentBrush}function deleteBrushById(e){const t=window.brushes||[],a=t.findIndex(t=>t.id===e);if(a>=0){const e=t[a];try{"bitmap"===e.type&&e.tex&&gl.deleteTexture(e.tex)}catch{}t.splice(a,1)}}["mousedown","touchstart"].forEach(e=>{colorPalette.addEventListener(e,e=>{pickBaseColor(e),document.addEventListener("mousemove",pickBaseColor),document.addEventListener("touchmove",pickBaseColor)}),lightnessPalette.addEventListener(e,e=>{pickLightness(e),document.addEventListener("mousemove",pickLightness),document.addEventListener("touchmove",pickLightness)})}),["mouseup","touchend"].forEach(e=>{document.addEventListener(e,()=>{document.removeEventListener("mousemove",pickBaseColor),document.removeEventListener("mousemove",pickLightness),document.removeEventListener("touchmove",pickBaseColor),document.removeEventListener("touchmove",pickLightness)})}),document.addEventListener("touchmove",function(e){e.target.closest("#colorPalette, #lightnessPalette")&&e.preventDefault()},{passive:!1});var layerToBrushBtn=document.getElementById("layerToBrushBtn");function createShader(e,t,a){const r=e.createShader(t);return e.shaderSource(r,a),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS)?r:(console.error("Shader compile error:",e.getShaderInfoLog(r)),e.deleteShader(r),null)}function createProgram(e,t,a){const r=createShader(e,e.VERTEX_SHADER,t),n=createShader(e,e.FRAGMENT_SHADER,a);if(!r||!n)return null;const o=e.createProgram();return e.attachShader(o,r),e.attachShader(o,n),e.linkProgram(o),e.getProgramParameter(o,e.LINK_STATUS)?o:(console.error("Program link error:",e.getProgramInfoLog(o)),null)}layerToBrushBtn&&layerToBrushBtn.addEventListener("click",function(){makeBrushFromActiveLayer()?("function"==typeof showStatusMessage&&showStatusMessage("Brush created from layer","success"),"function"==typeof requestDrawIfIdle&&requestDrawIfIdle()):"function"==typeof showStatusMessage&&showStatusMessage("No active layer to convert","warning")});const quadVS="\n  attribute vec2 a_position;\n  attribute vec2 a_texCoord;\n  uniform vec2 u_resolution;\n  uniform float u_flipY; // set to 1.0 for no flip; -1.0 for normal flip\n  varying vec2 v_texCoord;\n  void main() {\n    vec2 zeroToOne = a_position / u_resolution;\n    vec2 clipSpace = zeroToOne * 2.0 - 1.0;\n    gl_Position = vec4(clipSpace.x, clipSpace.y * u_flipY, 0, 1);\n    v_texCoord = a_texCoord;\n  }\n",quadFS="\n    precision mediump float;\n    varying vec2 v_texCoord;\n    uniform sampler2D u_texture;\n    uniform float u_layerOpacity; // NEW\n\n    void main() {\n      vec4 c = texture2D(u_texture, v_texCoord);\n      c.a *= u_layerOpacity;      // apply per-layer opacity here\n      gl_FragColor = c;\n    }\n",paintFS="\n  precision mediump float;\n  varying vec2 v_texCoord;\n  uniform sampler2D u_brush;\n  uniform vec4 u_tint;\n  uniform bool u_erase;\n  uniform float u_eraseStrength; // controls erasing strength\n  uniform float u_paintStrength; // controls painting strength\n  void main() {\n    vec4 brushColor = texture2D(u_brush, v_texCoord);\n    if (u_erase) {\n      gl_FragColor = vec4(0.0, 0.0, 0.0, brushColor.a * u_eraseStrength * 0.05);\n    } else {\n      // Multiply the brush alpha by u_paintStrength so that lower values yield lighter strokes.\n      gl_FragColor = vec4(u_tint.rgb, brushColor.a * u_paintStrength);\n    }\n  }\n",overlayFS="\n  precision mediump float;\n  varying vec2 v_texCoord;\n  uniform sampler2D u_brush;\n  uniform vec4 u_tint;\n  void main() {\n    vec4 brushColor = texture2D(u_brush, v_texCoord);\n    gl_FragColor = vec4(u_tint.rgb, brushColor.a);\n  }\n";let ringProgram;const ringFS="\nprecision mediump float;\nuniform vec2  u_center;     // circle center in screen px (top-left origin)\nuniform float u_radius;     // ring radius in px\nuniform float u_thickness;  // ring thickness in px\nuniform vec4  u_color;      // RGBA\nuniform vec2  u_viewport;   // canvas size (w,h)\n\nvoid main() {\n  // Convert gl_FragCoord (bottom-left origin) to top-left\n  vec2 p = vec2(gl_FragCoord.x, u_viewport.y - gl_FragCoord.y);\n  float d = abs(length(p - u_center) - u_radius);\n  // 1px anti-aliasing band\n  float aa = 1.0;\n  float alpha = smoothstep(u_thickness + aa, u_thickness - aa, d);\n  gl_FragColor = vec4(u_color.rgb, u_color.a * alpha);\n}\n";let dashProgram;const dashFS="\nprecision mediump float;\n\nuniform vec2  u_a;          // start of line in screen px (top-left origin)\nuniform vec2  u_b;          // end of line in screen px\nuniform float u_thickness;  // half-thickness in px\nuniform float u_dash;       // dash length in px\nuniform float u_gap;        // gap length in px\nuniform vec4  u_color;      // RGBA\nuniform vec2  u_viewport;   // canvas size (w,h)\n\nvoid main() {\n  // convert gl_FragCoord (bottom-left origin) to top-left origin\n  vec2 p = vec2(gl_FragCoord.x, u_viewport.y - gl_FragCoord.y);\n  vec2 a = u_a, b = u_b;\n\n  vec2 ab = b - a;\n  float len = max(1.0, length(ab));\n  vec2 ap = p - a;\n\n  // project p onto segment a-b\n  float t = clamp(dot(ap, ab) / (len * len), 0.0, 1.0);\n  float dist = length(ap - ab * t);\n\n  // dashed pattern along the segment\n  float along = t * len;\n  float seg   = max(1.0, u_dash + u_gap);\n  float m     = mod(along, seg);\n  float inDash = step(m, u_dash); // 1 inside dash, 0 inside gap\n\n  // soft edges (1px AA band)\n  float aa = 1.0;\n  float alpha = inDash * smoothstep(u_thickness + aa, u_thickness - aa, dist);\n\n  gl_FragColor = vec4(u_color.rgb, u_color.a * alpha);\n}\n";function getActiveLayer(){return layers[activeLayerIndex]}function syncActiveAliases(){const e=getActiveLayer();if(!e)return paintFBO=null,void(paintTexture=null);paintFBO=e.fbo,paintTexture=e.texture}function initGL(){gl?(quadProgram=createProgram(gl,quadVS,quadFS),paintProgram=createProgram(gl,quadVS,paintFS),overlayProgram=createProgram(gl,quadVS,overlayFS),ringProgram=createProgram(gl,quadVS,ringFS),dashProgram=createProgram(gl,quadVS,dashFS)):console.error("WebGL not supported.")}let __quadVbo=null;function __bindAndDrawTexturedQuad(e,t,a){const r=new Float32Array([0,0,0,0,t,0,1,0,0,a,0,1,0,a,0,1,t,0,1,0,t,a,1,1]);__quadVbo||(__quadVbo=gl.createBuffer()),gl.bindBuffer(gl.ARRAY_BUFFER,__quadVbo),gl.bufferData(gl.ARRAY_BUFFER,r,gl.STREAM_DRAW);const n=gl.getAttribLocation(e,"a_position"),o=gl.getAttribLocation(e,"a_texCoord");gl.enableVertexAttribArray(n),gl.vertexAttribPointer(n,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(o),gl.vertexAttribPointer(o,2,gl.FLOAT,!1,16,8),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(n),gl.disableVertexAttribArray(o),gl.bindBuffer(gl.ARRAY_BUFFER,null)}function __getSelectedIndices(){if(void 0!==selectedLayerIndices&&selectedLayerIndices&&selectedLayerIndices.size)return Array.from(selectedLayerIndices).sort((e,t)=>e-t);try{const e=document.getElementById("layersList");if(e){const t=[];if(e.querySelectorAll(".layer-item").forEach(e=>{const a=e.getAttribute("data-index"),r=e.querySelector(".layer-select input[type='checkbox']");r&&r.checked&&null!=a&&t.push(Number(a))}),t.length)return t.sort((e,t)=>e-t)}}catch{}return["number"==typeof activeLayerIndex?activeLayerIndex:0]}function __layerQuadInFboSpace(e,t,a){const r=fixedFBOWidth,n=fixedFBOHeight,o=Number.isFinite(e.ox)?e.ox:0,i=Number.isFinite(e.oy)?e.oy:0,l=Number.isFinite(e.texW)?e.texW:r,s=Number.isFinite(e.texH)?e.texH:n,c=Number.isFinite(e.px)?e.px:.5*r,d=Number.isFinite(e.py)?e.py:.5*n,g=Math.cos(e.rotation||0),u=Math.sin(e.rotation||0);function m(t,a){let r=t-c,n=a-d;r*=Number.isFinite(e.scaleX)?e.scaleX:1,n*=Number.isFinite(e.scaleY)?e.scaleY:1;const o=r*u+n*g;return{x:c+(r*g-n*u)+(Number.isFinite(e.x)?e.x:0),y:d+o+(Number.isFinite(e.y)?e.y:0)}}const f=m(o,i),h=m(o+l,i),y=m(o,i+s),p=m(o+l,i+s);return new Float32Array([f.x,f.y,0,0,h.x,h.y,1,0,y.x,y.y,0,1,y.x,y.y,0,1,h.x,h.y,1,0,p.x,p.y,1,1])}function createLayerFBO(e,t){const a=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,a),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,e,t,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);const r=gl.createFramebuffer();return gl.bindFramebuffer(gl.FRAMEBUFFER,r),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,a,0),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.bindFramebuffer(gl.FRAMEBUFFER,null),{texture:a,fbo:r}}let layers=[],activeLayerIndex=0;function addLayer(e=`Layer ${layers.length+1}`,t=activeLayerIndex){const a=fixedFBOWidth,r=fixedFBOHeight,{texture:n,fbo:o}=createLayerFBO(a,r),i={id:Date.now()+Math.random(),name:e,fbo:o,texture:n,visible:!0,opacity:1,x:0,y:0,scaleX:1,scaleY:1,rotation:0,px:.5*a,py:.5*r,texW:a,texH:r,ox:0,oy:0,history:[],redo:[]},l=Math.max(0,Math.min(t,layers.length));layers.splice(l,0,i),activeLayerIndex=l,syncActiveAliases(),"function"==typeof rebuildLayersUI&&rebuildLayersUI(),needsRedraw=!0}function drawRingOverlay(e,t,a,r,n=[1,0,0,.95]){if(!ringProgram)return;gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.useProgram(ringProgram);const o=gl.getUniformLocation(ringProgram,"u_flipY");o&&gl.uniform1f(o,-1);const i=gl.getUniformLocation(ringProgram,"u_resolution");i&&gl.uniform2f(i,canvas.width,canvas.height),gl.uniform2f(gl.getUniformLocation(ringProgram,"u_center"),e,t),gl.uniform1f(gl.getUniformLocation(ringProgram,"u_radius"),Math.max(0,a)),gl.uniform1f(gl.getUniformLocation(ringProgram,"u_thickness"),Math.max(.5,r)),gl.uniform4fv(gl.getUniformLocation(ringProgram,"u_color"),n),gl.uniform2f(gl.getUniformLocation(ringProgram,"u_viewport"),canvas.width,canvas.height);const l=new Float32Array([0,0,0,0,canvas.width,0,1,0,0,canvas.height,0,1,0,canvas.height,0,1,canvas.width,0,1,0,canvas.width,canvas.height,1,1]),s=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,s),gl.bufferData(gl.ARRAY_BUFFER,l,gl.STREAM_DRAW);const c=gl.getAttribLocation(ringProgram,"a_position"),d=gl.getAttribLocation(ringProgram,"a_texCoord");gl.enableVertexAttribArray(c),gl.vertexAttribPointer(c,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(d),gl.vertexAttribPointer(d,2,gl.FLOAT,!1,16,8),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(c),gl.disableVertexAttribArray(d),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(s)}function drawDashedLine(e,t,a,r,n=1.5,o=10,i=6,l=[1,0,0,.95]){if(!dashProgram)return;gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.useProgram(dashProgram);const s=gl.getUniformLocation(dashProgram,"u_flipY");s&&gl.uniform1f(s,-1);const c=gl.getUniformLocation(dashProgram,"u_resolution");c&&gl.uniform2f(c,canvas.width,canvas.height),gl.uniform2f(gl.getUniformLocation(dashProgram,"u_a"),e,t),gl.uniform2f(gl.getUniformLocation(dashProgram,"u_b"),a,r),gl.uniform1f(gl.getUniformLocation(dashProgram,"u_thickness"),Math.max(.5,n)),gl.uniform1f(gl.getUniformLocation(dashProgram,"u_dash"),Math.max(1,o)),gl.uniform1f(gl.getUniformLocation(dashProgram,"u_gap"),Math.max(.5,i)),gl.uniform4fv(gl.getUniformLocation(dashProgram,"u_color"),l),gl.uniform2f(gl.getUniformLocation(dashProgram,"u_viewport"),canvas.width,canvas.height);const d=new Float32Array([0,0,0,0,canvas.width,0,1,0,0,canvas.height,0,1,0,canvas.height,0,1,canvas.width,0,1,0,canvas.width,canvas.height,1,1]),g=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,g),gl.bufferData(gl.ARRAY_BUFFER,d,gl.STREAM_DRAW);const u=gl.getAttribLocation(dashProgram,"a_position"),m=gl.getAttribLocation(dashProgram,"a_texCoord");gl.enableVertexAttribArray(u),gl.vertexAttribPointer(u,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(m),gl.vertexAttribPointer(m,2,gl.FLOAT,!1,16,8),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(u),gl.disableVertexAttribArray(m),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(g)}function drawLayerWithTransform(e,t){const a=fixedFBOWidth,r=fixedFBOHeight,n=canvas.width/a,o=canvas.height/r,i=Number.isFinite(t.ox)?t.ox:0,l=Number.isFinite(t.oy)?t.oy:0,s=Number.isFinite(t.texW)?t.texW:a,c=Number.isFinite(t.texH)?t.texH:r,d=Number.isFinite(t.px)?t.px:.5*a,g=Number.isFinite(t.py)?t.py:.5*r,u=[{x:i,y:l},{x:i+s,y:l},{x:i,y:l+c},{x:i+s,y:l+c}],m=Math.cos(t.rotation||0),f=Math.sin(t.rotation||0);function h(e){let a=e.x-d,r=e.y-g;a*=Number.isFinite(t.scaleX)?t.scaleX:1,r*=Number.isFinite(t.scaleY)?t.scaleY:1;const i=a*f+r*m,l=d+(a*m-r*f)+(Number.isFinite(t.x)?t.x:0),s=g+i+(Number.isFinite(t.y)?t.y:0);return{x:l*n,y:s*o}}const y=h(u[0]),p=h(u[1]),E=h(u[2]),v=h(u[3]),b=new Float32Array([y.x,y.y,0,0,p.x,p.y,1,0,E.x,E.y,0,1,E.x,E.y,0,1,p.x,p.y,1,0,v.x,v.y,1,1]);gl.useProgram(e);const x=gl.getUniformLocation(e,"u_flipY");x&&gl.uniform1f(x,-1);const T=gl.getUniformLocation(e,"u_resolution");T&&gl.uniform2f(T,canvas.width,canvas.height);const w=gl.getUniformLocation(e,"u_layerOpacity");w&&gl.uniform1f(w,Math.max(0,Math.min(1,t.opacity||1)));const A=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,A),gl.bufferData(gl.ARRAY_BUFFER,b,gl.STREAM_DRAW);const R=gl.getAttribLocation(e,"a_position"),L=gl.getAttribLocation(e,"a_texCoord");gl.enableVertexAttribArray(R),gl.vertexAttribPointer(R,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(L),gl.vertexAttribPointer(L,2,gl.FLOAT,!1,16,8),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,t.texture);const F=gl.getUniformLocation(e,"u_texture");F&&gl.uniform1i(F,0),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(R),gl.disableVertexAttribArray(L),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(A)}let transformTool={mode:"idle",start:null,ref:null,shiftInvert:!1};function setLayerTransformLock(e,t){const a=layers[e];if(!a)return;a.transformLocked=!!t;const r=document.getElementById("layersList");if(r){r.querySelectorAll(".layer-item").forEach(a=>{const r=a.getAttribute("data-index");if((null!==r?Number(r):null)===e){const e=a.querySelector(".transform-btn");e&&e.classList.toggle("is-active",t)}})}if(t&&e===activeLayerIndex)transformTool.mobileCombo=!0,"idle"===transformTool.mode&&startTransform("grab");else if(!t){layers.some(e=>!!e.transformLocked)||(transformTool.mobileCombo=!1,"idle"!==transformTool.mode&&endTransform(!0))}needsRedraw=!0}function clearTransformLockAll(){layers.forEach(e=>{e&&(e.transformLocked=!1)}),transformTool.mobileCombo=!1;const e=document.getElementById("layersList");e&&e.querySelectorAll(".transform-btn.is-active").forEach(e=>e.classList.remove("is-active")),"idle"!==transformTool.mode&&endTransform(!0),needsRedraw=!0}function onTransformPointerMove(e){if("idle"===transformTool.mode)return;const t=pointerToBoth(e),a=getActiveLayer();if(!a)return;transformTool.start||(transformTool.start={cx:t.cx,cy:t.cy});const r=t.cx-transformTool.start.cx,n=t.cy-transformTool.start.cy,o=fixedFBOWidth/canvas.width,i=fixedFBOHeight/canvas.height;if("grab"===transformTool.mode)a.x=transformTool.ref.x+r*o,a.y=transformTool.ref.y+n*i;else if("scale"===transformTool.mode){const e=.004,r=3,n=40,o=.05,i=20,l=transformTool.pivotCanvas||{cx:.5*canvas.width,cy:.5*canvas.height},s=transformTool.start.cx-l.cx,c=transformTool.start.cy-l.cy,d=t.cx-l.cx,g=t.cy-l.cy,u=Math.hypot(s,c),m=Math.hypot(d,g);Math.max(n,u);let f=m-u;Math.abs(f)<=r?f=0:f-=Math.sign(f)*r;let h=Math.exp(f*e);transformTool.shiftInvert&&(h=1/Math.max(h,1e-6));const y=transformTool.ref.scaleX,p=transformTool.ref.scaleY,E=e=>Math.min(i,Math.max(o,e*h));a.scaleX=E(y),a.scaleY=E(p)}else if("rotate"===transformTool.mode){const e=transformTool.pivotCanvas||{cx:.5*canvas.width,cy:.5*canvas.height},r=Math.atan2(transformTool.start.cy-e.cy,transformTool.start.cx-e.cx);let n=Math.atan2(t.cy-e.cy,t.cx-e.cx)-r;transformTool.shiftInvert&&(n=-n);const o=Math.PI/90;n=Math.round(n/o)*o,a.rotation=transformTool.ref.rotation+n}needsRedraw=!0}function startTransform(e,t=!1){const a=getActiveLayer();if(!a)return void console.warn("[transform] no active layer");a.x=Number.isFinite(a.x)?a.x:0,a.y=Number.isFinite(a.y)?a.y:0,a.scaleX=Number.isFinite(a.scaleX)?a.scaleX:1,a.scaleY=Number.isFinite(a.scaleY)?a.scaleY:1,a.rotation=Number.isFinite(a.rotation)?a.rotation:0;const r=canvasPxToFBO(null!=lastX?lastX:.5*canvas.width,null!=lastY?lastY:.5*canvas.height);a.px=Math.max(0,Math.min(fixedFBOWidth,r.fx)),a.py=Math.max(0,Math.min(fixedFBOHeight,r.fy));const n=canvas.width/fixedFBOWidth,o=canvas.height/fixedFBOHeight;transformTool.pivotCanvas={cx:a.px*n,cy:a.py*o},transformTool.mode=e,transformTool.shiftInvert=t,transformTool.ref={x:a.x,y:a.y,scaleX:a.scaleX,scaleY:a.scaleY,rotation:a.rotation,px:a.px,py:a.py},transformTool.start=null,isDrawing&&(isDrawing=!1,stopRender("draw")),startRender("transform"),showStatusMessage("grab"===e?"Grab (move) layer":"scale"===e?t?"Scale (down)":"Scale (up)":"rotate"===e?t?"Rotate (counter-clockwise)":"Rotate (clockwise)":"","info"),needsRedraw=!0}function endTransform(e=!0){if(!(transformTool&&transformTool.mode&&"idle"!==transformTool.mode)){try{isTwoFingerGesture=!1,pinchStart=null}catch{}return transformTool&&(transformTool.mode="idle"),needsRedraw=!0,void requestDrawIfIdle?.()}try{stopRender?.("transform")}catch{}let t=!1,a=null,r=null;try{promoteLayerForScale?.(1.25)}catch{}try{e&&activeLayerWouldClip()&&(e=!1,showStatusMessage?.("Skipped bake to prevent off-canvas cropping","info"))}catch(e){console.warn("[endTransform] clip-guard error:",e)}if(e)try{a=snapshotLayer?.(activeLayerIndex),applyActiveLayerTransform?.(),r=snapshotLayer?.(activeLayerIndex),a&&r&&History?.push&&History.push({type:"transform_bake",before:a,after:r}),t=!0}catch(e){console.warn("[endTransform] Bake failed:",e),t=!1}try{transformTool.start=null}catch{}try{transformTool.ref=null}catch{}try{transformTool.shiftInvert=!1}catch{}try{transformTool.pivotCanvas=null}catch{}transformTool&&(transformTool.mode="idle");try{isTwoFingerGesture=!1,pinchStart=null}catch{}const n=getActiveLayer?.(),o=!(!n||!n.transformLocked);transformTool&&(transformTool.mobileCombo=o),o&&queueMicrotask?.(()=>startTransform?.("grab")),showStatusMessage?.(t?"Transform applied":e?"Transform failed":"Transform cancelled",t?"success":e?"warning":"info"),needsRedraw=!0,requestDrawIfIdle?.()}function initPaintLayerFixed(){layers.forEach(e=>{gl.deleteTexture(e.texture),gl.deleteFramebuffer(e.fbo)}),layers=[],activeLayerIndex=0,addLayer("Layer 1",-1),syncActiveAliases()}function mergeSelectedLayers(){if(!gl||!layers||!selectedLayerIndices||selectedLayerIndices.size<2||!quadProgram)return;const e=0|fixedFBOWidth,t=0|fixedFBOHeight,a=Array.from(selectedLayerIndices).sort((e,t)=>e-t);let r=1/0,n=1/0,o=-1/0,i=-1/0;a.forEach(a=>layers[a]&&function(a){const l=Number.isFinite(a.ox)?a.ox:0,s=Number.isFinite(a.oy)?a.oy:0,c=Math.max(1,Number.isFinite(a.texW)?a.texW:e),d=Math.max(1,Number.isFinite(a.texH)?a.texH:t),g=Number.isFinite(a.scaleX)?a.scaleX:1,u=Number.isFinite(a.scaleY)?a.scaleY:1,m=Number.isFinite(a.rotation)?a.rotation:0,f=Number.isFinite(a.x)?a.x:0,h=Number.isFinite(a.y)?a.y:0,y=Number.isFinite(a.px)?a.px:.5*e,p=Number.isFinite(a.py)?a.py:.5*t,E=Math.cos(m),v=Math.sin(m);function b(e,t){let a=(e-y)*g,r=(t-p)*u;return{x:y+(a*E-r*v)+f,y:p+(a*v+r*E)+h}}const x=b(l,s),T=b(l+c,s),w=b(l,s+d),A=b(l+c,s+d);r=Math.min(r,x.x,T.x,w.x,A.x),n=Math.min(n,x.y,T.y,w.y,A.y),o=Math.max(o,x.x,T.x,w.x,A.x),i=Math.max(i,x.y,T.y,w.y,A.y)}(layers[a])),r=Math.floor(r),n=Math.floor(n),o=Math.ceil(o),i=Math.ceil(i);const l=Math.max(1,o-r|0),s=Math.max(1,i-n|0),c=gl.getParameter(gl.FRAMEBUFFER_BINDING),d=gl.getParameter(gl.CURRENT_PROGRAM),g=gl.getParameter(gl.VIEWPORT),u=gl.isEnabled(gl.BLEND),m=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,m),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,l,s,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);const f=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,f),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,m,0),gl.viewport(0,0,l,s),gl.enable(gl.BLEND),gl.blendFuncSeparate(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA,gl.ONE,gl.ONE_MINUS_SRC_ALPHA),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);const h=gl.getUniformLocation(quadProgram,"u_flipY");h&&gl.uniform1f(h,1);const y=gl.getUniformLocation(quadProgram,"u_resolution");y&&gl.uniform2f(y,l,s);const p=gl.getUniformLocation(quadProgram,"u_layerOpacity"),E=gl.getUniformLocation(quadProgram,"u_texture");for(const w of a){const A=layers[w];if(!A||!A.texture||!A.visible||(A.opacity??1)<=0)continue;const R=Number.isFinite(A.ox)?A.ox:0,L=Number.isFinite(A.oy)?A.oy:0,F=Math.max(1,Number.isFinite(A.texW)?A.texW:e),_=Math.max(1,Number.isFinite(A.texH)?A.texH:t),B=Number.isFinite(A.scaleX)?A.scaleX:1,I=Number.isFinite(A.scaleY)?A.scaleY:1,P=Number.isFinite(A.rotation)?A.rotation:0,U=Number.isFinite(A.x)?A.x:0,S=Number.isFinite(A.y)?A.y:0,M=Number.isFinite(A.px)?A.px:.5*e,D=Number.isFinite(A.py)?A.py:.5*t,C=Math.cos(P),N=Math.sin(P);function v(e,t){let a=(e-M)*B,r=(t-D)*I;return{x:M+(a*C-r*N)+U,y:D+(a*N+r*C)+S}}const O=v(R,L),k=v(R+F,L),X=v(R,L+_),W=v(R+F,L+_),H=new Float32Array([O.x-r,O.y-n,0,0,k.x-r,k.y-n,1,0,X.x-r,X.y-n,0,1,X.x-r,X.y-n,0,1,k.x-r,k.y-n,1,0,W.x-r,W.y-n,1,1]),Y=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,Y),gl.bufferData(gl.ARRAY_BUFFER,H,gl.STREAM_DRAW);const G=gl.getAttribLocation(quadProgram,"a_position"),q=gl.getAttribLocation(quadProgram,"a_texCoord");gl.enableVertexAttribArray(G),gl.vertexAttribPointer(G,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(q),gl.vertexAttribPointer(q,2,gl.FLOAT,!1,16,8),p&&gl.uniform1f(p,Math.max(0,Math.min(1,A.opacity??1))),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,A.texture),E&&gl.uniform1i(E,0),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(G),gl.disableVertexAttribArray(q),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(Y)}const b=a[a.length-1];for(let z=a.length-1;z>=0;z--){const V=layers[a[z]];if(V){try{V.texture&&gl.deleteTexture(V.texture)}catch{}try{V.fbo&&gl.deleteFramebuffer(V.fbo)}catch{}layers.splice(a[z],1)}}const x={name:`Merged (${a.length})`,texture:m,fbo:f,visible:!0,opacity:1,ox:r,oy:n,texW:l,texH:s,x:0,y:0,scaleX:1,scaleY:1,rotation:0,px:r+.5*l,py:n+.5*s},T=Math.min(b-(a.length-1),layers.length);layers.splice(T,0,x),activeLayerIndex=T,selectedLayerIndices=new Set([T]),"function"==typeof syncActiveAliases&&syncActiveAliases(),u||gl.disable(gl.BLEND),gl.bindFramebuffer(gl.FRAMEBUFFER,c),gl.useProgram(d),g&&gl.viewport(g[0],g[1],g[2],g[3]),needsRedraw=!0,requestDrawIfIdle?.()}function mergeAllLayers(){!gl||!layers||layers.length<2||(selectedLayerIndices=new Set(layers.map((e,t)=>t)),mergeSelectedLayers())}const BackgroundPicker=(()=>{let e=["/static/draw/images/backgrounds/WEBP_1920/46.webp","/static/draw/images/backgrounds/WEBP_1920/45.webp","/static/draw/images/backgrounds/WEBP_1920/44.webp","/static/draw/images/backgrounds/WEBP_1920/43.webp","/static/draw/images/backgrounds/WEBP_1920/42.webp","/static/draw/images/backgrounds/WEBP_1920/41.webp","/static/draw/images/backgrounds/WEBP_1920/40.webp"],t={},a=null,r="curated";function n(e){return document.getElementById(e)}function o(e,t){const a=document.createElement(e);return t&&(a.className=t),a}function i(e,t){const a=document.createElement("canvas");return a.width=e,a.height=t,a}function l(e){return new Promise((t,a)=>{const r=new Image;r.crossOrigin="anonymous",r.onload=()=>t(r),r.onerror=a,r.src=e})}function s(e,t,a){const r=i(t,a),n=r.getContext("2d"),o=(e.naturalWidth||e.width)/(e.naturalHeight||e.height);let l,s,c,d;return o>t/a?(s=a,l=Math.ceil(a*o),c=Math.floor((t-l)/2),d=0):(l=t,s=Math.ceil(t/o),c=0,d=Math.floor((a-s)/2)),n.drawImage(e,c,d,l,s),r}function c(e){t.curatedGrid.querySelectorAll(".bgp-thumb.selected").forEach(e=>e.classList.remove("selected")),e&&e.classList.add("selected")}function d(e){r=e,document.querySelectorAll(".bgp-tab").forEach(t=>t.classList.toggle("active",t.dataset.tab===e)),n("bgPickerModal").querySelectorAll(".bgp-pane").forEach(t=>{const a=t.classList.contains("bgp-pane-curated")?"curated":t.classList.contains("bgp-pane-upload")?"upload":"solid";t.classList.toggle("active",a===e)})}function g(){t.colorHex.value=t.color.value.toUpperCase();const e=fixedFBOWidth||canvas.width,r=fixedFBOHeight||canvas.height,o=function(e,t,a){const r=i(t,a),n=r.getContext("2d");return n.fillStyle=e,n.fillRect(0,0,t,a),r}(t.color.value,e,r),l=n("bgpSolidPreview").getContext("2d");l.clearRect(0,0,n("bgpSolidPreview").width,n("bgpSolidPreview").height),l.drawImage(s(o,n("bgpSolidPreview").width,n("bgpSolidPreview").height),0,0),a=o}function u(){a=null,c(null),t.fileName.textContent="No file chosen",t.file.value="",d("curated"),g(),n("bgPickerModal").style.display="flex"}function m(){n("bgPickerModal").style.display="none"}function f(){if(!a)return void m();const e=new Image;e.onload=()=>{currentImage=e,fixedFBOWidth=e.width,fixedFBOHeight=e.height,initPaintLayerFixed(),updateCanvasSize(e),initFloodFBOs(),createTextureFromImage(e),canvas.offsetWidth,canvasWrapper.offsetWidth,zoomScale=1,panX=(canvasWrapper.clientWidth-canvas.width)/2,panY=(canvasWrapper.clientHeight-canvas.height)/2,updateCanvasTransform(),needsRedraw=!0,initFloodFillProgram(),addSoundEvents(),m()},e.src=a.toDataURL("image/png")}function h(e){const r=e.target.files&&e.target.files[0];if(!r)return;t.fileName.textContent=r.name;const o=new FileReader;o.onload=async()=>{const e=o.result,t=await l(e),r=fixedFBOWidth||canvas.width,i=fixedFBOHeight||canvas.height;a=s(t,r,i);const c=n("bgpUploadPreview"),d=c.getContext("2d");d.clearRect(0,0,c.width,c.height),d.drawImage(s(t,c.width,c.height),0,0)},o.readAsDataURL(r)}function y(){t.gridBtn=n("bgpCuratedGrid"),t.modal=n("bgPickerModal"),t.curatedGrid=n("bgpCuratedGrid"),t.file=n("bgpFile"),t.fileName=n("bgpFileName"),t.color=n("bgpColor"),t.colorHex=n("bgpColorHex"),t.apply=n("bgpApply"),t.cancel=n("bgpCancel"),t.closeX=n("bgpClose"),document.querySelectorAll(".bgp-tab").forEach(e=>{e.addEventListener("click",()=>d(e.dataset.tab))}),t.file.addEventListener("change",h),t.color.addEventListener("input",g),t.colorHex.addEventListener("input",()=>{let e=t.colorHex.value.trim();/^#([0-9a-f]{3}|[0-9a-f]{6}|[0-9a-f]{8})$/i.test(e)&&(t.color.value=e,g())}),t.apply.addEventListener("click",f),t.cancel.addEventListener("click",m),t.closeX.addEventListener("click",m),document.getElementById("bgPickerBtn")?.addEventListener("click",u),t.curatedGrid.innerHTML="",e.forEach(e=>{const r=o("button","bgp-thumb");r.type="button";const n=o("img");n.loading="lazy",n.src=e,n.alt="background",r.appendChild(n),r.addEventListener("click",async()=>{const t=fixedFBOWidth||canvas.width,n=fixedFBOHeight||canvas.height,o=await l(e);a=s(o,t,n),c(r)}),t.curatedGrid.appendChild(r)}),g()}return{install:function(t){t?.curated&&Array.isArray(t.curated)&&(e=t.curated),y()},open:u}})();function toggleUIVisibilityMode(){if(!document.getElementById("__uiHideStyle")){const e=document.createElement("style");e.id="__uiHideStyle",e.textContent="\n      /* hide any element that is neither a canvas nor an ancestor of a canvas,\n         and keep the toggle button and its children visible */\n      body.__ui_off :not(canvas):not(#hideAllButton):not(#hideAllButton *):not(:has(canvas)) {\n        visibility: hidden !important;\n      }\n      /* canvases must remain interactive while UI is hidden */\n      body.__ui_off canvas { pointer-events: auto !important; }\n      /* ensure the toggle stays clickable above everything */\n      #hideAllButton { z-index: 999999; }\n    ",document.head.appendChild(e)}const e=document.body.classList.toggle("__ui_off"),t=document.getElementById("hideAllButton");t&&(t.title=e?"Show UI":"Hide UI")}function duplicateLayer(e=activeLayerIndex){if(!layers.length)return;e=Math.max(0,Math.min(e,layers.length-1));const t=layers[e];if(!t||!gl.isFramebuffer(t.fbo)||!gl.isTexture(t.texture))return void console.warn("[duplicateLayer] invalid source layer");const a=Number.isFinite(t.texW)?t.texW:fixedFBOWidth,r=Number.isFinite(t.texH)?t.texH:fixedFBOHeight,{texture:n,fbo:o}=createLayerFBO(a,r);gl.bindFramebuffer(gl.FRAMEBUFFER,o),gl.viewport(0,0,a,r),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.SCISSOR_TEST),gl.disable(gl.BLEND),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);const i=gl.getUniformLocation(quadProgram,"u_flipY");i&&gl.uniform1f(i,1);const l=gl.getUniformLocation(quadProgram,"u_resolution");l&&gl.uniform2f(l,a,r);const s=gl.getUniformLocation(quadProgram,"u_layerOpacity");s&&gl.uniform1f(s,1);const c=gl.getUniformLocation(quadProgram,"u_texture");c&&gl.uniform1i(c,0);const d=new Float32Array([0,0,0,0,a,0,1,0,0,r,0,1,0,r,0,1,a,0,1,0,a,r,1,1]),g=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,g),gl.bufferData(gl.ARRAY_BUFFER,d,gl.STREAM_DRAW);const u=gl.getAttribLocation(quadProgram,"a_position"),m=gl.getAttribLocation(quadProgram,"a_texCoord");gl.enableVertexAttribArray(u),gl.vertexAttribPointer(u,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(m),gl.vertexAttribPointer(m,2,gl.FLOAT,!1,16,8),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,t.texture),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(u),gl.disableVertexAttribArray(m),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(g),gl.bindFramebuffer(gl.FRAMEBUFFER,null);const f={id:Date.now()+Math.random(),name:t.name+" copy",fbo:o,texture:n,visible:t.visible,opacity:t.opacity,x:t.x,y:t.y,scaleX:t.scaleX,scaleY:t.scaleY,rotation:t.rotation,px:t.px,py:t.py,texW:a,texH:r,ox:t.ox,oy:t.oy,history:[],redo:[]},h=Math.min(activeLayerIndex+1,layers.length);layers.splice(h,0,f),activeLayerIndex=h,syncActiveAliases(),rebuildLayersUI?.(),needsRedraw=!0,requestDrawIfIdle?.()}function createTextureFromImage(e,t=!1){if(!e)return void console.error("Image is null or undefined.");const a=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,a),t?(gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0),gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0)):gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!1),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,e),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),t?(overlayTexture=a,brushAspect=e.width/e.height):texture=a,needsRedraw=!0}function centerAndFitToWrapper(){const e=canvasWrapper.getBoundingClientRect(),t=canvas.width,a=canvas.height,r=Math.min(e.width/t,e.height/a);zoomScale=Math.min(zoomMax,Math.max(zoomMin,r)),panX=Math.round((e.width-t*zoomScale)/2),panY=Math.round((e.height-a*zoomScale)/2),updateCanvasTransform(),resetStrokeState(),needsRedraw=!0}function centerNextFrame(){requestAnimationFrame(()=>{centerAndFitToWrapper()})}function loadDefaultImage(){const e=document.createElement("canvas");e.width=window.innerWidth,e.height=window.innerHeight;const t=e.getContext("2d");t.fillStyle="#f2efe4",t.fillRect(0,0,e.width,e.height);const a=document.createElement("canvas");a.width=e.width,a.height=e.height;const r=a.getContext("2d"),n=r.createImageData(a.width,a.height);for(let e=0;e<n.data.length;e+=4){const t=50*Math.random()-25;n.data[e]=240+t,n.data[e+1]=235+t,n.data[e+2]=225+t,n.data[e+3]=255}r.putImageData(n,0,0),t.globalAlpha=.2,t.drawImage(a,0,0),t.globalAlpha=1;const o=document.createElement("canvas");o.width=e.width,o.height=e.height;const i=o.getContext("2d"),l=i.createImageData(o.width,o.height);for(let e=0;e<l.data.length;e+=4){const t=255*Math.random();l.data[e]=t,l.data[e+1]=t,l.data[e+2]=t,l.data[e+3]=90*Math.random()}i.putImageData(l,0,0),t.globalAlpha=.08,t.drawImage(o,0,0),t.globalAlpha=1;const s=t.createRadialGradient(e.width/2,e.height/2,.3*Math.min(e.width,e.height),e.width/2,e.height/2,.6*Math.max(e.width,e.height));s.addColorStop(0,"rgba(0,0,0,0)"),s.addColorStop(1,"rgba(0,0,0,0.35)"),t.globalAlpha=.3,t.fillStyle=s,t.fillRect(0,0,e.width,e.height),t.globalAlpha=1;const c=new Image;c.crossOrigin="anonymous",c.onload=()=>{currentImage=c,fixedFBOWidth=c.width,fixedFBOHeight=c.height,initPaintLayerFixed(),updateCanvasSize(c),initFloodFBOs(),createTextureFromImage(c),canvas.offsetWidth,canvasWrapper.offsetWidth,zoomScale=1,panX=(canvasWrapper.clientWidth-canvas.width)/2,panY=(canvasWrapper.clientHeight-canvas.height)/2,updateCanvasTransform(),resetStrokeState(),needsRedraw=!0,initFloodFillProgram(),addSoundEvents()},c.onerror=()=>console.error("Failed to load default image."),c.src=e.toDataURL("image/png")}function createBrushThumbnails(){const e=document.getElementById("brushContainer");e.innerHTML="",brushes.forEach(t=>{const a=document.createElement("img");a.src=t.file,a.classList.add("brush-thumbnail"),t.selected&&(a.style.border="2px solid red"),a.addEventListener("click",()=>selectBrush(t.name)),e.appendChild(a)});const t=document.getElementById("brushContainerToggle");e.appendChild(t)}function updateBrushThumbnailStyles(e){const t=document.getElementById("brushContainer").querySelectorAll("img.brush-thumbnail");brushes.forEach((a,r)=>{t[r]&&(t[r].style.border=a.name===e?"2px solid red":"2px solid transparent")})}function selectBrush(e){const t=brushes.find(t=>t.name===e);if(!t)return void console.warn(`Brush "${e}" not found.`);currentBrush=t,overlayTexture=brushTextures[t.name],brushAspect=brushAspects[t.name];const a=document.getElementById("brushSizeSlider"),r=document.getElementById("brushSizeValue");a.value=brushSize,r.textContent=brushSize.toFixed(2),brushes.forEach(t=>t.selected=t.name===e),updateBrushThumbnailStyles(t.name),needsRedraw=!0}function loadBrushes(){brushes.forEach(e=>{const t=new Image;t.crossOrigin="anonymous",t.onload=()=>{const a=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,a),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0),gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,t),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),brushTextures[e.name]=a,brushAspects[e.name]=t.width/t.height,e.selected&&selectBrush(e.name)},t.onerror=()=>console.error("Failed to load brush image:",e.file),t.src=e.file})}function centerCanvasInWrapper(){const e=canvasWrapper.getBoundingClientRect(),t=canvas.width*zoomScale,a=canvas.height*zoomScale;panX=(e.width-t)/2,panY=(e.height-a)/2,viewRotation=0,transformOriginX=0,transformOriginY=0,updateCanvasTransform()}function ensureCanvasNotLost(){const e=canvasWrapper.getBoundingClientRect(),t=canvas.getBoundingClientRect(),a=Math.max(0,Math.min(t.right,e.right)-Math.min(t.left,e.left))*Math.max(0,Math.min(t.bottom,e.bottom)-Math.min(t.top,e.top)),r=t.width*t.height;(!isFinite(a)||r<=0||a/r<.05)&&centerCanvasInWrapper()}BackgroundPicker.install({curated:["/static/draw/images/backgrounds/WEBP_1920/sl_072622_51930_13.jpg","/static/draw/images/backgrounds/WEBP_1920/02.webp","/static/draw/images/backgrounds/WEBP_1920/44.webp","/static/draw/images/backgrounds/WEBP_1920/43.webp","/static/draw/images/backgrounds/WEBP_1920/42.webp","/static/draw/images/backgrounds/WEBP_1920/41.webp","/static/draw/images/backgrounds/WEBP_1920/40.webp"]}),document.getElementById("hideAllButton")?.addEventListener("click",toggleUIVisibilityMode),document.addEventListener("keydown",e=>{if(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;("Escape"===e.key||"Esc"===e.key||27===e.keyCode)&&(e.preventDefault(),toggleUIVisibilityMode())},{capture:!0}),["mouseup","mouseleave","touchend","touchcancel"].forEach(e=>canvasWrapper.addEventListener(e,ensureCanvasNotLost,{passive:!0})),window.addEventListener("resize",ensureCanvasNotLost),window.visualViewport&&(visualViewport.addEventListener("resize",ensureCanvasNotLost),visualViewport.addEventListener("scroll",ensureCanvasNotLost));let lastMultiTap=0;function snapBackIfLost(e,t){t="number"==typeof t?t:8;var a=e.getBoundingClientRect(),r=window.visualViewport?window.visualViewport:null,n=r&&r.width?r.width:window.innerWidth,o=r&&r.height?r.height:window.innerHeight;if(!(a.right>t&&a.bottom>t&&a.left<n-t&&a.top<o-t)){var i=Math.min(Math.max(e.offsetLeft||0,t),n-a.width-t),l=Math.min(Math.max(e.offsetTop||0,t),o-a.height-t);e.style.left=Math.round(i)+"px",e.style.top=Math.round(l)+"px"}}canvasWrapper.addEventListener("touchend",e=>{if(e.changedTouches.length>=2){const e=performance.now();e-lastMultiTap<350&&centerCanvasInWrapper(),lastMultiTap=e}},{passive:!0}),[["brushSizeSliderContainer","brushSizeDragBar"],["brushContainerWrapper","brushContainerDragBar"],["layersPanel",".layers-header"]].forEach(([e,t])=>{const a=document.getElementById(e),r=a&&(t.startsWith("#")?document.querySelector(t):a.querySelector(t));if(!a||!r)return;const n=e=>{try{r.releasePointerCapture(e.pointerId)}catch{}snapBackIfLost(a)};r.addEventListener("pointerup",n),r.addEventListener("pointercancel",n)}),window.addEventListener("resize",()=>{["brushSizeSliderContainer","brushContainerWrapper","layersPanel"].forEach(e=>{const t=document.getElementById(e);t&&snapBackIfLost(t)})});let resizeTimer=null;function updateBrushSize(){const e=canvas.width;brushSize=Math.min(brushSize,e/10)}function updateCanvasSize(e){if(!e)return;const t=window.innerWidth/window.innerHeight;let a,r;imageAspect=e.width/e.height,imageAspect>t?(a=window.innerWidth,r=window.innerWidth/imageAspect):(r=window.innerHeight,a=window.innerHeight*imageAspect),canvas.width=Math.round(a),canvas.height=Math.round(r),gl.viewport(0,0,canvas.width,canvas.height),updateBrushSize(),needsRedraw=!0}function resetStrokeState(){lastX=null,lastY=null,lastFx=null,lastFy=null,void 0!==lastDrawTime&&(lastDrawTime=0),void 0!==soundLastX&&(soundLastX=null),void 0!==soundLastY&&(soundLastY=null)}function setDocumentSize(e,t){fixedFBOWidth=e,fixedFBOHeight=t,canvas.width=e,canvas.height=t,gl.viewport(0,0,e,t),zoomScale=1;const a=canvasWrapper.getBoundingClientRect();panX=Math.round((a.width-e)/2),panY=Math.round((a.height-t)/2),updateCanvasTransform(),resetStrokeState(),needsRedraw=!0}window.addEventListener("resize",()=>{clearTimeout(resizeTimer),resizeTimer=setTimeout(()=>{currentImage&&updateCanvasSize(currentImage),centerCanvasInWrapper?.()},120)}),window.addEventListener("resize",()=>{currentImage&&updateCanvasSize(currentImage)});const audioCtx=new(window.AudioContext||window.webkitAudioContext);let gainNode,noiseNode,filterNode,isDrawingSoundActive=!1,soundLastX=null,soundLastY=null,soundIsMoving=!1,lastMoveTimestamp=0;function unlockAudio(){"suspended"===audioCtx.state&&audioCtx.resume()}function createNoiseBuffer(){const e=audioCtx.sampleRate,t=Math.max(1,Math.floor(.5*e)),a=audioCtx.createBuffer(1,t,e),r=a.getChannelData(0);for(let e=0;e<t;e++)r[e]=Math.random()>.9?.5*(2*Math.random()-1):0;return a}function startDrawingSound(e=1){if(isDrawingSoundActive)return;isDrawingSoundActive=!0,unlockAudio(),gainNode=audioCtx.createGain(),gainNode.gain.setValueAtTime(0,audioCtx.currentTime),filterNode=audioCtx.createBiquadFilter(),filterNode.type="bandpass";const t=.5*audioCtx.sampleRate,a=400+300*(Number(e)||0),r=Math.min(t-20,Math.max(10,a));filterNode.frequency.setValueAtTime(r,audioCtx.currentTime),filterNode.Q.setValueAtTime(2.5,audioCtx.currentTime),noiseNode=audioCtx.createBufferSource(),noiseNode.buffer=createNoiseBuffer(),noiseNode.loop=!0,noiseNode.connect(filterNode),filterNode.connect(gainNode),gainNode.connect(audioCtx.destination),noiseNode.start()}function updateDrawingSound(e){if(!isDrawingSoundActive)return;const t=.5*audioCtx.sampleRate,a=400+300*(Number(e)||0),r=Math.min(t-20,Math.max(10,a));filterNode.frequency.linearRampToValueAtTime(r,audioCtx.currentTime+.05);const n=Math.min(.15,.05*(Number(e)||0)),o=Math.max(0,Math.min(1,n));gainNode.gain.linearRampToValueAtTime(o,audioCtx.currentTime+.05)}function stopDrawingSound(){isDrawingSoundActive&&(isDrawingSoundActive=!1,gainNode.gain.linearRampToValueAtTime(0,audioCtx.currentTime+.2),setTimeout(()=>{noiseNode&&(noiseNode.stop(),noiseNode.disconnect()),filterNode&&filterNode.disconnect(),gainNode&&gainNode.disconnect()},200))}function getTouchPos(e){const t=e.touches&&e.touches[0]?e.touches[0]:e.changedTouches&&e.changedTouches[0];if(!t)return{x:0,y:0};const a=canvasWrapper.getBoundingClientRect(),r=t.clientX-a.left,n=t.clientY-a.top,o=screenToCanvasPx(t.clientX,t.clientY);return{x:r,y:n,cx:o.x,cy:o.y}}function addSoundEvents(){document.addEventListener("touchstart",unlockAudio,{once:!0}),document.addEventListener("click",unlockAudio,{once:!0}),canvas.addEventListener("mousedown",()=>{soundIsMoving=!1}),canvas.addEventListener("mousemove",e=>{if(!isDrawing)return;let t=Math.sqrt(e.movementX**2+e.movementY**2);soundIsMoving||(startDrawingSound(t),soundIsMoving=!0),updateDrawingSound(t)}),canvas.addEventListener("mouseup",()=>{soundIsMoving=!1,stopDrawingSound()}),canvas.addEventListener("mouseleave",()=>{soundIsMoving=!1,stopDrawingSound()}),canvas.addEventListener("touchstart",e=>{e.preventDefault(),isDrawing=!0,soundLastX=null,soundLastY=null,soundIsMoving=!1,lastMoveTimestamp=Date.now()}),canvas.addEventListener("touchmove",e=>{if(e.preventDefault(),!isDrawing)return;const t=getTouchPos(e),a=Date.now();if(null!==soundLastX&&null!==soundLastY){const e=t.x-soundLastX,r=t.y-soundLastY,n=Math.sqrt(e*e+r*r);if(n>1){let e=n/(a-lastMoveTimestamp+1);lastMoveTimestamp=a,soundIsMoving||(startDrawingSound(e),soundIsMoving=!0),updateDrawingSound(e)}}soundLastX=t.x,soundLastY=t.y}),canvas.addEventListener("touchend",()=>{soundIsMoving=!1,stopDrawingSound()}),canvas.addEventListener("touchcancel",()=>{soundIsMoving=!1,stopDrawingSound()}),setInterval(()=>{isDrawing&&soundIsMoving&&Date.now()-lastMoveTimestamp>100&&(soundIsMoving=!1,stopDrawingSound())},50)}let lastDrawTime=0;function isUserTyping(){const e=document.activeElement;return e&&("INPUT"===e.tagName||"TEXTAREA"===e.tagName||e.isContentEditable)}canvas.addEventListener("mousedown",e=>{if(!canPaint())return;const t=pointerToBoth(e);if(overlayPosition=[t.cx/canvas.width,t.cy/canvas.height],"fill"===currentTool)return performFloodFill(t.fx,t.fy),needsRedraw=!0,void drawScene();isDrawing=!0,startRender("draw"),drawBrushStrokeToPaintLayer(t.cx,t.cy)}),canvas.addEventListener("mousemove",e=>{if(!canPaint()&&!isDrawing)return;const t=Date.now();if(t-lastDrawTime<16)return;lastDrawTime=t;const a=pointerToBoth(e);if(null!==lastX&&null!==lastY){const e=a.cx-lastX,t=a.cy-lastY;(Math.abs(e)>.1||Math.abs(t)>.1)&&(currentAngle=Math.atan2(t,e))}lastX=a.cx,lastY=a.cy,overlayPosition=[a.cx/canvas.width,a.cy/canvas.height],isDrawing&&canPaint()&&drawBrushStrokeToPaintLayer(a.cx,a.cy)}),canvas.addEventListener("mouseup",()=>{isDrawing=!1,stopRender("draw"),lastFx=null,lastFy=null}),canvas.addEventListener("mouseleave",()=>{isDrawing=!1,stopRender("draw"),lastFx=null,lastFy=null}),canvas.addEventListener("touchstart",e=>{if(e.preventDefault(),!canPaint())return;const t=e.touches[0];if(!t)return;const a=pointerToBoth(t);if(overlayPosition=[a.cx/canvas.width,a.cy/canvas.height],"fill"===currentTool)return performFloodFill(a.fx,a.fy),needsRedraw=!0,void drawScene();isDrawing=!0,startRender("draw"),drawBrushStrokeToPaintLayer(a.cx,a.cy)},{passive:!1}),canvas.addEventListener("touchmove",e=>{if(e.preventDefault(),!isDrawing||!canPaint())return;const t=e.touches[0];if(!t)return;const a=Date.now();if(a-lastDrawTime<16)return;lastDrawTime=a;const r=pointerToBoth(t);if(null!==lastX&&null!==lastY){const e=r.cx-lastX,t=r.cy-lastY;(Math.abs(e)>.1||Math.abs(t)>.1)&&(currentAngle=Math.atan2(t,e))}lastX=r.cx,lastY=r.cy,overlayPosition=[r.cx/canvas.width,r.cy/canvas.height],drawBrushStrokeToPaintLayer(r.cx,r.cy)},{passive:!1}),canvas.addEventListener("touchend",()=>{isDrawing=!1,stopRender("draw"),lastFx=null,lastFy=null},{passive:!0}),canvas.addEventListener("touchcancel",()=>{isDrawing=!1,stopRender("draw"),lastFx=null,lastFy=null},{passive:!0}),document.addEventListener("keydown",e=>{if(isUserTyping())return;let t=!1;if("["===e.key){brushSize=Math.max(.01,brushSize-.02);const e=document.getElementById("brushSizeSlider");e&&(e.value=brushSize),t=!0,overlayPosition=[lastPointer.cx/canvas.width,lastPointer.cy/canvas.height],showBrushHUD()}else if("]"===e.key){brushSize=Math.min(1,brushSize+.02);const e=document.getElementById("brushSizeSlider");e&&(e.value=brushSize),t=!0,overlayPosition=[lastPointer.cx/canvas.width,lastPointer.cy/canvas.height],showBrushHUD()}else if(e.key>="0"&&e.key<="9"){let a="0"===e.key?9:parseInt(e.key,10)-1;a>=0&&a<brushes.length&&(selectBrush(brushes[a].name),t=!0,overlayPosition=[lastPointer.cx/canvas.width,lastPointer.cy/canvas.height],showBrushHUD())}t&&(needsRedraw=!0)});let brushSize=.02,opacity=1,eraseStrength=.5,paintStrength=1;document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("brushSizeSlider"),t=document.getElementById("brushSizeValue");e.value=brushSize,t.textContent=brushSize.toFixed(2),e.addEventListener("input",e=>{brushSize=parseFloat(e.target.value),t.textContent=brushSize.toFixed(2),needsRedraw=!0,showBrushHUD()});const a=document.getElementById("eraseStrengthSlider"),r=document.getElementById("eraseStrengthValue");a.value=eraseStrength,r.textContent=eraseStrength.toFixed(2),a.addEventListener("input",e=>{eraseStrength=parseFloat(e.target.value),r.textContent=eraseStrength.toFixed(2),needsRedraw=!0,showBrushHUD()});const n=document.getElementById("paintStrengthSlider"),o=document.getElementById("paintStrengthValue");n.value=paintStrength,o.textContent=paintStrength.toFixed(2),n.addEventListener("input",e=>{paintStrength=parseFloat(e.target.value),o.textContent=paintStrength.toFixed(2),needsRedraw=!0})});let selectedLayerIndices=new Set;function rebuildLayersUI(){const e=document.getElementById("layersList");if(!e)return;if(layers?.length?0===selectedLayerIndices.size&&Number.isInteger(activeLayerIndex)&&selectedLayerIndices.add(activeLayerIndex):selectedLayerIndices.clear(),!window.__mobileLayerTransformSetup){const l=canvasWrapper||document.getElementById("canvasWrapper")||canvas?.parentElement;let s=null;function t(e){if(isMobile()&&(s&&(!e.touches||e.touches.length<2)&&(s=null),transformTool&&"idle"===transformTool.mode)){const e=getActiveLayer();e&&e.transformLocked||(transformTool.mobileCombo=!1)}}l&&(l.addEventListener("touchstart",function(e){if(isMobile()&&transformTool&&transformTool.mobileCombo&&2===e.touches.length){e.preventDefault(),e.stopImmediatePropagation();const t=e.touches[0],a=e.touches[1],r=a.clientX-t.clientX,n=a.clientY-t.clientY,o=Math.hypot(r,n),i=Math.atan2(n,r),l=getActiveLayer();if(!l)return;s={dist0:Math.max(1e-6,o),ang0:i,ref:{scaleX:Number.isFinite(l.scaleX)?l.scaleX:1,scaleY:Number.isFinite(l.scaleY)?l.scaleY:1,rotation:Number.isFinite(l.rotation)?l.rotation:0}}}},{passive:!1,capture:!0}),l.addEventListener("touchmove",function(e){if(isMobile()&&transformTool&&transformTool.mobileCombo&&2===e.touches.length&&s){e.preventDefault(),e.stopImmediatePropagation();const t=e.touches[0],a=e.touches[1],r=a.clientX-t.clientX,n=a.clientY-t.clientY,o=Math.max(1e-6,Math.hypot(r,n)),i=Math.atan2(n,r),l=getActiveLayer();if(!l)return;const c=o/s.dist0;l.scaleX=s.ref.scaleX*c,l.scaleY=s.ref.scaleY*c;let d=i-s.ang0;return d>Math.PI&&(d-=2*Math.PI),d<-Math.PI&&(d+=2*Math.PI),l.rotation=s.ref.rotation+d,void(needsRedraw=!0)}},{passive:!1,capture:!0}),l.addEventListener("touchend",t,{passive:!0,capture:!0}),l.addEventListener("touchcancel",t,{passive:!0,capture:!0})),window.__mobileLayerTransformSetup=!0}e.innerHTML="";const a=document.createElement("div");a.className="layers-header";const r=document.createElement("button");r.type="button",r.className="bs-n",r.textContent="Merge Selected",r.disabled=selectedLayerIndices.size<2,r.addEventListener("click",e=>{e.stopPropagation(),selectedLayerIndices.size>=2&&mergeSelectedLayers()});const n=document.createElement("button");function o(){r.disabled=selectedLayerIndices.size<2,r.textContent=selectedLayerIndices.size>1?`Merge Selected (${selectedLayerIndices.size})`:"Merge Selected",n.disabled=!(layers&&layers.length>=2)}function i(e,t){if(!t)return selectedLayerIndices.clear(),selectedLayerIndices.add(e),void(activeLayerIndex=e);selectedLayerIndices.has(e)?(selectedLayerIndices.delete(e),0===selectedLayerIndices.size&&selectedLayerIndices.add(e)):(selectedLayerIndices.add(e),activeLayerIndex=e)}n.type="button",n.className="bs-n",n.textContent="Merge All",n.disabled=!(layers&&layers.length>=2),n.addEventListener("click",e=>{if(e.stopPropagation(),layers&&layers.length>=2){selectedLayerIndices.clear();for(let e=0;e<layers.length;e++)selectedLayerIndices.add(e);mergeSelectedLayers(),selectedLayerIndices.clear(),Number.isInteger(activeLayerIndex)&&selectedLayerIndices.add(activeLayerIndex),rebuildLayersUI()}}),a.appendChild(r),a.appendChild(n),e.appendChild(a),(layers||[]).forEach((t,a)=>{const r=document.createElement("div"),n=a===activeLayerIndex,l=selectedLayerIndices.has(a);r.className="layer-item"+(n?" active":"")+(l?" is-selected":""),r.dataset.index=String(a);const s=document.createElement("div");s.className="layer-select";const c=document.createElement("input");c.type="checkbox",c.checked=l,c.title="Select for merge",c.addEventListener("click",e=>{e.stopPropagation(),i(a,!0),o(),r.classList.toggle("is-selected",selectedLayerIndices.has(a))}),s.appendChild(c);const d=document.createElement("div");d.className="layer-vis";const g=document.createElement("button");g.type="button",g.className="bs icon-btn",g.title=t.visible?"Hide layer":"Show layer",g.setAttribute("aria-label",`${t.visible?"Hide":"Show"} ${t.name}`);const u="/static/draw/images/icons/show.svg",m="/static/draw/images/icons/hide.svg",f=document.createElement("img");function h(){f.src=t.visible?u:m,f.alt=t.visible?"Visible":"Hidden",g.title=t.visible?"Hide layer":"Show layer",g.setAttribute("aria-label",`${t.visible?"Hide":"Show"} ${t.name}`)}f.alt=t.visible?"Visible":"Hidden",f.src=t.visible?u:m,f.style.pointerEvents="none",g.appendChild(f),g.addEventListener("click",e=>{e.stopPropagation(),clearTransformLockAll(),t.visible=!t.visible,h(),needsRedraw=!0}),d.appendChild(g);const y=document.createElement("button");y.type="button",y.className="bs icon-btn transform-btn",y.title="Transform layer",y.setAttribute("aria-label",`Transform ${t.name}`),y.innerHTML='<img src="/static/draw/images/icons/transform.svg" alt="Transform">',isMobile()||(y.style.display="none"),isMobile()&&t.transformLocked&&n?y.classList.add("is-active"):y.classList.remove("is-active"),y.addEventListener("click",e=>{e.stopPropagation(),activeLayerIndex!==a&&(clearTransformLockAll(),activeLayerIndex=a,syncActiveAliases?.(),rebuildLayersUI());const r=!!t.transformLocked;setLayerTransformLock(a,!r),y.classList.toggle("is-active",!r),showStatusMessage?.(r?"Transform unlocked":"Transform locked: drag to move, pinch to scale/rotate","info"),needsRedraw=!0}),d.appendChild(y);const p=document.createElement("div");p.className="layer-name";const E=document.createElement("input");E.value=t.name,E.title="Rename layer",E.setAttribute("aria-label",`Rename ${t.name}`),E.addEventListener("click",e=>e.stopPropagation()),E.addEventListener("mousedown",()=>{activeLayerIndex=a}),E.addEventListener("focus",()=>{activeLayerIndex=a});const v=()=>{const e=E.value;e!==t.name&&(t.name=e,h())};E.addEventListener("change",v),E.addEventListener("blur",v),p.appendChild(E);const b=document.createElement("div");b.className="layer-ops";const x=document.createElement("button");x.type="button",x.className="bs icon-btn",x.title="Duplicate layer",x.setAttribute("aria-label","Duplicate layer"),x.innerHTML='<img src="/static/draw/images/icons/clone.svg" alt="" style="pointer-events:none" width="18" height="18">',x.addEventListener("click",e=>{e.stopPropagation(),clearTransformLockAll(),duplicateLayer(a)});const T=document.createElement("button");T.type="button",T.className="bs icon-btn",T.title="Move up",T.setAttribute("aria-label","Move layer up"),T.innerHTML='<img src="/static/draw/images/icons/up-shevron.svg" alt="" style="pointer-events:none" width="18" height="18">',T.addEventListener("click",e=>{e.stopPropagation(),clearTransformLockAll(),moveLayerUp(a)});const w=document.createElement("button");w.type="button",w.className="bs icon-btn",w.title="Move down",w.setAttribute("aria-label","Move layer down"),w.innerHTML='<img src="/static/draw/images/icons/down-shevron.svg" alt="" style="pointer-events:none" width="18" height="18">',w.addEventListener("click",e=>{e.stopPropagation(),clearTransformLockAll(),moveLayerDown(a)}),b.appendChild(x),b.appendChild(T),b.appendChild(w);const A=document.createElement("div");A.className="layer-opacity";const R=document.createElement("span");R.textContent="Opacity";const L=document.createElement("input");L.type="range",L.min="0",L.max="1",L.step="0.01",L.value=String(t.opacity),["click","mousedown","touchstart","keydown"].forEach(e=>L.addEventListener(e,e=>e.stopPropagation())),L.addEventListener("input",()=>{clearTransformLockAll();const e=parseFloat(L.value);Number.isNaN(e)||e===t.opacity||(t.opacity=Math.max(0,Math.min(1,e)),needsRedraw=!0)}),A.appendChild(R),A.appendChild(L),r.appendChild(s),r.appendChild(d),r.appendChild(p),r.appendChild(b),r.appendChild(A),r.addEventListener("click",e=>{const r=!(!e.ctrlKey&&!e.metaKey),n=!!e.shiftKey;if(clearTransformLockAll(),n)!function(e){if(0===selectedLayerIndices.size)return selectedLayerIndices.add(e),void(activeLayerIndex=e);const t=activeLayerIndex??e,a=Math.min(t,e),r=Math.max(t,e);selectedLayerIndices.clear();for(let e=a;e<=r;e++)selectedLayerIndices.add(e);activeLayerIndex=e}(a);else{if(!r)return void function(e,t){clearTransformLockAll(),activeLayerIndex=e,selectedLayerIndices.clear(),selectedLayerIndices.add(e),syncActiveAliases?.(),rebuildLayersUI(),showStatusMessage?.(`Selected: ${t.name}`,"info"),needsRedraw=!0}(a,t);i(a,!0),activeLayerIndex=a}document.querySelectorAll("#layersList .layer-item").forEach(e=>{const t=Number(e.dataset.index);e.classList.toggle("is-selected",selectedLayerIndices.has(t)),e.classList.toggle("active",t===activeLayerIndex)}),o()}),e.insertBefore(r,e.children[1]||null)}),o()}function clearActiveLayer(){const e="function"==typeof getActiveLayer?getActiveLayer():layers?.[activeLayerIndex];if(!(gl&&e&&e.fbo&&e.texture))return;const t=snapshotLayer(activeLayerIndex),a=0|fixedFBOWidth,r=0|fixedFBOHeight,n=gl.getParameter(gl.FRAMEBUFFER_BINDING),o=gl.getParameter(gl.VIEWPORT);gl.bindFramebuffer(gl.FRAMEBUFFER,e.fbo),gl.viewport(0,0,a,r),gl.disable(gl.BLEND),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.bindTexture(gl.TEXTURE_2D,e.texture),(0|e.texW)===a&&(0|e.texH)===r||(gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,a,r,0,gl.RGBA,gl.UNSIGNED_BYTE,null),e.texW=a,e.texH=r,gl.bindFramebuffer(gl.FRAMEBUFFER,e.fbo),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,e.texture,0)),gl.bindFramebuffer(gl.FRAMEBUFFER,n),o&&gl.viewport(o[0],o[1],o[2],o[3]);const i=snapshotLayer(activeLayerIndex);t&&i&&History.push({type:"clear_layer",index:activeLayerIndex,before:t,after:i}),needsRedraw=!0,requestDrawIfIdle?.(),showStatusMessage?.("Layer cleared","info")}function removeActiveLayer(){if(layers.length<=1)return void showStatusMessage("Need at least one layer","warning");const[e]=layers.splice(activeLayerIndex,1);gl.deleteTexture(e.texture),gl.deleteFramebuffer(e.fbo),activeLayerIndex=Math.max(0,activeLayerIndex-1),syncActiveAliases(),rebuildLayersUI(),needsRedraw=!0}function moveLayerUp(e){e>=layers.length-1||([layers[e],layers[e+1]]=[layers[e+1],layers[e]],activeLayerIndex===e?activeLayerIndex=e+1:activeLayerIndex===e+1&&(activeLayerIndex=e),syncActiveAliases(),rebuildLayersUI(),needsRedraw=!0)}function moveLayerDown(e){e<=0||([layers[e],layers[e-1]]=[layers[e-1],layers[e]],activeLayerIndex===e?activeLayerIndex=e-1:activeLayerIndex===e-1&&(activeLayerIndex=e),syncActiveAliases(),rebuildLayersUI(),needsRedraw=!0)}function initFloodFillProgram(){floodFillProgram=createProgram(gl,"\n        attribute vec2 aPosition;\n        varying vec2 vTexCoord;\n        void main() {\n            vTexCoord = (aPosition + 1.0) * 0.5;\n            gl_Position = vec4(aPosition, 0.0, 1.0);\n        }\n    ","\n        precision mediump float;\n        varying vec2 vTexCoord;\n        uniform sampler2D uSource;\n        uniform vec4 uTargetColor;\n        uniform vec4 uFillColor;\n        uniform vec2 uTexelSize;\n\n        void main() {\n            vec4 current = texture2D(uSource, vTexCoord);\n\n            float threshold = 0.01;\n\n            bool isTarget = distance(current, uTargetColor) < threshold;\n            bool isFilled = distance(current, uFillColor) < threshold;\n\n            if (isFilled) {\n                gl_FragColor = uFillColor;\n                return;\n            }\n\n            // Check neighbors:\n            vec2 offsets[8];\n            offsets[0] = vec2(-uTexelSize.x, 0.0);\n            offsets[1] = vec2(uTexelSize.x, 0.0);\n            offsets[2] = vec2(0.0, -uTexelSize.y);\n            offsets[3] = vec2(0.0, uTexelSize.y);\n            offsets[4] = vec2(-uTexelSize.x, -uTexelSize.y);\n            offsets[5] = vec2(-uTexelSize.x, uTexelSize.y);\n            offsets[6] = vec2(uTexelSize.x, -uTexelSize.y);\n            offsets[7] = vec2(uTexelSize.x, uTexelSize.y);\n\n            // vec2 offsets[4];\n            // offsets[0] = vec2(-uTexelSize.x, 0.0);\n            // offsets[1] = vec2(uTexelSize.x, 0.0);\n            // offsets[2] = vec2(0.0, -uTexelSize.y);\n            // offsets[3] = vec2(0.0, uTexelSize.y);\n\n            for (int i = 0; i < 8; i++) {\n                vec4 neighbor = texture2D(uSource, vTexCoord + offsets[i]);\n                bool neighborFilled = distance(neighbor, uFillColor) < threshold;\n                if (neighborFilled && isTarget) {\n                    gl_FragColor = uFillColor;\n                    return;\n                }\n            }\n\n            // for (int i = 0; i < 4; i++) {\n            //     vec4 neighbor = texture2D(uSource, vTexCoord + offsets[i]);\n            //     bool neighborFilled = distance(neighbor, uFillColor) < threshold;\n            //     if (neighborFilled && isTarget) {\n            //         gl_FragColor = uFillColor;\n            //         return;\n            //     }\n            // }\n\n            gl_FragColor = current;\n        }\n    ")}function performFloodFill(e,t){const a=getActiveLayer();if(!a)return;const r=snapshotLayer(activeLayerIndex),n=Math.max(0,Math.min(fixedFBOWidth-1,Math.round(e))),o=Math.max(0,Math.min(fixedFBOHeight-1,Math.round(t))),i=fixedFBOHeight-1-o,l=new Uint8Array(4);gl.bindFramebuffer(gl.FRAMEBUFFER,a.fbo),gl.readPixels(n,i,1,1,gl.RGBA,gl.UNSIGNED_BYTE,l),gl.bindFramebuffer(gl.FRAMEBUFFER,null);runFloodFillShader(a,[l[0]/255,l[1]/255,l[2]/255,l[3]/255],tintColor);const s=snapshotLayer(activeLayerIndex);History.push({type:"fill",before:r,after:s}),needsRedraw=!0}function runFloodFillShader(e,t,a){let r=fillFBO1,n=fillFBO2;gl.bindFramebuffer(gl.READ_FRAMEBUFFER,e.fbo),gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,r.fbo),gl.viewport(0,0,fixedFBOWidth,fixedFBOHeight),gl.blitFramebuffer(0,0,fixedFBOWidth,fixedFBOHeight,0,0,fixedFBOWidth,fixedFBOHeight,gl.COLOR_BUFFER_BIT,gl.NEAREST);const o=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),i=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,i),gl.bufferData(gl.ARRAY_BUFFER,o,gl.STATIC_DRAW);const l=gl.getAttribLocation(floodFillProgram,"aPosition");gl.enableVertexAttribArray(l),gl.vertexAttribPointer(l,2,gl.FLOAT,!1,0,0);for(let e=0;e<50;e++){gl.bindFramebuffer(gl.FRAMEBUFFER,n.fbo),gl.viewport(0,0,fixedFBOWidth,fixedFBOHeight),gl.useProgram(floodFillProgram),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,r.texture),gl.uniform1i(gl.getUniformLocation(floodFillProgram,"uSource"),0),gl.uniform4fv(gl.getUniformLocation(floodFillProgram,"uTargetColor"),t),gl.uniform4fv(gl.getUniformLocation(floodFillProgram,"uFillColor"),a),gl.uniform2f(gl.getUniformLocation(floodFillProgram,"uTexelSize"),1/fixedFBOWidth,1/fixedFBOHeight),gl.drawArrays(gl.TRIANGLES,0,6);let e=r;r=n,n=e}gl.bindFramebuffer(gl.READ_FRAMEBUFFER,r.fbo),gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,e.fbo),gl.viewport(0,0,fixedFBOWidth,fixedFBOHeight),gl.blitFramebuffer(0,0,fixedFBOWidth,fixedFBOHeight,0,0,fixedFBOWidth,fixedFBOHeight,gl.COLOR_BUFFER_BIT,gl.NEAREST),gl.disableVertexAttribArray(l),gl.deleteBuffer(i),gl.bindFramebuffer(gl.FRAMEBUFFER,null)}function createFBO(e,t){const a=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,a),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,e,t,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);const r=gl.createFramebuffer();return gl.bindFramebuffer(gl.FRAMEBUFFER,r),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,a,0),gl.bindFramebuffer(gl.FRAMEBUFFER,null),{fbo:r,texture:a}}!function(){function e(e){if("function"==typeof isUserTyping&&isUserTyping())return;const t=e.key;!("Delete"===t)&&!("Backspace"===t)||e.metaKey||e.ctrlKey||e.altKey||(e.preventDefault(),clearActiveLayer())}try{document.removeEventListener("keydown",e,!0)}catch{}document.addEventListener("keydown",e,!0)}(),document.getElementById("addLayerBtn").addEventListener("click",()=>{addLayer(`Layer ${layers.length+1}`,activeLayerIndex)}),document.getElementById("removeLayerBtn").addEventListener("click",()=>{removeActiveLayer()}),function(){const e=document.getElementById("addLayerBtn");if(e){try{document.removeEventListener("keydown",t,!0)}catch{}document.addEventListener("keydown",t,!0)}function t(t){if("function"==typeof isUserTyping&&isUserTyping())return;if(t.metaKey||t.ctrlKey||t.altKey)return;const a=t.key||"";"n"!==a&&"N"!==a||(t.preventDefault(),function(){try{e.click(),console.log("[Shortcut] New Layer via 'n' → addBtn.click()")}catch(e){try{const e=`Layer ${layers.length+1}`,t="number"==typeof activeLayerIndex?activeLayerIndex:layers.length-1;addLayer(e,t),console.log("[Shortcut] New Layer fallback → addLayer()",{name:e,insertBelowIndex:t})}catch(e){console.warn("[Shortcut] New Layer failed",e)}}}())}}(),document.addEventListener("keydown",e=>{if(isUserTyping())return;if(spacePanning||isDrawing)return;if(e.ctrlKey||e.metaKey||e.altKey)return;if("x"===e.key.toLowerCase()||"Delete"===e.key){if(e.preventDefault(),e.stopImmediatePropagation(),transformTool?.mode&&"idle"!==transformTool.mode&&endTransform(!1),layers.length<=1)return void showStatusMessage("Need at least one layer","warning");const t=layers[activeLayerIndex]?.name||"Layer";removeActiveLayer(),showStatusMessage(`Deleted: ${t}`,"success")}},{capture:!0});let fillFBO1=null,fillFBO2=null;function initFloodFBOs(){fillFBO1&&(gl.deleteTexture(fillFBO1.texture),gl.deleteFramebuffer(fillFBO1.fbo)),fillFBO2&&(gl.deleteTexture(fillFBO2.texture),gl.deleteFramebuffer(fillFBO2.fbo)),fillFBO1=createFBO(fixedFBOWidth,fixedFBOHeight),fillFBO2=createFBO(fixedFBOWidth,fixedFBOHeight)}let strokeCount=0;const FLATTEN_THRESHOLD=isMobile()?50:150;function flattenStrokes(){const e=getActiveLayer?.();if(!(gl&&e&&e.texture&&quadProgram))return;const t=Math.max(1,0|e.texW),a=Math.max(1,0|e.texH),r=gl.getParameter(gl.FRAMEBUFFER_BINDING),n=gl.getParameter(gl.CURRENT_PROGRAM),o=gl.getParameter(gl.VIEWPORT),i=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,i),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,t,a,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);const l=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,l),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,i,0),gl.viewport(0,0,t,a),gl.disable(gl.BLEND),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);const s=gl.getUniformLocation(quadProgram,"u_flipY");s&&gl.uniform1f(s,1);const c=gl.getUniformLocation(quadProgram,"u_resolution");c&&gl.uniform2f(c,t,a);const d=gl.getUniformLocation(quadProgram,"u_layerOpacity");d&&gl.uniform1f(d,1);const g=gl.getUniformLocation(quadProgram,"u_texture"),u=new Float32Array([0,0,0,0,t,0,1,0,0,a,0,1,0,a,0,1,t,0,1,0,t,a,1,1]),m=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,m),gl.bufferData(gl.ARRAY_BUFFER,u,gl.STREAM_DRAW);const f=gl.getAttribLocation(quadProgram,"a_position"),h=gl.getAttribLocation(quadProgram,"a_texCoord");gl.enableVertexAttribArray(f),gl.vertexAttribPointer(f,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(h),gl.vertexAttribPointer(h,2,gl.FLOAT,!1,16,8),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,e.texture),g&&gl.uniform1i(g,0),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(f),gl.disableVertexAttribArray(h),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(m);const y=e.texture,p=e.fbo;e.texture=i,e.fbo=l;try{y&&gl.deleteTexture(y)}catch{}try{p&&gl.deleteFramebuffer(p)}catch{}try{strokeCount=0}catch{}gl.bindFramebuffer(gl.FRAMEBUFFER,r),gl.useProgram(n),o&&gl.viewport(o[0],o[1],o[2],o[3]),needsRedraw=!0,requestDrawIfIdle?.()}let currentAngle=0,sharedBuffer=null;function createPaperImage(e,t){return new Promise((a,r)=>{try{const n=document.createElement("canvas");n.width=Math.max(1,Math.floor(e)),n.height=Math.max(1,Math.floor(t));const o=n.getContext("2d");o.fillStyle="#f2efe4",o.fillRect(0,0,n.width,n.height);const i=document.createElement("canvas");i.width=n.width,i.height=n.height;const l=i.getContext("2d"),s=l.createImageData(i.width,i.height);for(let e=0;e<s.data.length;e+=4){const t=50*Math.random()-25;s.data[e]=240+t,s.data[e+1]=235+t,s.data[e+2]=225+t,s.data[e+3]=255}l.putImageData(s,0,0),o.globalAlpha=.2,o.drawImage(i,0,0),o.globalAlpha=1;const c=document.createElement("canvas");c.width=n.width,c.height=n.height;const d=c.getContext("2d"),g=d.createImageData(c.width,c.height);for(let e=0;e<g.data.length;e+=4){const t=255*Math.random();g.data[e]=t,g.data[e+1]=t,g.data[e+2]=t,g.data[e+3]=90*Math.random()}d.putImageData(g,0,0),o.globalAlpha=.08,o.drawImage(c,0,0),o.globalAlpha=1;const u=o.createRadialGradient(n.width/2,n.height/2,.3*Math.min(n.width,n.height),n.width/2,n.height/2,.6*Math.max(n.width,n.height));u.addColorStop(0,"rgba(0,0,0,0)"),u.addColorStop(1,"rgba(0,0,0,0.35)"),o.globalAlpha=.3,o.fillStyle=u,o.fillRect(0,0,n.width,n.height),o.globalAlpha=1;const m=new Image;m.onload=()=>a(m),m.onerror=r,m.src=n.toDataURL("image/png")}catch(e){r(e)}})}async function resetToBasePaper(){const e=Number(fixedFBOWidth)>0?fixedFBOWidth:window.innerWidth,t=Number(fixedFBOHeight)>0?fixedFBOHeight:window.innerHeight,a=await createPaperImage(e,t);currentImage=a,fixedFBOWidth=a.width,fixedFBOHeight=a.height,initPaintLayerFixed(),initFloodFBOs?.(),updateCanvasSize(a),createTextureFromImage(a),canvas.offsetWidth,canvasWrapper.offsetWidth,zoomScale=1,panX=(canvasWrapper.clientWidth-canvas.width)/2,panY=(canvasWrapper.clientHeight-canvas.height)/2,viewRotation=0,updateCanvasTransform(),resetStrokeState?.(),rebuildLayersUI?.(),needsRedraw=!0,requestDrawIfIdle?.()}async function clearProject(){try{console.log("[ClearProject] begin");const e=History._captureProject?.();try{Array.isArray(layers)&&layers.forEach(e=>{try{gl.deleteTexture(e.texture)}catch{}try{gl.deleteFramebuffer(e.fbo)}catch{}})}catch(e){console.warn("[ClearProject] disposing old layers warning:",e)}await resetToBasePaper();const t=History._captureProject?.();History.push({type:"clear_project",beforeAll:e,afterAll:t}),showStatusMessage?.("Project cleared to base paper","success"),console.log("[ClearProject] done")}catch(e){console.error("[ClearProject] fatal error:",e),showStatusMessage?.("Clear failed","error")}}(()=>{const e=document.getElementById("cleanButton");e?e.addEventListener("click",()=>{console.log("[ClearProject] click"),clearProject();try{saveAutosaveDebounced?.(400)}catch{}}):console.warn('[ClearProject] "#cleanButton" not found; binding skipped.')})();const UNDO_LIMIT=isMobile()?50:200;function createTextureAndFBO(e,t,a=gl.NEAREST){const r=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,r),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,e,t,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,a),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,a),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);const n=gl.createFramebuffer();return gl.bindFramebuffer(gl.FRAMEBUFFER,n),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,r,0),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null),{texture:r,fbo:n}}function blitFBOtoFBO(e,t,a=fixedFBOWidth,r=fixedFBOHeight){gl.bindFramebuffer(gl.READ_FRAMEBUFFER,e),gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,t),gl.blitFramebuffer(0,0,a,r,0,0,a,r,gl.COLOR_BUFFER_BIT,gl.NEAREST),gl.bindFramebuffer(gl.READ_FRAMEBUFFER,null),gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,null)}function applySnapshotToLayer(e,t){if(!t||!gl)return;const a=0|t.w,r=0|t.h,n=layers?.[e];if(!n)return;const o=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,o),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,a,r,0,gl.RGBA,gl.UNSIGNED_BYTE,t.pixels),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);const i=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,i),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,o,0);try{n.texture&&gl.deleteTexture(n.texture)}catch{}try{n.fbo&&gl.deleteFramebuffer(n.fbo)}catch{}n.texture=o,n.fbo=i,n.ox=0,n.oy=0,n.texW=a,n.texH=r,n.x=0,n.y=0,n.scaleX=1,n.scaleY=1,n.rotation=0,n.px=.5*a,n.py=.5*r,needsRedraw=!0,requestDrawIfIdle?.()}function snapshotLayer(e){const t=0|fixedFBOWidth,a=0|fixedFBOHeight,r=layers&&layers[e];if(!(gl&&r&&r.fbo&&t&&a))return null;const n=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,n),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,t,a,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);const o=gl.createFramebuffer();if(gl.bindFramebuffer(gl.FRAMEBUFFER,o),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,n,0),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl instanceof WebGL2RenderingContext&&gl.blitFramebuffer)gl.bindFramebuffer(gl.READ_FRAMEBUFFER,r.fbo),gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,o),gl.blitFramebuffer(0,0,t,a,0,0,t,a,gl.COLOR_BUFFER_BIT,gl.NEAREST),gl.bindFramebuffer(gl.READ_FRAMEBUFFER,null),gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,null);else{const e=gl.getParameter(gl.FRAMEBUFFER_BINDING),n=gl.getParameter(gl.CURRENT_PROGRAM),i=gl.getParameter(gl.VIEWPORT);gl.bindFramebuffer(gl.FRAMEBUFFER,o),gl.viewport(0,0,t,a),gl.disable(gl.BLEND),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);const l=gl.getUniformLocation(quadProgram,"u_flipY");l&&gl.uniform1f(l,1);const s=gl.getUniformLocation(quadProgram,"u_resolution");s&&gl.uniform2f(s,t,a);const c=gl.getUniformLocation(quadProgram,"u_layerOpacity");c&&gl.uniform1f(c,1);const d=gl.getUniformLocation(quadProgram,"u_texture");d&&gl.uniform1i(d,0);const g=new Float32Array([0,0,0,0,t,0,1,0,0,a,0,1,0,a,0,1,t,0,1,0,t,a,1,1]),u=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,u),gl.bufferData(gl.ARRAY_BUFFER,g,gl.STREAM_DRAW);const m=gl.getAttribLocation(quadProgram,"a_position"),f=gl.getAttribLocation(quadProgram,"a_texCoord");m>=0&&(gl.enableVertexAttribArray(m),gl.vertexAttribPointer(m,2,gl.FLOAT,!1,16,0)),f>=0&&(gl.enableVertexAttribArray(f),gl.vertexAttribPointer(f,2,gl.FLOAT,!1,16,8)),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,r.texture),gl.drawArrays(gl.TRIANGLES,0,6),m>=0&&gl.disableVertexAttribArray(m),f>=0&&gl.disableVertexAttribArray(f),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(u),gl.bindFramebuffer(gl.FRAMEBUFFER,e),gl.useProgram(n),i&&gl.viewport(i[0],i[1],i[2],i[3])}return{index:e,w:t,h:a,texture:n,fbo:o}}function restoreLayerSnapshot(e){const t=layers[e.index];t&&blitFBOtoFBO(e.fbo,t.fbo,e.w,e.h)}function disposeSnapshot(e){try{e?.texture&&gl.deleteTexture(e.texture),e?.fbo&&gl.deleteFramebuffer(e.fbo)}catch(e){console.warn("disposeSnapshot",e)}}const History={stack:[],redo:[],limit:UNDO_LIMIT,push(e){this.stack.push(e),this.stack.length>this.limit&&this._dispose(this.stack.shift()),this.redo.length=0,console.log("[History] push",e.type)},undo(){const e=this.stack.pop();e&&(this._applyInverse(e),this.redo.push(e),needsRedraw=!0,showStatusMessage("Undo","info"),console.log("[History] undo",e.type))},redoDo(){const e=this.redo.pop();e&&(this._apply(e),this.stack.push(e),needsRedraw=!0,showStatusMessage("Redo","info"),console.log("[History] redo",e.type))},_dispose(e){if(e&&(e.before&&disposeSnapshot(e.before),e.after&&disposeSnapshot(e.after),e.removedLayer&&e.removedLayer.snapshot&&disposeSnapshot(e.removedLayer.snapshot),e.addedLayer&&e.addedLayer.snapshot&&disposeSnapshot(e.addedLayer.snapshot),"merge_layers"===e.type))try{if(e.added&&e.added.data&&e.added.data.snapshot&&disposeSnapshot(e.added.data.snapshot),Array.isArray(e.removed))for(const t of e.removed)t&&t.data&&t.data.snapshot&&disposeSnapshot(t.data.snapshot)}catch(e){console.warn("dispose merge_layers",e)}},_apply(e){switch(e.type){case"stroke":case"fill":case"transform_bake":e.after&&restoreLayerSnapshot(e.after);break;case"layer_visibility":layers[e.index].visible=e.next;break;case"layer_opacity":layers[e.index].opacity=e.next;break;case"layer_rename":layers[e.index].name=e.next,rebuildLayersUI?.();break;case"layer_move":this._moveLayer(e.from,e.to);break;case"add_layer":this._insertLayer(e.index,e.addedLayer);break;case"remove_layer":this._removeLayerAt(e.index);break;case"clear_project":this._restoreProject(e.afterAll);break;case"merge_layers":{if(!Array.isArray(e.removed)||!e.added)break;const t=e.removed.map(e=>e.index).sort((e,t)=>t-e);for(const e of t)this._removeLayerAt(e);this._insertLayer(e.added.index,e.added.data),activeLayerIndex=e.added.index,syncActiveAliases?.(),rebuildLayersUI?.();break}}},_applyInverse(e){switch(e.type){case"stroke":case"fill":case"transform_bake":e.before&&restoreLayerSnapshot(e.before);break;case"layer_visibility":layers[e.index].visible=e.prev;break;case"layer_opacity":layers[e.index].opacity=e.prev;break;case"layer_rename":layers[e.index].name=e.prev,rebuildLayersUI?.();break;case"layer_move":this._moveLayer(e.to,e.from);break;case"add_layer":this._removeLayerAt(e.index);break;case"remove_layer":this._insertLayer(e.index,e.removedLayer);break;case"clear_project":this._restoreProject(e.beforeAll);break;case"merge_layers":if(e.added&&this._removeLayerAt(e.added.index),Array.isArray(e.removed)){const t=e.removed.slice().sort((e,t)=>e.index-t.index);for(const e of t)this._insertLayer(e.index,e.data);activeLayerIndex=t[t.length-1]?.index??0,syncActiveAliases?.(),rebuildLayersUI?.()}}},_moveLayer(e,t){if(e===t)return;const a=layers.splice(e,1)[0];layers.splice(t,0,a),activeLayerIndex=t,syncActiveAliases?.(),rebuildLayersUI?.()},_removeLayerAt(e){const t=layers[e];t&&(gl.deleteTexture(t.texture),gl.deleteFramebuffer(t.fbo),layers.splice(e,1),activeLayerIndex=Math.max(0,Math.min(activeLayerIndex,layers.length-1)),syncActiveAliases?.(),rebuildLayersUI?.())},_insertLayer(e,t){const{name:a,visible:r,opacity:n,snapshot:o}=t,{texture:i,fbo:l}=createLayerFBO(fixedFBOWidth,fixedFBOHeight),s={id:Date.now()+Math.random(),name:a,fbo:l,texture:i,visible:r,opacity:n,x:0,y:0,scaleX:1,scaleY:1,rotation:0,px:.5*fixedFBOWidth,py:.5*fixedFBOHeight,history:[],redo:[]};layers.splice(e,0,s),blitFBOtoFBO(o.fbo,s.fbo),activeLayerIndex=e,syncActiveAliases?.(),rebuildLayersUI?.()},_captureProject(){const e={w:fixedFBOWidth,h:fixedFBOHeight,layers:layers.map((e,t)=>({index:t,name:e.name,visible:e.visible,opacity:e.opacity,snapshot:snapshotLayer(t)})),background:null};if(currentImage)try{const t=document.createElement("canvas");t.width=fixedFBOWidth,t.height=fixedFBOHeight;t.getContext("2d").drawImage(currentImage,0,0,fixedFBOWidth,fixedFBOHeight),e.background=t.toDataURL("image/png")}catch(e){console.warn("captureProject background",e)}return e},_restoreProject(e){if(e)try{if(layers.forEach(e=>{gl.deleteTexture(e.texture),gl.deleteFramebuffer(e.fbo)}),layers=[],e.background){const t=new Image;t.onload=()=>{currentImage=t,updateCanvasSize(t),createTextureFromImage(t),needsRedraw=!0},t.src=e.background}else currentImage=null,texture=null;e.layers.forEach(t=>{const{texture:a,fbo:r}=createLayerFBO(e.w,e.h),n={id:Date.now()+Math.random(),name:t.name,fbo:r,texture:a,visible:t.visible,opacity:t.opacity,x:0,y:0,scaleX:1,scaleY:1,rotation:0,px:.5*fixedFBOWidth,py:.5*fixedFBOHeight,history:[],redo:[]};layers.push(n),blitFBOtoFBO(t.snapshot.fbo,n.fbo,e.w,e.h)}),activeLayerIndex=Math.max(0,layers.length-1),syncActiveAliases?.(),rebuildLayersUI?.(),needsRedraw=!0}catch(e){console.error("_restoreProject failed",e)}}};let __strokeBeforeSnap=null;function beginStrokeHistory(){try{if(!getActiveLayer())return;__strokeBeforeSnap=snapshotLayer(activeLayerIndex)}catch(e){console.warn("beginStrokeHistory",e)}}function endStrokeHistory(e="stroke"){try{if(!getActiveLayer()||!__strokeBeforeSnap)return void(__strokeBeforeSnap=null);const t=snapshotLayer(activeLayerIndex);History.push({type:e,before:__strokeBeforeSnap,after:t}),__strokeBeforeSnap=null}catch(e){console.warn("endStrokeHistory",e),__strokeBeforeSnap=null}}function undoStroke(){History.undo()}function redoStroke(){History.redoDo()}try{document.getElementById("undoButton").removeEventListener?.("click",undoStroke),document.getElementById("redoButton").removeEventListener?.("click",redoStroke)}catch{}function performFloodFill(e,t){const a=getActiveLayer();if(!a)return;const r=snapshotLayer(activeLayerIndex),n=Math.max(0,Math.min(fixedFBOWidth-1,Math.round(e))),o=Math.max(0,Math.min(fixedFBOHeight-1,Math.round(t))),i=fixedFBOHeight-1-o,l=new Uint8Array(4);gl.bindFramebuffer(gl.FRAMEBUFFER,a.fbo),gl.readPixels(n,i,1,1,gl.RGBA,gl.UNSIGNED_BYTE,l),gl.bindFramebuffer(gl.FRAMEBUFFER,null);runFloodFillShader(a,[l[0]/255,l[1]/255,l[2]/255,l[3]/255],tintColor);const s=snapshotLayer(activeLayerIndex);History.push({type:"fill",before:r,after:s}),needsRedraw=!0}function endTransform(e=!0){if(!(transformTool&&transformTool.mode&&"idle"!==transformTool.mode)){try{isTwoFingerGesture=!1,pinchStart=null}catch{}return transformTool&&(transformTool.mode="idle"),needsRedraw=!0,void requestDrawIfIdle?.()}try{stopRender?.("transform")}catch{}let t=!1,a=null,r=null;if(e)try{a=snapshotLayer?.(activeLayerIndex),applyActiveLayerTransform(),r=snapshotLayer?.(activeLayerIndex),a&&r&&History?.push&&History.push({type:"transform_bake",before:a,after:r}),t=!0}catch(e){console.warn("[endTransform] Bake failed:",e),t=!1}try{transformTool.start=null,transformTool.ref=null,transformTool.shiftInvert=!1,transformTool.pivotCanvas=null}catch{}transformTool&&(transformTool.mode="idle");try{isTwoFingerGesture=!1,pinchStart=null}catch{}const n=getActiveLayer?.(),o=!(!n||!n.transformLocked);transformTool&&(transformTool.mobileCombo=o),o&&queueMicrotask?.(()=>startTransform?.("grab")),showStatusMessage?.(t?"Transform applied":e?"Transform failed":"Transform cancelled",t?"success":e?"warning":"info"),needsRedraw=!0,requestDrawIfIdle?.()}function recordLayerVisibilityChange(e,t,a){History.push({type:"layer_visibility",index:e,prev:t,next:a})}function recordLayerOpacityChange(e,t,a){History.push({type:"layer_opacity",index:e,prev:t,next:a})}function recordLayerRename(e,t,a){History.push({type:"layer_rename",index:e,prev:t,next:a})}function recordLayerMove(e,t){History.push({type:"layer_move",from:e,to:t})}function recordAddLayer(e){const t=snapshotLayer(e);History.push({type:"add_layer",index:e,addedLayer:{name:layers[e].name,visible:layers[e].visible,opacity:layers[e].opacity,snapshot:t}})}function recordRemoveLayer(e,t){History.push({type:"remove_layer",index:e,removedLayer:t})}function captureLayerDataForRemoval(e){const t=layers[e];return{name:t.name,visible:t.visible,opacity:t.opacity,snapshot:snapshotLayer(e)}}document.getElementById("undoButton").addEventListener("click",undoStroke),document.getElementById("redoButton").addEventListener("click",redoStroke),document.addEventListener("keydown",e=>{isUserTyping()||("z"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),undoStroke()),"y"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),redoStroke()))},{capture:!0}),canvas.addEventListener("pointerdown",()=>{beginStrokeHistory()},{capture:!0}),canvas.addEventListener("pointerup",()=>{endStrokeHistory("stroke")},{capture:!0});const __moveLayerUp=moveLayerUp;moveLayerUp=function(e){const t=Math.min(layers.length-1,e+1);e!==t&&(__moveLayerUp(e),recordLayerMove(e,t))};const __moveLayerDown=moveLayerDown;moveLayerDown=function(e){const t=Math.max(0,e-1);e!==t&&(__moveLayerDown(e),recordLayerMove(e,t))};const __removeActiveLayer=removeActiveLayer;removeActiveLayer=function(){if(layers.length<=1)return void __removeActiveLayer();const e=activeLayerIndex,t=captureLayerDataForRemoval(e);__removeActiveLayer(),recordRemoveLayer(e,t)};const __addLayer=addLayer;addLayer=function(e=`Layer ${layers.length+1}`,t=activeLayerIndex){__addLayer(e,t),recordAddLayer(activeLayerIndex)};const __rebuildLayersUI=rebuildLayersUI;function recordClearProject(e,t){History.push({type:"clear_project",beforeAll:e,afterAll:t})}rebuildLayersUI=function(){__rebuildLayersUI();try{const e=document.getElementById("layersList");if(!e)return;e.querySelectorAll(".layer-item").forEach(e=>{const t=Number(e.getAttribute("data-index")),a=e.querySelector(".layer-vis button.bs.icon-btn");if(a&&!a.__hp_vis_hist_patched){a.__hp_vis_hist_patched=!0;const e=a.onclick;a.onclick=a=>{const r=layers[t].visible;e?.(a);const n=layers[t].visible;r!==n&&recordLayerVisibilityChange(t,r,n)}}const r=e.querySelector(".layer-opacity input[type='range']");if(r&&!r.__hp_op_hist_patched){r.__hp_op_hist_patched=!0;let e=layers[t].opacity;r.addEventListener("change",()=>{const a=layers[t].opacity;e!==a&&(recordLayerOpacityChange(t,e,a),e=a)})}const n=e.querySelector(".layer-name input");if(n&&!n.__hp_name_hist_patched){n.__hp_name_hist_patched=!0;let e=layers[t].name;n.addEventListener("blur",()=>{const a=layers[t].name;e!==a&&(recordLayerRename(t,e,a),e=a)}),n.addEventListener("change",()=>{const a=layers[t].name;e!==a&&(recordLayerRename(t,e,a),e=a)})}})}catch(e){console.warn("rebuildLayersUI history patch",e)}};let isErasing=!1;function updateEraserSliderVisibility(){const e=document.getElementById("eraseStrengthSlider");e&&(e.style.display=isErasing?"block":"none")}function toggleEraser(){isErasing=!isErasing,updateEraserSliderVisibility(),updateEraserButton(),showStatusMessage(isErasing?"Mode: Erase":"Mode: Paint","info")}function updateEraserButton(){document.querySelector("#eraserToggle").innerHTML=isErasing?'<img src="/static/draw/images/icons/eraser.svg" alt="Erase">':'<img src="/static/draw/images/icons/brush.svg" alt="Brush">',needsRedraw=!0}document.addEventListener("keydown",e=>{isUserTyping()||"e"===e.key.toLowerCase()&&toggleEraser()}),document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector("#eraserToggle");e&&(e.addEventListener("click",toggleEraser),updateEraserButton())}),document.addEventListener("keydown",e=>{isUserTyping()||(","===e.key?(eraseStrength=Math.max(0,eraseStrength-.01),updateEraserSliderUI()):"."===e.key&&(eraseStrength=Math.min(1,eraseStrength+.01),updateEraserSliderUI()))});let lineMode=!0,lineStepFactor=.02,lastFx=null,lastFy=null;function drawSingleBrushStamp(e,t,a=null,r=null){const n=getActiveLayer();if(!n||!gl)return;const o=0|fixedFBOWidth,i=0|fixedFBOHeight;let l=Math.max(1,0|(Number(n.texW)||o)),s=Math.max(1,0|(Number(n.texH)||i)),c=Number.isFinite(n.ox)?n.ox:0,d=Number.isFinite(n.oy)?n.oy:0,g=Number.isFinite(n.px)?n.px:c+.5*l,u=Number.isFinite(n.py)?n.py:d+.5*s;const m=Number.isFinite(n.x)?n.x:0,f=Number.isFinite(n.y)?n.y:0,h=Number.isFinite(n.scaleX)?n.scaleX:1,y=Number.isFinite(n.scaleY)?n.scaleY:1,p=Number.isFinite(n.rotation)?n.rotation:0,E=!Number.isFinite(n.px)||!Number.isFinite(n.py),v=g,b=u;let x=e-m,T=t-f;x-=g,T-=u;const w=Math.cos(-p),A=Math.sin(-p),R=x*w-T*A,L=x*A+T*w;let F=(0!==h?R/h:R)+g-c,_=(0!==y?L/y:L)+u-d;const B=(a??brushSize)*o,I=.5*B,P=.5*(B/brushAspect),U=r??currentAngle,S=Math.cos(U),M=Math.sin(U),D=(e,t)=>({x:e*S-t*M,y:e*M+t*S});let C=D(-I,-P),N=D(I,-P),O=D(-I,P),k=D(I,P),X=F+C.x,W=_+C.y,H=F+N.x,Y=_+N.y,G=F+O.x,q=_+O.y,z=F+k.x,V=_+k.y,$=Math.min(X,H,G,z),j=Math.min(W,Y,q,V),K=Math.max(X,H,G,z),J=Math.max(W,Y,q,V);const Z=1.5,Q=$<0,ee=j<0,te=K>l,ae=J>s;if(Q||ee||te||ae){const e=Q?Math.ceil(-$):0,t=ee?Math.ceil(-j):0,a=te?Math.ceil(K-l):0,r=ae?Math.ceil(J-s):0,o=e?Math.ceil((e+4)*Z):0,i=t?Math.ceil((t+4)*Z):0,m=l+o+(a?Math.ceil((a+4)*Z):0),f=s+i+(r?Math.ceil((r+4)*Z):0),h=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,h),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,m,f,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);const y=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,y),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,h,0),gl.viewport(0,0,m,f),gl.disable(gl.BLEND),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);const p=gl.getUniformLocation(quadProgram,"u_texture")||gl.getUniformLocation(quadProgram,"u_image"),x=gl.getUniformLocation(quadProgram,"u_flipY"),T=gl.getUniformLocation(quadProgram,"u_resolution"),w=gl.getUniformLocation(quadProgram,"u_layerOpacity");x&&gl.uniform1f(x,1),T&&gl.uniform2f(T,m,f),w&&gl.uniform1f(w,1);const A=new Float32Array([o,i,0,0,o+l,i,1,0,o,i+s,0,1,o,i+s,0,1,o+l,i,1,0,o+l,i+s,1,1]),R=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,R),gl.bufferData(gl.ARRAY_BUFFER,A,gl.STREAM_DRAW);const L=gl.getAttribLocation(quadProgram,"a_position"),B=gl.getAttribLocation(quadProgram,"a_texCoord");gl.enableVertexAttribArray(L),gl.vertexAttribPointer(L,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(B),gl.vertexAttribPointer(B,2,gl.FLOAT,!1,16,8),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,n.texture),p&&gl.uniform1i(p,0),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(L),gl.disableVertexAttribArray(B),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(R);const I=n.texture,P=n.fbo;n.texture=h,n.fbo=y,n.texW=l=m,n.texH=s=f,n.ox=c-=o,n.oy=d-=i,E&&(n.px=v,n.py=b,g=n.px,u=n.py),F+=o,_+=i,X+=o,H+=o,G+=o,z+=o,W+=i,Y+=i,q+=i,V+=i,gl.deleteFramebuffer(P),gl.deleteTexture(I)}gl.bindFramebuffer(gl.FRAMEBUFFER,n.fbo),gl.viewport(0,0,l,s),gl.disable(gl.SCISSOR_TEST),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.useProgram(paintProgram),gl.enable(gl.BLEND),isErasing?gl.blendFuncSeparate(gl.ZERO,gl.ONE,gl.ZERO,gl.ONE_MINUS_SRC_ALPHA):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);const re=gl.getUniformLocation(paintProgram,"u_flipY");re&&gl.uniform1f(re,1);const ne=gl.getUniformLocation(paintProgram,"u_resolution");ne&&gl.uniform2f(ne,l,s);const oe=gl.getUniformLocation(paintProgram,"u_erase");oe&&gl.uniform1i(oe,isErasing?1:0);const ie=gl.getUniformLocation(paintProgram,"u_eraseStrength");ie&&gl.uniform1f(ie,eraseStrength);const le=gl.getUniformLocation(paintProgram,"u_paintStrength");le&&gl.uniform1f(le,paintStrength);const se=gl.getUniformLocation(paintProgram,"u_tint");se&&gl.uniform4fv(se,tintColor),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,overlayTexture);const ce=gl.getUniformLocation(paintProgram,"u_brushTex"),de=gl.getUniformLocation(paintProgram,"u_brush");ce&&gl.uniform1i(ce,0),de&&gl.uniform1i(de,0);const ge=new Float32Array([X,W,0,0,H,Y,1,0,G,q,0,1,G,q,0,1,H,Y,1,0,z,V,1,1]),ue=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,ue),gl.bufferData(gl.ARRAY_BUFFER,ge,gl.STREAM_DRAW);const me=gl.getAttribLocation(paintProgram,"a_position"),fe=gl.getAttribLocation(paintProgram,"a_texCoord");gl.enableVertexAttribArray(me),gl.vertexAttribPointer(me,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(fe),gl.vertexAttribPointer(fe,2,gl.FLOAT,!1,16,8),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(me),gl.disableVertexAttribArray(fe),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(ue),gl.bindFramebuffer(gl.FRAMEBUFFER,null),needsRedraw=!0,requestDrawIfIdle?.()}function drawBrushStrokeToPaintLayer(e,t){if(!canPaint())return;if(!(gl&&layers.length&&overlayTexture&&getActiveLayer()))return;if(!Number.isFinite(e)||!Number.isFinite(t))return;if(e<0||t<0||e>canvas.width||t>canvas.height)return;const a=e*(fixedFBOWidth/canvas.width),r=t*(fixedFBOHeight/canvas.height),n=getActiveLayer();let o=1;if(void 0!==dynamicModeEnabled&&dynamicModeEnabled&&(o=void 0!==intuitiveMode&&intuitiveMode?.8+.8*Math.random():1.5-Math.random()),void 0===window.__stampCarry&&(window.__stampCarry=0),void 0===window.__angleEMA&&(window.__angleEMA=null),n.__lastDoc||(n.__lastDoc=null),!n.__lastDoc){let i=currentAngle;return void 0!==reverseModeEnabled&&reverseModeEnabled&&(i+=Math.PI),drawSingleBrushStamp(a,r,brushSize*o,i),n.__lastDoc={x:a,y:r},lastFx=a,lastFy=r,lastX=e,lastY=t,needsRedraw=!0,strokeCount++,void(void 0!==FLATTEN_THRESHOLD&&strokeCount>=FLATTEN_THRESHOLD&&flattenStrokes?.())}const i=a-n.__lastDoc.x,l=r-n.__lastDoc.y,s=Math.hypot(i,l);let c=Math.atan2(l,i);if(null==window.__angleEMA)window.__angleEMA=c;else{const e=.35;let t=window.__angleEMA,a=c;for(;a-t>Math.PI;)a-=2*Math.PI;for(;a-t<-Math.PI;)a+=2*Math.PI;window.__angleEMA=t+(a-t)*e,c=window.__angleEMA}void 0!==reverseModeEnabled&&reverseModeEnabled&&(c+=Math.PI);const d=Math.max(1,brushSize*fixedFBOWidth),g=Math.max(1e-6,.3*d),u=Math.min(2.5,s/g),m=brushSize*u*o;let f=d*(void 0!==lineStepFactor?lineStepFactor:.3)*u*o;f=Math.max(.5,f);let h=Math.max(0,f-window.__stampCarry);if(lineMode){for(;h<=s;){const e=h/s;drawSingleBrushStamp(n.__lastDoc.x+i*e,n.__lastDoc.y+l*e,m,c),h+=f}window.__stampCarry=h-s}else drawSingleBrushStamp(a,r,m,c),window.__stampCarry=(f-s%f)%f;n.__lastDoc={x:a,y:r},lastFx=a,lastFy=r,lastX=e,lastY=t,strokeCount++,void 0!==FLATTEN_THRESHOLD&&strokeCount>=FLATTEN_THRESHOLD&&flattenStrokes?.(),needsRedraw=!0}function drawBrushStrokeToPaintLayer(e,t){if(!canPaint())return;if(!(gl&&layers.length&&overlayTexture&&getActiveLayer()))return;if(!Number.isFinite(e)||!Number.isFinite(t))return;if(e<0||t<0||e>canvas.width||t>canvas.height)return;const a=e*(fixedFBOWidth/canvas.width),r=t*(fixedFBOHeight/canvas.height);if(void 0===window.__stampCarry&&(window.__stampCarry=0),void 0===window.__angleEMA&&(window.__angleEMA=null),null===lastFx||null===lastFy){let n=1;dynamicModeEnabled&&(n=intuitiveMode?.8+.8*Math.random():1.5-Math.random());let o=currentAngle;return reverseModeEnabled&&(o+=Math.PI),drawSingleBrushStamp(a,r,brushSize*n,o),lastFx=a,lastFy=r,lastX=e,lastY=t,needsRedraw=!0,strokeCount++,void(strokeCount>=FLATTEN_THRESHOLD&&flattenStrokes())}const n=a-lastFx,o=r-lastFy,i=Math.hypot(n,o);if(i<=1e-6)return;const l=Math.atan2(o,n);if(null===window.__angleEMA)window.__angleEMA=l;else{const e=window.__angleEMA,t=Math.cos(e),a=Math.sin(e),r=.25,n=(1-r)*t+r*Math.cos(l),o=(1-r)*a+r*Math.sin(l);window.__angleEMA=Math.atan2(o,n)}let s=window.__angleEMA;reverseModeEnabled&&(s+=Math.PI);let c=1;dynamicModeEnabled&&(c=intuitiveMode?.8+.8*Math.random():1.5-Math.random());const d=Math.max(1,brushSize*fixedFBOWidth),g=Math.max(1e-6,.3*d),u=Math.min(2.5,i/g),m=brushSize*u*c;let f=d*lineStepFactor*u*c;f=Math.max(.5,f);let h=Math.max(0,f-window.__stampCarry);if(lineMode){for(;h<=i;){const e=h/i;drawSingleBrushStamp(lastFx+n*e,lastFy+o*e,m,s),h+=f}window.__stampCarry=h-i}else drawSingleBrushStamp(a,r,m,s),window.__stampCarry=(f-i%f)%f;lastFx=a,lastFy=r,lastX=e,lastY=t,strokeCount++,strokeCount>=FLATTEN_THRESHOLD&&flattenStrokes(),needsRedraw=!0}function drawBrushOverlay(){gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.useProgram(overlayProgram);let e=gl.getUniformLocation(overlayProgram,"u_flipY");gl.uniform1f(e,-1);let t=gl.getUniformLocation(overlayProgram,"u_resolution");gl.uniform2f(t,canvas.width,canvas.height);let a=gl.getUniformLocation(overlayProgram,"u_tint");gl.uniform4fv(a,tintColor);const r=overlayPosition[0]*canvas.width,n=overlayPosition[1]*canvas.height,o=brushSize*canvas.width,i=o/2,l=o/brushAspect/2,s=[{x:-i,y:-l},{x:i,y:-l},{x:-i,y:l},{x:i,y:l}],c=Math.cos(currentAngle),d=Math.sin(currentAngle);const g=s.map(function(e){return{x:e.x*c-e.y*d,y:e.x*d+e.y*c}}),u={x:r+g[0].x,y:n+g[0].y},m={x:r+g[1].x,y:n+g[1].y},f={x:r+g[2].x,y:n+g[2].y},h={x:r+g[3].x,y:n+g[3].y},y=new Float32Array([u.x,u.y,0,0,m.x,m.y,1,0,f.x,f.y,0,1,f.x,f.y,0,1,m.x,m.y,1,0,h.x,h.y,1,1]),p=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,p),gl.bufferData(gl.ARRAY_BUFFER,y,gl.STREAM_DRAW);let E=gl.getAttribLocation(overlayProgram,"a_position");gl.enableVertexAttribArray(E),gl.vertexAttribPointer(E,2,gl.FLOAT,!1,16,0);let v=gl.getAttribLocation(overlayProgram,"a_texCoord");gl.enableVertexAttribArray(v),gl.vertexAttribPointer(v,2,gl.FLOAT,!1,16,8),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,overlayTexture);const b=gl.getUniformLocation(overlayProgram,"u_brush");gl.uniform1i(b,0),gl.drawArrays(gl.TRIANGLES,0,6),gl.deleteBuffer(p),gl.disableVertexAttribArray(E),gl.disableVertexAttribArray(v)}function activeLayerWouldClip(){const e=getActiveLayer?.();if(!e)return!1;const t=0|fixedFBOWidth,a=0|fixedFBOHeight,r=Number.isFinite(e.ox)?e.ox:0,n=Number.isFinite(e.oy)?e.oy:0,o=Math.max(1,Number.isFinite(e.texW)?e.texW:t),i=Math.max(1,Number.isFinite(e.texH)?e.texH:a),l=Number.isFinite(e.scaleX)?e.scaleX:1,s=Number.isFinite(e.scaleY)?e.scaleY:1,c=Number.isFinite(e.rotation)?e.rotation:0,d=Number.isFinite(e.x)?e.x:0,g=Number.isFinite(e.y)?e.y:0,u=Number.isFinite(e.px)?e.px:.5*t,m=Number.isFinite(e.py)?e.py:.5*a,f=Math.cos(c),h=Math.sin(c);function y(e,t){let a=(e-u)*l,r=(t-m)*s;return{x:u+(a*f-r*h)+d,y:m+(a*h+r*f)+g}}const p=y(r,n),E=y(r+o,n),v=y(r,n+i),b=y(r+o,n+i);return p.x<0||p.y<0||p.x>t||p.y>a||E.x<0||E.y<0||E.x>t||E.y>a||v.x<0||v.y<0||v.x>t||v.y>a||b.x<0||b.y<0||b.x>t||b.y>a}function promoteLayerForScale(e=1.25){const t=getActiveLayer?.();if(!(gl&&t&&t.texture&&quadProgram))return!1;const a=Math.abs(Number.isFinite(t.scaleX)?t.scaleX:1),r=Math.abs(Number.isFinite(t.scaleY)?t.scaleY:1);if(Math.max(a,r)<=e)return!1;const n=Math.max(1,0|t.texW),o=Math.max(1,0|t.texH),i=0|gl.getParameter(gl.MAX_TEXTURE_SIZE),l=Math.min(i,Math.max(1,Math.round(n*a))),s=Math.min(i,Math.max(1,Math.round(o*r))),c=gl.getParameter(gl.FRAMEBUFFER_BINDING),d=gl.getParameter(gl.CURRENT_PROGRAM),g=gl.getParameter(gl.VIEWPORT),u=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,u),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,l,s,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);const m=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,m),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,u,0),gl.viewport(0,0,l,s),gl.disable(gl.BLEND),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);const f=gl.getUniformLocation(quadProgram,"u_flipY");f&&gl.uniform1f(f,1);const h=gl.getUniformLocation(quadProgram,"u_resolution");h&&gl.uniform2f(h,l,s);const y=gl.getUniformLocation(quadProgram,"u_layerOpacity");y&&gl.uniform1f(y,1);const p=gl.getUniformLocation(quadProgram,"u_texture"),E=new Float32Array([0,0,0,0,l,0,1,0,0,s,0,1,0,s,0,1,l,0,1,0,l,s,1,1]),v=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,v),gl.bufferData(gl.ARRAY_BUFFER,E,gl.STREAM_DRAW);const b=gl.getAttribLocation(quadProgram,"a_position"),x=gl.getAttribLocation(quadProgram,"a_texCoord");gl.enableVertexAttribArray(b),gl.vertexAttribPointer(b,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(x),gl.vertexAttribPointer(x,2,gl.FLOAT,!1,16,8),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,t.texture),p&&gl.uniform1i(p,0),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(b),gl.disableVertexAttribArray(x),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(v);const T=t.texture,w=t.fbo;t.texture=u,t.fbo=m,t.texW=l,t.texH=s,a&&(t.scaleX/=a),r&&(t.scaleY/=r);try{T&&gl.deleteTexture(T)}catch{}try{w&&gl.deleteFramebuffer(w)}catch{}return gl.bindFramebuffer(gl.FRAMEBUFFER,c),gl.useProgram(d),g&&gl.viewport(g[0],g[1],g[2],g[3]),!0}function applyActiveLayerTransform(){const e=getActiveLayer?.();if(!(gl&&e&&e.texture&&quadProgram))return;const t=0|fixedFBOWidth,a=0|fixedFBOHeight,r=Number.isFinite(e.ox)?e.ox:0,n=Number.isFinite(e.oy)?e.oy:0,o=Math.max(1,Number.isFinite(e.texW)?e.texW:t),i=Math.max(1,Number.isFinite(e.texH)?e.texH:a),l=Number.isFinite(e.scaleX)?e.scaleX:1,s=Number.isFinite(e.scaleY)?e.scaleY:1,c=Number.isFinite(e.rotation)?e.rotation:0,d=Number.isFinite(e.x)?e.x:0,g=Number.isFinite(e.y)?e.y:0,u=Number.isFinite(e.px)?e.px:.5*t,m=Number.isFinite(e.py)?e.py:.5*a,f=Math.cos(c),h=Math.sin(c);function y(e,t){let a=(e-u)*l,r=(t-m)*s;return{x:u+(a*f-r*h)+d,y:m+(a*h+r*f)+g}}const p=y(r,n),E=y(r+o,n),v=y(r,n+i),b=y(r+o,n+i),x=Math.floor(Math.min(p.x,E.x,v.x,b.x)),T=Math.floor(Math.min(p.y,E.y,v.y,b.y)),w=Math.ceil(Math.max(p.x,E.x,v.x,b.x)),A=Math.ceil(Math.max(p.y,E.y,v.y,b.y)),R=Math.max(1,w-x|0),L=Math.max(1,A-T|0),F=gl.getParameter(gl.FRAMEBUFFER_BINDING),_=gl.getParameter(gl.CURRENT_PROGRAM),B=gl.getParameter(gl.VIEWPORT),I=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,I),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,R,L,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);const P=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,P),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,I,0),gl.viewport(0,0,R,L),gl.disable(gl.BLEND),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);const U=gl.getUniformLocation(quadProgram,"u_flipY");U&&gl.uniform1f(U,1);const S=gl.getUniformLocation(quadProgram,"u_resolution");S&&gl.uniform2f(S,R,L);const M=gl.getUniformLocation(quadProgram,"u_layerOpacity");M&&gl.uniform1f(M,1);const D=gl.getUniformLocation(quadProgram,"u_texture"),C=new Float32Array([p.x-x,p.y-T,0,0,E.x-x,E.y-T,1,0,v.x-x,v.y-T,0,1,v.x-x,v.y-T,0,1,E.x-x,E.y-T,1,0,b.x-x,b.y-T,1,1]),N=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,N),gl.bufferData(gl.ARRAY_BUFFER,C,gl.STREAM_DRAW);const O=gl.getAttribLocation(quadProgram,"a_position"),k=gl.getAttribLocation(quadProgram,"a_texCoord");gl.enableVertexAttribArray(O),gl.vertexAttribPointer(O,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(k),gl.vertexAttribPointer(k,2,gl.FLOAT,!1,16,8),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,e.texture),D&&gl.uniform1i(D,0),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(O),gl.disableVertexAttribArray(k),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(N);const X=e.texture,W=e.fbo;e.texture=I,e.fbo=P,e.ox=x,e.oy=T,e.texW=R,e.texH=L,e.x=0,e.y=0,e.scaleX=1,e.scaleY=1,e.rotation=0,e.px=e.ox+.5*e.texW,e.py=e.oy+.5*e.texH;try{X&&gl.deleteTexture(X)}catch{}try{W&&gl.deleteFramebuffer(W)}catch{}gl.bindFramebuffer(gl.FRAMEBUFFER,F),gl.useProgram(_),B&&gl.viewport(B[0],B[1],B[2],B[3]),needsRedraw=!0,requestDrawIfIdle?.()}function drawScene(){if(!gl||!quadProgram||!canvas)return;const e="undefined"!=typeof navigator&&navigator.maxTouchPoints>0||"undefined"!=typeof window&&"ontouchstart"in window;if(gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.viewport(0,0,canvas.width,canvas.height),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.SCISSOR_TEST),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),texture&&gl.isTexture(texture)){const e=new Float32Array([0,0,0,0,canvas.width,0,1,0,0,canvas.height,0,1,0,canvas.height,0,1,canvas.width,0,1,0,canvas.width,canvas.height,1,1]);gl.disable(gl.BLEND),function(e,t,a,r){if(!e||!t||!gl.isTexture(t))return;gl.useProgram(e);const n=gl.getUniformLocation(e,"u_flipY");n&&gl.uniform1f(n,-1);const o=gl.getUniformLocation(e,"u_resolution");o&&gl.uniform2f(o,canvas.width,canvas.height);const i=gl.getUniformLocation(e,"u_layerOpacity");i&&gl.uniform1f(i,null!=r?r:1);const l=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,l),gl.bufferData(gl.ARRAY_BUFFER,a,gl.STREAM_DRAW);const s=gl.getAttribLocation(e,"a_position"),c=gl.getAttribLocation(e,"a_texCoord");s>=0&&(gl.enableVertexAttribArray(s),gl.vertexAttribPointer(s,2,gl.FLOAT,!1,16,0)),c>=0&&(gl.enableVertexAttribArray(c),gl.vertexAttribPointer(c,2,gl.FLOAT,!1,16,8)),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,t);const d=gl.getUniformLocation(e,"u_texture")??gl.getUniformLocation(e,"u_brush");d&&gl.uniform1i(d,0),gl.drawArrays(gl.TRIANGLES,0,6),s>=0&&gl.disableVertexAttribArray(s),c>=0&&gl.disableVertexAttribArray(c),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(l)}(quadProgram,texture,e,1)}if(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),Array.isArray(layers))for(let e=0;e<layers.length;e++){const t=layers[e];!t||!t.visible||t.opacity<=0||t.texture&&gl.isTexture(t.texture)&&drawLayerWithTransform(quadProgram,t)}gl.disable(gl.BLEND);const t=!(!transformTool||"idle"===transformTool.mode),a=t&&!e;if((isDrawing||t||brushHUD.visible)&&overlayProgram&&overlayTexture&&gl.isTexture(overlayTexture)&&"function"==typeof drawBrushOverlay){gl.useProgram(overlayProgram);const e=gl.getUniformLocation(overlayProgram,"u_flipY");e&&gl.uniform1f(e,-1);const t=gl.getUniformLocation(overlayProgram,"u_resolution");if(t&&gl.uniform2f(t,canvas.width,canvas.height),drawBrushOverlay(),a){const e=overlayPosition[0]*canvas.width,t=overlayPosition[1]*canvas.height,a=brushSize*canvas.width,r=1.5*a,n=Math.max(1,.06*a);"function"==typeof drawRingOverlay&&drawRingOverlay(e,t,r,n,[1,0,0,.95]);"function"==typeof drawDashedLine&&drawDashedLine(lastPointer?.cx??e,lastPointer?.cy??t,e,t,1.5,10,6,[1,0,0,.95])}}if(t&&"object"==typeof touchViz&&touchViz?.visible&&Array.isArray(touchViz.pts)&&touchViz.pts.length&&"function"==typeof drawRingOverlay){if(overlayProgram){gl.useProgram(overlayProgram);const e=gl.getUniformLocation(overlayProgram,"u_flipY");e&&gl.uniform1f(e,-1);const t=gl.getUniformLocation(overlayProgram,"u_resolution");t&&gl.uniform2f(t,canvas.width,canvas.height)}const e=[0,1,0,.95],t=20*(window.devicePixelRatio||1),a=2*(window.devicePixelRatio||1),r=2,n=10,o=6;for(const r of touchViz.pts)drawRingOverlay(r.x,r.y,t,a,e);if(2===touchViz.pts.length&&"function"==typeof drawDashedLine){const t=touchViz.pts[0],a=touchViz.pts[1];drawDashedLine(t.x,t.y,a.x,a.y,r,n,o,e)}}gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null),gl.useProgram(null),maybeAutoHideBrushHUD()}document.addEventListener("keydown",e=>{if("function"==typeof isUserTyping&&isUserTyping())return;if(void 0!==spacePanning&&spacePanning)return;if(void 0!==isDrawing&&isDrawing)return;if(e.ctrlKey||e.metaKey||e.altKey)return;const t=e.key,a=t.toLowerCase(),r="ArrowUp"===t||"ArrowDown"===t||"ArrowLeft"===t||"ArrowRight"===t,n=Math.PI/180;if(e.shiftKey&&"d"===a){e.preventDefault(),e.stopImmediatePropagation();const t=Array.isArray(layers)?layers.length:0;try{"function"==typeof duplicateLayer&&duplicateLayer("number"==typeof activeLayerIndex?activeLayerIndex:void 0)}catch{}if((Array.isArray(layers)?layers.length:0)>t){try{const e="function"==typeof getActiveLayer?getActiveLayer():layers&&layers[activeLayerIndex]?layers[activeLayerIndex]:null;e&&(e.x=(Number.isFinite(e.x)?e.x:0)+10,e.y=(Number.isFinite(e.y)?e.y:0)+10,"function"==typeof startTransform&&startTransform("grab"))}catch{}try{rebuildLayersUI?.()}catch{}try{showStatusMessage?.("Layer duplicated (Shift+D)","success")}catch{}needsRedraw=!0,"function"==typeof requestDrawIfIdle&&requestDrawIfIdle()}return}if("function"==typeof isMobile&&!isMobile()&&"idle"!==transformTool?.mode&&r){e.preventDefault(),e.stopImmediatePropagation();const a="function"==typeof getActiveLayer?getActiveLayer():null;if(!a)return;Number.isFinite(a.x)||(a.x=0),Number.isFinite(a.y)||(a.y=0),Number.isFinite(a.scaleX)||(a.scaleX=1),Number.isFinite(a.scaleY)||(a.scaleY=1),Number.isFinite(a.rotation)||(a.rotation=0);const r=transformTool.mode;if("grab"===r){const r=e.shiftKey?10:1;"ArrowLeft"===t&&(a.x-=r),"ArrowRight"===t&&(a.x+=r),"ArrowUp"===t&&(a.y-=r),"ArrowDown"===t&&(a.y+=r)}else if("scale"===r){const r=e.shiftKey?.1:.01,n=e=>Math.max(.001,e);if(e.shiftKey){const e="ArrowRight"===t||"ArrowUp"===t?1:"ArrowLeft"===t||"ArrowDown"===t?-1:0;if(0!==e){const t=1+e*r;a.scaleX=n(a.scaleX*t),a.scaleY=n(a.scaleY*t)}}else"ArrowLeft"===t?a.scaleX=n(a.scaleX*(1-r)):"ArrowRight"===t?a.scaleX=n(a.scaleX*(1+r)):"ArrowUp"===t?a.scaleY=n(a.scaleY*(1+r)):"ArrowDown"===t&&(a.scaleY=n(a.scaleY*(1-r)))}else if("rotate"===r){const r=e.shiftKey?5:1,o="ArrowRight"===t||"ArrowDown"===t?1:"ArrowLeft"===t||"ArrowUp"===t?-1:0;a.rotation+=o*r*n}else{const r=e.shiftKey?10:1;"ArrowLeft"===t&&(a.x-=r),"ArrowRight"===t&&(a.x+=r),"ArrowUp"===t&&(a.y-=r),"ArrowDown"===t&&(a.y+=r)}try{startRender?.("transform")}catch{}return needsRedraw=!0,void("function"==typeof requestDrawIfIdle&&requestDrawIfIdle())}if("function"==typeof isMobile&&!isMobile()&&"idle"===transformTool?.mode&&e.shiftKey&&("ArrowUp"===t||"ArrowDown"===t)){if(e.preventDefault(),e.stopImmediatePropagation(),!layers||!layers.length)return;const a=Number.isInteger(activeLayerIndex)?activeLayerIndex:0,r="ArrowUp"===t?1:-1,n=Math.max(0,Math.min(layers.length-1,a+r));if(n===a)return;const o=layers[a]?.name??"";!function(e,t){if(!Array.isArray(layers)||0===layers.length)return;if((e=Math.max(0,Math.min(layers.length-1,0|e)))===(t=Math.max(0,Math.min(layers.length-1,0|t))))return;const a=layers.splice(e,1)[0];layers.splice(t,0,a);const r=Number.isInteger(activeLayerIndex)?activeLayerIndex:0;r===e?activeLayerIndex=t:e<r&&r<=t?activeLayerIndex=r-1:t<=r&&r<e&&(activeLayerIndex=r+1);try{recordLayerReorder?.(e,t)}catch{}try{rebuildLayersUI?.()}catch{}try{syncActiveAliases?.()}catch{}needsRedraw=!0,"function"==typeof requestDrawIfIdle&&requestDrawIfIdle()}(a,n);try{showStatusMessage?.(`Moved ${o||"layer"} ${r>0?"up":"down"}`,"info")}catch{}return}if(!("function"!=typeof isMobile||isMobile()||"idle"!==transformTool?.mode||e.shiftKey||"ArrowUp"!==t&&"ArrowDown"!==t)){if(e.preventDefault(),e.stopImmediatePropagation(),!layers||!layers.length)return;try{"idle"!==transformTool?.mode&&endTransform(!1)}catch{}try{clearTransformLockAll?.()}catch{}const a="ArrowUp"===t?1:-1,r=Math.max(0,Math.min(layers.length-1,activeLayerIndex+a));if(r!==activeLayerIndex){activeLayerIndex=r;try{syncActiveAliases?.()}catch{}try{rebuildLayersUI?.()}catch{}try{showStatusMessage?.(`Selected: ${layers[activeLayerIndex].name}`,"info")}catch{}needsRedraw=!0,"function"==typeof requestDrawIfIdle&&requestDrawIfIdle()}return}if("h"===a){e.preventDefault(),e.stopImmediatePropagation();const t=activeLayerIndex,a=layers?.[t];if(!a)return;const r=!!a.visible,n=!r;a.visible=n;try{recordLayerVisibilityChange?.(t,r,n)}catch{}try{rebuildLayersUI?.()}catch{}try{showStatusMessage?.(n?"Layer visible":"Layer hidden","info")}catch{}return needsRedraw=!0,void("function"==typeof requestDrawIfIdle&&requestDrawIfIdle())}if("g"===a)return e.preventDefault(),e.stopImmediatePropagation(),void("function"==typeof startTransform&&startTransform("grab"));if("s"===a)return e.preventDefault(),e.stopImmediatePropagation(),void("function"==typeof startTransform&&startTransform("scale",e.shiftKey));if("r"===a)return e.preventDefault(),e.stopImmediatePropagation(),void("function"==typeof startTransform&&startTransform("rotate",e.shiftKey));if("Escape"===t&&"idle"!==transformTool?.mode){const t="function"==typeof getActiveLayer?getActiveLayer():null;return t&&transformTool.ref&&(t.x=transformTool.ref.x,t.y=transformTool.ref.y,t.scaleX=transformTool.ref.scaleX,t.scaleY=transformTool.ref.scaleY,t.rotation=transformTool.ref.rotation),"function"==typeof endTransform&&endTransform(!1),needsRedraw=!0,e.preventDefault(),void e.stopImmediatePropagation()}if(("Enter"===t||"Return"===t)&&"idle"!==transformTool?.mode)return"function"==typeof endTransform&&endTransform(),needsRedraw=!0,e.preventDefault(),void e.stopImmediatePropagation();if("t"===a){e.preventDefault(),e.stopImmediatePropagation();const t="function"==typeof getActiveLayer?getActiveLayer():null;if(!t)return;t.x=0,t.y=0,t.scaleX=1,t.scaleY=1,t.rotation=0;try{showStatusMessage?.("Layer transform reset","info")}catch{}return needsRedraw=!0,void("function"==typeof requestDrawIfIdle&&requestDrawIfIdle())}},{capture:!0});let dynamicModeEnabled=!1,reverseModeEnabled=!1,intuitiveMode=!0;function showStatusMessage(e,t="info"){console.log("showStatusMessage",e);const a=document.createElement("div");a.classList.add("status-message",t),a.innerText=e,document.body.appendChild(a),setTimeout(()=>{a.classList.add("fade-out"),setTimeout(()=>a.remove(),700)},700)}function downscaleImage(e,t,a){const r=Math.min(t/e.width,a/e.height,1);if(r<1){const t=document.createElement("canvas");t.width=Math.floor(e.width*r),t.height=Math.floor(e.height*r);return t.getContext("2d").drawImage(e,0,0,t.width,t.height),t.toDataURL("image/jpeg",.7)}return null}function downscaleImageToWindow(e){const t=window.innerWidth,a=window.innerHeight,r=Math.min(t/e.width,a/e.height,1);if(r<1){const t=document.createElement("canvas");t.width=Math.floor(e.width*r),t.height=Math.floor(e.height*r);return t.getContext("2d").drawImage(e,0,0,t.width,t.height),t.toDataURL("image/jpeg",.7)}return null}document.addEventListener("keydown",e=>{isUserTyping()||(e.shiftKey&&"e"===e.key.toLowerCase()&&(isErasing=!isErasing,showStatusMessage(isErasing?"Mode: Erase":"Mode: Paint","info"),needsRedraw=!0),e.shiftKey&&"g"===e.key.toLowerCase()&&(lineMode=!lineMode,showStatusMessage("Line Mode: "+(lineMode?"ON":"OFF"),"info"),needsRedraw=!0))}),imageLoader.addEventListener("change",e=>{console.log("[DEBUG] imageLoader change event fired:",e);const t=e.target.files[0];if(t){console.log("[DEBUG] Selected file:",t.name,t.type,t.size);const e=new FileReader;e.onerror=e=>{console.error("[DEBUG] FileReader error:",e)},e.onload=e=>{console.log("[DEBUG] FileReader onload triggered. Data length:",e.target.result.length);const t=new Image;t.onerror=e=>{console.error("[DEBUG] Image load error:",e)},t.onload=()=>{console.log("[DEBUG] Image loaded successfully. Dimensions:",t.width,t.height);const e=downscaleImageToWindow(t);e?(console.log("[DEBUG] Downscaled image to window dimensions."),t.src=e,t.onload=()=>{console.log("[DEBUG] Downscaled image loaded. Dimensions:",t.width,t.height),currentImage=t,fixedFBOWidth=t.width,fixedFBOHeight=t.height,console.log("[DEBUG] Calling initPaintLayerFixed()"),initPaintLayerFixed(),initFloodFillProgram(),console.log("[DEBUG] Calling updateCanvasSize(currentImage)"),updateCanvasSize(currentImage),console.log("[DEBUG] Calling createTextureFromImage(currentImage)"),createTextureFromImage(currentImage),canvas.offsetWidth,canvasWrapper.offsetWidth,zoomScale=1,panX=(canvasWrapper.clientWidth-canvas.width)/2,panY=(canvasWrapper.clientHeight-canvas.height)/2,updateCanvasTransform(),resetStrokeState(),needsRedraw=!0}):(console.log("[DEBUG] No downscaling needed."),currentImage=t,fixedFBOWidth=t.width,fixedFBOHeight=t.height,console.log("[DEBUG] Calling initPaintLayerFixed()"),initPaintLayerFixed(),initFloodFillProgram(),console.log("[DEBUG] Calling updateCanvasSize(currentImage)"),updateCanvasSize(currentImage),console.log("[DEBUG] Calling createTextureFromImage(currentImage)"),createTextureFromImage(currentImage),canvas.offsetWidth,canvasWrapper.offsetWidth,zoomScale=1,panX=(canvasWrapper.clientWidth-canvas.width)/2,panY=(canvasWrapper.clientHeight-canvas.height)/2,updateCanvasTransform(),resetStrokeState(),needsRedraw=!0)},console.log("[DEBUG] Setting image src to FileReader result"),t.src=e.target.result};try{e.readAsDataURL(t),console.log("[DEBUG] FileReader readAsDataURL called successfully")}catch(e){console.error("[DEBUG] Exception while reading file:",e)}}else console.warn("[DEBUG] No file selected.")});const imageLoaderButton=document.getElementById("imageLoaderButton");async function clearCanvas(e=!0){const t=History._captureProject?History._captureProject():null;try{console.log("[Clear] start");try{Array.isArray(layers)&&layers.forEach(e=>{try{gl.deleteTexture(e.texture)}catch{}try{gl.deleteFramebuffer(e.fbo)}catch{}})}catch(e){console.warn("[Clear] warning disposing old layers:",e)}const e=Math.max(1,0|window.visualViewport?.width||0|window.innerWidth),t=Math.max(1,0|window.visualViewport?.height||0|window.innerHeight);let a=null;if("function"==typeof createPaperImage)try{a=await createPaperImage(e,t)}catch(e){console.warn("[Clear] createPaperImage failed, falling back to flat paper:",e)}if(!a){const r=document.createElement("canvas");r.width=e,r.height=t;const n=r.getContext("2d");n.fillStyle="#f2efe4",n.fillRect(0,0,e,t),a=await new Promise((e,t)=>{const a=new Image;a.onload=()=>e(a),a.onerror=t,a.src=r.toDataURL("image/png")})}currentImage=a,fixedFBOWidth=a.width,fixedFBOHeight=a.height,"function"==typeof setDocumentSize?setDocumentSize(a.width,a.height):(canvas.width=a.width,canvas.height=a.height,gl.viewport(0,0,a.width,a.height));try{initFloodFBOs?.()}catch{}initPaintLayerFixed();try{if(texture)try{gl.deleteTexture(texture)}catch{}createTextureFromImage(a)}catch(e){console.error("[Clear] createTextureFromImage failed:",e)}try{updateCanvasSize(a)}catch{}zoomScale=1,panX=panY=0;try{centerCanvasInWrapper?.()}catch{}viewRotation=0;try{updateCanvasTransform?.()}catch{}try{resetStrokeState?.()}catch{}try{syncActiveAliases?.()}catch{}try{rebuildLayersUI?.()}catch{}try{showStatusMessage?.("New project created to match current window.","success")}catch{}needsRedraw=!0;try{requestDrawIfIdle?.()}catch{}console.log("[Clear] done",{w:a.width,h:a.height})}catch(e){console.error("[Clear] fatal error:",e);try{showStatusMessage?.("Clear failed.","error")}catch{}}if(e&&History._captureProject){const e=History._captureProject();try{recordClearProject?.(t,e)}catch(a){console.warn("[Clear] recordClearProject failed; pushing generic history entry:",a);try{History.push?.({type:"clear_project",beforeAll:t,afterAll:e})}catch{}}}}function resetPageZoomFromInputs(){const e=document.querySelector('meta[name="viewport"]');if(!e)return;const t=e.getAttribute("content")||"width=device-width, initial-scale=1",a=t.replace(/,\s*maximum-scale=[^,]+/i,"");e.setAttribute("content",`${a}, maximum-scale=1`),setTimeout(()=>e.setAttribute("content",t),80)}function blurActiveElement(){document.activeElement&&"function"==typeof document.activeElement.blur&&document.activeElement.blur()}function resetToCurrentWindow(){const e=0|(window.visualViewport?.width||window.innerWidth),t=0|(window.visualViewport?.height||window.innerHeight),a=document.createElement("canvas");a.width=e,a.height=t;const r=a.getContext("2d");r.fillStyle="#f2efe4",r.fillRect(0,0,e,t);const n=r.createImageData(e,t);for(let e=0;e<n.data.length;e+=4){const t=40*Math.random()|0;n.data[e+0]=230+t,n.data[e+1]=226+t,n.data[e+2]=218+t,n.data[e+3]=255}r.globalAlpha=.15,r.putImageData(n,0,0),r.globalAlpha=1;const o=new Image;o.onload=()=>{currentImage=o,fixedFBOWidth=o.width,fixedFBOHeight=o.height,initFloodFBOs(),initPaintLayerFixed(),updateCanvasSize(o),createTextureFromImage(o),zoomScale=1,panX=panY=0,centerCanvasInWrapper?.(),resetStrokeState(),needsRedraw=!0,showStatusMessage("New document sized to window","success")},o.src=a.toDataURL("image/png")}imageLoaderButton.addEventListener("click",()=>{console.log("[DEBUG] imageLoaderButton clicked."),document.getElementById("imageLoader").click()}),imageLoaderButton.addEventListener("touchend",()=>{console.log("[DEBUG] imageLoaderButton touchend triggered."),document.getElementById("imageLoader").click()}),/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream&&(console.log("[DEBUG] Detected iOS device – removing capture attribute"),imageLoader.removeAttribute("capture")),document.addEventListener("DOMContentLoaded",async()=>{const e="artworks";let t;async function a(){return t||new Promise((a,r)=>{const n=indexedDB.open("DrawingAppDB",1);n.onupgradeneeded=t=>{let a=t.target.result;a.objectStoreNames.contains(e)||a.createObjectStore(e,{keyPath:"id"})},n.onsuccess=()=>a(t=n.result),n.onerror=()=>r("IndexedDB failed to open")})}async function r(t,r=!1,n=null,o=!1){try{const l=await a(),s=b(!0),c=await x(s,"image/png",.92),d=320,g=Math.min(d/s.width,d/s.height,1),u=document.createElement("canvas");u.width=Math.round(s.width*g),u.height=Math.round(s.height*g),u.getContext("2d").drawImage(s,0,0,u.width,u.height);const m=await x(u,"image/webp",.7),f=await new Promise(e=>{const t=new FileReader;t.onloadend=()=>e(t.result),t.readAsDataURL(m)}),h=fixedFBOWidth,y=fixedFBOHeight;let p=null;if(currentImage){const L=document.createElement("canvas");L.width=h,L.height=y;L.getContext("2d").drawImage(currentImage,0,0,h,y),p=await x(L,"image/png",.92)}async function i(e,t,a){const r=new Uint8Array(t*a*4);gl.bindFramebuffer(gl.FRAMEBUFFER,e),gl.readPixels(0,0,t,a,gl.RGBA,gl.UNSIGNED_BYTE,r),gl.bindFramebuffer(gl.FRAMEBUFFER,null);const n=document.createElement("canvas");n.width=t,n.height=a;const o=n.getContext("2d"),i=new ImageData(new Uint8ClampedArray(r),t,a);o.putImageData(i,0,0);const l=document.createElement("canvas");l.width=t,l.height=a;const s=l.getContext("2d");return s.save(),s.translate(t/2,a/2),s.scale(-1,-1),s.rotate(Math.PI),s.drawImage(n,-t/2,-a/2),s.restore(),x(l,"image/png",.92)}const E=[];for(let F=0;F<layers.length;F++){const _=layers[F],B=Math.max(1,0|(Number(_.texW)||h)),I=Math.max(1,0|(Number(_.texH)||y)),P=await i(_.fbo,B,I);E.push({name:_.name,visible:!!_.visible,opacity:Number(_.opacity)||1,x:Number(_.x)||0,y:Number(_.y)||0,scaleX:Number.isFinite(_.scaleX)?_.scaleX:1,scaleY:Number.isFinite(_.scaleY)?_.scaleY:1,rotation:Number(_.rotation)||0,px:Number.isFinite(_.px)?_.px:.5*h,py:Number.isFinite(_.py)?_.py:.5*y,texW:B,texH:I,ox:Number(_.ox)||0,oy:Number(_.oy)||0,blob:P})}const v=document.getElementById("existingArtworkId"),T=v?v.value:null,w=r?n??currentArtworkId??T??Date.now():Date.now(),A={id:w,name:t||`Untitled ${w}`,date:(new Date).toISOString(),username:"User",appName:"Web Paint",image:c,thumbnail:f,project:{v:2,width:h,height:y,backgroundBlob:p,layers:E}},R=l.transaction(e,"readwrite");R.objectStore(e).put(A),R.oncomplete=()=>{if(o||ve(r?"Artwork overwritten!":"Artwork saved!","success"),v&&(v.value=w),currentArtworkId=w,!o&&O&&O.readyState===WebSocket.OPEN){const e=JSON.parse(localStorage.getItem("userProfile"))||{},t={type:"image",clientId:k,nickname:e.nickname?.trim()||"",profileImage:e.image||"",imageData:A.thumbnail,imageName:A.name,timestamp:Date.now()};O.send(JSON.stringify(t))}},R.onerror=e=>{console.error("[saveArtwork] IndexedDB ERROR:",e),o||ve("Error saving artwork.","error")}}catch(U){console.error("[saveArtwork] ERROR:",U),o||ve("Error saving artwork.","error")}}const n="__autosave__";let o=null;async function i(){await a();const e=document.getElementById("artworkName"),t=e?e.value:"";await r(t||"Autosave",!0,n,{quiet:!0})}async function l(e){if(e){if(currentArtworkId=e.id,e.project&&e.project.layers&&e.project.layers.length){const a=0|e.project.width,r=0|e.project.height;if(fixedFBOWidth=a,fixedFBOHeight=r,initFloodFBOs(),initPaintLayerFixed(),e.project.backgroundBlob){const n=URL.createObjectURL(e.project.backgroundBlob),o=new Image;await new Promise(e=>{o.onload=()=>{currentImage=o,updateCanvasSize(o),createTextureFromImage(o),canvas.offsetWidth,canvasWrapper.offsetWidth,zoomScale=1,panX=(canvasWrapper.clientWidth-canvas.width)/2,panY=(canvasWrapper.clientHeight-canvas.height)/2,updateCanvasTransform(),resetStrokeState(),needsRedraw=!0,URL.revokeObjectURL(n),e()},o.src=n})}else currentImage=null,texture=null,updateCanvasSize({width:a,height:r});function t(e,t,a,r){const n=document.createElement("canvas");n.width=a,n.height=r;const o=n.getContext("2d");o.clearRect(0,0,a,r),o.drawImage(e,0,0,a,r);const i=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,i),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!1),gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,n),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindFramebuffer(gl.FRAMEBUFFER,t),gl.viewport(0,0,a,r),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.SCISSOR_TEST),gl.disable(gl.BLEND),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);const l=gl.getUniformLocation(quadProgram,"u_flipY"),s=gl.getUniformLocation(quadProgram,"u_resolution"),c=gl.getUniformLocation(quadProgram,"u_layerOpacity"),d=gl.getUniformLocation(quadProgram,"u_texture")||gl.getUniformLocation(quadProgram,"u_image");l&&gl.uniform1f(l,1),s&&gl.uniform2f(s,a,r),c&&gl.uniform1f(c,1),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,i),d&&gl.uniform1i(d,0),__bindAndDrawTexturedQuad(quadProgram,a,r),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.deleteTexture(i)}layers.forEach(e=>{gl.deleteTexture(e.texture),gl.deleteFramebuffer(e.fbo)}),layers=[];for(const i of e.project.layers){const l=Math.max(1,0|(Number(i.texW)||a)),s=Math.max(1,0|(Number(i.texH)||r)),c=Number(i.ox)||0,d=Number(i.oy)||0,{texture:g,fbo:u}=createLayerFBO(l,s);if(i.blob){const f=URL.createObjectURL(i.blob),h=new Image;await new Promise(e=>{h.onload=()=>{t(h,u,l,s),URL.revokeObjectURL(f),e()},h.src=f})}else gl.bindFramebuffer(gl.FRAMEBUFFER,u),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.bindFramebuffer(gl.FRAMEBUFFER,null);const m={id:Date.now()+Math.random(),name:i.name||`Layer ${layers.length+1}`,fbo:u,texture:g,visible:!1!==i.visible,opacity:Number(i.opacity)||1,x:Number(i.x)||0,y:Number(i.y)||0,scaleX:Number.isFinite(i.scaleX)?i.scaleX:1,scaleY:Number.isFinite(i.scaleY)?i.scaleY:1,rotation:Number(i.rotation)||0,px:Number.isFinite(i.px)?i.px:.5*a,py:Number.isFinite(i.py)?i.py:.5*r,texW:l,texH:s,ox:c,oy:d,history:[],redo:[]};layers.push(m)}return activeLayerIndex=Math.max(0,layers.length-1),syncActiveAliases?.(),rebuildLayersUI?.(),needsRedraw=!0,void requestDrawIfIdle?.()}if(e.image){const y=URL.createObjectURL(e.image),p=new Image;p.onload=()=>{currentImage=p,updateCanvasSize(p),createTextureFromImage(p),zoomScale=1,panX=(canvasWrapper.clientWidth-canvas.width)/2,panY=(canvasWrapper.clientHeight-canvas.height)/2,updateCanvasTransform(),resetStrokeState(),needsRedraw=!0,URL.revokeObjectURL(y)},p.src=y}}}!function(){const t=()=>function(e=800){o&&clearTimeout(o),o=setTimeout(()=>{i().catch(console.error)},e)}(500),r=()=>{try{i()}catch(e){}},s=document.getElementById("glCanvas");s&&["pointerup","mouseup","touchend"].forEach(e=>s.addEventListener(e,t,{passive:!0})),document.addEventListener("keyup",t,{passive:!0}),document.addEventListener("visibilitychange",()=>{document.hidden&&r()}),window.addEventListener("beforeunload",r),setInterval(()=>{try{isDrawing||t()}catch(e){}},15e3),window.addEventListener("load",()=>{requestAnimationFrame(()=>{!async function(){const t=(await a()).transaction(e,"readonly").objectStore(e).get(n);t.onsuccess=async()=>{const e=t.result;e&&(await l(e),ve("Autosave restored","success"))},t.onerror=()=>{console.warn("Autosave lookup failed.")}}()})})}(),document.addEventListener("keydown",e=>{if(!isUserTyping())if(e.metaKey&&"s"===e.key.toLowerCase()){console.log("kd: s"),e.preventDefault(),e.stopPropagation();const t=document.getElementById("artworkName").value,a=document.getElementById("existingArtworkId");a&&a.value?(r(t,!0,a.value),ve("Artwork overwritten!","success")):console.warn("No artwork selected for overwrite.")}else if(e.shiftKey&&"s"===e.key.toLowerCase()){e.preventDefault(),e.stopPropagation();const t=document.getElementById("saveModal");I(t)}}),document.getElementById("saveNewButton").addEventListener("click",()=>{r(document.getElementById("artworkName").value,!1),P(be)}),document.getElementById("overwriteButton").addEventListener("click",()=>{const e=document.getElementById("artworkName").value,t=document.getElementById("existingArtworkId"),a=t?t.value:null;a&&e?r(e,!0,a,{quiet:!0}):console.error("No existing artwork ID or name found. Cannot overwrite."),P(be)}),document.getElementById("exportProjectBtn").addEventListener("click",()=>{!async function({includeBackground:e=!0}={}){if(!window.JSZip)return console.error("JSZip not loaded"),void ve("Export failed: JSZip not loaded.","error");const t=fixedFBOWidth,a=fixedFBOHeight,r=new JSZip,n={version:2,width:t,height:a,app:"Helena Paint",date:(new Date).toISOString(),hasBackground:!!currentImage&&e,layers:layers.map((e,r)=>({index:r,name:e.name,visible:!!e.visible,opacity:Number(e.opacity)||1,x:Number(e.x)||0,y:Number(e.y)||0,scaleX:Number(e.scaleX)||1,scaleY:Number(e.scaleY)||1,rotation:Number(e.rotation)||0,px:Number.isFinite(e.px)?e.px:.5*t,py:Number.isFinite(e.py)?e.py:.5*a,ox:Number.isFinite(e.ox)?e.ox:0,oy:Number.isFinite(e.oy)?e.oy:0,texW:Number.isFinite(e.texW)?e.texW:t,texH:Number.isFinite(e.texH)?e.texH:a}))};if(r.file("manifest.json",JSON.stringify(n,null,2),{compression:"DEFLATE"}),n.hasBackground){const e=document.createElement("canvas");e.width=t,e.height=a,e.getContext("2d").drawImage(currentImage,0,0,t,a);const n=await new Promise(t=>e.toBlob(t,"image/png",.92));r.file("background.png",n,{compression:"DEFLATE"})}for(let e=0;e<layers.length;e++){const n=layers[e],o=Number.isFinite(n.texW)?n.texW:t,i=Number.isFinite(n.texH)?n.texH:a,l=c(n.fbo,o,i),s=await d(l),g=(n.name||"Layer").replace(/[^\w\-]+/g,"_"),u=`layers/${String(e).padStart(3,"0")}_${g}_${o}x${i}.png`;r.file(u,s,{compression:"DEFLATE"})}const o=await r.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:6}}),i=`helena_project_${Date.now()}.hpaint`,l=document.createElement("a");l.href=URL.createObjectURL(o),l.download=i,document.body.appendChild(l),l.click(),l.remove(),ve("Project exported!","success")}({includeBackground:!0})});const s=document.getElementById("importProjectInput");document.getElementById("importProjectBtn").addEventListener("click",()=>s.click()),s.addEventListener("change",e=>{const t=e.target.files?.[0];t&&async function(e){if(!window.JSZip)return console.error("JSZip not loaded"),void ve("Import failed: JSZip not loaded.","error");try{const a=await JSZip.loadAsync(e),r=await a.file("manifest.json").async("string"),n=JSON.parse(r),o=Number(n.version)||1,i=Number(n.width)||fixedFBOWidth,l=Number(n.height)||fixedFBOHeight;if("function"==typeof setFixedFBODimensions?setFixedFBODimensions(i,l):(window.fixedFBOWidth=i,window.fixedFBOHeight=l),initPaintLayerFixed?.(),n.hasBackground&&a.file("background.png")){const c=await a.file("background.png").async("blob"),d=await createImageBitmap(c);"function"==typeof setDocumentBackgroundImageBitmap?await setDocumentBackgroundImageBitmap(d):window.currentImage=d}function t(e,t,a,r){const n=Math.max(1,0|a.texW),o=Math.max(1,0|a.texH),s=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,s),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,n,o,0,gl.RGBA,gl.UNSIGNED_BYTE,null),t&&gl.texSubImage2D(gl.TEXTURE_2D,0,0,0,gl.RGBA,gl.UNSIGNED_BYTE,t);const c=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,c),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,s,0),gl.bindFramebuffer(gl.FRAMEBUFFER,null);const d={id:Date.now()+Math.random(),name:e,texture:s,fbo:c,visible:!!r.visible,opacity:Number.isFinite(r.opacity)?r.opacity:1,ox:0|a.ox,oy:0|a.oy,texW:n,texH:o,x:Number.isFinite(r.x)?r.x:0,y:Number.isFinite(r.y)?r.y:0,scaleX:Number.isFinite(r.scaleX)?r.scaleX:1,scaleY:Number.isFinite(r.scaleY)?r.scaleY:1,rotation:Number.isFinite(r.rotation)?r.rotation:0,px:Number.isFinite(r.px)?r.px:.5*i,py:Number.isFinite(r.py)?r.py:.5*l,history:[],redo:[]};layers.push(d)}const s=(n.layers||[]).slice().sort((e,t)=>e.index-t.index);for(let g=0;g<s.length;g++){const u=s[g],m=String(u.index).padStart(3,"0")+"_",f=Object.keys(a.files).filter(e=>e.startsWith("layers/")),h=f.find(e=>e.split("/").pop().startsWith(m))||f[u.index];let y=null;if(h){const E=await a.file(h).async("blob");y=await createImageBitmap(E)}else console.warn("Missing layer image in zip for index",u.index);const p=o>=2?{ox:Number.isFinite(u.ox)?u.ox:0,oy:Number.isFinite(u.oy)?u.oy:0,texW:Number.isFinite(u.texW)?u.texW:i,texH:Number.isFinite(u.texH)?u.texH:l}:{ox:0,oy:0,texW:i,texH:l};t(u.name||`Layer ${g+1}`,y,p,{visible:!!u.visible,opacity:Number(u.opacity)||1,x:u.x,y:u.y,scaleX:u.scaleX,scaleY:u.scaleY,rotation:u.rotation,px:u.px,py:u.py})}activeLayerIndex=Math.max(0,layers.length-1),syncActiveAliases?.(),rebuildLayersUI?.(),needsRedraw=!0,requestDrawIfIdle?.(),ve?.("Project imported","success")}catch(v){console.error(v),ve("Import failed.","error")}}(t)});function c(e,t,a){const r=new Uint8Array(t*a*4);return gl.bindFramebuffer(gl.FRAMEBUFFER,e),gl.readPixels(0,0,t,a,gl.RGBA,gl.UNSIGNED_BYTE,r),gl.bindFramebuffer(gl.FRAMEBUFFER,null),new ImageData(new Uint8ClampedArray(r),t,a)}function d(e){const t=document.createElement("canvas");return t.width=e.width,t.height=e.height,t.getContext("2d").putImageData(e,0,0),new Promise(e=>t.toBlob(e,"image/png",.92))}const g=document.getElementById("importLayerButton"),u=document.getElementById("importLayerInput"),m=document.getElementById("exportLayerButton");function f(){document.getElementById("exportOptionsModal").style.display="none"}function h(e){const t=0|fixedFBOWidth,a=0|fixedFBOHeight,r=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,r),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,t,a,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);const n=gl.createFramebuffer();if(gl.bindFramebuffer(gl.FRAMEBUFFER,n),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,r,0),gl.checkFramebufferStatus(gl.FRAMEBUFFER)!==gl.FRAMEBUFFER_COMPLETE)return gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.deleteFramebuffer(n),gl.deleteTexture(r),void ve?.("Export failed (FBO incomplete).","error");gl.viewport(0,0,t,a),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.SCISSOR_TEST),gl.enable(gl.BLEND),gl.blendFuncSeparate(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA,gl.ONE,gl.ONE_MINUS_SRC_ALPHA),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);const o=gl.getUniformLocation(quadProgram,"u_flipY"),i=gl.getUniformLocation(quadProgram,"u_resolution"),l=gl.getUniformLocation(quadProgram,"u_layerOpacity"),s=gl.getUniformLocation(quadProgram,"u_texture")||gl.getUniformLocation(quadProgram,"u_image");o&&gl.uniform1f(o,-1),i&&gl.uniform2f(i,t,a);const c=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,c);const d=gl.getAttribLocation(quadProgram,"a_position"),g=gl.getAttribLocation(quadProgram,"a_texCoord");function u(e,t,a,r,n,o){const i=new Float32Array([t.x,t.y,0,0,a.x,a.y,1,0,r.x,r.y,0,1,r.x,r.y,0,1,a.x,a.y,1,0,n.x,n.y,1,1]);gl.bufferData(gl.ARRAY_BUFFER,i,gl.STREAM_DRAW),l&&gl.uniform1f(l,Math.max(0,Math.min(1,o))),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,e),s&&gl.uniform1i(s,0),gl.drawArrays(gl.TRIANGLES,0,6)}gl.enableVertexAttribArray(d),gl.vertexAttribPointer(d,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(g),gl.vertexAttribPointer(g,2,gl.FLOAT,!1,16,8);let m=null;e&&currentImage&&(m=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,m),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!1),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,currentImage),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),u(m,{x:0,y:0},{x:t,y:0},{x:0,y:a},{x:t,y:a},1));for(let x=0;x<layers.length;x++){const T=layers[x];if(!T||!1===T.visible)continue;if(null!=T.opacity&&T.opacity<=0)continue;if(!T.texture)continue;const w=Number.isFinite(T.ox)?T.ox:0,A=Number.isFinite(T.oy)?T.oy:0,R=Math.max(1,0|(Number(T.texW)||t)),L=Math.max(1,0|(Number(T.texH)||a)),F=Number.isFinite(T.px)?T.px:.5*t,_=Number.isFinite(T.py)?T.py:.5*a,B=Number.isFinite(T.x)?T.x:0,I=Number.isFinite(T.y)?T.y:0,P=Number.isFinite(T.scaleX)?T.scaleX:1,U=Number.isFinite(T.scaleY)?T.scaleY:1,S=Number.isFinite(T.rotation)?T.rotation:0,M=Math.cos(S),D=Math.sin(S);function f(e,t){let a=e-F,r=t-_;return a*=P,r*=U,{x:F+(a*M-r*D)+B,y:_+(a*D+r*M)+I}}const C=f(w,A),N=f(w+R,A),O=f(w,A+L),k=f(w+R,A+L);u(T.texture,C,N,O,k,Number(T.opacity)||1)}const h=new Uint8Array(t*a*4);gl.readPixels(0,0,t,a,gl.RGBA,gl.UNSIGNED_BYTE,h);const y=new Uint8ClampedArray(t*a*4),p=4*t;for(let X=0;X<a;X++){const W=X*p,H=(a-1-X)*p;y.set(h.subarray(W,W+p),H)}const E=document.createElement("canvas");E.width=t,E.height=a;E.getContext("2d").putImageData(new ImageData(y,t,a),0,0);const v=e?"_with_background":"_transparent",b=`canvas_${Date.now()}${v}.png`;E.toBlob(e=>{if(!e)return void ve?.("Export failed.","error");const t=document.createElement("a");t.download=b,t.href=URL.createObjectURL(e),document.body.appendChild(t),t.click(),URL.revokeObjectURL(t.href),t.remove()},"image/png",.92),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.disableVertexAttribArray(d),gl.disableVertexAttribArray(g),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(c),m&&gl.deleteTexture(m),gl.deleteFramebuffer(n),gl.deleteTexture(r)}function y(){document.getElementById("shareOptionsModal").style.display="none"}function p(e){b(e).toBlob(async t=>{if(!t)return void ve("Error generating artwork.","error");const a=new File([t],`artwork${e?"_with_background":"_transparent"}.png`,{type:"image/png"});if(navigator.canShare&&navigator.canShare({files:[a]}))try{await navigator.share({title:"Artwork",text:"Check out my artwork!",files:[a]})}catch{ve("Error sharing artwork.","error")}else ve("Sharing not supported on this device.","error")},"image/png")}/iPad|iPhone|iPod/.test(navigator.userAgent)&&u?.removeAttribute("capture"),g?.addEventListener("click",()=>u?.click()),u?.addEventListener("change",async e=>{const t=e.target.files?.[0];if(!t)return;const a=new Image;a.onload=async()=>{fixedFBOWidth&&fixedFBOHeight||(fixedFBOWidth=a.width,fixedFBOHeight=a.height,initPaintLayerFixed?.(),updateCanvasSize({width:a.width,height:a.height}),needsRedraw=!0);const{texture:e,fbo:r}=createLayerFBO(fixedFBOWidth,fixedFBOHeight),n={id:Date.now()+Math.random(),name:(t.name||"Imported").replace(/\.[^.]+$/,""),fbo:r,texture:e,visible:!0,opacity:1,x:0,y:0,scaleX:1,scaleY:1,rotation:0,px:.5*fixedFBOWidth,py:.5*fixedFBOHeight,history:[],redo:[]},o=Math.max(0,Math.min(activeLayerIndex,layers.length));layers.splice(o,0,n),activeLayerIndex=o,await async function(e,t){const a=fixedFBOWidth,r=fixedFBOHeight,n=a/e.width,o=r/e.height,i=Math.min(n,o,1),l=Math.round(e.width*i),s=Math.round(e.height*i),c=Math.floor((a-l)/2),d=Math.floor((r-s)/2),g=document.createElement("canvas");g.width=a,g.height=r;const u=g.getContext("2d");u.clearRect(0,0,a,r),u.imageSmoothingEnabled=!0,u.imageSmoothingQuality="high",u.drawImage(e,0,0,e.width,e.height,c,d,l,s);const m=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,m),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!1),gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,g),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindFramebuffer(gl.FRAMEBUFFER,t),gl.viewport(0,0,a,r),gl.disable(gl.BLEND),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);const f=gl.getUniformLocation(quadProgram,"u_flipY");f&&gl.uniform1f(f,1);const h=gl.getUniformLocation(quadProgram,"u_resolution");h&&gl.uniform2f(h,a,r);const y=gl.getUniformLocation(quadProgram,"u_layerOpacity");y&&gl.uniform1f(y,1);const p=new Float32Array([0,0,0,0,a,0,1,0,0,r,0,1,0,r,0,1,a,0,1,0,a,r,1,1]),E=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,E),gl.bufferData(gl.ARRAY_BUFFER,p,gl.STATIC_DRAW);const v=gl.getAttribLocation(quadProgram,"a_position"),b=gl.getAttribLocation(quadProgram,"a_texCoord");gl.enableVertexAttribArray(v),gl.vertexAttribPointer(v,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(b),gl.vertexAttribPointer(b,2,gl.FLOAT,!1,16,8),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,m);const x=gl.getUniformLocation(quadProgram,"u_texture");x&&gl.uniform1i(x,0),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(v),gl.disableVertexAttribArray(b),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(E),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null),gl.deleteTexture(m),needsRedraw=!0}(a,r),syncActiveAliases?.(),rebuildLayersUI?.(),needsRedraw=!0,ve?.("Imported image as new layer.","success")},a.src=URL.createObjectURL(t),e.target.value=""}),m?.addEventListener("click",()=>{const e=layers?.[activeLayerIndex];if(!e)return void ve?.("No active layer to export.","error");const t=fixedFBOWidth,a=fixedFBOHeight,r=document.createElement("canvas");r.width=t,r.height=a;r.getContext("2d").putImageData(c(e.fbo,t,a),0,0);const n=document.createElement("canvas");n.width=t,n.height=a;const o=n.getContext("2d");o.save(),o.translate(t/2,a/2),o.scale(-1,-1),o.rotate(Math.PI),o.drawImage(r,-t/2,-a/2),o.restore();const i=document.createElement("a");i.download=`${(e.name||"Layer").replace(/\s+/g,"_")}.png`,i.href=n.toDataURL("image/png"),document.body.appendChild(i),i.click(),i.remove(),ve?.("Active layer exported.","success")}),document.getElementById("saveCanvasAsIcoButton").addEventListener("click",function(){const e=b(!0),t=document.createElement("canvas");t.width=64,t.height=64,t.getContext("2d").drawImage(e,0,0,64,64),t.toBlob(e=>{if(!e)return void ve("ICO export failed.","error");const t=new FileReader;t.onloadend=()=>{const e=function(e,t){const a=new Uint8Array([0,0,1,0,1,0]),r=new Uint8Array(16);r.set([t,t,0,0,1,0,32,0]);const n=e.byteLength,o=a.length+r.length,i=new DataView(r.buffer);i.setUint32(8,n,!0),i.setUint32(12,o,!0);const l=a.length+r.length+n,s=new Uint8Array(l);return s.set(a,0),s.set(r,a.length),s.set(new Uint8Array(e),o),s.buffer}(t.result,64),a=new Blob([e],{type:"image/x-icon"}),r=document.createElement("a");r.href=URL.createObjectURL(a),r.download="favicon.ico",document.body.appendChild(r),r.click(),document.body.removeChild(r)},t.readAsArrayBuffer(e)},"image/png")}),document.getElementById("exportModalClose").addEventListener("click",f),document.getElementById("exportWithBackgroundBtn").addEventListener("click",function(){f(),h(!0)}),document.getElementById("exportTransparentBtn").addEventListener("click",function(){f(),h(!1)}),document.getElementById("saveCanvasButton").addEventListener("click",function(){document.getElementById("exportOptionsModal").style.display="flex"}),document.getElementById("shareButton").addEventListener("click",function(){document.getElementById("shareOptionsModal").style.display="flex"}),document.getElementById("shareModalClose").addEventListener("click",y),document.getElementById("shareWithBackgroundBtn").addEventListener("click",function(){y(),p(!0)}),document.getElementById("shareTransparentBtn").addEventListener("click",function(){y(),p(!1)});let E=!1,v=null;function b(e=!1){const t=0|fixedFBOWidth,a=0|fixedFBOHeight,r=e?0|canvas.width:t,n=e?0|canvas.height:a,o=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,o),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,r,n,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);const i=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,i),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,o,0);if(!(gl.checkFramebufferStatus(gl.FRAMEBUFFER)===gl.FRAMEBUFFER_COMPLETE))return gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.deleteFramebuffer(i),gl.deleteTexture(o),null;gl.viewport(0,0,r,n),gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.SCISSOR_TEST),gl.enable(gl.BLEND),gl.blendFuncSeparate(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA,gl.ONE,gl.ONE_MINUS_SRC_ALPHA),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);const l=gl.getUniformLocation(quadProgram,"u_flipY"),s=gl.getUniformLocation(quadProgram,"u_resolution"),c=gl.getUniformLocation(quadProgram,"u_layerOpacity"),d=gl.getUniformLocation(quadProgram,"u_texture")||gl.getUniformLocation(quadProgram,"u_image");l&&gl.uniform1f(l,-1),s&&gl.uniform2f(s,r,n);const g=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,g);const u=gl.getAttribLocation(quadProgram,"a_position"),m=gl.getAttribLocation(quadProgram,"a_texCoord");function f(e,t,a,r,n,o){const i=new Float32Array([t.x,t.y,0,0,a.x,a.y,1,0,r.x,r.y,0,1,r.x,r.y,0,1,a.x,a.y,1,0,n.x,n.y,1,1]);gl.bufferData(gl.ARRAY_BUFFER,i,gl.STREAM_DRAW),c&&gl.uniform1f(c,Math.max(0,Math.min(1,o))),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,e),d&&gl.uniform1i(d,0),gl.drawArrays(gl.TRIANGLES,0,6)}gl.enableVertexAttribArray(u),gl.vertexAttribPointer(u,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(m),gl.vertexAttribPointer(m,2,gl.FLOAT,!1,16,8);const h=.5*r,y=.5*n,p=zoomScale||1,E=viewRotation||0,v=Math.cos(E),b=Math.sin(E);function x(r,n){if(!e)return{x:r,y:n};return{x:panX+h+((r-=.5*t)*p*v-(n-=.5*a)*p*b),y:panY+y+(r*p*b+n*p*v)}}if(currentImage){const F=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,F),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!1),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,currentImage),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);f(F,x(0,0),x(t,0),x(0,a),x(t,a),1),gl.deleteTexture(F)}for(let _=0;_<layers.length;_++){const B=layers[_];if(!B||!1===B.visible||(B.opacity??1)<=0||!B.texture)continue;const I=Number.isFinite(B.ox)?B.ox:0,P=Number.isFinite(B.oy)?B.oy:0,U=Math.max(1,0|(Number(B.texW)||t)),S=Math.max(1,0|(Number(B.texH)||a)),M=Number.isFinite(B.px)?B.px:.5*t,D=Number.isFinite(B.py)?B.py:.5*a,C=Number.isFinite(B.x)?B.x:0,N=Number.isFinite(B.y)?B.y:0,O=Number.isFinite(B.scaleX)?B.scaleX:1,k=Number.isFinite(B.scaleY)?B.scaleY:1,X=Number.isFinite(B.rotation)?B.rotation:0,W=Math.cos(X),H=Math.sin(X);function T(t,a){let r=t-M,n=a-D;r*=O,n*=k;const o=M+(r*W-n*H)+C,i=D+(r*H+n*W)+N;return e?x(o,i):{x:o,y:i}}const Y=T(I,P),G=T(I+U,P),q=T(I,P+S),z=T(I+U,P+S);f(B.texture,Y,G,q,z,Number(B.opacity)||1)}const w=new Uint8Array(r*n*4);gl.readPixels(0,0,r,n,gl.RGBA,gl.UNSIGNED_BYTE,w);const A=new Uint8ClampedArray(w.length),R=4*r;for(let V=0;V<n;V++){const $=V*R,j=(n-1-V)*R;A.set(w.subarray($,$+R),j)}const L=document.createElement("canvas");L.width=r,L.height=n;return L.getContext("2d").putImageData(new ImageData(A,r,n),0,0),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.disableVertexAttribArray(u),gl.disableVertexAttribArray(m),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(g),gl.deleteFramebuffer(i),gl.deleteTexture(o),L}function x(e,t="image/webp",a=.75){return new Promise(r=>{e.toBlob(e=>r(e),t,a)})}async function T(){const t=(await a()).transaction(e,"readonly").objectStore(e).getAll();t.onsuccess=()=>{const r=t.result;r.sort((e,t)=>new Date(t.date)-new Date(e.date));const n=document.getElementById("gallery");n.innerHTML=r.length?"":"<p>No saved artworks</p>",r.forEach(t=>{const r=document.createElement("div");r.classList.add("gallery-item");const o=document.createElement("img");o.src=t.thumbnail||"",o.alt=t.name,r.appendChild(o);const i=document.createElement("p");i.textContent=t.name,r.appendChild(i);const s=document.createElement("button");s.classList.add("delete-button"),s.style.display=E?"block":"none",s.innerHTML='\n                <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" stroke-width="1.5" fill="none">\n                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"\n                          d="M19 11v9.4a.6.6 0 0 1-.6.6H5.6a.6.6 0 0 1-.6-.6V11M10 17v-6M14 17v-6M21 7h-5M3 7h5m0 0V3.6a.6.6 0 0 1 .6-.6h6.8a.6.6 0 0 1 .6.6V7M8 7h8" />\n                </svg>\n            ',s.addEventListener("click",e=>{e.stopPropagation(),v=t.id,document.getElementById("deleteConfirmModal").style.display="flex"}),r.appendChild(s),r.addEventListener("click",()=>{E||async function(t){const r=(await a()).transaction(e,"readonly").objectStore(e).get(t);r.onsuccess=async()=>{const e=r.result;e?await l(e):ve("Artwork not found.","error")},r.onerror=()=>{console.error("Failed to load artwork from IndexedDB."),ve("Failed to load artwork.","error")}}(t.id)}),n.appendChild(r)})},t.onerror=()=>console.error("Failed to load gallery.")}document.getElementById("galleryEditButton").addEventListener("click",()=>{E=!E,document.querySelectorAll(".gallery-item .delete-button").forEach(e=>{e.style.display=E?"block":"none"}),document.getElementById("galleryEditButton").textContent=E?"Done":"Edit"}),document.getElementById("confirmDeleteButton").addEventListener("click",async()=>{if(null!==v){const t=(await a()).transaction(e,"readwrite");t.objectStore(e).delete(v),t.oncomplete=()=>{ve("Artwork deleted!","success"),v=null,document.getElementById("deleteConfirmModal").style.display="none",T()},t.onerror=()=>{console.error("Failed to delete artwork."),ve("Error deleting artwork.","error")}}}),document.getElementById("cancelDeleteButton").addEventListener("click",()=>{v=null,document.getElementById("deleteConfirmModal").style.display="none"});const w=document.getElementById("profileModal"),A=document.getElementById("profileIconButton"),R=document.getElementById("saveProfileButton"),L=document.getElementById("profileImageInput"),F=document.getElementById("profileImagePreview"),_=document.getElementById("drawProfileButton");function B(){const e=JSON.parse(localStorage.getItem("userProfile"))||{};if(e.image){F.style.backgroundImage=`url('${e.image}')`;const t=document.querySelector("#profileIconButton img");t&&(t.src=e.image)}else{F.style.backgroundImage="url('/static/draw/images/icons/cat.svg')";const e=document.querySelector("#profileIconButton img");e&&(e.src="/static/draw/images/icons/cat.svg")}document.getElementById("profileNickname").value=e.nickname||"",document.getElementById("profileEmail").value=e.email||"",document.getElementById("profileBio").value=e.bio||""}function I(e){e.style.display="flex";const t=e.querySelector(".close");t&&!t.dataset.listenerAdded&&(t.addEventListener("click",()=>P(e)),t.dataset.listenerAdded="true")}function P(e){e.style.display="none"}B(),A.addEventListener("click",()=>{B(),I(w)}),R.addEventListener("click",function(){const e=F.style.backgroundImage.match(/url\(["']?(.*?)["']?\)/),t={image:e?e[1]:null,nickname:document.getElementById("profileNickname").value,email:document.getElementById("profileEmail").value,bio:document.getElementById("profileBio").value};localStorage.setItem("userProfile",JSON.stringify(t)),H=t.nickname?.trim()||"",$(),ve("Profile saved!","success"),P(w)}),F.addEventListener("click",()=>{L.click()}),L.addEventListener("change",t=>{const r=t.target.files[0];if(r){const t=new FileReader;t.onload=()=>{const r=t.result;F.style.backgroundImage=`url('${r}')`;const n={image:r,nickname:document.getElementById("profileNickname").value,email:document.getElementById("profileEmail").value,bio:document.getElementById("profileBio").value};localStorage.setItem("userProfile",JSON.stringify(n));const o=document.querySelector("#profileIconButton img");o&&(o.src=r),fetch(r).then(e=>e.blob()).then(t=>{const n={id:Date.now(),name:"Profile",date:(new Date).toISOString(),username:"User",appName:"Web Paint",image:t,thumbnail:r};a().then(t=>{t.transaction(e,"readwrite").objectStore(e).put(n),ve("Profile image saved to gallery!","success")})})},t.readAsDataURL(r)}}),_.addEventListener("click",()=>{try{const t=b(!0);if(!t)return void ve?.("Profile export unavailable.","error");const r=t.width,n=t.height,o=Math.min(r,n),i=(r-o)/2|0,l=(n-o)/2|0,s=document.createElement("canvas");s.width=o,s.height=o;s.getContext("2d").drawImage(t,i,l,o,o,0,0,o,o);const c=s.toDataURL("image/png");F.style.backgroundImage=`url('${c}')`;const d=document.querySelector("#profileIconButton img");d&&(d.src=c);const g={image:c,nickname:document.getElementById("profileNickname").value,email:document.getElementById("profileEmail").value,bio:document.getElementById("profileBio").value};try{localStorage.setItem("userProfile",JSON.stringify(g))}catch{}s.toBlob(t=>{if(!t)return void ve?.("Profile save failed.","error");const r={id:Date.now(),name:"Profile",date:(new Date).toISOString(),username:"User",appName:"Web Paint",image:t,thumbnail:c};a().then(t=>{t.transaction(e,"readwrite").objectStore(e).put(r),ve?.("Profile image saved.","success")}).catch(e=>{console.error("[Profile] gallery save error",e),ve?.("Saved preview; gallery write failed.","warning")})},"image/png")}catch(e){console.error("[Profile] compose/save failed",e),ve?.("Profile export failed.","error")}});const U=document.getElementById("chatToggleBtn"),S=document.getElementById("chatOverlay"),M=document.getElementById("chatCloseBtn"),D=document.getElementById("chatSendBtn"),C=document.getElementById("chatInput"),N=document.getElementById("chatMessages");U.addEventListener("click",()=>{S.classList.remove("hidden")}),M.addEventListener("click",()=>{S.classList.add("hidden")});let O=null,k=null,X=null,W=JSON.parse(localStorage.getItem("userProfile"))||{},H=W.nickname?.trim()||"",Y=W.image||"";const G=new Map;function q(e){U.style.borderColor=e?"limegreen":"red"}let z=null,V=0;function $(){O&&O.readyState===WebSocket.OPEN&&(W=JSON.parse(localStorage.getItem("userProfile"))||{},H=W.nickname?.trim()||"",Y=W.image||"",O.send(JSON.stringify({type:"set-nickname",nickname:H,profileImage:Y})))}function j(){const e=document.getElementById("chatUsers"),t=document.getElementById("chatUserBadge");e.innerHTML="",G.forEach((t,a)=>{const r=document.createElement("div");r.className="chat-user-item";const n=document.createElement("img");n.className="chat-user-avatar";t.profileImage&&t.profileImage.startsWith("data:")||t.profileImage&&""!==t.profileImage?n.src=t.profileImage:n.src="/static/draw/images/icons/cat.svg";const o=document.createElement("span");o.className="chat-user-name",o.textContent=t.nickname||"Unknown",r.appendChild(n),r.appendChild(o),e.appendChild(r)});const a=G.size;t&&(t.textContent=a,t.style.display=a>0?"flex":"none")}function K(){const e=C.value.trim();if(e&&O&&O.readyState===WebSocket.OPEN){const t={type:"text",clientId:k,message:e,timestamp:Date.now()};O.send(JSON.stringify(t)),C.value="",J(t,"sent")}}function J(e,t){const a=G.get(e.clientId)||{},r=a.nickname||"Unknown",n=a.profileImage?`<img src="${a.profileImage}" class="chat-avatar">`:"",o=Z(e.clientId),i=new Date(e.timestamp||Date.now()),l=`${String(i.getHours()).padStart(2,"0")}:${String(i.getMinutes()).padStart(2,"0")}:${String(i.getSeconds()).padStart(2,"0")}`,s=document.createElement("div");if("system"===t)s.textContent=`*** ${e.message} ***`,s.className="chat-message system";else{s.className=`chat-message ${t}`,s.style.backgroundColor="received"===t?o:"";const a=marked.parse(e.message),i=DOMPurify.sanitize(a,{ADD_TAGS:["pre","code"],ADD_ATTR:["class"]});s.innerHTML=`\n            <div class="chat-timestamp">${l}</div>\n            <div class="chat-message-header">\n                ${n}\n                <span class="chat-sender-name">${r}</span>\n            </div>\n            <div class="chat-message-body">${i}</div>\n        `,s.querySelectorAll("pre code").forEach(e=>{hljs.highlightElement(e)})}N.prepend(s)}function Z(e){let t=0;for(let a=0;a<e.length;a++)t=e.charCodeAt(a)+((t<<5)-t);return`hsl(${t%360}, 70%, 80%)`}!function e(){O&&(O.onopen=O.onmessage=O.onerror=O.onclose=null,O=null);let t="";if("localhost"===location.hostname||"127.0.0.1"===location.hostname||location.hostname.startsWith("172.")||location.hostname.startsWith("192.168.")){const e=3001;t=`${"https:"===location.protocol?"wss":"ws"}://${location.hostname}:${e}`}else{t=`${"https:"===location.protocol?"wss":"ws"}://${location.host}/chat-ws/`}O=new WebSocket(t),O.onopen=()=>{q(!0),X&&(clearTimeout(X),X=null),V=Date.now(),z&&clearInterval(z),z=setInterval(()=>{if(O.readyState===WebSocket.OPEN){O.send(JSON.stringify({type:"ping",timestamp:Date.now()}));Date.now()-V>1e4&&(console.warn("[WebSocket] Pong timeout — force reconnect"),O.close())}},3e3),$()},O.onmessage=e=>{try{let t=e.data;t.startsWith("[User] ")&&(t=t.substring(7));const a=JSON.parse(t);if("welcome"===a.type)return k=a.clientId,void j();if("profile-update"===a.type)return G.set(a.clientId,{nickname:a.nickname,profileImage:a.profileImage}),void j();if("user-list"===a.type)return G.clear(),a.users.forEach(e=>{G.set(e.clientId,{nickname:e.nickname,profileImage:e.profileImage})}),void j();if("pong"===a.type)return void(V=Date.now());if("text"===a.type){const e=a.clientId===k;return void J(a,e?"sent":"received")}if("image"===a.type){const e=G.get(a.clientId)||{},t=e.nickname||"Unknown",r=e.profileImage?`<img src="${e.profileImage}" class="chat-avatar">`:"",n=Z(a.clientId),o=document.createElement("div");return o.className="chat-message received",o.style.backgroundColor=n,o.innerHTML=`\n                ${r} \n                <div class="chat-text">\n                    <div>[${t}]: posted artwork</div>\n                    <img src="${a.imageData}" alt="${a.imageName}" style="max-width: 220px; max-height: 320px; margin-top: 5px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">\n                </div>\n            `,void N.prepend(o)}if("system"===a.type){return void J({clientId:"",message:a.message,timestamp:a.timestamp},"system")}}catch(t){console.error("[WebSocket] Invalid message format",e.data)}},O.onclose=()=>{q(!1),z&&(clearInterval(z),z=null),X&&clearTimeout(X),X=setTimeout(e,3e3)},O.onerror=e=>{console.error("[WebSocket] Error:",e)}}(),D.addEventListener("click",K),C.addEventListener("keypress",e=>{"Enter"===e.key&&(e.preventDefault(),K())}),marked.setOptions({breaks:!0,gfm:!0,headerIds:!1,mangle:!1,sanitize:!1}),document.getElementById("sendToChatButton").addEventListener("click",()=>{!function(e="Untitled",t={}){const{size:a=1024,quality:r=.75,format:n="image/webp",includeBackground:o=!0,glFlipY:i=!0}=t;try{console.log("[sendCurrentArtworkToChat] start");let t=null;t=b(o),console.log("[sendCurrentArtworkToChat] Using composeToCanvas() flatten");const i=1===a?Math.max(t.width,t.height):Math.max(1,Math.round(a)),l=Math.min(1,i/Math.max(t.width,t.height)),s=Math.max(1,Math.round(t.width*l)),c=Math.max(1,Math.round(t.height*l)),d=document.createElement("canvas");d.width=s,d.height=c,d.getContext("2d").drawImage(t,0,0,s,c);const g=t.width*t.height*4;console.log(`[sendCurrentArtworkToChat] Raw RGBA ~${Math.round(g/1024)} KB`);const u=n,m=r;d.toBlob(t=>{if(!t)return console.error("[sendCurrentArtworkToChat] ERROR: Failed to generate blob."),void ve("Error sending artwork to chat.","error");console.log(`[sendCurrentArtworkToChat] Blob ${u}, ${Math.round(t.size/1024)} KB`);const a=new FileReader;a.onloadend=()=>{const t=a.result;if(O&&O.readyState===WebSocket.OPEN){const a=JSON.parse(localStorage.getItem("userProfile"))||{},r=a.nickname?.trim()||"",n=a.image||"",o={type:"image",clientId:k,nickname:r,profileImage:n,imageData:t,imageName:e,timestamp:Date.now()};O.send(JSON.stringify(o)),console.log("[sendCurrentArtworkToChat] Artwork sent to chat."),ve("Send to Chat","info")}},a.readAsDataURL(t)},u,m)}catch(e){console.error("[sendCurrentArtworkToChat] CATCH ERROR:",e),ve("Error sending artwork to chat.","error")}}("Quick Share")});const Q=document.getElementById("brushSizeToggle"),ee=document.getElementById("brushSizeSliderContainer");let te="true"===localStorage.getItem("brushSizeToggleMinimized");function ae(){if(ee.dataset.minimized=te?"true":"false",ee.classList.remove("brush-panel-visible","brush-panel-hidden"),te){ee.classList.add("brush-panel-hidden"),Q.innerHTML='<img class="show-icon" src="/static/draw/images/icons/hide.svg" alt="Show">';const e=ee.getBoundingClientRect(),t=window.innerWidth,a=window.innerHeight;(e.left<0||e.top<0||e.left>t-40||e.top>a-40)&&(ee.style.left="10px",ee.style.top="10px")}else ee.classList.add("brush-panel-visible"),Q.innerHTML='<img class="show-icon" src="/static/draw/images/icons/show.svg" alt="Hide">'}ae(),Q.addEventListener("click",()=>{te=!te,localStorage.setItem("brushSizeToggleMinimized",te),ae()}),ae();const re=document.getElementById("brushContainerToggle"),ne=document.getElementById("brushContainer");let oe="true"===localStorage.getItem("brushContainerMinimized");function ie(){ne.querySelectorAll(".brush-thumbnail").forEach(e=>{e.style.display=oe?"none":"inline-block"}),re.innerHTML=oe?'<img class="show-icon" src="/static/draw/images/icons/hide.svg" alt="Show">':'<img class="show-icon" src="/static/draw/images/icons/show.svg" alt="Hide">'}re.addEventListener("click",()=>{oe=!oe,localStorage.setItem("brushContainerMinimized",oe),ie()}),ie();const le=document.getElementById("brushSizeSliderContainer"),se=document.getElementById("brushSizeDragBar");let ce=0,de=0,ge=!1;se.addEventListener("pointerdown",e=>{ge=!0,ce=e.clientX-le.offsetLeft,de=e.clientY-le.offsetTop;try{se.setPointerCapture(e.pointerId)}catch{}se.style.cursor="grabbing"}),se.addEventListener("pointermove",e=>{if(!ge)return;const t=e.clientX-ce,a=e.clientY-de,r=window.visualViewport&&window.visualViewport.width||window.innerWidth,n=window.visualViewport&&window.visualViewport.height||window.innerHeight,o=le.getBoundingClientRect(),i=Math.min(Math.max(t,0),r-o.width),l=Math.min(Math.max(a,0),n-o.height);le.style.left=`${i}px`,le.style.top=`${l}px`,le.style.bottom="auto"}),se.addEventListener("pointerup",e=>{ge=!1;try{se.releasePointerCapture(e.pointerId)}catch{}se.style.cursor="grab";const t=window.visualViewport&&window.visualViewport.width||window.innerWidth,a=window.visualViewport&&window.visualViewport.height||window.innerHeight,r=le.getBoundingClientRect(),n=Math.min(Math.max(le.offsetLeft,0),t-r.width),o=Math.min(Math.max(le.offsetTop,0),a-r.height);le.style.left=`${n}px`,le.style.top=`${o}px`}),se.addEventListener("pointercancel",()=>{ge=!1,se.style.cursor="grab"});const ue=document.getElementById("brushContainerWrapper"),me=document.getElementById("brushContainerDragBar");let fe=0,he=0,ye=!1;me.addEventListener("pointerdown",e=>{ye=!0,fe=e.clientX-ue.offsetLeft,he=e.clientY-ue.offsetTop;try{me.setPointerCapture(e.pointerId)}catch{}me.style.cursor="grabbing"}),me.addEventListener("pointermove",e=>{if(!ye)return;const t=e.clientX-fe,a=e.clientY-he,r=window.visualViewport&&window.visualViewport.width||window.innerWidth,n=window.visualViewport&&window.visualViewport.height||window.innerHeight,o=ue.getBoundingClientRect(),i=Math.min(Math.max(t,0),r-o.width),l=Math.min(Math.max(a,0),n-o.height);ue.style.left=`${i}px`,ue.style.top=`${l}px`}),me.addEventListener("pointerup",e=>{ye=!1;try{me.releasePointerCapture(e.pointerId)}catch{}me.style.cursor="grab";const t=window.visualViewport&&window.visualViewport.width||window.innerWidth,a=window.visualViewport&&window.visualViewport.height||window.innerHeight,r=ue.getBoundingClientRect(),n=Math.min(Math.max(ue.offsetLeft,0),t-r.width),o=Math.min(Math.max(ue.offsetTop,0),a-r.height);ue.style.left=`${n}px`,ue.style.top=`${o}px`}),me.addEventListener("pointercancel",()=>{ye=!1,me.style.cursor="grab"});const pe=document.getElementById("menuButton"),Ee=document.querySelector("#saveGalleryButtons .menuButtons");function ve(e,t="info"){console.log("showStatusMessage",e);const a=document.createElement("div");a.classList.add("status-message",t),a.innerText=e,document.body.appendChild(a),setTimeout(()=>{a.classList.add("fade-out"),setTimeout(()=>a.remove(),700)},700)}function I(e){e.style.display="flex",setTimeout(()=>{const t=e.querySelector(".close");t&&!t.dataset.listenerAdded&&(t.addEventListener("click",()=>P(e)),t.dataset.listenerAdded="true")},0)}function P(e){e.style.display="none"}Ee.style.display="none",pe.addEventListener("click",()=>{"none"===Ee.style.display?Ee.style.display="flex":Ee.style.display="none"});const be=document.getElementById("saveModal"),xe=document.getElementById("galleryModal"),Te=document.getElementById("saveButton"),we=document.getElementById("galleryButton"),Ae=document.getElementById("confirmSave");function Re({fit:e=!0}={}){const t=canvasWrapper.getBoundingClientRect(),a=canvas.width,r=canvas.height,n=Math.min(t.width/a,t.height/r,zoomMax),o=e?Math.max(zoomMin,n):1,i=canvas.style.transition;canvas.style.transition="transform 140ms ease-out",zoomScale=o,centerCanvasInWrapper(),setTimeout(()=>{canvas.style.transition=i},160),resetStrokeState(),needsRedraw=!0}Te&&Te.addEventListener("click",()=>I(be)),we&&we.addEventListener("click",()=>{I(xe),T()}),Ae&&Ae.addEventListener("click",()=>{const e=document.getElementById("artworkName");r(e?e.value:""),P(be)});document.getElementById("resetViewBtn").addEventListener("click",()=>{Re({fit:!0}),document.activeElement&&"function"==typeof document.activeElement.blur&&document.activeElement.blur();const e=document.querySelector('meta[name="viewport"]');if(e){const t=e.getAttribute("content")||"width=device-width, initial-scale=1",a=t.replace(/,\s*maximum-scale=[^,]+/i,"");e.setAttribute("content",`${a}, maximum-scale=1`),setTimeout(()=>e.setAttribute("content",t),80)}}),document.addEventListener("keydown",e=>{isUserTyping()||"0"===e.key&&Re({fit:!0})})}),document.getElementById("cleanButton").addEventListener("click",()=>clearCanvas(!0)),document.getElementById("artworkName").addEventListener("keydown",function(e){"Enter"===e.key&&(e.preventDefault(),document.getElementById("saveNewButton").click())});const uiElements=[{id:"brushContainerWrapper",display:"flex"},{id:"brushSizeSliderContainer",display:"flex"},{id:"redoUndoButtons",display:"flex"},{id:"colorsContainer",display:"block"},{id:"saveGalleryButtons",display:"block"},{id:"profileSection",display:"block"},{id:"chatToggleBtn",display:"flex"},{id:"layersPanel",display:"block"}],fadeOutUI=()=>{uiElements.forEach(e=>{const t=document.getElementById(e.id);t&&(t.style.opacity="0",setTimeout(()=>{t.style.display="none"},250))})},fadeInUI=()=>{uiElements.forEach(e=>{const t=document.getElementById(e.id);t&&(t.style.display=e.display,setTimeout(()=>{t.style.opacity="1"},10))})};let uiTimeout=null;const uiTimeoutInterval=500,resetUITimeout=()=>{uiTimeout&&clearTimeout(uiTimeout),uiTimeout=setTimeout(fadeInUI,500)};let uiHidden=!1,hideStart=null;const HIDE_MOVE_THRESHOLD=6;function getCanvasPosFromEvent(e){const t=canvas.getBoundingClientRect(),a="touches"in e?e.touches[0]:e;return{x:(a.clientX-t.left)*(canvas.width/t.width),y:(a.clientY-t.top)*(canvas.height/t.height)}}function maybeHideUIOnMove(e){if(!isDrawing||uiHidden||!hideStart)return;const t=getCanvasPosFromEvent("touches"in e?e.touches[0]:e),a=t.x-hideStart.x,r=t.y-hideStart.y;Math.hypot(a,r)>=6&&(fadeOutUI(),uiTimeout&&clearTimeout(uiTimeout),uiHidden=!0)}function endStrokeUIReset(){uiHidden&&resetUITimeout(),hideStart=null,uiHidden=!1}canvas.addEventListener("mousedown",e=>{"fill"!==currentTool&&(hideStart=getCanvasPosFromEvent(e),uiHidden=!1)}),canvas.addEventListener("touchstart",e=>{isTwoFingerGesture||"fill"!==currentTool&&(hideStart=getCanvasPosFromEvent(e),uiHidden=!1)},{passive:!1}),canvas.addEventListener("mousemove",maybeHideUIOnMove,{passive:!0}),canvas.addEventListener("touchmove",e=>{isTwoFingerGesture||maybeHideUIOnMove(e)},{passive:!1}),canvas.addEventListener("mouseup",endStrokeUIReset),canvas.addEventListener("touchend",endStrokeUIReset),canvas.addEventListener("mouseleave",endStrokeUIReset),window.addEventListener("blur",resetUITimeout),window.addEventListener("focus",fadeInUI),document.getElementById("footer").innerHTML=document.title;const panels=[{id:"brushSizeSliderContainer",dragBarId:"brushSizeDragBar"},{id:"brushContainerWrapper",dragBarId:"brushContainerDragBar"}];function exportCanvasToImage(){const e=document.getElementById("glCanvas");return e?e.toDataURL("image/png"):(alert("Canvas not found!"),null)}function sendCanvasToFlaskForAI(){const e=exportCanvasToImage();e&&fetch("/run_ai_inference",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image_data:e})}).then(e=>e.blob()).then(e=>{const t=URL.createObjectURL(e),a=document.createElement("img");a.src=t,a.style.position="fixed",a.style.bottom="10px",a.style.right="10px",a.style.border="2px solid #ccc",a.style.maxWidth="200px",a.style.zIndex=9999,document.body.appendChild(a)}).catch(e=>{console.error("Error during AI request:",e),alert("AI request failed.")})}async function pasteImageFromClipboard(e){console.log("[Clipboard] pasteImageFromClipboard start");try{let t=null;if(e&&e.clipboardData&&e.clipboardData.items&&e.clipboardData.items.length)for(let a=0;a<e.clipboardData.items.length;a++){const r=e.clipboardData.items[a];if(r&&r.type&&r.type.startsWith("image/")){t=r.getAsFile?r.getAsFile():null;break}}if(!t&&navigator.clipboard&&navigator.clipboard.read)try{const e=await navigator.clipboard.read();for(const a of e){for(const e of a.types)if(e.startsWith("image/")){t=await a.getType(e);break}if(t)break}}catch(e){console.warn("[Clipboard] navigator.clipboard.read not permitted",e)}if(!t)return void showStatusMessage?.("Clipboard has no image data.","error");const a=await new Promise((e,a)=>{const r=URL.createObjectURL(t),n=new Image;n.onload=()=>{URL.revokeObjectURL(r),e(n)},n.onerror=e=>{URL.revokeObjectURL(r),a(e)},n.src=r});fixedFBOWidth&&fixedFBOHeight||(fixedFBOWidth=a.width,fixedFBOHeight=a.height,"function"==typeof initPaintLayerFixed&&initPaintLayerFixed(),"function"==typeof updateCanvasSize&&updateCanvasSize({width:a.width,height:a.height}),needsRedraw=!0);const r=layers&&Number.isInteger(activeLayerIndex)?layers[activeLayerIndex]:null;if(!r||!r.fbo)return void showStatusMessage?.("No active layer to paste into.","error");const n=fixedFBOWidth,o=fixedFBOHeight;!function(e,t,a,r){const n=a/e.width,o=r/e.height,i=Math.min(n,o,1),l=Math.max(1,Math.round(e.width*i)),s=Math.max(1,Math.round(e.height*i)),c=Math.floor((a-l)/2),d=Math.floor((r-s)/2),g=document.createElement("canvas");g.width=a,g.height=r;const u=g.getContext("2d");u.clearRect(0,0,a,r),u.imageSmoothingEnabled=!0,u.imageSmoothingQuality="high",u.drawImage(e,0,0,e.width,e.height,c,d,l,s);const m=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,m),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!1),gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,g),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindFramebuffer(gl.FRAMEBUFFER,t);const f=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(f!==gl.FRAMEBUFFER_COMPLETE)return console.warn("[Clipboard] FBO incomplete:",f),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null),void gl.deleteTexture(m);gl.viewport(0,0,a,r),gl.disable(gl.BLEND),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.useProgram(quadProgram);const h=gl.getUniformLocation(quadProgram,"u_flipY");null!==h&&gl.uniform1f(h,1);const y=gl.getUniformLocation(quadProgram,"u_resolution");null!==y&&gl.uniform2f(y,a,r);const p=gl.getUniformLocation(quadProgram,"u_layerOpacity");null!==p&&gl.uniform1f(p,1);const E=new Float32Array([0,0,0,0,a,0,1,0,0,r,0,1,0,r,0,1,a,0,1,0,a,r,1,1]),v=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,v),gl.bufferData(gl.ARRAY_BUFFER,E,gl.STATIC_DRAW);const b=gl.getAttribLocation(quadProgram,"a_position"),x=gl.getAttribLocation(quadProgram,"a_texCoord");gl.enableVertexAttribArray(b),gl.vertexAttribPointer(b,2,gl.FLOAT,!1,16,0),gl.enableVertexAttribArray(x),gl.vertexAttribPointer(x,2,gl.FLOAT,!1,16,8),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,m);const T=gl.getUniformLocation(quadProgram,"u_texture");null!==T&&gl.uniform1i(T,0),gl.drawArrays(gl.TRIANGLES,0,6),gl.disableVertexAttribArray(b),gl.disableVertexAttribArray(x),gl.bindBuffer(gl.ARRAY_BUFFER,null),gl.deleteBuffer(v),gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindTexture(gl.TEXTURE_2D,null),gl.deleteTexture(m)}(a,r.fbo,n,o),syncActiveAliases?.(),rebuildLayersUI?.(),needsRedraw=!0,showStatusMessage?.("Pasted image into active layer.","success"),console.log("[Clipboard] Paste complete")}catch(e){console.error("pasteImageFromClipboard error",e),showStatusMessage?.("Paste failed.","error")}}async function copyActiveLayerToClipboard(){console.log("[Clipboard] copyActiveLayerToClipboard start");try{if(!(navigator.clipboard&&navigator.clipboard.write&&window.ClipboardItem))return void showStatusMessage?.("Clipboard copy not supported.","error");const e=layers&&Number.isInteger(activeLayerIndex)?layers[activeLayerIndex]:null;if(!e||!e.fbo)return void showStatusMessage?.("No active layer to copy.","error");const t=fixedFBOWidth,a=fixedFBOHeight,r=document.createElement("canvas");r.width=t,r.height=a;r.getContext("2d").putImageData(readFBOToImageData(e.fbo,t,a),0,0);const n=document.createElement("canvas");n.width=t,n.height=a;const o=n.getContext("2d");o.save(),o.translate(t/2,a/2),o.scale(-1,-1),o.rotate(Math.PI),o.drawImage(r,-t/2,-a/2),o.restore();const i=await new Promise(e=>n.toBlob(e,"image/png"));if(!i)return void showStatusMessage?.("Copy failed (no data).","error");await navigator.clipboard.write([new ClipboardItem({[i.type]:i})]),showStatusMessage?.("Active layer copied to clipboard.","success"),console.log("[Clipboard] Copy complete")}catch(e){console.error("copyActiveLayerToClipboard error",e),showStatusMessage?.("Copy to clipboard failed.","error")}}async function _readClipboardImage(e){if(e&&e.clipboardData&&e.clipboardData.items&&e.clipboardData.items.length)for(let t=0;t<e.clipboardData.items.length;t++){const a=e.clipboardData.items[t];if(a&&a.type&&a.type.startsWith("image/")){const e=a.getAsFile?a.getAsFile():null;if(e)return e}}if(navigator.clipboard&&navigator.clipboard.read)try{const e=await navigator.clipboard.read();for(const t of e)for(const e of t.types)if(e.startsWith("image/")){const a=await t.getType(e);if(a)return a}}catch(e){console.warn("[Clipboard] navigator.clipboard.read not permitted",e)}return null}function _blobToImage(e){return new Promise((t,a)=>{const r=URL.createObjectURL(e),n=new Image;n.onload=()=>{URL.revokeObjectURL(r),t(n)},n.onerror=e=>{URL.revokeObjectURL(r),a(e)},n.src=r})}function renderLoop(){needsRedraw&&(drawScene(),console.log("renderLoop"),needsRedraw=!1),requestAnimationFrame(renderLoop)}function onKeyDownClear(e){if("function"==typeof isUserTyping&&isUserTyping())return;const t=e.key;!("Delete"===t)&&!("Backspace"===t)||e.metaKey||e.ctrlKey||e.altKey||(e.preventDefault(),clearActiveLayer())}function onKeyDownNewLayerN(e){if("function"==typeof isUserTyping&&isUserTyping())return;if(e.metaKey||e.ctrlKey||e.altKey)return;const t=e.key||"";"n"!==t&&"N"!==t||(e.preventDefault(),triggerAdd())}function docToCanvasScale(){return{sx:canvas.width/fixedFBOWidth,sy:canvas.height/fixedFBOHeight}}function bind(){els.gridBtn=q("bgpCuratedGrid"),els.modal=q("bgPickerModal"),els.curatedGrid=q("bgpCuratedGrid"),els.file=q("bgpFile"),els.fileName=q("bgpFileName"),els.color=q("bgpColor"),els.colorHex=q("bgpColorHex"),els.apply=q("bgpApply"),els.cancel=q("bgpCancel"),els.closeX=q("bgpClose"),document.querySelectorAll(".bgp-tab").forEach(e=>{e.addEventListener("click",()=>switchTab(e.dataset.tab))}),els.file.addEventListener("change",onUploadFile),els.color.addEventListener("input",syncColorHex),els.colorHex.addEventListener("input",()=>{let e=els.colorHex.value.trim();/^#([0-9a-f]{3}|[0-9a-f]{6}|[0-9a-f]{8})$/i.test(e)&&(els.color.value=e,syncColorHex())}),els.apply.addEventListener("click",applySelected),els.cancel.addEventListener("click",close),els.closeX.addEventListener("click",close),document.getElementById("bgPickerBtn")?.addEventListener("click",open),buildCurated(),syncColorHex()}function markSelection(e){els.curatedGrid.querySelectorAll(".bgp-thumb.selected").forEach(e=>e.classList.remove("selected")),e&&e.classList.add("selected")}function open(){selectedCanvas=null,markSelection(null),els.fileName.textContent="No file chosen",els.file.value="",switchTab("curated"),syncColorHex(),q("bgPickerModal").style.display="flex"}function toggleUIVisibilityMode(){if(!document.getElementById("__uiHideStyle")){const e=document.createElement("style");e.id="__uiHideStyle",e.textContent="\n      /* hide any element that is neither a canvas nor an ancestor of a canvas,\n         and keep the toggle button and its children visible */\n      body.__ui_off :not(canvas):not(#hideAllButton):not(#hideAllButton *):not(:has(canvas)) {\n        visibility: hidden !important;\n      }\n      /* canvases must remain interactive while UI is hidden */\n      body.__ui_off canvas { pointer-events: auto !important; }\n      /* ensure the toggle stays clickable above everything */\n      #hideAllButton { z-index: 999999; }\n    ",document.head.appendChild(e)}const e=document.body.classList.toggle("__ui_off"),t=document.getElementById("hideAllButton");t&&(t.title=e?"Show UI":"Hide UI")}function docToCanvasPt(e){const{sx:t,sy:a}=docToCanvasScale();return{x:e.x*t,y:e.y*a}}function syncColorHex(){els.colorHex.value=els.color.value.toUpperCase();const e=fixedFBOWidth||canvas.width,t=fixedFBOHeight||canvas.height,a=solidToCanvas(els.color.value,e,t),r=q("bgpSolidPreview").getContext("2d");r.clearRect(0,0,q("bgpSolidPreview").width,q("bgpSolidPreview").height),r.drawImage(imageToCanvasCover(a,q("bgpSolidPreview").width,q("bgpSolidPreview").height),0,0),selectedCanvas=a}function setupClearLayerShortcut(){function e(e){if("function"==typeof isUserTyping&&isUserTyping())return;const t=e.key;!("Delete"===t)&&!("Backspace"===t)||e.metaKey||e.ctrlKey||e.altKey||(e.preventDefault(),clearActiveLayer())}try{document.removeEventListener("keydown",e,!0)}catch{}document.addEventListener("keydown",e,!0)}function loadImage(e){return new Promise((t,a)=>{const r=new Image;r.crossOrigin="anonymous",r.onload=()=>t(r),r.onerror=a,r.src=e})}function snapshotsEqual(e,t){if(!e||!t)return!1;if(e.w!==t.w||e.h!==t.h)return!1;const a=e.pixels,r=t.pixels;if(!a||!r||a.length!==r.length)return!1;const n=a.length;for(let e=0;e<n;e+=128)if(a[e]!==r[e]||a[e+1]!==r[e+1]||a[e+2]!==r[e+2]||a[e+3]!==r[e+3])return!1;const o=n-4;return a[o]===r[o]&&a[o+1]===r[o+1]&&a[o+2]===r[o+2]&&a[o+3]===r[o+3]}function imageToCanvasCover(e,t,a){const r=createCanvas(t,a),n=r.getContext("2d"),o=(e.naturalWidth||e.width)/(e.naturalHeight||e.height);let i,l,s,c;return o>t/a?(l=a,i=Math.ceil(a*o),s=Math.floor((t-i)/2),c=0):(i=t,l=Math.ceil(t/o),s=0,c=Math.floor((a-l)/2)),n.drawImage(e,s,c,i,l),r}function clearActiveLayer(){const e="function"==typeof getActiveLayer?getActiveLayer():layers?.[activeLayerIndex];if(!(gl&&e&&e.fbo&&e.texture))return;const t=snapshotLayer(activeLayerIndex),a=0|fixedFBOWidth,r=0|fixedFBOHeight,n=gl.getParameter(gl.FRAMEBUFFER_BINDING),o=gl.getParameter(gl.VIEWPORT);gl.bindFramebuffer(gl.FRAMEBUFFER,e.fbo),gl.viewport(0,0,a,r),gl.disable(gl.BLEND),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.bindTexture(gl.TEXTURE_2D,e.texture),(0|e.texW)===a&&(0|e.texH)===r||(gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,a,r,0,gl.RGBA,gl.UNSIGNED_BYTE,null),e.texW=a,e.texH=r,gl.bindFramebuffer(gl.FRAMEBUFFER,e.fbo),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,e.texture,0)),gl.bindFramebuffer(gl.FRAMEBUFFER,n),o&&gl.viewport(o[0],o[1],o[2],o[3]);const i=snapshotLayer(activeLayerIndex);t&&i&&History.push({type:"clear_layer",index:activeLayerIndex,before:t,after:i}),needsRedraw=!0,requestDrawIfIdle?.(),showStatusMessage?.("Layer cleared","info")}function setupNewLayerShortcutN(){const e=document.getElementById("addLayerBtn");if(e){try{document.removeEventListener("keydown",t,!0)}catch{}document.addEventListener("keydown",t,!0)}function t(t){if("function"==typeof isUserTyping&&isUserTyping())return;if(t.metaKey||t.ctrlKey||t.altKey)return;const a=t.key||"";"n"!==a&&"N"!==a||(t.preventDefault(),function(){try{e.click(),console.log("[Shortcut] New Layer via 'n' → addBtn.click()")}catch(e){try{const e=`Layer ${layers.length+1}`,t="number"==typeof activeLayerIndex?activeLayerIndex:layers.length-1;addLayer(e,t),console.log("[Shortcut] New Layer fallback → addLayer()",{name:e,insertBelowIndex:t})}catch(e){console.warn("[Shortcut] New Layer failed",e)}}}())}}function buildCurated(){els.curatedGrid.innerHTML="",curated.forEach(e=>{const t=el("button","bgp-thumb");t.type="button";const a=el("img");a.loading="lazy",a.src=e,a.alt="background",t.appendChild(a),t.addEventListener("click",async()=>{const a=fixedFBOWidth||canvas.width,r=fixedFBOHeight||canvas.height,n=await loadImage(e);selectedCanvas=imageToCanvasCover(n,a,r),markSelection(t)}),els.curatedGrid.appendChild(t)})}function solidToCanvas(e,t,a){const r=createCanvas(t,a),n=r.getContext("2d");return n.fillStyle=e,n.fillRect(0,0,t,a),r}function install(e){e?.curated&&Array.isArray(e.curated)&&(curated=e.curated),bind()}function q(e){return document.getElementById(e)}function switchTab(e){currentTab=e,document.querySelectorAll(".bgp-tab").forEach(t=>t.classList.toggle("active",t.dataset.tab===e)),q("bgPickerModal").querySelectorAll(".bgp-pane").forEach(t=>{const a=t.classList.contains("bgp-pane-curated")?"curated":t.classList.contains("bgp-pane-upload")?"upload":"solid";t.classList.toggle("active",a===e)})}function onUploadFile(e){const t=e.target.files&&e.target.files[0];if(!t)return;els.fileName.textContent=t.name;const a=new FileReader;a.onload=async()=>{const e=a.result,t=await loadImage(e),r=fixedFBOWidth||canvas.width,n=fixedFBOHeight||canvas.height;selectedCanvas=imageToCanvasCover(t,r,n);const o=q("bgpUploadPreview"),i=o.getContext("2d");i.clearRect(0,0,o.width,o.height),i.drawImage(imageToCanvasCover(t,o.width,o.height),0,0)},a.readAsDataURL(t)}function docToCanvasPx(e,t){return{x:e*(canvas.width/fixedFBOWidth),y:t*(canvas.height/fixedFBOHeight)}}function close(){q("bgPickerModal").style.display="none"}function createCanvas(e,t){const a=document.createElement("canvas");return a.width=e,a.height=t,a}function applySelected(){if(!selectedCanvas)return void close();const e=new Image;e.onload=()=>{currentImage=e,fixedFBOWidth=e.width,fixedFBOHeight=e.height,initPaintLayerFixed(),updateCanvasSize(e),initFloodFBOs(),createTextureFromImage(e),canvas.offsetWidth,canvasWrapper.offsetWidth,zoomScale=1,panX=(canvasWrapper.clientWidth-canvas.width)/2,panY=(canvasWrapper.clientHeight-canvas.height)/2,updateCanvasTransform(),needsRedraw=!0,initFloodFillProgram(),addSoundEvents(),close()},e.src=selectedCanvas.toDataURL("image/png")}function el(e,t){const a=document.createElement(e);return t&&(a.className=t),a}function layerLocalToDoc(e,t,a){const r=Number.isFinite(e.scaleX)?e.scaleX:1,n=Number.isFinite(e.scaleY)?e.scaleY:1,o=Number.isFinite(e.rotation)?e.rotation:0,i=Math.cos(o),l=Math.sin(o),s=t*r,c=a*n;return{x:e.x+(s*i-c*l),y:e.y+(s*l+c*i)}}function docToLayerLocal(e,t,a){const r=t-e.x,n=a-e.y,o=Number.isFinite(e.rotation)?e.rotation:0,i=Math.cos(o),l=Math.sin(o),s=-r*l+n*i;return{px:(r*i+n*l)/(Number.isFinite(e.scaleX)?e.scaleX:1),py:s/(Number.isFinite(e.scaleY)?e.scaleY:1)}}function triggerAdd(){try{addBtn.click(),console.log("[Shortcut] New Layer via 'n' → addBtn.click()")}catch(e){try{const e=`Layer ${layers.length+1}`,t="number"==typeof activeLayerIndex?activeLayerIndex:layers.length-1;addLayer(e,t),console.log("[Shortcut] New Layer fallback → addLayer()",{name:e,insertBelowIndex:t})}catch(e){console.warn("[Shortcut] New Layer failed",e)}}}panels.forEach(({id:e,dragBarId:t})=>{const a=document.getElementById(e),r=document.getElementById(t);if(!a||!r)return;let n=0,o=0,i=!1;const l=localStorage.getItem(`${e}-x`),s=localStorage.getItem(`${e}-y`);null!==l&&null!==s&&(a.style.left=`${l}px`,a.style.top=`${s}px`,a.style.bottom="auto"),r.addEventListener("pointerdown",e=>{i=!0,n=e.clientX-a.offsetLeft,o=e.clientY-a.offsetTop,r.setPointerCapture(e.pointerId),r.style.cursor="grabbing"}),r.addEventListener("pointermove",e=>{if(!i)return;const t=e.clientX-n,r=e.clientY-o;a.style.left=`${t}px`,a.style.top=`${r}px`,a.style.bottom="auto"}),r.addEventListener("pointerup",t=>{i=!1,r.releasePointerCapture(t.pointerId),r.style.cursor="grab",localStorage.setItem(`${e}-x`,a.offsetLeft),localStorage.setItem(`${e}-y`,a.offsetTop)}),r.addEventListener("pointercancel",()=>{i=!1,r.style.cursor="grab"})}),document.addEventListener("paste",e=>{!!(e&&e.clipboardData&&[...e.clipboardData.items].some(e=>e.type.startsWith("image/")))&&(e.preventDefault(),pasteImageFromClipboard(e))}),document.addEventListener("copy",e=>{(navigator.platform.toUpperCase().includes("MAC")?e.metaKey:e.ctrlKey)&&!0===e.shiftKey&&(e.preventDefault(),copyActiveLayerToClipboard())}),document.addEventListener("keydown",e=>{(navigator.platform.toUpperCase().includes("MAC")?e.metaKey:e.ctrlKey)&&"v"===e.key.toLowerCase()&&setTimeout(async()=>{if(navigator.clipboard&&navigator.clipboard.read)try{const e=await navigator.clipboard.read();e.some(e=>e.types.some(e=>e.startsWith("image/")))&&pasteImageFromClipboard(null)}catch(e){}},0)}),function(){const e=document.getElementById("layersPanel"),t=document.getElementById("layersPanelDragBar"),a=document.getElementById("layersList"),r=document.getElementById("layersActions"),n=document.getElementById("layersPanelToggle");if(!e||!t)return;const o="layersPanel:minimized",i="layersPanel:x",l="layersPanel:y",s=localStorage.getItem(i),c=localStorage.getItem(l);null!==s&&null!==c&&(e.style.left=+s+"px",e.style.top=+c+"px",e.style.bottom="auto");let d="true"===localStorage.getItem(o);function g(){a&&(a.style.display=d?"none":"flex"),r&&(r.style.display=d?"none":"flex"),n&&(n.innerHTML=d?'<img class="show-icon-invert" src="/static/draw/images/icons/hide.svg" alt="Show">':'<img class="show-icon-invert" src="/static/draw/images/icons/show.svg" alt="Hide">')}g(),n&&n.addEventListener("click",e=>{e.stopPropagation(),d=!d,localStorage.setItem(o,d),g()});let u=!1,m=0,f=0;function h(e,t,a){return Math.max(t,Math.min(a,e))}function y(a){if(u){u=!1;try{t.releasePointerCapture(a.pointerId)}catch{}t.style.cursor="grab",localStorage.setItem(i,e.offsetLeft),localStorage.setItem(l,e.offsetTop)}}t.style.cursor="grab",t.addEventListener("pointerdown",function(a){const r=a.target;if(!r.closest||!r.closest(".icon-btn")){u=!0,m=a.clientX-e.offsetLeft,f=a.clientY-e.offsetTop;try{t.setPointerCapture(a.pointerId)}catch{}t.style.cursor="grabbing",a.preventDefault()}}),t.addEventListener("pointermove",function(t){if(!u)return;const a=window.innerWidth,r=window.innerHeight,n=h(t.clientX-m,0,a-e.offsetWidth),o=h(t.clientY-f,0,r-e.offsetHeight);e.style.left=`${n}px`,e.style.top=`${o}px`,e.style.bottom="auto"}),t.addEventListener("pointerup",y),t.addEventListener("pointercancel",y);try{a&&"block"===getComputedStyle(a).display&&(a.style.display="flex")}catch{}try{rebuildLayersUI?.()}catch{}}(),initGL(),loadDefaultImage(),loadBrushes(),createBrushThumbnails(),renderLoop(),window.addEventListener("keydown",e=>{const t=/Mac|iPhone|iPad/.test(navigator.platform);"F1"===e.key&&(e.preventDefault(),openHelpModal()),("?"===e.key||"/"===e.key&&e.shiftKey)&&(e.preventDefault(),openQuickHelpOverlay()),(t?e.metaKey:e.ctrlKey)&&"/"===e.key&&(e.preventDefault(),openQuickHelpOverlay())});